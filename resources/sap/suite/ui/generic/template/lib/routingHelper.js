sap.ui.define(["sap/f/FlexibleColumnLayout","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/generic/app/util/ModelUtil","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/FlexibleColumnLayoutHandler","sap/suite/ui/generic/template/lib/testableHelper","sap/m/routing/Targets"],function(F,a,b,M,C,c,t,T){"use strict";function g(N,i){var u=i.getId();var v=N.oAppComponent.getConfig(),w,x;if(!v.pages||!v.pages.length){throw new Error("Route Configuration missing");}if(v.pages.length>1){throw new Error("Currently only one Top route supported");}w=v.pages[0];N.oTemplateContract.mEntityTree={};x=j([],w,"root",0,null,N,u);N.oRouter.addRoute(x);f(x,N);d(x.target,w,0,null,N,u);return w.entitySet;}function d(P,R,L,u,N,v,w){var i,x;if(R.pages){x=R.pages.length;for(i=0;i<x;i++){e(P,R.pages[i],(L+1),u,N,v,w);}}}function e(P,R,L,i,N,u,v){if(R.component){var w={parent:i&&i.entitySet,level:L,children:[]};var x=j(P,R,R.component.list?"aggregation":"detail",L,i,N,u);w.sRouteName=x.name;if(v){v.push(x.entitySet);}N.oTemplateContract.mEntityTree[x.entitySet]=w;N.oRouter.addRoute(x);f(x,N);d(x.target,R,L,x,N,u,w.children);}}function f(R,N){var Q=jQuery.extend({},R);Q.name=R.name+"query";Q.pattern=R.pattern+"{?query}";N.oRouter.addRoute(Q);}function h(R,i,u,v,w){var x={};x={viewName:v,controlId:i,controlAggregation:w};var y=R.getTargets();y.addTarget(u,x);}function j(P,R,O,L,i,N,u){var v,w;v=R.navigationProperty||R.entitySet;w=jQuery.extend({},R);w.path="/"+R.entitySet;w.operation=O;w.viewLevel=L;w.template=R.component?(R.component.name||R.component):R.template;switch(O){case"root":w.name="root";w.pattern="";break;case"aggregation":w.name=v+"~aggregation";w.pattern=v;break;default:w.name=v;w.pattern=v+"({keys"+L+"})";break;}if(i){w.name=i.name+"/"+w.name;w.pattern=i.pattern+"/"+w.pattern;w.parentEntitySet=i.entitySet;}if(w.viewLevel===1){N.oTemplateContract.routeViewLevel1={pattern:w.pattern,name:w.name};}var x,y,z;if(w.viewLevel<3&&N.oTemplateContract.oFlexibleColumnLayoutHandler){x=u;y=w.name;switch(w.viewLevel){case 0:z="beginColumn";break;case 1:z="midColumn";break;case 2:z="endColumn";}w.target=P.concat([y]);}else{x=N.oTemplateContract.oNavContainer.getId();z="pages";y=w.name;w.target=y;}h(N.oRouter,x,y,w.name,z);var A=new Promise(function(B){N.mRouteToComponentResolve[w.name]=B;});N.oTemplateContract.mRouteToTemplateComponentPromise[w.name]=A;return w;}function I(N,S){var H;if(!N.oHashChanger.getHash()){H="";if(S&&S.route&&S.route.length===1){H=S.route[0];N.navigate(H,true);}}N.oRouter.initialize();N.fnInitializationResolve();}function r(N,E,K,S,u){var i,L,P,v,w=[];if(K&&S&&u){L=K.length;for(i=0;i<L;i++){P=K[i].PropertyPath;v=S[P][0];w.push(new a(P,b.EQ,v));}if(N.oAppComponent.getTransactionController().getDraftController().getDraftContext().isDraftEnabled(E)){var x=new a({filters:[new a("IsActiveEntity","EQ",false),new a("SiblingEntity/IsActiveEntity","EQ",null)],and:false});w.push(x);}var y=new a(w,true);u.read("/"+E,{filters:[y],success:function(R){var z,i,A,B;if(R&&R.results){A=R.results.length;for(i=0;i<A;i++){z=R.results[i];if(z&&z.IsActiveEntity){break;}z=null;}if(!z){z=R.results[0];}}if(z){B=u.getKey(z);}if(B){N.navigate(B,true);}I(N,S);},error:function(z){I(N,S);}});}}function k(P,i){if((P&&i)||(i==="display")){return{mode:"unsupported"};}var R={mode:"display",force:"false"};R.mode=i||P||R.mode;R.force=!!i;return R;}function D(i,N,E,S,u){var v=m(i,N,E,S,u);var H;if(v.bNavigationWithTechnicalKeyPossible){H=i.createKey(E,S);if(H){N.navigate(H,true);}}else if(v.bNavigationWithSemanticKeyPossible){r(N,E,v.aSemanticKey,S,i);return;}I(N,S);}function l(K,P){var i,L,S=false,u,v;if(P&&K){L=K.length;for(i=0;i<L;i++){S=true;u=K[i];v=u.name||u.PropertyPath;if(!P[v]||P[v].length>1){S=false;break;}}}return S;}function m(i,N,E,S,u){if(!N.oRouter.getRoute(E)){return{};}if(N.oAppComponent.getManifestEntry("sap.ui.generic.app").pages[0].pages[0].navigation&&N.oAppComponent.getManifestEntry("sap.ui.generic.app").pages[0].pages[0].navigation[u.mode]){return{};}var v=i.getMetaModel().getODataEntitySet(E);if(!v){return{};}var w=i.getMetaModel().getODataEntityType(v.entityType);if(l(w.key.propertyRef,S)){return{bNavigationWithTechnicalKeyPossible:true};}var x=w["com.sap.vocabularies.Common.v1.SemanticKey"];if(l(x,S)){return{bNavigationWithSemanticKeyPossible:true,aSemanticKey:x};}return{};}function p(N,E,S){var u;u=N.oAppComponent.getModel();u.attachMetadataFailed(N.fnInitializationResolve);u.getMetaModel().loaded().then(function(){var v;var P=S.preferredMode&&S.preferredMode[0];var w=S.mode&&S.mode[0];var x=k(P,w);if(S.DraftUUID){S.DraftUUID=["00000000-0000-0000-0000-000000000000"];}if(S.IsActiveEntity){S.IsActiveEntity=["true"];}switch(x.mode){case"create":N.oTemplateContract.oApplicationProxy.addDataForNextPage({addEntry:true,addEntryForDeleteButton:true,addEntryForCancelButton:true});var y=C.create(N.oAppComponent.getTransactionController().getDraftController(),E,"/"+E,u,N.oTemplateContract.oApplicationProxy.setEditableNDC);y.then(function(H){N.oTemplateContract.oApplicationProxy.addDataForNextPage({isObjectRoot:true});I(N,S);N.navigateToContext(H,"",true,4);},function(H){N.navigateToMessagePage({title:N.oTemplateContract.getText("ST_GENERIC_ERROR_TITLE"),text:H.messageText,description:"",icon:"sap-icon://message-error",replaceURL:true});});N.oTemplateContract.oBusyHelper.setBusy(y,true);break;case"createWithContext":v=u.getMetaModel().getODataEntitySet(E);var z=v["com.sap.vocabularies.Common.v1.DraftRoot"];if(z&&z.NewAction){var A=u.getMetaModel().getODataFunctionImport(z.NewAction.String.split("/")[1]);var U={};if(A&&A.parameter){for(var i=0;i<A.parameter.length;i++){if(A.parameter[i].mode==="In"&&S[A.parameter[i].name][0]){U[A.parameter[i].name]=S[A.parameter[i].name][0];}}sap.ui.core.BusyIndicator.show();u.callFunction("/"+A.name,{success:function(H,R){I(N,S);sap.ui.core.BusyIndicator.hide();var J=new M(u);var K=J.getContextFromResponse(H);if(K){N.navigateToContext(K,null,true,4);}else{N.navigateToMessagePage({title:N.oTemplateContract.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),replaceURL:true});}},error:function(H){sap.ui.core.BusyIndicator.hide();N.navigateToMessagePage({title:N.oTemplateContract.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),replaceURL:true});},method:"POST",urlParameters:U});}else{N.navigateToMessagePage({title:N.oTemplateContract.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),replaceURL:true});}}break;case"edit":var B=m(u,N,E,S,x);if(B.bNavigationWithTechnicalKeyPossible||B.bNavigationWithSemanticKeyPossible){var G=C.edit(N.oAppComponent.getTransactionController(),E,"/"+u.createKey(E,S),u,N.oTemplateContract,N.fnInitializationResolve);G.then(function(R){N.navigate(R.context.getPath(),true);I(N);},function(H){if(H.lockedByUser){if(!x.force){D(u,N,E,S,x);}else{N.fnInitializationResolve();N.navigateToMessagePage({title:N.oTemplateContract.getText("LOCKED_OBJECT_POPOVER_TITLE"),text:N.oTemplateContract.getText("LOCKED_OBJECT_POPOVER_TITLE"),description:N.oTemplateContract.getText("ST_GENERIC_LOCKED_OBJECT_POPOVER_TEXT",[H.lockedByUser]),icon:"sap-icon://message-error",replaceURL:true});}}else if(H.draftAdminReadResponse){N.fnInitializationResolve();N.navigateToMessagePage({title:N.oTemplateContract.getText("ST_GENERIC_ERROR_TITLE"),text:N.oTemplateContract.getText("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE"),description:N.oTemplateContract.getText("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE_DESC"),icon:"sap-icon://message-error",replaceURL:true});}});}else{I(N,S);}break;case"display":D(u,N,E,S,x);break;default:N.fnInitializationResolve();N.navigateToMessagePage({title:N.oTemplateContract.getText("ST_GENERIC_ERROR_TITLE"),text:N.oTemplateContract.getText("ST_GENERIC_ERROR_TITLE"),description:N.oTemplateContract.getText("PARAMETER_COMBINATION_NOT_SUPPORTED",[w,P]),icon:"sap-icon://message-error",replaceURL:true});}});}function s(N){var i=N.oAppComponent.getManifestEntry("sap.ui.generic.app");var u;if(i.settings&&i.settings.flexibleColumnLayout&&i.settings.flexibleColumnLayout===true){u=new F({threeColumnLayoutType:"MidColumnEmphasized",threeColumnLayoutTypeFixed:i.settings.flexibleColumnLayoutIsThirdColumnFixed});N.oTemplateContract.oNavContainer.addPage(u);N.oTemplateContract.oFlexibleColumnLayoutHandler=new c(u,N);}else{u=N.oTemplateContract.oNavContainer;}var E=g(N,u);var v=N.oAppComponent.getComponentData();var S=v&&v.startupParameters;if(E&&S&&!N.oHashChanger.getHash()){p(N,E,S);}else{I(N);}}function n(R){var P,i,u;if(R){P=R.pattern;i=R.navigationProperty||R.entitySet;if(P&&i){u=P.indexOf("{?query}");if(u>0){P=P.substring(0,u);}u=-1;i+="({keys";u=P.indexOf(i);if(u>0){P=P.substring(u);}if(R.navigationProperty){P=P.replace(R.navigationProperty,R.entitySet);}P="/"+P;}}return P;}function o(R,E,P){var i,K,u;if(R.operation==="root"){return null;}if(R.operation==="aggregation"){i=R.pattern;}else{if(P){i=P;}else{i=n(R);}}if(i.indexOf("/")!==0){i="/"+i;}K=E.getParameter("arguments");delete K["?query"];if(K){for(u in K){i=i.replace("{"+u+"}",K[u]);}return i;}}function q(i,N){var P,u,E;P=i.getPath().substring(1);u=P.split("(");if(u[0]){E=u[0];}if(N){P=P.replace(E,N);if(P.indexOf("/")===0){P=P.substring(1);}}return{entitySet:E,path:P};}var g=t.testableStatic(g,"routingHelpergenerateRoutingMetadataAndGetRootEntitySet");var I=t.testableStatic(I,"routingHelper_initialiseRouting");var r=t.testableStatic(r,"routingHelper_readObject");var p=t.testableStatic(p,"routingHelper_processStartupParameters");return{startupRouter:s,determinePath:o,determineNavigationPath:q};});
