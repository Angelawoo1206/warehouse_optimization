sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/m/MessageToast","sap/ui/generic/app/util/ModelUtil","sap/ui/generic/app/util/ActionUtil","sap/suite/ui/generic/template/lib/MessageUtils","sap/m/MessageBox","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/testableHelper","sap/m/Table","sap/ui/table/AnalyticalTable"],function(q,B,M,a,A,b,c,C,t,T,d){"use strict";var r=Promise.reject();r.catch(q.noop);function g(o,e,s,f,h){function k(O,i,j,P){b.handleError(O,o,s,j,P);return(i||q.noop)(j);}function l(){b.handleTransientMessages(s.oApplication.getDialogFragmentForView.bind(null,null));}var E;function m(i){return new Promise(function(j,D){var F=o.getOwnerComponent();var G=F.getBindingContext();var H=F.getModel();H.read(G.getPath(),{urlParameters:{"$expand":"DraftAdministrativeData"},success:function(R){if(!R.DraftAdministrativeData){if(i){return k(b.operations.editEntity,D,i);}return j({});}if(R.DraftAdministrativeData.InProcessByUser){var U=R.DraftAdministrativeData.InProcessByUserDescription||R.DraftAdministrativeData.InProcessByUser;i=i||new Error(f.getText("ST_GENERIC_DRAFT_LOCKED_BY_USER",[" ",U]));return k(b.operations.editEntity,D,i,i);}return j({draftAdministrativeData:R.DraftAdministrativeData});},error:k.bind(null,b.operations.editEntity,D)});});}function n(i,U,P){if(P.draftAdministrativeData){return Promise.resolve(P);}return new Promise(function(j,D){s.oTransactionController.editEntity(o.getView().getBindingContext(),!U).then(function(R){e.rebindHeaderData(R.context.getPath());l(R);return j({context:R.context});},function(R){if(R&&R.response&&R.response.statusCode==="409"&&i&&!U){b.removeTransientMessages();return m(R).then(j,D);}else{k(b.operations.editEntity,D,R,R);}});});}E=function(U){var i=f.isDraftEnabled();if(i&&!U){var D=s.oDraftController.getDraftContext();var j=o.getOwnerComponent();var F=j.getBindingContext();var P=D.hasPreserveChanges(F);if(!P){return m().then(n.bind(null,true,true));}}return n(i,U,{});};function p(U){if(h.isBusy()){return r;}var R=E(U);h.setBusy(R);return R;}function u(D,N){if(h.isBusy()){return r;}var i=o.getView().getBindingContext();var I=s.oDraftController.isActiveEntity(i);var H=s.oDraftController.hasActiveEntity(i);var R=new Promise(function(j,F){var G=function(J){o.getOwnerComponent().getComponentContainer().bindElement(i.getPath());return k(b.operations.deleteEntity,F,J);};if(I&&D){s.oDraftController.getDraftForActiveEntity(i).then(function(J){s.oTransactionController.deleteEntity(J.context).then(function(){if(!N){s.oApplication.showMessageToast(f.getText("ST_GENERIC_DRAFT_WITH_ACTIVE_DOCUMENT_DELETED"));}return j();});},G);}else{s.oTransactionController.deleteEntity(i).then(function(){var J=a.getEntitySetFromContext(i);var K=s.oDraftController.getDraftContext();var L=K.isDraftRoot(J);var O=f.getText("ST_GENERIC_OBJECT_DELETED");if(!I&&L){O=f.getText(H?"ST_GENERIC_DRAFT_WITH_ACTIVE_DOCUMENT_DELETED":"ST_GENERIC_DRAFT_WITHOUT_ACTIVE_DOCUMENT_DELETED");}if(!N){s.oApplication.showMessageToast(O);}return j();},G);}});h.setBusy(R);return R;}function v(P){return new Promise(function(D,F){s.oTransactionController.deleteEntities(P).then(function(G){var H=[];var O=sap.ui.getCore().getMessageManager().getMessageModel().getData();for(var i=0;i<O.length;i++){var I=O[i].getTarget();for(var j=0;j<P.length;j++){if(I.indexOf(P[j])>-1){H.push(I);break;}}}return D(H);},function(i){return F(i);});});}function w(){if(h.isBusy()){return r;}var R=new Promise(function(i,j){s.oTransactionController.triggerSubmitChanges().then(function(D){l();return i(D.context);},k.bind(null,b.operations.saveEntity,j));});h.setBusy(R);return R;}function x(){if(h.isBusy()){return r;}var R=new Promise(function(i,j){s.oDraftController.activateDraftEntity(o.getView().getBindingContext()).then(function(D){var F=o.getOwnerComponent();var G=F.getComponentContainer();var P=D.context.getPath();function H(){G.unbindElement();e.rebindHeaderData(P);}var I=F.getComponentData().preprocessorsData.rootContextExpand;if(I){o.getView().getModel().read(P,{urlParameters:{"$select":I.join(","),"$expand":I.join(",")},success:H,error:H});}else{H();}l();return i(D);},k.bind(null,b.operations.activateDraftEntity,j));});h.setBusy(R);return R;}function y(P,S){if(h.isBusy()){return r;}var F=P.functionImportPath;var j=P.contexts;var D=P.sourceControl;var G=P.label;var N=P.navigationProperty;var O=P.operationGrouping;var H=new A({controller:o,contexts:j,applicationController:s.oApplicationController,operationGrouping:O});var I=function(Q,U){if(Q.pages){for(var i in Q.pages){var V=Q.pages[i];if(V.component.list!=true&&V.entitySet===U){return true;}else{var W=I(V,U);if(W){return true;}}}}return false;};var J=function(i,Q){var U=i.getAppComponent().getConfig();if(Q&&Q.sPath){var V=Q.sPath.split("(")[0].replace("/","");return I(U.pages[0],V);}return false;};var K=function(i){var Q,U,V,W;if(q.isArray(i)&&i.length===1){Q=i[0];}else{Q={response:{context:i.context}};}U=Q.response&&Q.response.context;V=o.getOwnerComponent();W=J(V,U);if(W&&U&&U!==Q.actionContext&&U.getPath()!=="/undefined"){if(D){f.navigateFromListItem(U,D);}else{s.oNavigationController.navigateToContext(U,N,false);}}if(i.length>0){var X=f.getTableBinding(D);var Y=X&&X.binding;if(Y&&Y.oEntityType){f.setEnabledToolbarButtons(D);var Z=V.getComponentContainer();var $=Z&&Z.getSettings();var _=$&&$.routeConfig;if(_){if(sap.suite.ui.generic.template.js.AnnotationHelper.isListReportTemplate(_)){f.setEnabledFooterButtons(D,o);}}}}return i;};var L=function(i){if(q.isArray(i)){if(i.length===1){i=i[0].error;}else{i=null;}}var Q={context:j};k(b.operations.callAction,null,i,Q);};var R=H.call(F,G).then(K,L);h.setBusy(R);return R;}function z(i){if(!i){throw new Error("Unknown Table");}var j="";var D="";var F=o.getOwnerComponent().getEntitySet();var G,H,N,I;var V=o.getView();var J=V.getModel();var K=V.getBindingContext();if(K){D=f.getTableBinding(i).path;I=J.getMetaModel();H=I.getODataEntitySet(F);G=I.getODataEntityType(H.entityType);N=I.getODataAssociationSetEnd(G,D);if(N){F=N.entitySet;}D="/"+D;j=K.getPath()+D;}else{j="/"+F;}var L=C.create(s.oDraftController,F,j,J,s.oApplication.setEditableNDC);s.oApplication.getBusyHelper().setBusy(L);return L.then(function(O){return{newContext:O,tableBindingPath:D};},k.bind(null,b.operations.addEntry,function(O){throw O;}));}var k=t.testable(k,"handleError");return{editEntity:p,deleteEntity:u,deleteEntities:v,saveEntity:w,activateDraftEntity:x,callAction:y,addEntry:z};}return B.extend("sap.suite.ui.generic.template.lib.CRUDManager.js",{constructor:function(o,e,s,f,h){q.extend(this,g(o,e,s,f,h));}});});
