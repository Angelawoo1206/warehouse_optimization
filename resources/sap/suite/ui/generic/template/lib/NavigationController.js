/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/core/ComponentContainer","sap/ui/core/routing/HashChanger","sap/ui/core/routing/History","sap/ui/core/routing/HistoryDirection","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/m/MessagePage","sap/m/Link","sap/suite/ui/generic/template/lib/routingHelper","sap/suite/ui/generic/template/lib/testableHelper"],function(B,C,H,a,b,F,c,M,d,L,r,t){"use strict";var h=a.getInstance();function T(s,m,D){var i;if(s&&m){if(isNaN(D)){D=0;}i=s.indexOf(m);if(i>-1){s=s.substring(0,i-D);}}return s;}function f(A,R,i){var s,E,o,S;s=R.template;E=R.entitySet;S={appComponent:A,isLeaf:!R.pages||!R.pages.length,subPages:R.pages,entitySet:E,navigationProperty:R.navigationProperty,routeConfig:R,componentData:{preprocessorsData:{},registryEntry:{componentCreateResolve:i,viewLevel:R.viewLevel}}};if(R.component.settings){jQuery.extend(S,R.component.settings);}A.runAsOwner(function(){try{o=new C({name:s,propagateModel:true,width:"100%",height:"100%",handleValidation:true,settings:S});}catch(e){throw new Error("Component "+s+" could not be loaded");}});return o;}function g(A,o,n){var s=null;var e={iHashChangeCount:0};function j(){for(var i in o.componentRegistry){var R=o.componentRegistry[i];if(R.activationTakt<e.iHashChangeCount){R.utils.suspendBinding();}}}function k(){e.back=true;window.history.back();}function l(i,R){i=i||"";e.hash=i;if(R){n.oHashChanger.replaceHash(i);}else{n.oHashChanger.setHash(i);}}function m(R){l("",R);}function p(i){var R=o.mEntityTree[i.entitySet].sRouteName;var E=o.mRouteToTemplateComponentPromise[R];return[E];}function P(E,G){var I=e.iHashChangeCount;var J=function(O){var R=o.componentRegistry[O.getId()];(R.methods.presetDisplayMode||jQuery.noop)(G,I===R.activationTakt);};for(var i=0;i<E.length;i++){var K=E[i];K.then(J);}}function q(i,E,R,G){var I=n.oHashChanger.getHash(),J;var K;var O=[];if(i){if(typeof i==="string"){J=i;s=null;}else{K=r.determineNavigationPath(i,E);J=K.path;s=i.getPath();O=p(K);}}else{J=E;}if(J){if(E){if(E.indexOf("/")<0){E="/"+E;}I=T(I,E);I=T(I,"?");if(I){if(I.substr(I.length-1,1)!=="/"){I=I+"/";}J=I+J;}}P(O,G||0);if(o.oFlexibleColumnLayoutHandler){var Q=o.oFlexibleColumnLayoutHandler.getAppStateParStringForNavigation(K);Q.then(function(S){if(S){J=J+"?"+S;}l(J,R);});}else{l(J,R);}}}var u;function v(i){var E,G,I,J,K,O,Q=null,R,S;if(i){E=i.entitySet;G=i.title;I=i.text;Q=i.icon;S=i.description;}if(E){R=A.getModel().getMetaModel();if(R){J=R.getODataEntitySet(E);K=R.getODataEntityType(J.entityType);O=K["com.sap.vocabularies.UI.v1.HeaderInfo"];}if(O&&O.TypeImageUrl&&O.TypeImageUrl.String){Q=O.TypeImageUrl.String;}}o.oNoOwnTitlePromise.then(function(U){if(!u){u=new d({showNavButton:true,navButtonPress:o.oNavContainer.back,showHeader:!U});o.oNavContainer.addPage(u);}if(U){o.oShellService.setTitle(G);o.oShellService.setBackNavigation(undefined);}else{u.setTitle(G);}u.setText(I);u.setIcon(Q);u.setDescription(S);o.oNavContainer.to(u);e={iHashChangeCount:e.iHashChangeCount+1};j();});}function w(i,E,G){var R=o.componentRegistry[G.getId()]||{};var I=(R.activationTakt===E.iHashChangeCount-1);R.activationTakt=E.iHashChangeCount;var J;if(G&&G.onActivate){J=G.onActivate(i,I);}return J||R.viewRegisterd;}function x(i,E,G){w(i,E,G).then(j);}function y(E,i,I){var G={};if(i||I){var V=E.getParameter("config").viewLevel;var J=o.oTemplatePrivateGlobalModel.getProperty("/generic/paginatorInfo");for(var K=0;K<V;K++){G[K]=J[K];}}o.oTemplatePrivateGlobalModel.setProperty("/generic/paginatorInfo",G);}function z(E){for(var i=0;i<o.aStateChangers.length;i++){var S=o.aStateChangers[i];if(S.isStateChange(E)){return;}}var G=e.iHashChangeCount;var I=n.oHashChanger.getHash()||"";var J=(I===e.hash);var K=!!(e.back||(!J&&(h.getDirection()===b.Backwards)));e={iHashChangeCount:G+1};y(E,J,K);var O={bIsProgrammatic:J,bIsBack:K,iHashChangeCount:G+1};if(o.oFlexibleColumnLayoutHandler){o.oFlexibleColumnLayoutHandler.handleRouteMatchedFlexibleColumnLayout(E,O);return;}o.oApplicationProxy.onRouteMatched(E);var R,Q;R=E.getParameter("config");if(R.viewLevel===0||!(J||K)){o.oApplicationProxy.setEditableNDC(false);}if(s){Q=s;s=null;}else{Q=r.determinePath(R,E);}var U=R.target;var V=o.mRouteToTemplateComponentPromise[U];V.then(x.bind(null,Q,O));}function D(){o.oApplicationProxy.onBypassed();v({title:o.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),replaceURL:true});}n.oRouter.attachRouteMatched(z);n.oRouter.attachBypassed(D);n.navigate=l;n.activateOneComponent=w;n.afterActivation=j;var v=t.testable(v,"navigateToMessagePage");t.testable(function(){return s;},"getTargetContextPath");t.testable(function(i){s=i;},"setTargetContextPath");return{navigateToRoot:m,navigateToContext:q,navigateToMessagePage:v,navigateBack:k};}var N=B.extend("sap.suite.ui.generic.template.lib.NavigationController",{metadata:{library:"sap.suite.ui.generic.template"},constructor:function(A,o){B.apply(this,arguments);var n={oAppComponent:A,oRouter:A.getRouter(),oTemplateContract:o,oHashChanger:H.getInstance(),mRouteToComponentResolve:{}};var e=new Promise(function(R){n.fnInitializationResolve=R;});o.oBusyHelper.setBusy(e);jQuery.extend(this,g(A,o,n));jQuery.extend(n,this);var v={};n.oRouter._oViews._getViewWithGlobalId=function(V){if(!v[V.viewName]){var R=n.oRouter.getRoute(V.viewName);var i;if(R&&R._oConfig){i=f(A,R._oConfig,n.mRouteToComponentResolve[V.viewName]);}else{i=sap.ui.view({viewName:V.viewName,type:V.type,height:"100%"});}v[V.viewName]=i;if(V.viewName==="root"){o.rootContainer=i;}}return v[V.viewName];};r.startupRouter(n);}});N._sChanges="Changes";return N;});
