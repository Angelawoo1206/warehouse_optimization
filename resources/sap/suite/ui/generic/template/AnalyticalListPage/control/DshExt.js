sap.ui.define(["sap/zen/dsh/Dsh","sap/suite/ui/generic/template/AnalyticalListPage/control/AlrDshRenderer","sap/ui/comp/smartvariants/PersonalizableInfo","sap/ui/comp/smartvariants/SmartVariantManagement"],function(D,A,P,S){"use strict";var c=D.extend("sap.suite.ui.generic.template.AnalyticalListPage.control.DshExt",{renderer:A,metadata:{properties:{persistencyKey:{type:"string",group:"Misc",defaultValue:null}},associations:{smartVariant:{type:"sap.ui.core.Control",multiple:false}}}});c.prototype.init=function(){var m=this;sap.zen.dsh.Dsh.prototype.init.apply(m);m.DSH_ROOT_NODE_ID=m.getId()+"sapbi_snippet_ROOT";m._scriptReady=false;m.DATASOURCE_ID="DS_1";m.dimensionsExternalNameMap={};};c.prototype.doInit=function(){var m=this;sap.zen.dsh.Dsh.prototype.doInit.apply(this);m._scriptReady=true;if(m._pendingCreatePage){m._pendingCreatePage=false;m._filterVariantLoaded=true;m.createPage();m.updateDshContainerHeight();m.rb=m.oState.oController.getView().getModel("i18n").getResourceBundle();}m.oState.oSmartFilterbar.attachAfterVariantLoad(jQuery.proxy(m.handleFilterAfterVariantLoad,m));};c.prototype.handleFilterAfterVariantLoad=function(C){var m=this;m._filterVariantLoaded=true;if(m._pendingApplyVariant){m.applyVariant(m._oCurrentVariant);m._filterVariantLoaded=false;m._pendingApplyVariant=false;}else if(m._pendingApplyFilter){m.execApplyFilter();m._filterVariantLoaded=false;m._pendingApplyFilter=false;}};c.prototype.setViewController=function(C,s){var m=this;m.oController=C;m.oState=s;};c.prototype.setSmartVariant=function(s){var m=this;m.setAssociation("smartVariant",s);if(s){var p=new P({type:"alr_designstudio_app",keyName:"persistencyKey",dataSource:"TODO"});p.setControl(m);}m._oVariantManagement=m._getVariantManagementControl(s);if(m._oVariantManagement){m._oVariantManagement.addPersonalizableControl(p);m._oVariantManagement.initialise(m._variantInitialised,m);}else if(s){if(typeof s==="string"){jQuery.sap.log.error("Variant with id="+s+" cannot be found");}else if(s instanceof sap.ui.core.Control){jQuery.sap.log.error("Variant with id="+s.getId()+" cannot be found");}}else{jQuery.sap.log.error("Missing SmartVariant");}};c.prototype._variantInitialised=function(){if(!this._oCurrentVariant){this._oCurrentVariant="STANDARD";}};c.prototype._getVariantManagementControl=function(s){var o=null;if(s){if(typeof s==="string"){o=sap.ui.getCore().byId(s);}else{o=s;}if(o){if(!(o instanceof S)){jQuery.sap.log.error("Control with the id="+s.getId?s.getId():s+" not of expected type");return null;}}}return o;};c.prototype.applyVariant=function(v,C){var m=this;m._oCurrentVariant=v;if(m._oCurrentVariant==="STANDARD"){m._oCurrentVariant=null;}var d=m.getPage();if(d){if(v){if(v.content){if(m._filterVariantLoaded){var n=m.overrideBookmarkFilterValues(v);if(n){var t=this;window.putInQueue(function(){d.exec("BOOKMARK_ACTION.LOAD_BOOKMARK('"+btoa(n.newBookmarkContent)+"','"+n.msgContent+"')");t._filterVariantLoaded=false;});}}else{m._pendingApplyVariant=true;}}else{if(m._filterVariantLoaded){m._filterVariantLoaded=false;m.execApplyFilter();}else{m._pendingApplyFilter=true;}}}}};c.prototype._createISODate=function(p){function a(n){if(n<10){return"0"+n;}return n;}if(p){return p.getUTCFullYear()+"-"+a(p.getUTCMonth()+1)+"-"+a(p.getUTCDate());}else{return null;}};c.prototype._checkConditionDateType=function(v){var m=this;var r=v;if(v&&v instanceof Date){r=m._createISODate(v);}return r;};c.prototype.execApplyFilter=function(){var m=this;if(m._pendingApplyVariant)return;var f=m.oState.oSmartFilterbar.getFilterData();var d={fields:{},msg:[]};var u=[];if(m.dimensionsExternalNameMap){for(var a in f){if(a=="_CUSTOM")continue;var b=f[a];var e="";if(m.dimensionsExternalNameMap[a]){e=m.dimensionsExternalNameMap[a]["name"];}if(e==""){jQuery.sap.log.error("Cannot map ODATA field name \""+a+"\" to any external names of BEx query fields");e=a;}var g=[];if(b.ranges&&b.ranges.length>0){var h="";for(var i=0;i<b.ranges.length;i++){var r=b.ranges[i];if(r.operation=="EQ"&&r.exclude!=true){h=r.value1;}else if(r.operation=="GE"&&r.exclude!=true){h={low:r.value1};}else if(r.operation=="LE"&&r.exclude!=true){h={high:r.value1};}else if(r.operation=="BT"&&r.exclude!=true){h={low:r.value1,high:r.value2};}else{u.push(r);continue;}if(h&&h instanceof Date){h=m._createISODate(h);}if(h.low&&h.low instanceof Date){h.low=m._createISODate(h.low);}if(h.high&&h.high instanceof Date){h.high=m._createISODate(h.high);}g.push(h);}}if(b.items&&b.items.length>0){var h="";for(var i=0;i<b.items.length;i++){var j=b.items[i];h=j.key;if(h&&h instanceof Date){h=m._createISODate(h);}g.push(h);}}if(b.value!=null){var h=b.value;if(h&&h instanceof Date){h=m._createISODate(h);}g.push(h);}if(g.length==1){d.fields[e]=g[0];}else if(g.length>1){d.fields[e]=g;}}if(u.length>0){d.msg.push(m._createUnsupportedConditionMsg(u));}var s=m._checkBasicSearchUsage();if(s){d.msg.push(s);}}if(m.getPage()){window.putInQueue(function(){m.getPage().exec("FILTER_ACTION.APPLY_FILTER('"+JSON.stringify(d)+"')");});}};c.prototype._getFilterLabelByKey=function(f){var m=this;var l=f;var a=m.oState.oSmartFilterbar.getFiltersWithValues();if(a){for(var i=0;i<a.length;i++){if(a[i].getName()===f){l=a[i].getLabel();break;}}}return l;};c.prototype._checkBasicSearchUsage=function(){var m=this;var r;if(m.oState.oSmartFilterbar.getBasicSearchControl()&&m.oState.oSmartFilterbar.getBasicSearchControl().getValue()!=""){r=m.rb.getText("CROSSTAB_UNSUPPORTED_SEARCH",m.oState.oSmartFilterbar.getBasicSearchControl().getValue());}return r;};c.prototype._createUnsupportedConditionMsg=function(a){var m=this;var r="";if(a&&a.length>0){r+=(m.rb.getText("CROSSTAB_UNSUPPORTED_FILTER_CONDITION")+"  ");r+=(m.rb.getText("CROSSTAB_UNSUPPORTED_FILTER_CONDITION2")+"\\n\\n");for(var i=0;i<a.length;i++){var b=a[i];var d=m._getFilterLabelByKey(b.keyField)+" "+b.tokenText+" "+m.rb.getText("CROSSTAB_FILTER_CONDITION_NOT_APPLIED")+"\\n";r+=d;}}return r;};c.prototype.overrideBookmarkFilterValues=function(v){var m=this;var r="";var a="";try{if(v&&v.content){var b=m.getBookmarkContentAsJSON(v.content);var d=b.content;var s=[];var e=[];var f=m.oState.oSmartFilterbar.getFilterData();for(var g in f){if(g=="_CUSTOM")continue;var h="";if(m.dimensionsExternalNameMap&&m.dimensionsExternalNameMap[g]){h=m.dimensionsExternalNameMap[g]["keyField"];}if(h==""){h=g;jQuery.sap.log.error("Cannot map ODATA field name \""+g+"\" to any external names of BEx query fields");}var i={"SetOperand":{"Elements":[],"FieldName":h}};if(f.hasOwnProperty(g)){var j=m.convertFilter_ODATA_TO_INA(f[g]);if(j){i.SetOperand.Elements=j.inaModel;if(j.xconditionMsg)e.push(j.xconditionMsg);}}s.push(i);}if(m._oMeasureSelection&&m._oMeasureSelection.selection!=""){var i={"SetOperand":{"Elements":[],"FieldName":m._oMeasureSelection.key}};var k=[];for(var g in m._oMeasureSelection.selection){k.push({operation:"EQ",value1:g});}var l=m.convertFilter_ODATA_TO_INA({ranges:k});i.SetOperand.Elements=l;s.push(i);}if(!d.Filter){d.Filter={"Selection":{"Operator":{"SubSelections":{}}}};}if(d.Filter&&d.Filter.Selection&&d.Filter.Selection.Operator&&d.Filter.Selection.Operator.SubSelections){d.Filter.Selection.Operator.SubSelections=s;}r=m.getUpdatedBookmarkContentString(b.xml,d);var n=m._checkBasicSearchUsage();if(n){e.msg.push(n);}if(e.length>0){a=JSON.stringify({msg:e});}}return{newBookmarkContent:r,msgContent:a};}catch(o){return{newBookmarkContent:v.content};}};c.prototype.getBookmarkContentAsJSON=function(b,x){var a;if(!x){x=jQuery.sap.parseXML(b);}var i=x.getElementsByName("INA_MODEL");if(i&&i.length==1){var v=i[0].getElementsByTagName("value");if(v&&v.length==1){var b=v[0].innerHTML;var C="<![CDATA[";var d="]]>";var e=b.indexOf(C);if(e>=0){b=b.substring(C.length);var f=b.indexOf(d);if(f>=0){b=b.substring(0,b.length-d.length);a=JSON.parse(b);}}}}return{content:a,xml:x};};c.prototype.getUpdatedBookmarkContentString=function(x,b){var r="";if(x){var C="<![CDATA[";var a="]]>";var i=x.getElementsByName("INA_MODEL");if(i&&i.length==1){var v=i[0].getElementsByTagName("value");r=v[0].innerHTML=C+JSON.stringify(b)+a;r=jQuery.sap.serializeXML(x);}}return r;};c.prototype.removeBookmarkFilterValues=function(b){var m=this;var a=m.getBookmarkContentAsJSON(b);var d=a.content;if(d.Filter&&d.Filter.Selection&&d.Filter.Selection.Operator&&d.Filter.Selection.Operator.SubSelections){d.Filter.Selection.Operator.SubSelections=[];}if(d.FixedFilter&&d.FixedFilter.Selection&&d.FixedFilter.Selection.Operator&&d.FixedFilter.Selection.Operator.SubSelections){d.FixedFilter.Selection.Operator.SubSelections=[];}return m.getUpdatedBookmarkContentString(a.xml,d);};c.prototype.convertFilter_ODATA_TO_INA=function(f){var m=this;var i=[];var u=[];var x="";if(f&&f.ranges&&f.ranges.length>0){for(var r=0;r<f.ranges.length;r++){var a=f.ranges[r];var b={};if(a.operation=="GT"){b={"Comparison":">","Low":a.value1};}else if(a.operation=="GE"){b={"Comparison":">=","Low":a.value1};}else if(a.operation=="LT"){b={"Comparison":"<","Low":a.value1};}else if(a.operation=="LE"){b={"Comparison":"<=","Low":a.value1};}else if(a.operation=="BT"){b={"Comparison":"BETWEEN","High":a.value2,"Low":a.value1};}else if(a.operation=="EQ"){b={"Comparison":"=","Low":a.value1};}else{u.push(a);}if(a.exclude){u.push(a);b.isExcluding=true;}i.push(b);}}if(f&&f.items&&f.items.length>0){for(var r=0;r<f.items.length;r++){var d=f.items[r];var b={};b={"Comparison":"=","Low":d.key};i.push(b);}}if(f.value!=null){b={"Comparison":"=","Low":f.value};i.push(b);}if(u.length>0){x=m._createUnsupportedConditionMsg(u);}return{inaModel:i,xconditionMsg:x};};c.prototype.createDimensionsExternalNameMap=function(){var m=this;if(m.dimensionsExternalNameMap){var d=m.getPage().getDataSource(m.DATASOURCE_ID);if(d){for(var i=0;i<d.getDimensions().length;i++){var a=d.getDimensionByName((d.getDimensions()[i]).getName());m.dimensionsExternalNameMap[a.getExternalName()]={name:a.getName()};if(a.getKeyField()){m.dimensionsExternalNameMap[a.getExternalName()]["keyField"]=a.getKeyField().getName();}}}}};c.prototype.fetchVariant=function(){var m=this;var v={};var b="<bookmark>";var p=m.getPage();if(p){var d=p.getDataSources(m.DATASOURCE_ID);if(d){var _=d.m_native.DS_1;var a=_.getBookmarkContent();a=m.removeBookmarkFilterValues(a);b=(b+a);}var e=p.getApplicationPropertiesComponent();var f=e.getBookmarkContent();b=(b+f);b=(b+"</bookmark>");if(b){v.content=b;}}return v;};c.prototype.addCrosstabPersonalisationToToolbar=function(){var m=this;var b;if(!m._oDshPersonalisationButton){b=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("TABLE_PERSOBTN_TOOLTIP");m._oDshPersonalisationButton=new sap.m.OverflowToolbarButton(this.getId()+"-btnPersonalisation",{icon:"sap-icon://action-settings",text:b,tooltip:b,press:function(e){m.openP13nDialog();}});}};c.prototype.p13nHandleDialogOk=function(e){var m=this;var p=e.getParameter("payload");var d;if(p&&p.dimeasure&&p.dimeasure.dimMeasureItems){d=p.dimeasure.dimMeasureItems;}var f={row:[],column:[],measureSelection:{}};for(var i=0;d&&i<d.length;i++){var g=d[i];if(g.getVisible()){if(g.getRole()=="row"){f.row.push({key:g.getColumnKey(),index:g.getIndex()});}else if(g.getRole()=="column"){f.column.push({key:g.getColumnKey(),index:g.getIndex()});}}}function s(a,b){if(a.index>b.index){return 1;}else if(a.index<b.index){return-1;}else{return 0;}}f.row.sort(s);f.column.sort(s);if(p&&p.columns&&p.columns.tableItems){for(var i=0;i<p.columns.tableItems.length;i++){var h=p.columns.tableItems[i];if(h.visible){f.measureSelection[h.columnKey]=true;}}}if(m._oVariantManagement){m._oVariantManagement.currentVariantSetModified(true);}var j=m.getPage();if(j){m._oMeasureSelection.selection=f.measureSelection;window.putInQueue(function(){j.exec("DISPLAY_ACTION.CONFIG_DIM('"+JSON.stringify(f)+"')");});}m.dmDialog.detachOk(m.p13nHandleDialogOk,m);m.dmDialog.close();};c.prototype.p13nHandleDialogCancel=function(e){var m=this;m.dmDialog.detachCancel(m.p13nHandleDialogCancel,m);m.dmDialog.close();};c.prototype.openP13nDialog=function(){var m=this;var p=m.getPage();if(p){if(!m._oMeasureSelection){m._oMeasureSelection={key:"",selection:""};}var a="";var d=p.getDataSource(m.DATASOURCE_ID);if(d){var b={collection:[],selectedCollection:[],measures:[],selectedMeasures:[]};for(var i=0;i<d.getDimensions().length;i++){var e=d.getDimensions()[i];b.collection.push({text:e.getText(),path:e.getName(),type:e.isMeasuresDimension?"Measure":"Dimension"});if(e.isMeasuresDimension){a=e.dimension.getKeyField().getName();m._oMeasureSelection.key=a;var k=e.dimension.getAllDimensionMembers();if(k){var f=k.getIterator();var g=0;while(f.hasNext()){var h=f.next();b.measures.push({columnKey:h.getName(),text:h.getText(),visible:true,index:g});g++;}}}}jQuery.sap.require("sap.suite.ui.generic.template.AnalyticalListPage.control.P13nDimMeasurePanelExt");jQuery.sap.require("sap.m.P13nItem");jQuery.sap.require("sap.m.P13nDimMeasureItem");jQuery.sap.require("sap.m.P13nDialog");var l=new sap.suite.ui.generic.template.AnalyticalListPage.control.P13nDimMeasurePanelExt();l.setTitle(m.rb.getText("CROSSTAB_SETTING_CONFIG_DIM"));var n=new sap.m.P13nItem({columnKey:"{path}",text:"{text}",aggregationRole:"{type}"});var o=m.getBookmarkContentAsJSON(d.getBookmarkContent());var q=o.content;if(q.Dimensions){for(var i=0;i<q.Dimensions.length;i++){var e=q.Dimensions[i];var r="none";if(e.Axis=="None"){continue;}else if(e.Axis=="Columns"){r="column";}else if(e.Axis=="Rows"){r="row";}b.selectedCollection.push({columnKey:e.Name,visible:true,index:i,role:r});}}if(q.Filter&&q.Filter.Selection&&q.Filter.Selection.Operator&&q.Filter.Selection.Operator.SubSelections){var s=false;for(var i=0;i<q.Filter.Selection.Operator.SubSelections.length;i++){var t=q.Filter.Selection.Operator.SubSelections[i];if(t.SetOperand&&t.SetOperand.FieldName==a){s=true;for(var j=0;j<t.SetOperand.Elements.length;j++){var h=t.SetOperand.Elements[j];if(h.Comparison=="="){b.selectedMeasures.push({columnKey:h.Low,visible:true});}}break;}}if(!s){b.selectedMeasures=b.measures;}}else{b.selectedMeasures=b.measures;}var u=new sap.m.P13nDimMeasureItem({columnKey:"{columnKey}",visible:"{visible}",role:"{role}",index:"{index}"});var v=new sap.ui.model.json.JSONModel(b);l.bindItems({path:"/collection",template:n});l.bindDimMeasureItems({path:"/selectedCollection",template:u});l.setModel(v);m.dmDialog=new sap.m.P13nDialog({stretch:sap.ui.Device.system.phone});m.dmDialog.attachOk(m.p13nHandleDialogOk,m);m.dmDialog.attachCancel(m.p13nHandleDialogCancel,m);m.dmDialog.addPanel(l);m.dmDialog.setTitle("Define Crosstab Dimensions");var w=new sap.m.P13nColumnsPanel();w.setTitle(m.rb.getText("CROSSTAB_SETTING_SEL_MEASURE"));var n=new sap.m.P13nItem({columnKey:"{columnKey}",text:"{text}"});var x=new sap.m.P13nColumnsItem({columnKey:"{columnKey}",text:"{text}",visible:"{visible}",index:"{index}"});w.bindItems({path:"/measures",template:n});w.bindColumnsItems({path:"/selectedMeasures",template:x});m.dmDialog.addPanel(w);w.setModel(v);}m.dmDialog.toggleStyleClass("sapUiSizeCompact",!!jQuery(m.oState.oSmartTable.getTable().getDomRef()).closest(".sapUiSizeCompact").length);m.dmDialog.open();}};c.prototype.getPage=function(){var m=this;if(!m.page){m.page=window[m.getId()+"Buddha"];}return m.page;};c.prototype.createPage=function(){var m=this;if(m._scriptReady){m.doIt();m.addResizeHandler();m.createDimensionsExternalNameMap();if(m._oCurrentVariant==="STANDARD"||(m._oCurrentVariant&&!m._oCurrentVariant.content)){if(m.oState.oSmartFilterbar){setTimeout(function(){m.execApplyFilter();},1000);}}else{setTimeout(function(){m.applyVariant(m._oCurrentVariant);},1000);}}else{m._pendingCreatePage=true;}};c.prototype.addResizeHandler=function(){var m=this;if(m._dshResizeHandlerId){sap.ui.core.ResizeHandler.deregister(m._dshResizeHandlerId);}m._dshResizeHandlerId=sap.ui.core.ResizeHandler.register(m.oState.oContentContainer.getDomRef(),function(){m.updateDshContainerHeight();m.refreshCrosstab();});};c.prototype.updateDshContainerHeight=function(){var m=this;jQuery(m.getDomRef()).css("height",m.calculateDshContainerHeight());};c.prototype.calculateDshContainerHeight=function(){var m=this;var d=jQuery(m.oState.oContentContainer.getDomRef()).height()-jQuery(m.oState.alr_dshToolbar.getDomRef()).outerHeight(true);return d;};c.prototype.getNavPanelControl=function(){var m=this;var n=m.getPage().getComponentsByType("NAVIGATIONPANEL_COMPONENT");if(n&&n.m_list&&n.m_list.length==1){n=n.m_list[0];}var a=m.getId()+n.getId();if(n.getPostfixId()){a+=n.getPostfixId();}var b=sap.ui.getCore().byId(a);return b;};c.prototype.getCrosstabControl=function(){var m=this;var a=m.getPage().getComponentsByType("CROSSTAB_COMPONENT");if(a&&a.m_list&&a.m_list.length==1){a=a.m_list[0];}var b=m.getId()+a.getId();var d=sap.ui.getCore().byId(b);return d;};c.prototype.refreshCrosstab=function(b,u){var m=this;if(m.getPage()){var a=m.getCrosstabControl();var n=m.getNavPanelControl();if(a){if(b){if(u){m.updateDshContainerHeight();}var d=a.getRenderEngine().getMeasuringHelper();d.orig_hasCrosstabSizeChanged=d.hasCrosstabSizeChanged;d.hasCrosstabSizeChanged=function(){return true;};var h=function(){d.hasCrosstabSizeChanged=d.orig_hasCrosstabSizeChanged;a.getRenderEngine().removeAfterFinishRenderingHandler(h);};a.getRenderEngine().addAfterFinishRenderingHandler(h);}a.invalidate();a.doRendering();}if(n){n.invalidate();}}};c.prototype.logoff=function(){var m=this;if(m.getPage()){sap.zen.dsh.Dsh.prototype.logoff.apply(m);}};return c;},true);
