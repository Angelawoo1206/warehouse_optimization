sap.ui.define(["sap/ui/comp/odata/MetadataAnalyser"],function(M){"use strict";var V=function(f){this._filter=f;this._oMetadataAnalyser=new M(f.getModel());this._groupList=[];this._groupListByName={};this._groupMap={};this._measureList=[];this._measureMap={};this._dimensionMap={};this._selectionFieldsLength=0;this._selectionFieldsParsed=0;this._annotationData={Filters:[]};this._recordTypeInParameter='com.sap.vocabularies.Common.v1.ValueListParameterIn';this._recordTypeOutParameter='com.sap.vocabularies.Common.v1.ValueListParameterOut';this._recordTypeInOutParameter='com.sap.vocabularies.Common.v1.ValueListParameterInOut';this._allSelectionFields;this._initMetadata();};V.prototype._initMetadata=function(){var e=this._filter.getEntitySet();var a=this._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(e);this._getFieldAnnotations(e,a);this._getVisualFilterAnnotation(a);};V.prototype.getVisualFilterConfig=function(){return this._filterConfig;};V.prototype._getFieldAnnotations=function(e,a){if(!e)return;var b=this._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(e);if(!b)return;var m=this._filter.getModel();var c=m.getMetaModel();if(!a||!c)return;var g={};var d={};var f=this._oMetadataAnalyser.getFieldGroupAnnotation(b);for(var i=0;i<f.length;i++){var h=f[i];var k={name:h.groupName,label:h.groupLabel,fieldList:h.fields};d[k.name]=k;for(var j=0;j<h.fields.length;j++)g[h.fields[j]]=k;}var l=c.getODataEntityType(a);var s=l["com.sap.vocabularies.UI.v1.SelectionFields"];var n={};if(s){for(var i=0;i<s.length;i++){var o=s[i];n[o.PropertyPath]=o;}}var p=[];var u={};var q=this._oMetadataAnalyser.getFieldsByEntityTypeName(b);for(var i=0;i<q.length;i++){var r=q[i];var t=r.name;var v=c.getODataProperty(l,t);var w=v["sap:aggregation-role"];if(w=="dimension"){var x={name:t,fieldInfo:r,propInfo:v};var k=g[t];if(k){for(var j=0;j<k.fieldList.length;j++){if(k.fieldList[j]==t){k.fieldList[j]=x;break;}}}else{var y=n[t]?"_BASIC":(l['sap:label']||l.name);var k=d[y];if(!k){k={name:y,label:y=="_BASIC"?this._filter.getModel("i18n").getResourceBundle().getText("VIS_FILTER_GRP_BASIC_TITLE"):y,fieldList:[]};d[y]=k;}k.fieldList.push(x);g[t]=k;}u[k.name]=true;}else if(w=="measure"){var z={name:t,label:r.fieldLabel,fieldInfo:r,propInfo:v};p.push(z);}}var A=[];if(u["_BASIC"]){A.push(d["_BASIC"]);delete d["_BASIC"];}for(var i=0;i<f.length;i++){var y=f[i].groupName;if(y=="_BASIC")continue;if(u[y])A.push(d[y]);delete d[y];}for(var y in d){if(u[y])A.push(d[y]);delete d[y];}d={};for(var i=0;i<A.length;i++){var k=A[i];d[k.name]=k;}this._measureList=p;};V.prototype.getGroupList=function(){return this._groupList?this._groupList:[];};V.prototype.getGroupMap=function(){return this._groupMap?this._groupMap:{};};V.prototype.getMeasureList=function(){return this._measureList;};V.prototype.getMeasureMap=function(){return this._measureMap;};V.prototype.getDimensionMap=function(){return this._dimensionMap;};V.prototype.getEntityType=function(e){return this._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(e);};V.prototype._updateGroupList=function(e,a,p,d){var i=function(f){return f.PropertyPath===p;};var b=this._allSelectionFields.filter(i);b=(b.length>0)?true:false;var m=this._filter.getModel().getMetaModel();var c=m.getODataEntityType(e);c=c['sap:label']?c['sap:label']:c.name;var u=function(g,f){for(var k in f._groupList){var h=f._groupList[k],j=false;if(h.name===g){var l=h.fieldList;for(var n in l){if(l[n].name===d){j=true;}else{continue;}}if(!j){var o=m.getODataEntityType(a);var q=f._oMetadataAnalyser.getFieldsByEntityTypeName(a);for(var k in q){if(q[k].name===d){var r=m.getODataProperty(o,q[k].name);l.push({name:q[k].name,fieldInfo:q[k],propInfo:r});}}}}else{continue;}}};if(b){u('_BASIC',this);}else{u(c,this);}};V.prototype._createDimensionMap=function(e,a){var b,m=this._filter.getModel(),c=m.getMetaModel(),d,f={},p,g,h,i={};if(!c)return false;d=c.getODataEntityType(a);b=this._oMetadataAnalyser.getFieldsByEntityTypeName(a);for(var k in b){p=c.getODataProperty(d,b[k].name);if(b[k]['aggregationRole']==='dimension'){g={name:b[k].name,fieldInfo:b[k],propInfo:p};f[b[k].name]=g;}else if(b[k]['aggregationRole']==='measure'){h={name:b[k].name,label:b[k].fieldLabel,fieldInfo:b[k],propInfo:p};i[b[k].name]=h;}}if(Object.keys(f).length>0){this._dimensionMap[e]=f;}if(Object.keys(i).length>0){this._measureMap[e]=i;}};V.prototype._createGroupList=function(f,p,i,e){var g;if(i){g=this._filter.getModel("i18n").getResourceBundle().getText("VIS_FILTER_GRP_BASIC_TITLE");this._addToGroupListByName('_BASIC',g,f,p);}else{g=e;this._addToGroupListByName(e,g,f,p);}};V.prototype._addToGroupListByName=function(g,a,f,p){if(this._groupListByName[g]===undefined){this._groupListByName[g]=[];this._groupListByName[g].push({name:g,label:a,fieldList:[]});this._groupListByName[g][0].fieldList.push({name:f.name,fieldInfo:f,propInfo:p});}else{this._groupListByName[g][0].fieldList.push({name:f.name,fieldInfo:f,propInfo:p});}};V.prototype._setGroupListForDialog=function(e){if(this._groupListByName['_BASIC']!==undefined){this._groupList.push(this._groupListByName['_BASIC'][0]);delete this._groupListByName['_BASIC'];}if(Object.keys(this._groupListByName).length>0){var p=[];for(var k in this._groupListByName){if(k!=e){this._groupList.push(this._groupListByName[k][0]);}else{p.push(k);}}p.forEach(function(v){this._groupList.push(this._groupListByName[v][0]);}.bind(this));}var g={};for(var i=0;i<this._groupList.length;i++){var a=this._groupList[i];g[a.name]=a;}this._groupMap=g;};V.prototype._getFieldGroupForProperty=function(e,c){var f;for(var o in e){f=null;if(o.indexOf("com.sap.vocabularies.UI.v1.FieldGroup")>-1){f=o.split("#");if(f.length===2){f=f[1];}var E=e[o];if(E.Data){for(var a in E.Data){var s=E.Data[a].Value.Path;if(s===c){if(f==='_BASIC'){return f;}return((e[o].Label&&e[o].Label.String)?e[o].Label.String:"");}}}}}return;};V.prototype._getScaleFactor=function(e,a){if(a.indexOf("com.sap.vocabularies.UI.v1.DataPoint")>-1){a=a.toString();if(a.charAt(0)==="@"){a=a.slice(1);}var E=e[a];return E.ValueFormat.ScaleFactor.Decimal;}};V.prototype._getVisualFilterAnnotation=function(e){var m=this._filter.getModel();var a=m.getMetaModel();if(!e||!a)return null;var b=a.getODataEntityType(e);if(!b)return null;var c=this._oMetadataAnalyser.getFieldsByEntityTypeName(e),i,f,v,d,g,p,h,j,k;this._allSelectionFields=b["com.sap.vocabularies.UI.v1.SelectionFields"];var E=b['com.sap.vocabularies.Common.v1.Label']?b['com.sap.vocabularies.Common.v1.Label'].String:b.name;var l=function(q){return q.PropertyPath===d;};for(var n in c){v=c[n]["com.sap.vocabularies.Common.v1.ValueList"];if((c[n]["filterRestriction"]!=="interval")&&(c[n]['sap:filterable']===undefined||c[n]['sap:filterable']==="true")){for(var o in c[n]){if(o.indexOf("com.sap.vocabularies.Common.v1.ValueList")>-1){v=c[n][o];p=v.PresentationVariantQualifier;if(d!==c[n].name&&v&&p){d=c[n].name;i=this._allSelectionFields.filter(l);g=(c[n]['sap:required-in-filter']&&c[n]['sap:required-in-filter']==="true");f=this._getFieldGroupForProperty(b,d);i=((i.length>0)||g||(f==='_BASIC'));h=a.getODataProperty(b,c[n].name);if(c[n]["filterRestriction"]){k=c[n]["filterRestriction"];}else{k=undefined;}if(f){j=f;}else{j=E;}this._createGroupList(c[n],h,i,j);this._getAnnotationFromValueList(e,i,v,d,k);}}}}}this._setGroupListForDialog(E);this._filterConfig=this._getConfig(this._annotationData);};V.prototype._getAnnotationFromValueList=function(e,i,v,p,f,a){var P=e;if(v!==undefined){var b={Filters:[]},c=(v&&v.PresentationVariantQualifier)?v.PresentationVariantQualifier:undefined,d=(c&&c.String)?c.String:undefined,g=(v&&v.CollectionPath)?v.CollectionPath:undefined,h=(v&&v.Parameters)?v.Parameters:undefined,j=(g&&g.String)?g.String:undefined,P=this.getEntityType(j);if(d){var q=d,k=this._oMetadataAnalyser.getPresentationVariantAnnotation(P,q),l={};if(k!==undefined){this._createDimensionMap(g.String,P);var m=k.chartAnnotation.annotation.Dimensions[0].PropertyPath;this._updateGroupList(e,P,p,m);l=this._createConsumeableObjectFromAnnotation(k,g,i,h,p,f,a);b.Filters.push(l);this._annotationData.Filters.push(l);}}}};V.prototype._getDescendingFromSortOrder=function(s,S){var b;s.filter(function(e,i,a){if(e.Property.PropertyPath==S){b=!(e.Descending.Bool==="false");}});return b;};V.prototype._fieldExist=function(e,f){var a=this._oMetadataAnalyser.getFieldsByEntityTypeName(e);for(var i=0;i<a.length;i++){if(a[i].name===f){return true;}}return false;};V.prototype._createSortObject=function(p){var s,S={};if(p.chartAnnotation.chartType==="com.sap.vocabularies.UI.v1.ChartType/Line"){s=p.chartAnnotation.annotation.Dimensions[0].PropertyPath;}else{s=p.chartAnnotation.annotation.Measures[0].PropertyPath;}S.Field={"String":s};S.Descending={"Boolean":true};return S;};V.prototype._createSortOrderFromAnnotation=function(p,e){var a={};a.SortOrder=[];var s=p.annotation.SortOrder;if(s!==undefined&&s.length>0){for(var i=0;i<s.length;i++){var S=s[i].Property.PropertyPath;if(S){var o={};if(this._fieldExist(e,S)){o.Field={"String":S};o.Descending={"Boolean":this._getDescendingFromSortOrder(s,S)};}else{o=this._createSortObject(p);}a.SortOrder.push(o);}}}else{a.SortOrder.push(this._createSortObject(p));}return a;};V.prototype._createConsumeableObjectFromAnnotation=function(p,c,i,a,b,f,e){var d={};var s=p.sortOrderFields;d=this._createSortOrderFromAnnotation(p,this.getEntityType(c.String));var g=p.chartAnnotation.annotation.ChartType.EnumMember.split("/");var h=g[g.length-1];if(h){d.Type={"String":h};}var D=p.chartAnnotation.annotation.DataPoint;if(D){var j=D[0].AnnotationPath;var k=this._getScaleFactor(e,j);d.scaleFactor={"String":k};}else{d.scaleFactor={"String":undefined};}if(f){d.filterRestriction={"String":f};}else{d.filterRestriction={"String":undefined};}var l=p.chartAnnotation.annotation.Dimensions[0].PropertyPath;if(l){d.Dimensions=[];var m={};m.Field={"String":l};s.filter(function(B,C,E){if(B.name==l){m.Descending={"Boolean":B.descending};}});d.Dimensions.push(m);}var n=p.chartAnnotation.annotation.Measures[0].PropertyPath;if(n){d.Measures=[];var o={};o.Field={"String":n};var q=(p.annotation.SortOrder&&p.annotation.SortOrder.length>0)?p.annotation.SortOrder[0]:undefined;if(q){q=((q.Descending)&&(q.Descending.Boolean))?q.Descending.Boolean:undefined;}if(q){o.Descending={"Boolean":q};}else{o.Descending={"Boolean":"true"};}d.Measures.push(o);}if(i){d.Selected={"Boolean":"true"};}else{d.Selected={"Boolean":"false"};}if(c){d.CollectionPath=c;}if(a&&a.length>0){d.InParameters=[];for(var r in a){var t=a[r]?a[r]:undefined,u=(t&&t.RecordType)?t.RecordType:undefined,v=(t.ValueListProperty&&t.ValueListProperty.String)?t.ValueListProperty.String:undefined,w=(t.LocalDataProperty&&t.LocalDataProperty.PropertyPath)?t.LocalDataProperty.PropertyPath:undefined;if(t&&u&&v&&w){if(d.OutParameter===undefined&&(u===this._recordTypeOutParameter||u===this._recordTypeInOutParameter)&&v===l&&w===b){d.OutParameter=w;}if(u===this._recordTypeInParameter||u===this._recordTypeInOutParameter){var x=this._filter.getModel().getMetaModel(),y=this.getEntityType(c.String),z=x.getODataEntityType(y),A=x.getODataProperty(z,v);if(A['sap:filterable']===undefined||A['sap:filterable']=="true"){d.InParameters.push({localDataProperty:w,valueListProperty:v});}else{jQuery.sap.log.error('IN Parameter valueListProperty: '+v+' is not sap:filterable');}}}}if(d.InParameters.length===0){d.InParameters=undefined;}}if(b){d.ParentProperty=b;}return d;};V.prototype._getConfig=function(a){var c={filterList:[]};if(!a)return c;var f={};var b={};var d=a.Filters;for(var i=0;i<d.length;i++){var e=d[i];var p=e.ParentProperty;var g=e.Dimensions[0].Field.String;var h=e.CollectionPath.String;var l=this._dimensionMap[h][g];if(!l){jQuery.sap.log.error("Unknown Dimension :"+g);continue;}var m=e.Measures[0].Field.String;var n=this._measureMap[h][m];if(!n){jQuery.sap.log.error("Unknown Measure :"+m);continue;}var o=l.fieldInfo.description;if(!o)o=g;if(!f[g])f[g]=[];if(!b[p])b[p]=[];var q={type:e.Type.String,selected:e.Selected.Boolean=="true",dimension:{field:g,fieldDisplay:o},measure:{field:e.Measures[0].Field.String,descending:e.Measures[0].Descending.Boolean=="true"},sortOrder:e.SortOrder,scaleFactor:e.scaleFactor.String};q.collectionPath=e.CollectionPath.String;q.outParameter=e.OutParameter;q.inParameters=e.InParameters;q.parentProperty=e.ParentProperty;q.filterRestriction=e.filterRestriction.String;b[p].push(q);f[g].push(q);}var u={};for(var i=0;i<this._groupList.length;i++){var r=this._groupList[i];for(var j=0;j<r.fieldList.length;j++){var s=r.fieldList[j];var d=b[s.name];if(!d)continue;u[r.name]=true;for(var k=0;k<d.length;k++)c.filterList.push(d[k]);}}for(var i=this._groupList.length-1;i>=0;i--){var r=this._groupList[i];if(u[r.name])continue;this._groupList.splice(i,1);delete this._groupMap[r.name];}return c;};return V;},true);
