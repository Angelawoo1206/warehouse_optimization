sap.ui.define(["sap/ui/core/Control","sap/m/Label","sap/m/NumericContent","sap/ui/model/json/JSONModel","sap/suite/ui/generic/template/AnalyticalListPage/controller/KpiTagController","sap/suite/ui/generic/template/AnalyticalListPage/util/KpiUtil"],function(C,L,N,J,K,a){"use strict";var c={toleranceLow:null,toleranceHigh:null,deviationLow:null,deviationHigh:null,_value:null,state:sap.m.ValueColor.Neutral,setVals:function(t,T,d,D,v){this.toleranceLow=t;this.toleranceHigh=T;this.deviationLow=d;this.deviationHigh=D;this._value=v;this.state=sap.m.ValueColor.Neutral;},Maximize:function(){if(this.toleranceLow||this.deviationLow){if(this._value>=this.toleranceLow){this.state=sap.m.ValueColor.Good;}else if(this._value<this.deviationLow){this.state=sap.m.ValueColor.Error;}else{this.state=sap.m.ValueColor.Critical;}}return this.state;},Maximizing:function(){this.Maximize();},Minimize:function(){if(this.toleranceHigh||this.deviationHigh){if(this._value<=this.toleranceHigh){this.state=sap.m.ValueColor.Good;}else if(this._value>this.deviationHigh){this.state=sap.m.ValueColor.Error;}else{this.state=sap.m.ValueColor.Critical;}}return this.state;},Minimizing:function(){this.Minimize();},Target:function(){if(this.toleranceLow&&this.toleranceHigh){if(this._value>=this.toleranceLow&&this._value<=this.toleranceHigh){this.state=sap.m.ValueColor.Good;}else if(this._value<this.deviationLow||this._value>this.deviationHigh){this.state=sap.m.ValueColor.Error;}else{this.state=sap.m.ValueColor.Critical;}}return this.state;}};var o={Critical:sap.m.ValueColor.Critical,Negative:sap.m.ValueColor.Error,Positive:sap.m.ValueColor.Good};return C.extend("sap.suite.ui.generic.template.AnalyticalListPage.control.KpiTag",{metadata:{properties:{value:{type:"string",defaultValue:"",bindable:true},name:{type:"string",defaultValue:"",bindable:true},scale:{type:"string",defaultValue:undefined,bindable:true},indicator:{type:"sap.m.ValueColor",defaultValue:"Neutral"},entitySet:{type:"string",defaultValue:"",bindable:false},qualifier:{type:"string",defaultValue:"",bindable:false},modelName:{type:"string",defaultValue:undefined,bindable:false}},aggregations:{_name:{type:"sap.m.Label",multiple:false,visibility:"visible"},_value:{type:"sap.m.Label",multiple:false,visibility:"visible"},_content:{type:"sap.m.NumericContent",multiple:false,visibility:"visible"}},events:{press:{}}},_firstTime:true,_dataModel:undefined,_controller:undefined,_isRelative:false,_isPercent:false,_sUnitofMeasure:"",_relativeToProperties:[],_getDataModel:function(){if(!this._dataModel){this._dataModel=new J();}return this._dataModel;},_getController:function(){if(!this._controller){this._controller=new K();}return this._controller;},onBeforeRendering:function(){if(this._firstTime){this.setBusy(true);this._firstTime=false;var m=this.getModel(this.getModelName());m.getMetaModel().loaded().then(function(){var M=m.getMetaModel();var e=M.getODataEntitySet(this.getEntitySet());var E=M.getODataEntityType(e.entityType);var s="com.sap.vocabularies.UI.v1.SelectionPresentationVariant#"+this.getQualifier();var S=E[s];if(!S){return;}var b=S.SelectionVariant&&(S.SelectionVariant.AnnotationPath||S.SelectionVariant.Path);if(!b){return;}if(/^@/.test(b)){b=b.slice(1);}var d=E[b];var f=[];var g=d&&d.SelectOptions;var h,p,r;if(g){for(var i=0;i<g.length;i++){h=g[i];p=h.PropertyName.PropertyPath;for(var j=0;j<h[p].length;j++){r=h[p][j];if(r.Sign.EnumMember==="com.sap.vocabularies.UI.v1.SelectionRangeSignType/I"){var F={path:p,operator:r.Option.EnumMember.split("/")[1],value1:r.Low.String,value2:r.High?r.High.String:""};f.push(new sap.ui.model.Filter(F));}}}}var P=S.PresentationVariant&&(S.PresentationVariant.AnnotationPath||S.PresentationVariant.Path);if(!P){return;}if(/^@/.test(P)){P=P.slice(1);}var k="com.sap.vocabularies.UI.v1.DataPoint#"+this.getQualifier();var D=E[k];this.dataPointAnnotation=D;var l=M.getODataProperty(E,D.Value.Path);this._checkForPercent(m,l);this._getCriticalityRefProperties(D);this.setModel(this._getDataModel());if(D.Value){if(D.Value.Path){this.bindValue("/0/"+D.Value.Path);}else{this.setProperty("value",D.Value.String);}}m.read("/"+this.getEntitySet(),{async:false,urlParameters:{"$select":[D.Value.Path].concat(this._relativeToProperties).join(","),"$top":1},success:function(n,q){this._getDataModel().setData(n.results);this._calculateKPICriticality(this.dataPointAnnotation);this._setNameInformation(this.dataPointAnnotation);this._setScaleInformation(this.dataPointAnnotation);this.setBusy(false);}.bind(this),error:function(n){jQuery.sap.log.error("Error reading URL:"+n);}});}.bind(this));}},init:function(){if(C.prototype.init){C.prototype.init.call(this);}},_onMouseClick:function(e){K.openKpiCard(e);},_checkForPercent:function(m,e){this._sUnitofMeasure=a.getUnitofMeasure(m,e);if(this._sUnitofMeasure=="%")this._isPercent=true;},_checkIfRelative:function(d){var t=d.TrendCalculation;this._isRelative=a.isRelative(d);if(this._isRelative){if(t.ReferenceValue.Path){this._relativeToProperties.push(t.ReferenceValue.Path);}}},_setNameInformation:function(d){var t=d.Title;var n=a.getPathOrPrimitiveValue(this._getDataModel(),t);if(n===undefined){n="";}this.setProperty("name",this._getNameFromHeuristic(n),false);this.setTooltip(n);},_setScaleInformation:function(d){if(d.ValueFormat){if(d.ValueFormat.ScaleFactor){this.setProperty("scale",a.getPathOrPrimitiveValue(this._getDataModel(),d.ValueFormat.ScaleFactor));}}},_getCriticalityRefProperties:function(d){var b=d.CriticalityCalculation;var e=d.Criticality;if(b.DeviationRangeLowValue&&b.DeviationRangeLowValue.Path){this._relativeToProperties.push(b.DeviationRangeLowValue.Path);}if(b.DeviationRangeHighValue&&b.DeviationRangeHighValue.Path){this._relativeToProperties.push(b.DeviationRangeHighValue.Path);}if(b.ToleranceRangeLowValue&&b.ToleranceRangeLowValue.Path){this._relativeToProperties.push(b.ToleranceRangeLowValue.Path);}if(b.ToleranceRangeHighValue&&b.ToleranceRangeHighValue.Path){this._relativeToProperties.push(b.ToleranceRangeHighValue.Path);}if(e&&e.Path){this._relativeToProperties.push(e.Path);}},_getTitleRefProperty:function(d){var t=d.Title;if(t&&t.Path){this._relativeToProperties.push(t.Path);}},_getNameFromHeuristic:function(s){var p=s.split(/\s/);return p.length===1?this._getNameFromSingleWordHeuristic(s):this._getNameFromMultiWordHeuristic(p);},_getNameFromSingleWordHeuristic:function(w){return w.substr(0,3).toUpperCase();},_getNameFromMultiWordHeuristic:function(w){var p=[];p.push(w[0].charAt(0));p.push(w[1].charAt(0));if(w.length>=3){p.push(w[2].charAt(0));}return p.join("").toUpperCase();},_calculateKPICriticality:function(d){var i=d.CriticalityCalculation&&d.CriticalityCalculation.ImprovementDirection?a.getPathOrPrimitiveValue(this._getDataModel(),d.CriticalityCalculation.ImprovementDirection):undefined;var b=d.Criticality?a.getPathOrPrimitiveValue(this._getDataModel(),d.Criticality):undefined;var s=sap.m.ValueColor.Neutral;if(b){s=o[b];if(!s){s=sap.m.ValueColor.Neutral;}this.setIndicator(s);return;}var e=d.CriticalityCalculation.DeviationRangeLowValue?a.getPathOrPrimitiveValue(this._getDataModel(),d.CriticalityCalculation.DeviationRangeLowValue):undefined;var f=d.CriticalityCalculation.DeviationRangeHighValue?a.getPathOrPrimitiveValue(this._getDataModel(),d.CriticalityCalculation.DeviationRangeHighValue):undefined;var t=d.CriticalityCalculation.ToleranceRangeLowValue?a.getPathOrPrimitiveValue(this._getDataModel(),d.CriticalityCalculation.ToleranceRangeLowValue):undefined;var g=d.CriticalityCalculation.ToleranceRangeHighValue?a.getPathOrPrimitiveValue(this._getDataModel(),d.CriticalityCalculation.ToleranceRangeHighValue):undefined;var v=Number(this.getValue());c.setVals(t,g,e,f,v);this.setIndicator(c[i]());},renderer:function(r,b){r.write("<div");r.writeControlData(b);r.addClass("alrKpiTag sapUiSmallMarginEnd");b._addColorClasses(r);r.writeClasses();r.writeAttributeEscaped("title",b.getTooltip());r.write(">");r.write("<div");r.addClass("alrKpiTagName");r.writeClasses();r.write(">");r.writeEscaped(b.getName());r.write("</div>");r.write("<div");r.addClass("alrKpiTagValue");r.writeClasses();r.write(">");r.writeEscaped(b._isPercent?a.formatNumberForPresentation(b.getValue(),true,1,b.getProperty("scale"))+b._sUnitofMeasure:a.formatNumberForPresentation(b.getValue(),true,0,b.getProperty("scale")));r.write("</div>");r.write("</div>");},_addColorClasses:function(r){switch(this.getIndicator()){case sap.m.ValueColor.Neutral:r.addClass("alrKPINeutral");break;case sap.m.ValueColor.Error:r.addClass("alrKPINegative");break;case sap.m.ValueColor.Good:r.addClass("alrKPIPositive");break;case sap.m.ValueColor.Critical:r.addClass("alrKPICritical");break;default:break;}},onAfterRendering:function(){setTimeout(function(){this.$().off("click").on("click",this._onMouseClick);}.bind(this),1);},handleClick:function(e){this.fireEvent("press",{});},exit:function(){this._relativeToProperties=[];}});},true);
