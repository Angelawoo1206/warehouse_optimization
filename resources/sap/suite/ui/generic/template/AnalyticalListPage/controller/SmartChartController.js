sap.ui.define(["sap/m/OverflowToolbar","sap/m/ToolbarSpacer","sap/m/FlexItemData","sap/m/ToolbarDesign","sap/ui/core/mvc/Controller"],function(O,T,F,b,C){"use strict";var c=C.extend("sap.suite.ui.generic.template.AnalyticalListPage.controller.SmartChartController",{setState:function(s){this.triggeredByTableSort=false;this.tableSortSelection;this.allowMultiSelect=true;this._selectFilterByMeasure=false;this.oState=s;s.oSmartChart.attachInitialise(this._onSmartChartInit,this);s.oSmartChart.attachBeforeRebindChart(this._onBeforeRebindChart,this);this.oState.detailController.attachAutoHideToggle(this._onAutoHideToggle,this);this.oState.detailController.attachInitComplete(this._onDetailInitComplete,this);this.oState.detailController.attachTableChange(this._onTableChange,this);this.oState.attachSearchButtonPressed(this._onSearchButtonPressed,this);},_onBeforeRebindChart:function(E){if(this.triggeredByTableSort&&this.tableSortSelection){var v=this.oState.oSmartChart.fetchVariant();if(this.tableSortSelection.length>0){v.sort={};v.sort.sortItems=[];for(var i=0;i<(this.tableSortSelection.length);i++){E.mParameters.bindingParams.sorter.push(this.tableSortSelection[i]);v.sort.sortItems.push({columnKey:this.tableSortSelection[i].sPath,operation:this.tableSortSelection[i].bDescending?"Descending":"Ascending"});}}else{E.mParameters.bindingParams.sorter=this.tableSortSelection;if(v.sort){delete v.sort;}}this.oState.oSmartChart.applyVariant(v);this.triggeredByTableSort=false;}if(this.oState.oSmartFilterbar&&this.oState.oSmartFilterbar.getAnalyticBindingPath&&this.oState.oSmartFilterbar.getConsiderAnalyticalParameters()){try{var a=this.oState.oSmartFilterbar.getAnalyticBindingPath();if(a){this.oState.oSmartChart.setChartBindingPath(a);}}catch(e){jQuery.sap.log.warning("Mandatory parameters have no values","","AnalyticalListPage");}}this.oState.oController.onBeforeRebindChartExtension(E);},_onSmartChartInit:function(){var s=this.oState;this.oChart=s.oSmartChart.getChart();this.oChart.attachSelectData(this._onChartSelectData,this);this.oChart.attachDeselectData(this._onChartDeselectData,this);var a=this.allowMultiSelect?sap.chart.SelectionMode.Multi:sap.chart.SelectionMode.Single;s.oSmartChart.setSelectionMode(a);this.oChart.setSelectionMode(a);if(this.oState._pendingChartToolbarInit&&(this.oState._containerView=="chart"||this.oState._containerView=="charttable")){this.oState.oSmartChart.getToolbar().addContent(this.oState.alr_fullScreenButton);this.oState.oSmartChart.getToolbar().addContent(this.oState.alr_viewSwitchButton);}delete this.oState._pendingChartToolbarInit;this.oState.oSmartChart.getChart().setVizProperties({"valueAxis":{"title":{"visible":false}},"legendGroup":{"layout":{"position":"bottom"}}});if(this.oState.oSmartChart._oPersController)this.oState.oSmartChart._oPersController.attachAfterP13nModelDataChange(jQuery.proxy(this._onAfterP13nModelDataChange,this));jQuery.sap.log.info("Smart Chart Annotation initialized");},_onChartSelectData:function(e){var a=this.oState.oSmartChart.getChart();if(a._getVizFrame().vizSelection()){var s=a.getSelectedDataPoints().dataPoints;this._lastSelected=this._getLastSel(s,this._lastSelectedList);this._lastSelectedList=s;}this._updateTable("selection");},_getLastSel:function(n,o){var d=this.oState.oSmartChart.getChart();var e=this._getSelParamsFromDPList(n);var f=this._getSelParamsFromDPList(o);for(var i=0;i<e.length;i++){var g=e[i];var m=false;for(var j=0;j<f.length;j++){var h=f[j];m=true;for(var a in h){if(a.indexOf("__")!=-1)continue;if(g[a]!=h[a]){m=false;break;}}if(m)break;}if(!m){var k=d.getVisibleDimensions();var l={};for(var j=0;j<k.length;j++){var p=k[j];l[p]=g[p];}return l;}}return null;},_onChartDeselectData:function(e){var m=this;this._lastSelected=null;setTimeout(function(){var d=m.oState.oSmartChart.getChart();if(d.getSelectedDataPoints().count==0)m._updateTable("selection");else if(d.getSelectionMode()=="MULTIPLE")m._onChartSelectData(e);},1);var a=e.getParameter("oSource");if(a&&a instanceof sap.m.Link&&a.getParent()instanceof sap.m.Breadcrumbs)m._onChartDrilledUp(e);},_onChartDrilledUp:function(e){this._updateTable();},_onChartDrilledDown:function(e){this._updateTable();},_onAfterP13nModelDataChange:function(e){var a=(e.getParameter&&e.getParameter("changeData").sort&&e.getParameter("changeData").sort.sortItems.length===0)?true:false,s=e.getParameter&&e.getParameter("persistentData").sort&&e.getParameter("persistentData").sort.sortItems,d={allSortRemoved:a,sortList:s};this._updateTable(undefined,d);},_onSearchButtonPressed:function(){this._updateTable();},updateTable:function(){var v=this.oState.oSmartChart.fetchVariant(),s={};if(v.sort&&v.sort.sortItems){s.sortList=v.sort.sortItems;s.allSortRemoved=false;}else{s.sortList=undefined;s.allSortRemoved=true;}this._updateTable(undefined,s);},_updateTable:function(u,s){var a=this.oState.oSmartChart.getChart();if(!a){return;}var p=this._getSelParamsFromChart(a);var d=a.getVisibleDimensions();var g=a.getVisibleDimensions();var e=[];if(a._getVizFrame().vizSelection())e=a.getSelectedDataPoints().dataPoints;if(!e||e.length==0)this._lastSelected=null;this.oState.detailController.applyParamsToTable(p,this._lastSelected,d,g,s,u);},_getSelParamsFromChart:function(a){var d=[];if(a._getVizFrame().vizSelection())d=a.getSelectedDataPoints().dataPoints;return this._getSelParamsFromDPList(d);},_getSelParamsFromDPList:function(d){if(!d)return[];var p=[];for(var i=0;i<d.length;i++){var a=d[i];var e=a.context;if(!e)continue;var f=e.getProperty(e.sPath);var g={};if(this._selectFilterByMeasure){for(var j=0;j<a.measures.length;j++){var n=a.measures[j];var v=f[n];g[n]=v;}}else{for(var n in f)g[n]=f[n];}p.push(g);}return p;},_onAutoHideToggle:function(e){var t=this.oState.toolbarController;t.switchContainerView(this.oState._containerView);this._updateTable();},_onDetailInitComplete:function(e){this._updateTable();},_onTableChange:function(e){var g=e.getParameter("groupList"),s=e.getParameter("sortList"),a=e.getParameter("allTableSortRemoved"),d=this.oState.oSmartChart,f,h;if(g){var d=this.oState.oSmartChart;var f=d.getChart();var h=f.getVisibleDimensions();if(g.length!=h.length){f._getVizFrame().vizSelection([],{});this._lastSelected=null;}f.setVisibleDimensions(g);d._updateDrillBreadcrumbs();}if(s||a){this.triggeredByTableSort=true;this.tableSortSelection=(s&&s.length>0)?s:[];d.rebindChart();}}});return c;});
