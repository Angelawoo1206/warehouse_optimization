sap.ui.define(["sap/m/Button","sap/m/ButtonType","sap/m/Label","sap/m/Dialog","sap/m/Bar","sap/m/SearchField","sap/m/Toolbar","sap/m/ToolbarSpacer","sap/m/Title","sap/m/VBox","sap/m/HBox","sap/m/CheckBox","sap/m/Link","sap/m/List","sap/m/TextArea","sap/m/Text","sap/m/StandardListItem","sap/m/ListSeparators","sap/m/Popover","sap/ui/layout/form/SimpleForm","sap/ui/layout/GridData","sap/ui/core/mvc/Controller","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil"],function(B,a,L,D,b,S,T,c,d,V,H,C,e,f,g,h,j,l,P,m,G,n,F){"use strict";var o="_BASIC";var p,r,q,s;var t="100%";var u=0.33;var v=0.5;var w=n.extend("sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController",{init:function(i){this.oState=i;this.oRb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");},launchDialog:function(){var i=this;this.oConfig=this.oState.alr_visualFilterBar.getConfig();this._oGlobalFilter=jQuery.extend(true,{},this.oState.alr_visualFilterBar._globalFilters);this.filterCompList=[];this.filterChartList=[];this._buildFiltersFromConfig();this.oVFDialog=new sap.m.Dialog({title:this.oRb.getText("FILTER_BAR_ADV_FILTERS_DIALOG"),afterClose:function(){i.oVFDialog.destroy();}});this.oVFDialog.setModel(this.oState.oController.getView().getModel());this.oVFDialog.setModel(this.oState.oController.getView().getModel("i18n"),"i18n");this.oVFDialog.setVerticalScrolling(true);this._addDialogButtons();this.oVFDialog.addStyleClass("sapUiPopupWithPadding");this.oVFDialog.addStyleClass("sapUiSizeCompact");this.oVFDialog.addStyleClass("sapUiCompFilterBarDialog");var k=new b();var x=new S({placeholder:this.oRb.getText("FILTER_BAR_SEARCH")});x.attachLiveChange(function(E){if(i.oVFDialog){i._triggerSearchInFilterDialog(E);}});k.addContentRight(x);this.oVFDialog.setSubHeader(k);this.oForm=new m({layout:"ResponsiveGridLayout"});this.oForm.addStyleClass("sapUiCompFilterBarDialogForm");this.oVFDialog.addContent(this.oForm);this._addGroupsAndFilters();this.oVFDialog.open();},_addDialogButtons:function(){var i=this;q=new B({text:this.oRb.getText("FILTER_BAR_GO"),type:a.Emphasized,press:function(E){i.oState.alr_visualFilterBar._setVariantModified();i.oState.alr_visualFilterBar.setConfig(i._rebuildConfig());i._applyDialogFilters();i.oVFDialog.close();}});p=new B({text:this.oRb.getText("FILTER_BAR_CLEAR"),press:function(E){i._clearFilters();}});r=new B({text:this.oRb.getText("FILTER_BAR_RESTORE"),press:function(E){i._buildFiltersFromConfig();i.oForm.removeAllContent();i._addGroupsAndFilters();}});s=new B({text:this.oRb.getText("FILTER_BAR_CANCEL"),press:function(E){i.oVFDialog.close();i.oState.alr_visualFilterBar._globalFilters=i._oGlobalFilter;i.oState.alr_visualFilterBar._dialogFilters={};}});this.oVFDialog.addButton(q);this.oVFDialog.addButton(p);this.oVFDialog.addButton(r);this.oVFDialog.addButton(s);this.oVFDialog.attachAfterClose(function(){i.oVFDialog.destroy();i.oVFDialog=null;});},_buildFiltersFromConfig:function(){var i;this.filterCompList=[];this.filterChartList=[];for(i=0;i<this.oConfig.filterCompList.length;i++){this.filterCompList.push({obj:{shownInFilterBar:this.oConfig.filterCompList[i].shownInFilterBar,shownInFilterDialog:this.oConfig.filterCompList[i].shownInFilterDialog,cellHeight:this.oConfig.filterCompList[i].cellHeight,component:{type:this.oConfig.filterCompList[i].component.type,cellHeight:this.oConfig.filterCompList[i].component.cellHeight},group:{label:this.oConfig.filterCompList[i].group.label,name:this.oConfig.filterCompList[i].group.name}},searchVisible:true,toolbar:this._addChartCustomToolbar(this.oConfig.filterCompList[i],i)});this.filterChartList.push(this._addChart(this.oConfig.filterCompList[i].component.type,this.oConfig.filterCompList[i].component.properties,i));}this._applyFilterSelections();},_rebuildConfig:function(){var i;var k={filterCompList:[]};for(i=0;i<this.filterCompList.length;i++){k.filterCompList.push({shownInFilterBar:this.filterCompList[i].obj.shownInFilterBar&&this.filterCompList[i].obj.shownInFilterDialog,shownInFilterDialog:this.filterCompList[i].obj.shownInFilterDialog,cellHeight:this.filterCompList[i].obj.cellHeight,group:{label:this.filterCompList[i].obj.group.label,name:this.filterCompList[i].obj.group.name},component:{type:this.filterCompList[i].obj.component.type,cellHeight:this.filterCompList[i].obj.component.cellHeight,properties:{scaleFactor:this.filterChartList[i].getScaleFactor(),sortOrder:this.filterChartList[i].getSortOrder(),filterRestriction:this.oConfig.filterCompList[i].component.properties.filterRestriction,entitySet:this.filterChartList[i].getEntitySet(),width:this.oConfig.filterCompList[i].component.properties.width,height:this.oConfig.filterCompList[i].component.properties.height,dimensionField:this.filterChartList[i].getDimensionField(),dimensionFieldDisplay:this.filterChartList[i].getDimensionFieldDisplay(),dimensionFieldIsDateTime:this.filterChartList[i].getDimensionFieldIsDateTime(),dimensionFilter:this.filterChartList[i].getDimensionFilter(),unitField:this.filterChartList[i].getUnitField(),measureField:this.filterChartList[i].getMeasureField(),measureSortDescending:this.filterChartList[i].getMeasureSortDescending(),outParameter:this.oConfig.filterCompList[i].component.properties.outParameter,inParameters:this.oConfig.filterCompList[i].component.properties.inParameters,parentProperty:this.oConfig.filterCompList[i].component.properties.parentProperty}}});}return k;},_addHiddenFilterToolbar:function(i,k){var x=new V({items:[new h({text:i})]});var y=new H({items:[new C({text:"",selected:false,enabled:false}),new g({value:k,enabled:false,width:"100%"})]});y.setWidth("100%");x.addItem(y);return x;},_addGroupNames:function(i,k){if(!this.groupContainerInfo[i]){this.groupContainerInfo[i]=[];}this.groupContainerInfo[i].push(k);},_addGroupsAndFilters:function(){var i;var k;var x;this.groupContainerInfo=[];var M=this.oState.oSmartFilterbar.getAnalyticalParameters();this.oState.alr_visualFilterBar.groupHiddenFilters(M);var y=this.oState.alr_visualFilterBar._groupByFieldName;for(i=0;i<this.filterCompList.length;i++){if(this.filterCompList[i].searchVisible===false){continue;}if(!k||(k!=this.filterCompList[i].obj.group.name)){if(x){this.oForm.addContent(x);}k=this.filterCompList[i].obj.group.name;x=new V();x.setWidth("100%");x.setLayoutData(new G({span:"L12 M12 S12"}));this._addGroupToolbar(x,this.filterCompList[i].obj.group.label,this.filterCompList[i].obj.group.name);}if(this.filterCompList[i].obj.shownInFilterDialog){var z=new V();z.addStyleClass("alr_graphicalFilterDialogChartContainer");z.addStyleClass("sapSuiteVisualFilterBar");z.addItem(this.filterCompList[i].toolbar);z.addItem(this.filterChartList[i]);this._updateFilterCount(i);x.addItem(z);}if(y[k]){if(this.filterCompList[i+1]&&k===this.filterCompList[i+1].obj.group.name){continue;}this._hiddenFilterDisplay(y[k],k,i,x);delete y[k];}if(x){this.oForm.addContent(x);}}for(var A in y){x=new V();x.setWidth("100%");x.setLayoutData(new G({span:"L12 M12 S12"}));this._addHiddenGroupToolbar(x,A,A);this._hiddenFilterDisplay(y[A],A,undefined,x);this.oForm.addContent(x);}},_hiddenFilterDisplay:function(i,x,y,z){for(var A in i){var E="";var I=i[A][0].length;for(var k=0;k<i[A][0].length;k++){var J=i[A][0][k].parentProperty;var K=i[A][0][k].dimValueDisplay;E=E.concat(K);if(--I!=0){E=E.concat(", ");}}if(y===undefined){z.addItem(this._addHiddenFilterToolbar(J,E));}else if(!this.filterCompList[y+1]||(this.filterCompList[y+1]&&(x!=this.filterCompList[y+1].obj.group.name))){z.addItem(this._addHiddenFilterToolbar(J,E));}}},_addHiddenGroupToolbar:function(i,k,x){if(k==='_BASIC'){k=this.oState.alr_visualFilterBar._getBasicGroupTitle();}var y=new T({content:[new d({text:k}),new c()]});i.addItem(y);},_addGroupToolbar:function(i,k,x){var y=new T({content:[new d({text:k}),new c()]});if(x!=o){y.addContent(this._createMoreFiltersLink(x));}i.addItem(y);},_addChartCustomToolbar:function(i,k){var x=this;var y=i.component.properties.sortOrder[0].Descending.Boolean;var z=this._getChartTypeIconLink(i.component.type);var A=new H({items:[new C({text:"",selected:i.shownInFilterBar,select:function(I){var k=I.getSource().data("idx");x.filterCompList[k].obj.shownInFilterBar=this.getSelected();}}).data("idx",k)]});var E=new H({items:[new B({type:"Transparent",text:"",press:function(I){sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController.launchAllFiltersPopup(I.getSource(),x.filterChartList[I.getSource().data("idx")],I.getSource().getModel('i18n'));}}).data("idx",k),new B({type:"Transparent",icon:"sap-icon://line-chart-time-axis",visible:false,press:function(I){x._showLineChartTimeAxisPopup(I);}}).data("idx",k),new B({type:"Transparent",icon:(y?"sap-icon://sort-descending":"sap-icon://sort-ascending"),visible:true,tooltip:"{i18n>VISUAL_FILTER_SORT_ORDER}",press:function(I){x._showChartSortPopup(I);}}).data("idx",k),new B({type:"Transparent",icon:z,tooltip:"{i18n>VISUAL_FILTER_CHART_TYPE}",press:function(I){x._showChartTypesPopup(I);}}).data("idx",k),new B({type:"Transparent",icon:"sap-icon://measure",tooltip:"{i18n>VISUAL_FILTER_MEASURE}",press:function(I){x._showChartMeasuresPopup(I);}}).data("idx",k)]});E.setWidth("100%");E.setJustifyContent(sap.m.FlexJustifyContent.End);A.setWidth("100%");A.addItem(E);return A;},_addChart:function(i,k,x){var y;var z=this;var A={scaleFactor:k.scaleFactor,sortOrder:k.sortOrder,filterRestriction:k.filterRestriction,width:t,height:k.height,labelWidthPercent:u,entitySet:k.entitySet,dimensionField:k.dimensionField,dimensionFieldDisplay:k.dimensionFieldDisplay,dimensionFieldIsDateTime:k.dimensionFieldIsDateTime,unitField:k.unitField,measureField:k.measureField,dimensionFilter:k.dimensionFilter,measureSortDescending:k.measureSortDescending,outParameter:k.outParameter,inParameters:k.inParameters,parentProperty:k.parentProperty};if(i==="Donut"){A.labelWidthPercent=v;}var y=this.oState.alr_visualFilterBar._createFilterItemOfType(i,A);y.data("idx",x);y.attachFilterChange(function(E){var x=E.getSource().data("idx"),I=E.getParameter('removeGlobalFilter'),J=E.getParameter('removeGlobalFilterValue');z._updateFilterCount(x);z._setDialogFilters();z._removeGlobalFilters(I,J);z._applyFilterSelections();});y.attachTitleChange(function(E){var x=E.getSource().data("idx");z.filterCompList[x].toolbar.getItems()[0].setText(z._getChartTitle(z.filterCompList[x].obj,x));});return y;},_createMoreFiltersLink:function(k){var x=this;var y=0;var i;var z=new e();for(i=0;i<this.filterCompList.length;i++){if(this.filterCompList[i].searchVisible&&this.filterCompList[i].obj.group.name===k&&!this.filterCompList[i].obj.shownInFilterDialog){y++;}}if(y>0){z.setText(this.oRb.getText("FILTER_BAR_SHOW_MORE_FILTERS",[y]));}else{z.setText(this.oRb.getText("FILTER_BAR_SHOW_CHANGE_FILTERS"));}z.attachPress(function(A){x._createAddRemoveFiltersDialog(k,z);});return z;},_showChartMeasuresPopup:function(E){var i;var k=this;var x=E.getSource().data("idx");var y=sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController._createPopoverDialog(E.getSource().getModel('i18n'),"VISUAL_FILTER_MEASURES");var z=new f({mode:sap.m.ListMode.SingleSelectLeft});z.data("idx",x);y.addContent(z);var A=this.oState.alr_visualFilterBar._getMeasureList();z.addStyleClass("sapUiSizeCompact");for(i=0;i<A.length;i++){var I=new j({title:A[i].label}).data("measureName",A[i].name);z.addItem(I);if(this.filterChartList[x].getMeasureField()===A[i].name){z.setSelectedItem(I);}}z.attachSelectionChange(function(E){var x=E.getSource().data("idx");k.filterChartList[x].setMeasureField(E.getSource().getSelectedItem().data("measureName"));k.filterCompList[x].toolbar.getItems()[0].setText(k._getChartTitle(k.filterCompList[x].obj,x));y.close();});y.attachAfterClose(function(){y.destroy();y=null;});y.openBy(E.getSource());},_showChartTypesPopup:function(E){var k=this;var x=E.getSource();var y=sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController._createPopoverDialog(E.getSource().getModel('i18n'),"VISUAL_FILTER_CHART_TYPES");var z=this.oState.alr_visualFilterBar._getSupportedFilterItemList();var A=[];for(var i=0;i<z.length;i++){var I=z[i];var J=new j({title:"{i18n>"+I.textKey+"}",icon:I.iconLink,selected:x.getIcon()===I.iconLink}).data("type",I.type);A.push(J);}var K=new f({mode:sap.m.ListMode.SingleSelectMaster,items:A});K.data("button",x);K.addStyleClass("sapUiSizeCompact");y.addContent(K);K.attachSelectionChange(function(E){var M=E.getSource().data("button").data("idx");var N=E.getSource().getSelectedItem().data("type");var O=k.filterChartList[M].getP13NConfig();k.filterCompList[M].obj.component.type=N;E.getSource().data("button").setIcon(k._getChartTypeIconLink(N));k.filterChartList[M]=k._addChart(N,O,M);y.close();});y.attachBeforeClose(function(){k.oForm.removeAllContent();k._addGroupsAndFilters();});y.attachAfterClose(function(){y.destroy();y=null;});y.openBy(E.getSource());},_showLineChartTimeAxisPopup:function(E){var i=E.getSource().data("idx");var k=E.getSource();var x=sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController._createPopoverDialog(E.getSource().getModel('i18n'),"VISUAL_FILTER_LINE_CHART_TIME_LINE");var y=new f({mode:sap.m.ListMode.SingleSelectLeft,items:[new j({title:"{i18n>VISUAL_FILTER_LINE_CHART_TIME_LINE_DAYS}"}).data("idx",i),new j({title:"{i18n>VISUAL_FILTER_LINE_CHART_TIME_LINE_MONTH}"}).data("idx",i),new j({title:"{i18n>VISUAL_FILTER_LINE_CHART_TIME_LINE_QUARTERS}"}).data("idx",i),new j({title:"{i18n>VISUAL_FILTER_LINE_CHART_TIME_LINE_YEARS}"}).data("idx",i)]});y.data("button",k);y.addStyleClass("sapUiSizeCompact");x.addContent(y);y.attachSelectionChange(function(E){x.close();});x.attachAfterClose(function(){x.destroy();x=null;});x.openBy(E.getSource());},_showChartSortPopup:function(E){var i=this;var k=E.getSource().data("idx");var x=E.getSource();var y=E.getSource().getModel('i18n');var z=sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController._createPopoverDialog(y,"VISUAL_FILTER_SORTING");var A=new f({mode:sap.m.ListMode.SingleSelectLeft,items:[new j({title:y.getResourceBundle().getText("VISUAL_FILTER_SORTING_ASCENDING")}).data("idx",k),new j({title:y.getResourceBundle().getText("VISUAL_FILTER_SORTING_DESCENDING")}).data("idx",k)]});A.data("button",x);A.addStyleClass("sapUiSizeCompact");if(this.filterChartList[k].getSortOrder()[0].Descending.Boolean){A.setSelectedItem(A.getItems()[1],true);}else{A.setSelectedItem(A.getItems()[0],true);}z.addContent(A);A.attachSelectionChange(function(E){var x=E.getSource().data("button");var k=x.data("idx");var I=jQuery.extend(true,[],i.filterChartList[k].getSortOrder());I[0].Descending.Boolean=E.getSource().getItems()[1].isSelected();i.filterChartList[k].setSortOrder(I);if(i.filterChartList[k].getSortOrder()[0].Descending.Boolean){x.setIcon("sap-icon://sort-descending");}else{x.setIcon("sap-icon://sort-ascending");}z.close();});z.attachAfterClose(function(){z.destroy();z=null;});z.openBy(E.getSource());},_createAddRemoveFiltersDialog:function(k,x){var i;var y=this;var z=new sap.m.Dialog();z.setTitle(this.oRb.getText("SELECT_FILTER_FIELDS"));z.addStyleClass("sapUiPopupWithPadding");z.addStyleClass("sapUiCompAddRemoveFilterDialog");z.addStyleClass("sapUiSizeCompact");z.setVerticalScrolling(true);var A=new b();var E=new S({placeholder:this.oRb.getText("FILTER_BAR_SEARCH")});this._oSearchField=E;E.attachLiveChange(function(J){y._onAddRemoveFiltersSearch(J);});A.addContentRight(E);z.setSubHeader(A);this.addRemoveList=new f({mode:sap.m.ListMode.MultiSelect});this.addRemoveList.setShowSeparators(l.None);z.addContent(this.addRemoveList);for(i=0;i<this.filterCompList.length;i++){if(this.filterCompList[i].obj.group.name===k&&this.filterCompList[i].searchVisible){var I=new j({title:this._getChartTitle(this.filterCompList[i].obj,i,true)}).data("idx",i);this.addRemoveList.addItem(I);if(this.filterCompList[i].obj.shownInFilterDialog){this.addRemoveList.setSelectedItem(I,true);}}}var O=new B({text:this.oRb.getText("FORM_PERS_DIALOG_OK")});O.attachPress(function(){var i;var J=y.addRemoveList.getItems();for(i=0;i<J.length;i++){var K=J[i].data("idx");y.filterCompList[K].obj.shownInFilterDialog=J[i].isSelected();}y.oForm.removeAllContent();y._addGroupsAndFilters();z.close();});z.addAggregation("buttons",O);z.setInitialFocus(this._oSearchField);z.setContentHeight("23.25rem");var s=new B({text:this.oRb.getText("FORM_PERS_DIALOG_CANCEL"),press:function(){z.close();}});z.addAggregation("buttons",s);z.attachAfterClose(function(){z.destroy();z=null;});z.open();},_onAddRemoveFiltersSearch:function(E){var i;if(!E){return;}var k=E.getParameters();if(!k){return;}var x=(k.newValue?k.newValue:"").toLowerCase();var y=this.addRemoveList.getItems();for(i=0;i<y.length;i++){var z=(y[i].getTitle()).toLowerCase();y[i].setVisible(z.indexOf(x)>=0);}},_getChartTypeIconLink:function(i){var k=this.oState.alr_visualFilterBar._getSupportedFilterItemMap();var x=k[i];return!x?"":x.iconLink;},_getChartTitle:function(i,k,x){var y="";if(this.filterChartList[k]){if(x){i.component.properties=this.filterChartList[k].getP13NConfig();y=this.oState.alr_visualFilterBar.getTitleByFilterItemConfig(i);}else{y=this.filterChartList[k].getTitle();}}else{y=this.oState.alr_visualFilterBar.getTitleByFilterItemConfig(i);}return y;},_adjustToolbarIcons:function(i){if(this.filterCompList[i].obj.component.type==="Line"){this.filterCompList[i].toolbar.getItems()[1].getItems()[1].setVisible(true);this.filterCompList[i].toolbar.getItems()[1].getItems()[2].setVisible(false);}else{this.filterCompList[i].toolbar.getItems()[1].getItems()[1].setVisible(false);this.filterCompList[i].toolbar.getItems()[1].getItems()[2].setVisible(true);}},_removeGlobalFilters:function(i,k){this.oState.alr_visualFilterBar._removeGlobalFilters(i,k);},_applyFilterSelections:function(){this.oState.alr_visualFilterBar._updateFilterItemList(this.filterChartList);},_setDialogFilters:function(){this.oState.alr_visualFilterBar._setDialogFilters(this.filterChartList);},_applyDialogFilters:function(){this.oState.alr_visualFilterBar._applyDialogFilters(this.filterChartList);},_clearFilters:function(){var k;for(var i=0;i<this.filterCompList.length;i++){k=this.filterChartList[i].getParentProperty();delete this.oState.alr_visualFilterBar._globalFilters[k];this.filterChartList[i].setDimensionFilter([]);this._updateFilterCount(i);}this._setDialogFilters();this._applyFilterSelections();},_updateFilterCount:function(i){if(this.filterChartList[i].getDimensionFilter()&&this.filterChartList[i].getDimensionFilter().length>0){var k=this.oRb.getText("VALUEHELPDLG_SELECTEDITEMS_SHORT",[this.filterChartList[i].getDimensionFilter().length]);this.filterCompList[i].toolbar.getItems()[1].getItems()[0].setVisible(true);this.filterCompList[i].toolbar.getItems()[1].getItems()[0].setText(k);}else{this.filterCompList[i].toolbar.getItems()[1].getItems()[0].setVisible(false);}},_triggerSearchInFilterDialog:function(E){var i;if(!E){return;}var k=E.getParameters();if(!k){return;}var x=(k.newValue?k.newValue:"").toLowerCase();for(i=0;i<this.filterCompList.length;i++){var y=(this.filterCompList[i].toolbar.getItems()[0].getText()).toLowerCase();this.filterCompList[i].searchVisible=y.indexOf(x)>=0;}this.oForm.removeAllContent();this._addGroupsAndFilters();}});sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController._createPopoverDialog=function(i,k){var x=new sap.m.Popover();x.setTitle(i.getResourceBundle().getText(k));x.setPlacement(sap.m.PlacementType.PreferredBottomOrFlip);x.addStyleClass("sapUiPopupWithPadding");return x;};sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController.launchAllFiltersPopup=function(k,x,y){var i;var z=x.getDimensionFilter();var A=x.getFilterRestriction();var E=sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController._createPopoverDialog(y,"VISUAL_FILTER_ALL_SELECTED_FILTERS");var I=new f({mode:sap.m.ListMode.Delete});I.data("chart",x);E.addContent(I);if(A!=="single-value"){for(i=0;i<z.length;i++){var J=new j({title:F.createTitle(z[i].dimValueDisplay,z[i].dimValue)});I.addItem(J);}}else{I.addItem(new j({title:z[0].dimValue}));}I.attachDelete(function(K){var M=K.getParameter("listItem");var N=I.data("chart");var O=I.indexOfItem(M);var Q=z.splice(O,1);I.removeItem(M);N.setDimensionFilter(z);N.fireFilterChange({removeGlobalFilter:N.getOutParameter(),removeGlobalFilterValue:Q[0].dimValue});E.focus();});E.attachAfterClose(function(){E.destroy();E=null;});E.openBy(k);};return w;});
