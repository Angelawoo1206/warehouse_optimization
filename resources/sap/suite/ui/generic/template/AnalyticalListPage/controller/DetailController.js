sap.ui.define(["sap/ui/base/EventProvider","sap/ui/comp/personalization/Util","sap/suite/ui/generic/template/AnalyticalListPage/control/VariantToggleButton","sap/ui/table/AnalyticalTable","sap/ui/core/mvc/Controller","sap/ui/model/FilterType"],function(E,P,V,A,C,F){"use strict";var b=new E();var c="mirror";var d="masterDetail";var f=[c,d];var t=C.extend("sap.suite.ui.generic.template.AnalyticalListPage.controller.DetailController",{setState:function(s){var m=this;this.oState=s;this._enableExpandByFilter=true;this._enableUpdateExpandLevelInfo=false;this._isRebindTriggeredByChart=false;this._enableStrictFilter=false;var a=this.oState.oSmartTable;var e=a.getTable();e.attachEvent("_rowsUpdated",function(g){m._updateRows("_rowsUpdated");});var o=this.oState.oController.getOwnerComponent();this._autoHide=o.getAutoHide()!=undefined?o.getAutoHide():true;a.attachInitialise(this._onSmartTableInit,this);a.attachDataReceived(this._onDataReceived,this);a.attachBeforeRebindTable(this._onBeforeRebindTable,this);},_onSmartTableInit:function(){var a=new V("",{icon:"sap-icon://hide",pressed:this._autoHide,persistencyKey:"alr_charttablemode_toggleButton",smartVariant:this.oState.alr_pageVariant,press:$.proxy(this._onAutoHideToggle,this),visible:this.oState.oController.getOwnerComponent().getShowAutoHide()==true});this._getChartTableMode();this.oState._autoHideToggleBtn=a;if(this.oState._pendingTableToolbarInit&&this.oState._containerView=="table"){this.oState.oSmartTable._oToolbar.addContent(this.oState.alr_fullScreenButton);this.oState.oSmartTable._oToolbar.addContent(this.oState.alr_viewSwitchButton);}if(this.oState._pendingTableToolbarInit){var s=this.oState.oSmartTable;var e=s.getCustomToolbar();var T=e.getContent();var n;for(var i=0;i<T.length;i++){if(T[i].mProperties.text==="Settings"){n=i;}}e.insertContent(this.oState._autoHideToggleBtn,n);delete this.oState._pendingTableToolbarInit;}this._updateToggleTooltip();if(this.oState.oSmartTable._oPersController)this.oState.oSmartTable._oPersController.attachAfterP13nModelDataChange(jQuery.proxy(this._onAfterP13nModelDataChange,this));},_onAfterP13nModelDataChange:function(e){this._lastFilter="";this.oState.chartController.updateTable();},_onBindingDataReceived:function(){var a=this.oState.oSmartTable.getTable();if(a instanceof A){this._expandByFilter("bindingDataReceived");}},_onDataReceived:function(){this.oState.oSmartTable.detachDataReceived(this._onDataReceived,this);this.fireInitComplete();},_onAutoHideToggle:function(e){this._autoHide=this.oState._autoHideToggleBtn.getPressed();this._updateToggleTooltip();this.oState.chartController.updateTable();this.fireAutoHideToggle();},_updateToggleTooltip:function(){var a=this._autoHide?"CHARTTABLE_AUTOHIDE_ON":"CHARTTABLE_AUTOHIDE_OFF";var e=this.oController.oView.getModel("i18n").getResourceBundle().getText(a);this.oState._autoHideToggleBtn.setTooltip(e);},_onBeforeRebindTable:function(o){var v=this.oState.oSmartTable.fetchVariant(),l=v,a={};if(!v)return;var g=[];var h=this.oState.oSmartTable.getTable().getColumns();for(var i=0;i<h.length;i++){var j=h[i];if(j.getGrouped&&j.getGrouped())g.push(j.getLeadingProperty?j.getLeadingProperty():P.getColumnKey(j));}this._updateExpandLevelInfo(g);var s=[];if(v.sort&&v.sort.sortItems){for(var i=0;i<v.sort.sortItems.length;i++){var k=v.sort.sortItems[i].operation==="Descending"?true:false;s.push(new sap.ui.model.Sorter(v.sort.sortItems[i].columnKey,k));}}else if(!l.sort){a.allTableSortRemoved=true;}if(!this._isRebindTriggeredByChart&&this.isMirrorMode()){this._paramListFiltered=[];this._lastSelected=null;if(g.length>0){a.groupList=g;}if(s.length>0){a.sortList=s;}this.fireTableChange(a);}else{this._isRebindTriggeredByChart=false;}if(this.oState.oSmartFilterbar&&this.oState.oSmartFilterbar.getAnalyticBindingPath&&this.oState.oSmartFilterbar.getConsiderAnalyticalParameters()){try{var m=this.oState.oSmartFilterbar.getAnalyticBindingPath();if(m){this.oState.oSmartTable.setTableBindingPath(m);}}catch(e){jQuery.sap.log.warning("Mandatory parameters have no values","","AnalyticalListPage");}}this.oState.oController.onBeforeRebindTableExtension(o);},attachAutoHideToggle:function(D,a,l){return b.attachEvent("AutoHideToggle",D,a,l);},detachAutoHideToggle:function(a,l){return b.detachEvent("AutoHideToggle",a,l);},fireAutoHideToggle:function(a){return b.fireEvent("AutoHideToggle",a);},attachTableChange:function(D,a,l){return b.attachEvent("TableChange",D,a,l);},detachTableChange:function(a,l){return b.detachEvent("TableChange",a,l);},fireTableChange:function(a){return b.fireEvent("TableChange",a);},attachInitComplete:function(D,a,l){return b.attachEvent("InitComplete",D,a,l);},detachInitComplete:function(a,l){return b.detachEvent("InitComplete",a,l);},fireInitComplete:function(a){return b.fireEvent("InitComplete",a);},setDetailViewController:function(o){this.oController=o;},isMasterDetailMode:function(){return this._getChartTableMode()==d;},isMirrorMode:function(){return this._getChartTableMode()==c;},_getChartTableMode:function(){if(this._chartTableMode)return this._chartTableMode;this._chartTableMode=d;var m=this.oState.oController.getOwnerComponent().getChartTableMode();if(m){if(f.indexOf(m)==-1)throw new Error("Unsupported chartTableMode: "+m);this._chartTableMode=m;}return this._chartTableMode;},applyParamsToTable:function(p,l,a,g,s,u){var e=this.oState.oController.getOwnerComponent().getEntitySet();this._isRebindTriggeredByChart=true;if(this._autoHide){if(this._enableStrictFilter)this._applyParamsToTableAsFilter_strict(e,p,a,g,u);else this._applyParamsToTableAsFilter(e,p,a,g,s,u);}else{this._applyParamsToTableAsHighlight(e,p,l,a,g,s,u);}},_applyParamsToTableAsFilter:function(e,p,a,g,s,u){if(!this.oState)return;var h=this.oState.oSmartTable.getTable();var j=this._getTableBinding(h);if(!j){jQuery.sap.log.error("No table binding to apply the filter(s) to");return;}this._updateGrouping(h,g);if(s!==undefined&&this.isMirrorMode()){this._updateSorting(h,s);}var k=[];for(var i=0;i<p.length;i++){var l=p[i];for(var n in l){if(a.indexOf(n)==-1||!this._getBindingProperty(j,n)){jQuery.sap.log.warning("Could not apply filter with name \""+n+"\" as that field does not exist in the entity type");continue;}k.push(new sap.ui.model.Filter({path:n,operator:sap.ui.model.FilterOperator.EQ,value1:l[n]}));}}this.filterList=k;var m;if(k.length>0){m=k;if(this._getPageFilters(j).length>0){m.push(this._getPageFilters(j)[0]);}}else{m=this._getPageFilters(j);}if(!this._lastFilter){this._lastFilter=j.aApplicationFilter;}if(this._isFilterDiff(this._lastFilter,m)){j.filter(m,F.Application);this._lastFilter=m;}this._updateRows(u);},_updateSorting:function(a,s){var e=a.getColumns(),g={},v=this.oState.oSmartTable.fetchVariant(),h={};var g={};for(var i=0;i<e.length;i++){var j=e[i];if(!P.isSortable(j))continue;var k=j.getLeadingProperty?j.getLeadingProperty():P.getColumnKey(j);g[k]=j;}if(s.allSortRemoved){for(var l in v){if(l!=="sort"){h[l]=v[l];}}this.oState.oSmartTable.applyVariant(h);}else{v.sort={};v.sort.sortItems=[];for(var i=0;i<s.sortList.length;i++){var n=s.sortList[i].columnKey;var j=g[n];if(!j)continue;v.sort.sortItems.push({columnKey:n,operation:s.sortList[i].operation});delete g[n];}this.oState.oSmartTable.applyVariant(v);}},_getBindingProperty:function(a,n){if(a.getProperty){return a.getProperty(n);}else{var p=a.oEntityType.property;for(var i=0;i<p.length;i++){if(p[i].name==n)return p[i];}return null;}},_applyParamsToTableAsFilter_strict:function(e,p,a,g,u){if(!this.oState)return;var h=this.oState.oSmartTable.getTable();var j=this._getTableBinding(h);if(!j){jQuery.sap.log.error("No table binding to apply the filter(s) to");return;}var k=[];for(var i=0;i<p.length;i++){var l=p[i];var s=[];for(var n in l){if(!j.getProperty(n)||a.indexOf(n)==-1){jQuery.sap.log.warning("Could not apply filter with name \""+n+"\" as that field does not exist in the entity type");continue;}s.push(new sap.ui.model.Filter({path:n,operator:sap.ui.model.FilterOperator.EQ,value1:l[n]}));}k.push(new sap.ui.model.Filter({aFilters:s,and:true}));}this.filterList=k;var m=new sap.ui.model.Filter({aFilters:k,and:true});var o;if(k.length>0){o=m;}else{o=this._getPageFilters(j);}if(!this._lastFilter){this._lastFilter=j.aApplicationFilter;}if(this._isFilterDiff(this._lastFilter,o)){j.filter(o,F.Application);this._lastFilter=o;}},_isFilterDiff:function(a,e){if($.isArray(a)!=$.isArray(e))return true;if($.isArray(a))return this._isFilterListDiff(a,e);else return this._isFilterObjDiff(a,e);},_isFilterObjDiff:function(e,g){if(!e||!g)return true;for(var a in e){if(a=="aFilters"){if(this._isFilterListDiff(e.aFilters,g.aFilters))return true;}else if(e[a]!=g[a])return true;}return false;},_isFilterListDiff:function(l,L){if(!l||!L)return true;if(l.length!=L.length)return true;for(var i=0;i<l.length;i++){var a=l[i];var e=L[i];if(this._isFilterObjDiff(a,e))return true;}return false;},_getPageFilters:function(B){var p=this.oState.oSmartFilterbar.getFilters();for(var i=0;i<p.length;i++){if(p[i].aFilters!==undefined){var a=p[i].aFilters;for(var j=0;j<a.length;j++){var e=a[j];var n=e.sPath;if(!B.getProperty(n)){jQuery.sap.log.warning("Could not apply filter with name \""+n+"\" as that field does not exist in the entity type");continue;}e.sPath=n;}}else{var e=p[i];var n=e.sPath;if(!B.getProperty(n)){jQuery.sap.log.warning("Could not apply filter with name \""+n+"\" as that field does not exist in the entity type");continue;}e.sPath=n;}}return p;},_applyParamsToTableAsHighlight:function(e,p,l,a,g,s,u){if(!this.oState)return;var h=this.oState.oSmartTable.getTable();var j=this._getTableBinding(h);if(!j){jQuery.sap.log.error("No table binding to apply the selection(s) to");return;}var L=this._updateGrouping(h,g);if(s!==undefined&&this.isMirrorMode()){this._updateSorting(h,s);}var k=[];for(var i=0;i<p.length;i++){var m=p[i];var n={};for(var o in m){if(a.indexOf(o)==-1||!this._getBindingProperty(j,o))continue;n[o]=m[o];}k.push(n);}if(!this._lastFilter){this._lastFilter=j.aApplicationFilter;}var q=this._getPageFilters(j);if(this._isFilterDiff(this._lastFilter,q)){j.filter(q,F.Application);this._lastFilter=q;}else if(L){j.refresh();}this._paramListFiltered=k;this._lastSelected=l;this._updateRows(u);},_updateGrouping:function(a,g){if(!this.isMirrorMode())return;var e=a.getColumns();var h={};for(var i=0;i<e.length;i++){var j=e[i];if(!P.isGroupable(j))continue;var k=j.getLeadingProperty?j.getLeadingProperty():P.getColumnKey(j);h[k]=j;}var l=false;for(var i=0;i<g.length;i++){var n=g[i];var j=h[n];if(!j)continue;if(j.getGrouped&&!j.getGrouped()){j.setGrouped(true);j.isGroupableByMenu(true);j.setShowIfGrouped(true);l=true;}delete h[n];}for(var n in h){var j=h[n];if(j.getGrouped&&j.getGrouped()){j.setGrouped(false);j.isGroupableByMenu(false);j.setShowIfGrouped(false);l=true;}}if(l){var m=a.getGroupedColumns();a.fireGroup({column:m[0],groupedColumns:m,type:sap.ui.table.GroupEventType.group});}return this._updateExpandLevelInfo(g);},_expandByFilter:function(u){if(!this._enableExpandByFilter)return;var a=this.oState.oSmartTable.getTable();var e=this._getTableBinding(a);if(e&&this._lastBinding!=e){var m=this;e.attachDataReceived(this._onBindingDataReceived,this);e.attachEvent("change",function(k){if(m._expandingProgrammatically)return;var l=k.getParameter("reason");if(l=="expand"||l=="collapse")m._inUserChartSelectMode=false;});this._lastBinding=e;}if(u=="selection"||u=="bindingDataReceived")this._firstVisibleRelevantEventTS=new Date().getTime();if(u=="selection")this._inUserChartSelectMode=true;if(!this._inUserChartSelectMode)return;var r=this._getTableRows();for(var i=0;i<r.length;i++){var g=r[i];var h=g.getBindingContext();if(!h)continue;var j=a.getFirstVisibleRow()+i;if(this._isRowHighlighted(h.getObject())){if(a.isExpanded(j))continue;if(!g._bHasChildren)continue;if(!e.findNode(j))continue;this._expandingProgrammatically=true;a.expand(j);this._expandingProgrammatically=false;}else{if(!a.isExpanded(j))continue;if(!g._bHasChildren)continue;if(!e.findNode(j))continue;this._expandingProgrammatically=true;a.collapse(j);this._expandingProgrammatically=false;}}this._updateFirstVisibleRow(u);},_updateFirstVisibleRow:function(u){var a=this.oState.oSmartTable.getTable();var e=this._getTableBinding(a);var g=e.getTotalSize();if(g==0||(new Date().getTime()-this._firstVisibleRelevantEventTS)>250)return;var a=this.oState.oSmartTable.getTable();if(u=="selection"&&(!this._paramListFiltered||this._paramListFiltered.length==0)){a.setFirstVisibleRow(0);return;}var h=e.getContexts(0,g);for(var i=0;i<h.length;i++){var r=h[i].getObject();if(!this._isRowHighlighted(r))continue;if(this._lastSelected&&!this._rowMatch(this._lastSelected,r))continue;var l=a.getFirstVisibleRow();if(u=="selection"||this._autoHide){a.setFirstVisibleRow(i);}else{if(i>l)a.setFirstVisibleRow(i);}break;}},_rowMatch:function(s,r){for(var n in s){if(n.indexOf("__")!=-1)continue;if(!r.hasOwnProperty(n))continue;if(s[n]!=r[n])return false;}return true;},_updateExpandLevelInfo:function(g){if(!this._enableUpdateExpandLevelInfo)return false;var T=this.oState.oSmartTable.getTable();if(!T.getNumberOfExpandedLevels)return false;var B=T.getBinding();if(!B)return false;var e=g.length;var l=false;if(e>=B.aMaxAggregationLevel.length){l=true;e=B.aMaxAggregationLevel.length-1;this.wasAtMaxLevel=true;}else{l=T.getNumberOfExpandedLevels()!=e||this.wasAtMaxLevel;this.wasAtMaxLevel=false;}if(l){if(e>=0){T.setNumberOfExpandedLevels(e);T.bindRows(T.getBindingInfo("rows"));}var a=T.getGroupedColumns();T.fireGroup({column:a[0],groupedColumns:a,type:sap.ui.table.GroupEventType.group});}return l;},_updateRows:function(u){var a=this._autoHide&&this.filterList&&this.filterList.length>0;var r=this._getTableRows();for(var i=0;i<r.length;i++){var e=r[i];var g=false;var h=e.getBindingContext();if(h){var j=h.getObject();if(this._autoHide)g=a;else g=this._isRowHighlighted(j);}var k=e.getDomRefs?e.getDomRefs(true):e.getDomRef();if(!k)continue;if(k.row)k.row.toggleClass("alr_rowHighlighted",g);else $(k).toggleClass("alr_rowHighlighted",g);}var l=this.oState.oSmartTable.getTable();if(l instanceof A){this._expandByFilter(u);}},_getTableRows:function(){var a=this.oState.oSmartTable.getTable();if(a.getRows)return a.getRows();else return a.getItems();},_isRowHighlighted:function(r){if(this._autoHide&&this._lastFilter&&this._lastFilter.length>0)return true;var p=this._paramListFiltered;if(!p)return false;for(var i=0;i<p.length;i++){var m=true;var a=p[i];for(var n in a){if(!r.hasOwnProperty(n))continue;if(a[n]!=r[n]){m=false;break;}}if(m)return true;}return false;},_getTableBinding:function(a){return a.getBinding()?a.getBinding():a.getBinding("items");}});return t;});
