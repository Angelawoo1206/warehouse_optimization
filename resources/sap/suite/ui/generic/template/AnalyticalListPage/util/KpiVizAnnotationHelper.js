sap.ui.define(["sap/ui/base/Object","sap/ui/model/Context","sap/ui/model/odata/AnnotationHelper"],function(B,C,O){"use strict";var A=B.extend("sap.suite.ui.generic.template.AnalyticalListPage.util.KpiVizAnnotationHelper");sap.suite.ui.generic.template.AnalyticalListPage.util.KpiVizAnnotationHelper.constants={LABEL_KEY:"sap:label",TEXT_KEY:"sap:text",TYPE_KEY:"type"};sap.suite.ui.generic.template.AnalyticalListPage.util.KpiVizAnnotationHelper.config={"Line":{"type":"line","dimensions":{"min":1,"defaultRole":"Category"},"measures":{"min":1},"feeds":[{"uid":"valueAxis","type":"measure"},{"uid":"categoryAxis","min":1,"type":"dimension","role":"Category"},{"uid":"color","type":"dimension","role":"Series"}]},"Column":{"type":"column","dimensions":{"min":1,"defaultRole":"Category"},"measures":{"min":1,"defaultRole":"Axis1"},"feeds":[{"uid":"valueAxis","min":1,"type":"measure"},{"uid":"categoryAxis","min":1,"type":"dimension"}]},"Donut":{"type":"donut","dimensions":{"min":1},"measures":{"min":1,"max":1},"feeds":[{"uid":"size","min":1,"max":1,"type":"measure"},{"uid":"color","min":1,"type":"dimension"}]},"Bar":{"type":"bar","dimensions":{"min":1,"defaultRole":"Category"},"measures":{"min":1,"defaultRole":"Axis1"},"feeds":[{"uid":"valueAxis","min":1,"type":"measure"},{"uid":"categoryAxis","min":1,"type":"dimension"}]}};A.formatItems=function(c,e,s,p,D,M,S){var o=c.getSetting("dataModel");var r="{";var a=[];var b=[];var f=[];var g=p&&p.SortOrder;var h=p&&p.MaxItems,j=null;var t;var k=null;var l=sap.suite.ui.generic.template.AnalyticalListPage.util.KpiVizAnnotationHelper;var n="sap:text";if(h){j=h.Int32?h.Int32:h.Int;}if(j){if(j=="0"){jQuery.sap.log.error("maxItems is configured as "+j);r+="}";return r;}if(!/^\d+$/.test(j)){jQuery.sap.log.error("maxItems is Invalid. "+"Please enter an Integer.");r+="}";return r;}}r+="path: '"+S.model+">/"+e.name+"'";if(!S){jQuery.sap.log.error("NO KPI card settings in card formmater");r+="}";return r;}k=S.entitySet;if(!o||!k){return r;}var q=l.getMetadata(o,k);if(g){var u=p.SortOrder;if(u.length<1){jQuery.sap.log.warning("Kpi Card no Sort annotaion defined");}else{var v="";var w;var x;var y;for(var i=0;i<u.length;i++){w=u[i];y=w.Property.PropertyPath;f.push(y);if(typeof w.Descending=="undefined"){x="true";}else{var z=w.Descending.Bool;if(!z){jQuery.sap.log.warning(l.errorMessages.CARD_WARNING+l.errorMessages.BOOLEAN_ERROR);x="true";}else{x=z.toLowerCase()==="true";}}v=v+"{path: '"+y+"',descending: "+x+"},";}r+=", sorter: ["+v.substring(0,v.length-1)+"]";}}jQuery.each(M,function(i,m){t=m.Measure.PropertyPath;b.push(t);if(q&&q[t]&&q[t][n]&&t!=q[t][n]){b.push(q[t][n]?q[t][n]:t);}});jQuery.each(D,function(i,d){t=d.Dimension.PropertyPath;a.push(t);if(q&&q[t]&&q[t][n]&&t!=q[t][n]){a.push(q[t][n]?q[t][n]:t);}});r+=", parameters: {select:'"+[].concat(a,b).join(",");if(f.length>0){r+=","+f.join(",");}r+="'}";if(j){r+=", length: "+j;}r+="}";return r;};A.getChartType=function(c){var a=[];if(!c.EnumMember||!(a=c.EnumMember.split("/"))||a.length<2){jQuery.sap.log.error("KPI Card M - wrong or missing chart type");return"";}else{return A.config[a[1]].type;}};A.setupChartAttributes=function(v,s){var c,e,a;var o,b,d,D,m;var V;var q,Q,f;var p,g=[],M=[];d=A.config;var h=sap.suite.ui.generic.template.AnalyticalListPage.util.KpiVizAnnotationHelper;if(!(c=s)){jQuery.sap.log.error("KPI Card no card settings");return;}var l=v.getModel();var n=l.getMetaModel();var r=c.entitySet;var E=n.getODataEntitySet(r);if(!l||!r){return;}e=n.getODataEntityType(E.entityType,false);if(!e){jQuery.sap.log.error("KPI Card no entityType");return;}var t=h.getMetadata(l,r);var u="com.sap.vocabularies.UI.v1.Chart#"+c.qualifier;if(!u||!(a=e[u])){jQuery.sap.log.error("KPI Card no chart annotations");return;}if(!(D=a.DimensionAttributes)||!D.length){jQuery.sap.log.error("KPI Card no dimension annotations defined");return;}if(!(m=a.MeasureAttributes)||!m.length){jQuery.sap.log.error("KPI Card no measure annotations defined");return;}var w=[];o=a.ChartType;if(!o.EnumMember||!(w=o.EnumMember.split("/"))||w.length<2){jQuery.sap.log.error("KPI Card M - wrong or missing chart type");}else{b=w[1];}var H=true;v.removeAllAggregation();V={legend:{isScrollable:false},general:{background:{color:"transparent"},layout:{padding:15},groupData:false},title:{visible:false},interaction:{noninteractiveMode:false,selectability:{legendSelection:false,axisLabelSelection:false,mode:"NONE",plotLassoSelection:false,plotStdSelection:true}},plotArea:{window:{start:"firstDataPoint",end:"lastDataPoint"},background:{color:"transparent"}}};Q=D.slice();f=m.slice();jQuery.each(d[b].feeds,function(i,x){var y=x.uid;var F=[];if(x.type){var P,z,G;if(x.type==="dimension"){P=D.length;z="Dimension";G="dimensions";q=Q;p=g;}else{P=m.length;z="Measure";G="measures";q=f;p=M;}var I=0,J=P;if(x.min){I=I>x.min?I:x.min;}if(x.max){J=J<x.max?J:x.max;}if(!x.role){var K=q.length;for(var j=0;j<K&&F.length<J;++j){var L=q[j];q.splice(j,1);--K;--j;F.push(L);}}else{var N=x.role.split("|");jQuery.each(N,function(j,U){if(F.length==J){return false;}var K=q.length;for(var k=0;k<K&&F.length<J;++k){var L=q[k];if(L&&L.Role&&L.Role.EnumMember&&L.Role.EnumMember.split("/")&&L.Role.EnumMember.split("/")[1]){var W=L.Role.EnumMember.split("/")[1];if(W==U){q.splice(k,1);--K;--k;F.push(L);}}else if(jQuery.inArray(L,p)==-1){p.push(L);}}});if(F.length<J){jQuery.each(p,function(k,L){var U;var W;if((U=d[G].defaultRole)&&(jQuery.inArray(U,N)!==-1)&&(W=jQuery.inArray(L,q))!==-1){q.splice(W,1);F.push(L);if(F.length==J){return false;}}});}if(F.length<I){jQuery.sap.log.error("KPI card feed propperties < min");return false;}}if(F.length){var R=[];var S;if(!(S=v.getDataset())){jQuery.sap.log.error("KPI Card Viz framework no Dataset");return false;}jQuery.each(F,function(i,L){if(!L||!L[z]||!L[z].PropertyPath){jQuery.sap.log.error("KPI Card invalid chart annotations - propertypath");return false;}var k=L[z].PropertyPath;var U=k;var W=k;if(t&&t[k]){U=t[k][h.constants.LABEL_KEY]||k;W=t[k][h.constants.TEXT_KEY]||k;}var X="{"+W+"}";R.push(U);if(z=="Dimension"){S.addDimension(new sap.viz.ui5.data.DimensionDefinition({name:U,value:"{"+k+"}",displayValue:X}));}else{S.addMeasure(new sap.viz.ui5.data.MeasureDefinition({name:U,value:"{"+k+"}"}));}});var T=new sap.viz.ui5.controls.common.feeds.FeedItem({"uid":y,"type":z,"values":R});v.addFeed(T);V[y]={title:{visible:H?false:true,text:R.join(", ")},label:{formatString:"axisFormatter"}};if(y=="valueAxis"){V[y].layout={maxWidth:0.4};}}}});v.setVizProperties(V);};A.formatByType=function(m,p,v){var s=sap.ovp.cards.charts.VizAnnotationManager;var t=s.constants.TYPE_KEY;if(!m||!m[p]||!m[p][t]){return v;}var n=["Edm.Int","Edmt.Int16","Edm.Int32","Edm.Int64","Edm.Decimal"];var c=m[p][t];if(jQuery.inArray(c,n)!==-1){return Number(v);}return v;};A.getMetadata=function(m,e){var a=this.cacheODataMetadata(m);if(!a){return undefined;}return a[e];};A.cacheODataMetadata=function(m){var s=sap.suite.ui.generic.template.AnalyticalListPage.util.KpiVizAnnotationHelper;if(m){if(!jQuery.sap.getObject("sap.suite.ui.generic.template.AnalyticalListPage.kpi.cachedMetaModel")){s.cachedMetaModel={};}var a=s.cachedMetaModel[m.getId()];if(!a){var b=m.getMetaModel();a={};var c=b.getODataEntityContainer();jQuery.each(c.entitySet,function(d,e){var f=b.getODataEntityType(e.entityType);var g={};jQuery.each(f.property,function(p,h){g[h.name]=h;});a[e.name]=g;});s.cachedMetaModel[m.getId()]=a;}return a;}else{jQuery.sap.log.error(s.errorMessages.CARD_ERROR+s.errorMessages.CACHING_ERROR);}};A.formatChartAxes=function(s){jQuery.sap.require("sap.viz.ui5.format.ChartFormatter");jQuery.sap.require("sap.ui.core.format.NumberFormat");jQuery.sap.require("sap.viz.ui5.api.env.Format");var c=sap.viz.ui5.format.ChartFormatter.getInstance();var S=true;if(!s){s=undefined;}else{S=false;}if(c!=null){c.registerCustomFormatter("axisFormatter",function(v){var n=sap.ui.core.format.NumberFormat.getFloatInstance({style:"short",minFractionDigits:0,maxFractionDigits:1,decimals:2,showScale:S,shortRefNumber:s});return n.format(Number(v));});sap.viz.ui5.api.env.Format.numericFormatter(c);}};sap.suite.ui.generic.template.AnalyticalListPage.util.KpiVizAnnotationHelper.formatItems.requiresIContext=true;return A;},true);
