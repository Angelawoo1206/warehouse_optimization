// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";var m=new sap.ui.model.json.JSONModel({actions:[],userPreferences:{entries:[]},apps:{recentActivities:[],frequentActivities:[]}});sap.ui.controller("sap.ushell.renderers.fiori2.meArea.MeArea",{onInit:function(){var c=(this.getView().getViewData()?this.getView().getViewData().config:{})||{};this.aControlsWithPressHandler=[];this.getView().setModel(m,"meAreaModel");this._addActionItemToOverflowSupport();this.oResourceBundle=sap.ushell.resources.i18n;if(c.enableRecentActivity){this.oUserRecentsSrvc=sap.ushell.Container.getService('UserRecents');}this.lastVisited=null;},onBeforeRendering:function(){if(this.oUserRecentsSrvc){if(!m.getProperty('/apps/recentActivities')||!m.getProperty('/apps/recentActivities').length){this.refreshRecentActivities();}}if(!m.getProperty('/apps/frequentActivities')||!m.getProperty('/apps/frequentActivities').length){this.refreshFrequentActivities();}},refreshRecentActivities:function(){if(this.oUserRecentsSrvc){this.oUserRecentsSrvc.getRecentActivity().done(function(a){a.forEach(function(i){i.timestamp=sap.ushell.utils.formatDate(i.timestamp);});m.setProperty('/apps/recentActivities',a);});}},refreshFrequentActivities:function(c){if(this.oUserRecentsSrvc){this.oUserRecentsSrvc.getFrequentActivity().done(function(a){m.setProperty('/apps/frequentActivities',a);});}},createViewByName:function(e,n,v){var V=v?sap.ui.getCore().byId(v):null;if(!V){var s=e.getSource(),c=s.getBindingContext(),p=c?c.getPath():"",a=n||c.getModel().getProperty(p+"/viewName");v=v||c.getModel().getProperty(p+"/id");V=sap.ui.view(v,{viewName:a,type:'JS',viewData:{}});}return V;},getSettingsDialogContent:function(){var s=sap.ui.getCore().byId("userSettings");if(!s){s=sap.ui.view("userSettings",{viewName:"sap.ushell.renderers.fiori2.user_actions.user_preferences.UserSettings",type:'JS',viewData:this.getView().getViewData()});}s.setModel(this.getView().getModel());return s;},logout:function(){jQuery.sap.require('sap.m.MessageBox');var l=new sap.ushell.ui.launchpad.LoadingDialog({text:""}),s=true,i=false,L={};sap.ushell.Container.getGlobalDirty().done(function(d){s=false;if(i===true){l.exit();l=new sap.ushell.ui.launchpad.LoadingDialog({text:""});}var _=function(d){var L={},r=sap.ushell.resources.i18n;if(d===sap.ushell.Container.DirtyState.DIRTY){L.message=r.getText('unsaved_data_warning_popup_message');L.icon=sap.m.MessageBox.Icon.WARNING;L.messageTitle=r.getText("unsaved_data_warning_popup_title");}else{L.message=r.getText('signoutConfirmationMsg');L.icon=sap.m.MessageBox.Icon.QUESTION;L.messageTitle=r.getText("signoutMsgTitle");}return L;};L=_(d);sap.m.MessageBox.show(L.message,L.icon,L.messageTitle,[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],function(a){if(a===sap.m.MessageBox.Action.OK){l.openLoadingScreen();l.showAppInfo(sap.ushell.resources.i18n.getText('beforeLogoutMsg'),null);sap.ushell.Container.logout();}},sap.ui.core.ElementMetadata.uid("confirm"));});if(s===true){l.openLoadingScreen();i=true;}},_addPressHandlerToActions:function(c){var t=this;if(this.aControlsWithPressHandler.indexOf(c.getId())===-1){this.aControlsWithPressHandler.push(c.getId());c.attachPress(function(){sap.ui.getCore().byId("viewPortContainer").switchState("Center");if(c.getId()==="userSettingsBtn"){if(!t.getView().oSettingsDialog.getModel()){t.getView().oSettingsDialog.setModel(t.getView().getModel());}t.getView().oSettingsDialog.open();}});}},_getControlsWithPressHandler:function(){return this.aControlsWithPressHandler;},_addActionItemToOverflowSupport:function(){if(sap.m._overflowToolbarHelpers&&sap.m._overflowToolbarHelpers.OverflowToolbarAssociativePopoverControls._mSupportedControls){var s=sap.m._overflowToolbarHelpers.OverflowToolbarAssociativePopoverControls._mSupportedControls;var p=sap.m._overflowToolbarHelpers.OverflowToolbarAssociativePopoverControls.prototype;var c=["sap.ushell.ui.launchpad.ActionItem","sap.ushell.ui.footerbar.AboutButton","sap.ushell.ui.footerbar.ContactSupportButton","sap.ushell.ui.footerbar.EndUserFeedback","sap.ushell.ui.footerbar.HideGroupsButton","sap.ushell.ui.footerbar.LogoutButton","sap.ushell.ui.footerbar.UserPreferencesButton","sap.m.Button"];var C=function(n){return n.substring(0,1).toUpperCase()+n.substring(1);};var S={canOverflow:true,listenForEvents:["press"],noInvalidationProps:["enabled","type"]};var P=function(o){if(o.setActionType){o.setActionType('standard');}var t=o.getType();if(t!==sap.m.ButtonType.Accept&&t!==sap.m.ButtonType.Reject){o.setType(sap.m.ButtonType.Transparent);}};var f=function(o){if(o.setActionType){o.setActionType('action');}};c.forEach(function(n){s[n]=S;var a=n.split(".").map(C).join("");var b='_preProcess';var d='_postProcess';p[b+a]=P;p[d+a]=f;});}},setLastVisited:function(u){this.lastVisited=u;},updateScrollBar:function(h){if(this.lastVisited&&this.lastVisited!="#"+h){jQuery('.sapUshellViewPortLeft').scrollTop(0);sap.ui.getCore().byId('meAreaIconTabBar').setSelectedKey("sapUshellIconTabBarrecentActivities");var l=sap.ui.getCore().byId('sapUshellActivityListrecentActivities'),L=l.getItems();if(L&&L.length>0){sap.ui.getCore().byId('sapUshellActivityListrecentActivities').setSelectedItem(L[0],true);}this.lastVisited=null;}},_saveUserPrefEntries:function(){var e=this.getView().getModel().getProperty("/userPreferences/entries");var r=jQuery.Deferred();var w;var c;var t=0;var f=0;var s=0;var p=[];var a=[];var b;var d=function(){s++;r.notify();};var g=function(h){a.push({entry:b,message:h});f++;r.notify();};for(var i=0;i<e.length;i++){if(e[i]&&e[i].isDirty===true){c=e[i].onSave();c.done(d);b=e[i].title;c.fail(g);p.push(c);t++;}}w=jQuery.when.apply(null,p);w.done(function(){r.resolve();});r.progress(function(){if(f>0&&(f+s===t)){r.reject(a);}});return r.promise();},_saveButtonHandler:function(){var s;s=this._saveUserPrefEntries();var t=this;var i=this.getView().getModel().getProperty("/userPreferences/isDetailedEntryMode");if(i){this.getView().getModel().setProperty("/userPreferences/activeEntryPath",null);}s.done(function(){t._showSaveMessageToast();});s.fail(function(f){jQuery.sap.require("sap.m.MessageBox");var e;var a="";if(f.length===1){e=t.translationBundle.getText("savingEntryError")+" ";}else{e=t.translationBundle.getText("savingEntriesError")+"\n";}f.forEach(function(b){e+=b.entry+"\n";a+="Entry: "+b.entry+" - Error message: "+b.message+"\n";});sap.m.MessageBox.show(e,{icon:sap.m.MessageBox.Icon.ERROR,title:t.translationBundle.getText("Error"),actions:[sap.m.MessageBox.Action.OK]});jQuery.sap.log.error("Failed to save the following entries",a,"sap.ushell.ui.footerbar.UserPreferencesButton");});},_showSaveMessageToast:function(){jQuery.sap.require("sap.m.MessageToast");var a=this.oResourceBundle.getText("savedChanges");sap.m.MessageToast.show(a,{duration:3000,width:"15em",my:"center bottom",at:"center bottom",of:window,offset:"0 -50",collision:"fit fit"});},createSaveButton:function(){var t=this;return new sap.m.Button({id:"userSettingSaveButton",text:sap.ushell.resources.i18n.getText("saveBtn"),press:function(){t._saveButtonHandler();t._handleSettingsDialogClose.apply(t);},visible:true});},_dialogCancelButtonHandler:function(){var e=this.getView().getModel().getProperty("/userPreferences/entries");for(var i=0;i<e.length;i++){if(e[i]&&e[i].onCancel){e[i].onCancel();}}},_handleSettingsDialogClose:function(){var v=this.getView(),s=this.getSettingsDialogContent(),f=s.oController.oMasterEntryList.getItems()[0];s.oMainApp.toMaster('userSettingMaster');s.oController.oMasterEntryList.setSelectedItem(f);v.oSettingsDialog.close();},createCancelButton:function(){var t=this;return new sap.m.Button({id:"userSettingCancelButton",text:sap.ushell.resources.i18n.getText("cancelBtn"),press:function(){t._dialogCancelButtonHandler();t._handleSettingsDialogClose.apply(t);},visible:true});},onExit:function(){this.getView().aDanglingControls.forEach(function(c){if(c.destroyContent){c.destroyContent();}c.destroy();});}});}());
