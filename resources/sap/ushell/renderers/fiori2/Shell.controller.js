// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.require("sap.ui.core.IconPool");jQuery.sap.require("sap.ushell.renderers.fiori2.History");jQuery.sap.require("sap.ushell.services.Message");jQuery.sap.require("sap.ushell.services.ShellNavigation");jQuery.sap.require("sap.ushell.services.UsageAnalytics");jQuery.sap.require("sap.ushell.services.AppConfiguration");jQuery.sap.require("sap.ushell.services.Notifications");jQuery.sap.require("sap.ushell.ui.launchpad.Fiori2LoadingDialog");jQuery.sap.require("sap.ushell.renderers.fiori2.AccessKeysHandler");jQuery.sap.require("sap.ushell.renderers.fiori2.Lifecycle");jQuery.sap.require("sap.ushell.renderers.fiori2.ShellModel");jQuery.sap.require("sap.ushell.utils");jQuery.sap.require("sap.ushell.CanvasShapesManager");jQuery.sap.require("sap.ushell.ui5service.UserStatus");jQuery.sap.require("sap.ushell.UIActions");var c=true,a=true,b=false,u,s,m,n={embedded:"embedded",newWindowThenEmbedded:"newWindowThenEmbedded",newWindow:"newWindow",replace:"replace"},C={},B,d=['minimal','app','standalone','embedded','headerless','merged','home','blank'];sap.ui.controller("sap.ushell.renderers.fiori2.Shell",{oCoreExtLoadingDeferred:undefined,onInit:function(){a=true;b=false;c=true;var C=(this.getView().getViewData()?this.getView().getViewData().config:{})||{};this.bMeAreaSelected=false;this.oEndUserFeedbackConfiguration={showAnonymous:true,anonymousByDefault:true,showLegalAgreement:true,showCustomUIContent:true,feedbackDialogTitle:true,textAreaPlaceholder:true,customUIContent:undefined};this.bUserImageAlreadyLoaded=undefined;this.bMeAreaLoaded=false;this.bNotificationsSelected=false;C["enableBackGroundShapes"]=C.enableBackGroundShapes===undefined?true:C.enableBackGroundShapes;B=this._historyBackNavigation;this.initShellModel(C);this.getView().setModel(m);this.getView().setModel(sap.ushell.resources.i18nModel,"i18n");sap.ui.getCore().getEventBus().subscribe("externalSearch",this.externalSearchTriggered,this);this._setConfigurationToModel();sap.ui.getCore().getEventBus().subscribe("launchpad","contentRendered",this._loadCoreExt,this);sap.ui.getCore().getEventBus().subscribe("sap.ushell.renderers.fiori2.Renderer","appOpened",this.loadUserImage,this);sap.ui.getCore().getEventBus().subscribe("sap.ushell.renderers.fiori2.Renderer","appOpened",this.setBackGroundShapes,this);sap.ui.getCore().getEventBus().subscribe("launchpad","coreExtLoaded",this.checkEUFeedback,this);sap.ui.getCore().getEventBus().subscribe("launchpad","coreExtLoaded",this.loadMeAreaView,this);sap.ui.getCore().getEventBus().subscribe("sap.ushell.renderers.fiori2.Renderer","appOpened",this.checkEUFeedback,this);sap.ui.getCore().getEventBus().subscribe("sap.ushell.renderers.fiori2.Renderer","appOpened",this.delayedCloseLoadingScreen,this);sap.ui.getCore().getEventBus().subscribe("launchpad","toggleContentDensity",this.toggleContentDensity,this);sap.ui.getCore().getEventBus().subscribe("sap.ushell.renderers.fiori2.Renderer","appOpened",this._loadCoreExtNWBC,this);sap.ui.getCore().getEventBus().subscribe("sap.ushell.services.Notifications","onNewNotifications",this._handleAlerts,this);sap.ui.getCore().getEventBus().subscribe("launchpad","appClosed",this.logApplicationUsage,this);sap.ui.getCore().getEventBus().subscribe("launchpad","launchpadCustomRouterRouteMatched",this._centerViewPort,this);sap.ushell.Container.getService("AppLifeCycle");sap.ushell.Container.getService("UsageAnalytics").init(sap.ushell.resources.i18n.getText("usageAnalytics"),sap.ushell.resources.i18n.getText("i_agree"),sap.ushell.resources.i18n.getText("i_disagree"),sap.ushell.resources.i18n.getText("remind_me_later"));u=sap.ushell.Container.getService("UserRecents");if(sap.ushell.Container.getService("Notifications").isEnabled()===true){m.setProperty("/enableNotifications",true);sap.ushell.Container.getService("Notifications").init();if(C.enableNotificationsUI===true){m.setProperty("/enableNotificationsUI",true);sap.ushell.Container.getService("Notifications").registerDependencyNotificationsUpdateCallback(this.notificationsCountUpdateCallback.bind(this),true);}}this.history=new sap.ushell.renderers.fiori2.History();this.oViewPortContainer=sap.ui.getCore().byId("viewPortContainer");this.oNotificationsCountButton=sap.ui.getCore().byId("NotificationsCountButton");this.oFiori2LoadingDialog=sap.ui.getCore().byId("Fiori2LoadingDialog");this.oShellNavigation=sap.ushell.Container.getService("ShellNavigation");this.oShellNavigation.registerNavigationFilter(jQuery.proxy(this._handleEmptyHash,this));this.oShellNavigation.init(jQuery.proxy(this.doHashChange,this));this.oShellNavigation.registerNavigationFilter(jQuery.proxy(this.handleDataLoss,this));sap.ushell.Container.getService("Message").init(jQuery.proxy(this.doShowMessage,this));sap.ushell.Container.setLogonFrameProvider(this._getLogonFrameProvider());this.bContactSupportEnabled=sap.ushell.Container.getService("SupportTicket").isEnabled();sap.ushell.renderers.fiori2.AccessKeysHandler.init(m);window.onbeforeunload=function(){if(sap.ushell.Container&&sap.ushell.Container.getDirtyFlag()){if(!sap.ushell.resources.browserI18n){sap.ushell.resources.browserI18n=sap.ushell.resources.getTranslationModel(window.navigator.language).getResourceBundle();}return sap.ushell.resources.browserI18n.getText("dataLossExternalMessage");}};if(m.getProperty("/contentDensity")){this._applyContentDensityClass();}if(m.getProperty("/enableNotificationsUI")===true){s.addHeaderEndItem(["NotificationsCountButton"],false,["home","app","minimal"],true);}sap.ui.Device.media.attachHandler(this.onScreenSizeChange.bind(this),null,sap.ui.Device.media.RANGESETS.SAP_STANDARD);this.onScreenSizeChange(sap.ui.Device.media.getCurrentRange(sap.ui.Device.media.RANGESETS.SAP_STANDARD));this.initShellUIService();if(this.getView().oShellNavigationMenu){this.getView().oShellNavigationMenu.setModel(m);}sap.ui.getCore().attachThemeChanged(this.redrawBackGroundShapes);},initShellModel:function(C){s=sap.ushell.renderers.fiori2.ShellModel;s.init(C);m=s.getModel();},redrawBackGroundShapes:function(){if(C.enableBackGroundShapes){sap.ushell.CanvasShapesManager.drawShapes();}},setBackGroundShapes:function(){if(!b&&C.enableBackGroundShapes){b=true;sap.ushell.CanvasShapesManager.drawShapes();}},initShellUIService:function(){jQuery.sap.require("sap.ushell.ui5service.ShellUIService");this.oShellUIService=new sap.ushell.ui5service.ShellUIService({scopeObject:this.getOwnerComponent(),scopeType:"component"});this.oShellUIService._attachHierarchyChanged(this.onHierarchyChange.bind(this));this.oShellUIService._attachTitleChanged(this.onTitleChange.bind(this));this.oShellUIService._attachRelatedAppsChanged(this.onRelatedAppsChange.bind(this));this.oShellUIService._attachBackNavigationChanged(this.onBackNavigationChange.bind(this));this.oUserStatus=new sap.ushell.ui5service.UserStatus({scopeObject:this.getOwnerComponent(),scopeType:"component"});},onHierarchyChange:function(e){this.isHierarchyChanged=true;var h=e.getParameters().data,H,E,o;if(!h){h=[];}H=this.getHierarchyDefaultValue();E=h.concat(H);o=m.getProperty("/currentState");if(o&&o.stateName==="home"){s.updateStateProperty("application/hierarchy",E,false,["home"]);}s.updateStateProperty("application/hierarchy",E,true);},onTitleChange:function(e){this.isTitleChanged=true;var t=e.getParameters().data,o;if(!t){t=this.getTitleDefaultValue();}o=m.getProperty("/currentState");if(o&&o.stateName==="home"){s.updateStateProperty("application/title",t,false,["home"]);}s.updateStateProperty("application/title",t,true);window.document.title=t;},onBackNavigationChange:function(e){this.isBackNavigationChanged=true;var f=e.getParameters().data,m=this.getModel(),o=m.getProperty('/currentState/');if(f){B=f;if(o.stateName==='minimal'||o.stateName==='standalone'||o.stateName==='embedded'){sap.ushell.Container.getRenderer('fiori2').showHeaderItem('backBtn',true);}}else{B=this._historyBackNavigation;}},onRelatedAppsChange:function(e){this.isRelatedAppsChanged=true;var r=e.getParameters().data,o;if(!r){r=[];}o=m.getProperty("/currentState");if(o&&o.stateName==="home"){s.updateStateProperty("application/relatedApps",r,false,["home"]);}s.updateStateProperty("application/relatedApps",r,true);},getHierarchyDefaultValue:function(){var h=[],o=m.getProperty("/currentState");if(o&&(o.stateName==="app"||o.stateName==="embedded")){h=[{icon:"sap-icon://home",title:sap.ushell.resources.i18n.getText("actionHomePage"),intent:C.rootIntent?"#"+C.rootIntent:"#"}];}return h;},getTitleDefaultValue:function(){var t="",e=sap.ushell.services.AppConfiguration.getMetadata();if(e&&e.title){t=e.title;}return t;},getAppIcon:function(){var i="sap-icon://folder",e=sap.ushell.services.AppConfiguration.getMetadata();if(e&&e.icon){i=e.icon;}return i;},_handleAlerts:function(e,E,N){var i,f=(this.getModel().getProperty("/currentState").stateName==="home"&&this.oViewPortContainer.getCurrentState()==='Center'),g=sap.ui.Device.system.phone;if(this.oViewPortContainer.getCurrentState()!=='RightCenter'&&(!f||g)){for(i=0;i<N.length;i++){this.handleNotification(N[i]);}}},handleNotification:function(N){var A=sap.ushell.Container.getRenderer("fiori2").addRightFloatingContainerItem({press:function(e){var v=sap.ui.getCore().byId('viewPortContainer');if(hasher.getHash()===N.NavigationTargetObject+"-"+N.NavigationTargetAction){v.switchState("Center");}else{sap.ushell.utils.toExternalWithParameters(N.NavigationTargetObject,N.NavigationTargetAction,N.NavigationTargetParams);}sap.ushell.Container.getService("Notifications").markRead(N.Id);},datetime:sap.ushell.resources.i18n.getText("notification_arrival_time_now"),title:N.SensitiveText?N.SensitiveText:N.Text,unread:N.IsRead,priority:"High",hideShowMoreButton:true},true,true);setTimeout(function(){sap.ushell.Container.getRenderer("fiori2").removeRightFloatingContainerItem(A.getId(),true);},3500);},_createActionButtons:function(){var o,e,E,U=sap.ui.getCore().byId("userSettingsBtn"),A=sap.ui.getCore().byId("aboutBtn")||new sap.ushell.ui.footerbar.AboutButton("aboutBtn");if(!U){U=new sap.ushell.ui.launchpad.ActionItem("userSettingsBtn",{id:"userSettingsBtn",text:sap.ushell.resources.i18n.getText("userSettings"),icon:'sap-icon://action-settings'});}jQuery.sap.require('sap.ushell.ui.footerbar.ContactSupportButton');jQuery.sap.require('sap.ushell.ui.footerbar.EndUserFeedback');o=sap.ui.getCore().byId("ContactSupportBtn")||new sap.ushell.ui.footerbar.ContactSupportButton("ContactSupportBtn",{visible:this.bContactSupportEnabled});E=m.getProperty('/showEndUserFeedback');if(E){e=sap.ui.getCore().byId("EndUserFeedbackBtn")||new sap.ushell.ui.footerbar.EndUserFeedback("EndUserFeedbackBtn",{showAnonymous:this.oEndUserFeedbackConfiguration.showAnonymous,anonymousByDefault:this.oEndUserFeedbackConfiguration.anonymousByDefault,showLegalAgreement:this.oEndUserFeedbackConfiguration.showLegalAgreement,showCustomUIContent:this.oEndUserFeedbackConfiguration.showCustomUIContent,feedbackDialogTitle:this.oEndUserFeedbackConfiguration.feedbackDialogTitle,textAreaPlaceholder:this.oEndUserFeedbackConfiguration.textAreaPlaceholder,customUIContent:this.oEndUserFeedbackConfiguration.customUIContent});}if(m.getProperty("/enableHelp")){U.addStyleClass('help-id-loginDetails');A.addStyleClass('help-id-aboutBtn');if(E){e.addStyleClass('help-id-EndUserFeedbackBtn');}o.addStyleClass('help-id-contactSupportBtn');}this.getView().aDanglingControls.push(o,U,A);if(E){this.getView().aDanglingControls.push(e);}},_isCompactContentDensity:function(){var i,U,f;if(!sap.ui.Device.support.touch){i=true;}else if(!sap.ui.Device.system.combi){i=false;}else{try{f=sap.ushell.Container.getService("UserInfo");U=f.getUser();}catch(e){jQuery.sap.log.error("Getting UserInfo service failed.");U=sap.ushell.Container.getUser();}i=(U.getContentDensity()==='compact')?true:false;}return i;},_applyContentDensity:function(i){if(i===undefined){i=this._isCompactContentDensity();}var e=sap.ushell.services.AppConfiguration.getMetadata(),A;A=e.compactContentDensity===undefined?true:e.compactContentDensity;if(i&&!A){i=false;}else if(A&&!e.cozyContentDensity){i=true;}this._applyContentDensityClass(i);},_applyContentDensityClass:function(i){if(i===undefined){i=this._isCompactContentDensity();}if(i){jQuery('body').removeClass('sapUiSizeCozy');jQuery('body').addClass('sapUiSizeCompact');}else{jQuery('body').removeClass('sapUiSizeCompact');jQuery('body').addClass('sapUiSizeCozy');}},toggleContentDensity:function(e,E,D){var i=D.contentDensity==="compact";this._applyContentDensity(i);},checkEUFeedback:function(){if(!this.bFeedbackServiceChecked){this.bFeedbackServiceChecked=true;try{sap.ushell.Container.getService("EndUserFeedback").isEnabled().done(function(){m.setProperty('/showEndUserFeedback',true);}).fail(function(){m.setProperty('/showEndUserFeedback',false);});}catch(e){jQuery.sap.log.error("EndUserFeedback adapter is not found",e.message||e);m.setProperty('/showEndUserFeedback',false);}}},loadMeAreaView:function(){if(!sap.ui.getCore().byId('meArea')&&!this.bMeAreaLoaded){this.bMeAreaLoaded=true;var M=sap.ui.view("meArea",{viewName:"sap.ushell.renderers.fiori2.meArea.MeArea",type:'JS',viewData:this.getView().getViewData()});this._createActionButtons();this._setUserPrefModel();this.oViewPortContainer.addLeftViewPort(M);this.oViewPortContainer.navTo('leftViewPort',M.getId());}},notificationsCountUpdateCallback:function(D){var t=this,v=this.oViewPortContainer.getCurrentState(),i=v==="RightCenter"?true:false;if((D===undefined)||(!i)){this._updateBadge();}else{D.done(function(){t._updateBadge();});}},_updateBadge:function(){var e;sap.ushell.Container.getService("Notifications").getUnseenNotificationsCount().done(function(N){e=parseInt(N,10);m.setProperty('/notificationsCount',e);}).fail(function(f){jQuery.sap.log.error("Shell.controller - call to notificationsService.getCount failed: ",f,"sap.ushell.renderers.lean.Shell");});},_handleEmptyHash:function(h){h=(typeof h==="string")?h:"";h=h.split("?")[0];if(h.length===0){var v=this.getView()?this.getView().getViewData():{};C=v.config||{};if(C.migrationConfig){return this.oShellNavigation.NavigationFilterStatus.Continue;}if(C.rootIntent){setTimeout(function(){hasher.setHash(C.rootIntent);},0);return this.oShellNavigation.NavigationFilterStatus.Abandon;}}return this.oShellNavigation.NavigationFilterStatus.Continue;},_setConfigurationToModel:function(){var v=this.getView().getViewData(),e,f;if(v){C=v.config||{};}if(C){if(C.states){f=m.getProperty('/states');for(e in C.states){if(C.states.hasOwnProperty(e)){f[e]=C.states[e];}}m.setProperty('/states',f);}if(C.appState==="headerless"||C.appState==="merged"||C.appState==="blank"){m.setProperty("/personalization",false);C.enablePersonalization=false;}else if(C.enablePersonalization!==undefined){m.setProperty("/personalization",C.enablePersonalization);}if(C.changeEndUserFeedbackTitle!==undefined){this.oEndUserFeedbackConfiguration.feedbackDialogTitle=C.changeEndUserFeedbackTitle;}if(C.changeEndUserFeedbackPlaceholder!==undefined){this.oEndUserFeedbackConfiguration.textAreaPlaceholder=C.changeEndUserFeedbackPlaceholder;}if(C.showEndUserFeedbackAnonymousCheckbox!==undefined){this.oEndUserFeedbackConfiguration.showAnonymous=C.showEndUserFeedbackAnonymousCheckbox;}if(C.makeEndUserFeedbackAnonymousByDefault!==undefined){this.oEndUserFeedbackConfiguration.anonymousByDefault=C.makeEndUserFeedbackAnonymousByDefault;}if(C.showEndUserFeedbackLegalAgreement!==undefined){this.oEndUserFeedbackConfiguration.showLegalAgreement=C.showEndUserFeedbackLegalAgreement;}if(C.enableSetTheme!==undefined){m.setProperty("/setTheme",C.enableSetTheme);}m.setProperty("/contentDensity",C.enableContentDensity===undefined?true:C.enableContentDensity);if(C.title){m.setProperty("/title",C.title);}if(C.migrationConfig!==undefined){m.setProperty("/migrationConfig",C.migrationConfig);}if(C.enableUserDefaultParameters!==undefined){m.setProperty("/userDefaultParameters",C.enableUserDefaultParameters);}if(C.disableHomeAppCache!==undefined){m.setProperty("/disableHomeAppCache",C.disableHomeAppCache);}m.setProperty("/enableHelp",!!C.enableHelp);m.setProperty("/searchAvailable",(C.enableSearch!==false));if(C.animationMode){m.setProperty("/animationMode",C.animationMode);}s.updateStateProperty("headerHiding",false,false,["home","app"]);}},getModelConfiguration:function(){var v=this.getView().getViewData(),o,S;if(v){o=v.config||{};S=jQuery.extend({},o);}delete S.applications;return S;},_getLogonFrameProvider:function(){var v=this.getView();return{create:function(){return v.createIFrameDialog();},show:function(){v.showIFrameDialog();},destroy:function(){v.destroyIFrameDialog();}};},onExit:function(){sap.ui.getCore().getEventBus().unsubscribe("externalSearch",this.externalSearchTriggered,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","contentRendered",this._loadCoreExt,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","toggleContentDensity",this.toggleContentDensity,this);sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.renderers.fiori2.Renderer","appOpened",this.loadUserImage,this);sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.renderers.fiori2.Renderer","appOpened",this.setBackGroundShapes,this);sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.renderers.fiori2.Renderer","appOpened",this.checkEUFeedback,this);sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.renderers.fiori2.Renderer","appOpened",this.delayedCloseLoadingScreen,this);sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.renderers.fiori2.Renderer","appOpened",this._loadCoreExtNWBC,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","coreExtLoaded",this.checkEUFeedback,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","coreExtLoaded",this.loadMeAreaView,this);sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.services.Notifications","onNewNotifications",this._handleAlerts,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","appClosed",this.logApplicationUsage,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","launchpadCustomRouterRouteMatched",this._centerViewPort,this);sap.ui.Device.media.detachHandler(this.onScreenSizeChange.bind(this),null,sap.ui.Device.media.RANGESETS.SAP_STANDARD);this.oShellNavigation.hashChanger.destroy();this.getView().aDanglingControls.forEach(function(o){if(o.destroyContent){o.destroyContent();}o.destroy();});sap.ushell.UserActivityLog.deactivate();if(sap.ushell.Container){if(sap.ushell.Container.getService("Notifications").isEnabled()===true){sap.ushell.Container.getService("Notifications").destroy();}}s.destroy();s=undefined;},getAnimationType:function(){return"show";},onCurtainClose:function(e){jQuery.sap.log.warning("Closing Curtain",e);},handleDataLoss:function(e,o){if(!a){a=true;this.closeLoadingScreen();return this.oShellNavigation.NavigationFilterStatus.Custom;}if(sap.ushell.Container.getDirtyFlag()){if(!sap.ushell.resources.browserI18n){sap.ushell.resources.browserI18n=sap.ushell.resources.getTranslationModel(window.navigator.language).getResourceBundle();}if(confirm(sap.ushell.resources.browserI18n.getText("dataLossInternalMessage"))){sap.ushell.Container.setDirtyFlag(false);return this.oShellNavigation.NavigationFilterStatus.Continue;}a=false;hasher.setHash(o);return this.oShellNavigation.NavigationFilterStatus.Custom;}return this.oShellNavigation.NavigationFilterStatus.Continue;},doShowMessage:function(t,M,p){jQuery.sap.require("sap.m.MessageToast");jQuery.sap.require("sap.m.MessageBox");if(t===sap.ushell.services.Message.Type.ERROR){if(sap.ushell.Container.getService("SupportTicket").isEnabled()&&M!==sap.ushell.resources.i18n.getText("supportTicketCreationFailed")){try{jQuery.sap.require("sap.ushell.ui.launchpad.EmbeddedSupportErrorMessage");var f=new sap.ushell.ui.launchpad.EmbeddedSupportErrorMessage("EmbeddedSupportErrorMessage",{title:p.title||sap.ushell.resources.i18n.getText("error"),content:new sap.m.Text({text:M})});f.open();}catch(e){sap.m.MessageBox.show(M,sap.m.MessageBox.Icon.ERROR,p.title||sap.ushell.resources.i18n.getText("error"));}}else{sap.m.MessageBox.show(M,sap.m.MessageBox.Icon.ERROR,p.title||sap.ushell.resources.i18n.getText("error"));}}else if(t===sap.ushell.services.Message.Type.CONFIRM){if(p.actions){sap.m.MessageBox.show(M,sap.m.MessageBox.Icon.QUESTION,p.title,p.actions,p.callback);}else{sap.m.MessageBox.confirm(M,p.callback,p.title);}}else{sap.m.MessageToast.show(M,{duration:p.duration||3000});}},_isColdStart:function(){if(this.history.getHistoryLength()<=1){return true;}this._isColdStart=function(){return false;};return false;},_setEnableHashChange:function(v){a=v;},_logRecentActivity:function(r){if(C&&C.enableRecentActivity){setTimeout(function(){if(sap.ushell.Container){sap.ushell.services.AppConfiguration.addActivity(r);}},700);}},_logOpenAppAction:function(f){if(C&&C.enableTilesOpacity&&C.enableRecentActivity){setTimeout(function(){if(sap.ushell.Container){u.addAppUsage(f);}},700);}},doHashChange:function(S,A,o,O,p){jQuery.sap.measure.start("FLP:ShellController.doHashChange","doHashChange","FLP");var t=this,i,f;sap.ushell.utils.addTime("ShellControllerHashChange");this.lastApplicationFullHash=O?o+O:o;if(!a){a=true;this.closeLoadingScreen();return;}if(p){this.hashChangeFailure(this.history.getHistoryLength(),p.message,null,"sap.ushell.renderers.fiori2.Shell.controller",false);return;}if(sap.m.InstanceManager&&c){sap.m.InstanceManager.closeAllDialogs();sap.m.InstanceManager.closeAllPopovers();}c=true;this.openLoadingScreen();if(sap.ushell.utils.getParameterValueBoolean("sap-ushell-no-ls")){this.closeLoadingScreen();}i=this.history.getHistoryLength();f=this.fixShellHash(S);this.history.hashChange(f,o);this.currentAppBeforeNav=sap.ushell.services.AppConfiguration.getCurrentAppliction();this._resolveHashFragment(f).done(function(r,P){var I=P?P.semanticObject+"-"+P.action:"",C=t._getConfig(),e,T=r&&r.ui5ComponentName,g=!!T,h=r&&r.componentHandle;r=t._calculateNavigationMode(P,f,r);if(r&&(r.navigationMode===n.newWindow||sap.ushell.utils.isNativeWebGuiNavigation(r))){t._openAppInNewWindowAndRestore(r);return;}if(t.getModel().getProperty("/migrationConfig")){C.migrationConfig=false;t.getModel().setProperty("/migrationConfig",false);if(r&&f==='#'){C.rootIntent="";}else if(f==='#'){setTimeout(function(){hasher.setHash(C.rootIntent);},0);return;}}if(h){t._initiateApplication(r,f,P,i);return;}if(!g){t._initiateApplication(r,f,P,i);return;}if(C&&C.applications&&C.applications[I]){r.applicationConfiguration=C.applications[I];}e=t._getExistingAppAndDestroyIfNotRoot(I);if(e){t._initiateApplication(r,f,P,i);return;}else{sap.ui.getCore().getEventBus().publish("sap.ushell.components.container.ApplicationContainer","_prior.newUI5ComponentInstantion",{name:T});jQuery.sap.measure.start("FLP:ShellController.UI5createComponent","UI5 createComponent","FLP");sap.ushell.Container.getService("Ui5ComponentLoader").createComponent(r,P,t._createWaitForRendererCreatedPromise()).done(function(R){jQuery.sap.measure.end("FLP:ShellController.UI5createComponent");t._initiateApplication(r,f,P,i);}).fail(function(E){t.hashChangeFailure(i,"Failed to load U5 component for navigation intent "+f,E,"sap.ushell.renderers.fiori2.Shell.controller",false);});}}).fail(function(M){t.hashChangeFailure(i,"Failed to resolve navigation target: \""+f+"\"",M,"sap.ushell.renderers.fiori2.Shell.controller",false);});jQuery.sap.measure.end("FLP:ShellController.doHashChange");},_initiateApplication:function(r,f,p,o){jQuery.sap.measure.start("FLP:ShellController._initiateApplication","_initiateApplication","FLP");var M=sap.ushell.services.AppConfiguration.getMetadata(r);window.document.title=M.title;if(this.bContactSupportEnabled){sap.ushell.UserActivityLog.activate();}this._logOpenAppAction(f);try{this.navigate(p,f,M,r);}catch(e){if(e.stack){jQuery.sap.log.error("Application initialization (Intent: \n"+f+"\n failed due to an Exception:\n"+e.stack);}this.hashChangeFailure(o,e.name,e.message,M?M.title:"",false);}finally{if(r&&r.coreResourcesFullyLoaded&&!this._pluginLoadingTriggered){this._pluginLoadingTriggered=true;jQuery.sap.log.info("Triggering load of 'RendererExtension' plug-ins after application initialization",null,"sap.ushell.renderers.fiori2.Shell");sap.ushell.Container.getService("PluginManager").loadPlugins("RendererExtensions");}}jQuery.sap.measure.end("FLP:ShellController._initiateApplication");},_resolveHashFragment:function(S){jQuery.sap.measure.start("FLP:ShellController._resolveHashFragment","_resolveHashFragment","FLP");var r,p,P=sap.ushell.Container.getService("URLParsing").parseShellHash(S),D=new jQuery.Deferred(),C=this._getConfig();p=P&&P.params||{};if(P&&P.contextRaw&&P.contextRaw==="navResCtx"&&p&&p.additionalInformation&&(p.additionalInformation[0]||p.additionalInformation[0]==="")&&p.applicationType&&p.applicationType[0]&&p.url&&p.url[0]&&p.navigationMode&&(p.navigationMode[0]||p.additionalInformation[0]==="")){p=P.params||{};r={additionalInformation:p.additionalInformation[0],applicationType:p.applicationType[0],url:p.url[0],navigationMode:p.navigationMode[0]};if(p.title){r.text=p.title[0];}D.resolve(r,P);}else{if(window["sap-ushell-async-libs-promise-directstart"]){window["sap-ushell-async-libs-promise-directstart"].then(function(o){D.resolve(o.resolvedHashFragment,P);delete window["sap-ushell-async-libs-promise-directstart"];},function(M){D.reject(M);delete window["sap-ushell-async-libs-promise-directstart"];});return D.promise();}sap.ushell.Container.getService("NavTargetResolution").resolveHashFragment(S).done(function(r){if(P&&(P.semanticObject+"-"+P.action)===C.rootIntent){r.navigationMode="embedded";}jQuery.sap.measure.end("FLP:ShellController._resolveHashFragment");D.resolve(r,P);}).fail(function(M){D.reject(M);});}return D.promise();},_calculateNavigationMode:function(p,f,r){if(!r){return undefined;}var N=r.navigationMode;if(N===n.newWindowThenEmbedded){if(this._isColdStart()||(p.contextRaw&&p.contextRaw==="navResCtx")||this.history.backwards){r.navigationMode=n.embedded;}else{r.navigationMode=n.newWindow;if(!sap.ushell.utils.isNativeWebGuiNavigation(r)){r.url=encodeURI(f);}}return r;}if(N===n.newWindow&&this._isColdStart()){r.navigationMode=n.replace;return r;}return r;},_handleConditionalNavigation:function(p,f,M,r){var N=r.navigationMode;if(N===n.newWindowThenEmbedded){if(this._isColdStart()||(p.contextRaw&&p.contextRaw==="navResCtx")||this.history.backwards){r.navigationMode=n.embedded;this.navigate(p,f,M,r);}else{r.navigationMode=n.newWindow;r.url=encodeURI(f);this.navigate(p,f,M,r);}return true;}if(N===n.newWindow&&this._isColdStart()){r.navigationMode=n.replace;this.navigate(p,f,M,r);return true;}return false;},_usesNavigationRedirect:function(o){if(!o){return new jQuery.Deferred().reject().promise();}var t=this,e=o.getInstance({});if(e&&typeof e.navigationRedirect==="function"){var D=new jQuery.Deferred();var N=e.navigationRedirect();if(N&&typeof N.then==="function"){N.then(function(f){jQuery.sap.log.warning("Performing navigation redirect to hash "+f);e.destroy();t.history.pop();sap.ushell.Container.getService("ShellNavigation").toExternal({target:{shellHash:f}},undefined,false);D.resolve(true);},function(){D.reject();});return D.promise();}}return new jQuery.Deferred().reject().promise();},navigate:function(p,f,M,r){jQuery.sap.measure.start("FLP:ShellController.navigate","navigate","FLP");var N=(jQuery.isPlainObject(r)?r.navigationMode:null),t=this;if(N===null){if(this._isColdStart()){hasher.setHash("");return;}a=false;this.history.pop();this._windowHistoryBack(1);return;}r=this._calculateNavigationMode(p,f,r);N=(jQuery.isPlainObject(r)?r.navigationMode:null);if(N===n.embedded){var D=this._usesNavigationRedirect(r.componentHandle);D.fail(function(){t._handleEmbeddedNavMode(f,p,M,r);if(p&&p.contextRaw==="navResCtx"){jQuery.sap.log.error(" This path will no longer be supported in 1.40");a=false;if(p&&p.params&&p.params.original_intent&&p.params.original_intent[0]){hasher.replaceHash(p.params.original_intent[0]);t.history._history[0]=p.params.original_intent[0];}}});jQuery.sap.measure.end("FLP:ShellController.navigate");return;}if(N===n.replace){a=false;this._changeWindowLocation(r.url);return;}if(N===n.newWindow){this._openAppInNewWindowAndRestore(r);return;}this.hashChangeFailure(this.history.getHistoryLength(),"Navigation mode is not recognized",null,"sap.ushell.renderers.fiori2.Shell.controller",false);},_openAppInNewWindowAndRestore:function(r){a=false;if(sap.ushell.utils.isNativeWebGuiNavigation(r)){try{var U=sap.ushell.utils.appendUserIdToUrl("sap-user",r.url);var E=sap.ushell.utils.getPrivateEpcm();E.doNavigate(U);}catch(e){if(e.stack){jQuery.sap.log.error("Application initialization failed due to an Exception:\n"+e.stack);}this.hashChangeFailure(this.history.getHistoryLength(),e.name,e.message,r.text,false);}}else{this._openAppNewWindow(r.url);}this.history.pop();var v=r.componentHandle&&r.componentHandle.getInstance&&r.componentHandle.getInstance({});if(v){v.destroy();}this._windowHistoryBack(1);sap.ushell.services.AppConfiguration.setCurrentApplication(this.currentAppBeforeNav);return;},_handleEmbeddedNavMode:function(f,p,M,r){jQuery.sap.measure.start("FLP:ShellController._handleEmbeddedNavMode","_handleEmbeddedNavMode","FLP");var A,i,l,I,e;this.resetShellUIServiceHandlers();this.setAppIcons(M);A='-'+p.semanticObject+'-'+p.action;l=(r.applicationType==="NWBC"||r.applicationType==="TR");I=f==="#"||(C.rootIntent&&C.rootIntent===p.semanticObject+"-"+p.action);if(I&&!this.oHomeApp&&!C.disableHomeAppCache){this._saveHomePageComponent();}e=p?p.semanticObject+"-"+p.action:"";if(l&&!r.explicitNavMode){if(r.applicationType==="NWBC"&&C.appState&&C.appState==="headerless"){this.switchViewState("headerless");}else{this.switchViewState("minimal");}}else if(I){this.switchViewState("home");this.oShellUIService.setBackNavigation();}else{this.switchViewState("app");}i=this.getWrappedApplication(e,M,r,A,r.fullWidth||M.fullWidth||l);if(I&&!C.disableHomeAppCache){if(!this.oViewPortContainer.getInitialCenterViewPort()){this.oViewPortContainer.setInitialCenterViewPort(i);}}this.oViewPortContainer.navTo('centerViewPort',i.getId(),'show');this._centerViewPort();jQuery.sap.measure.end("FLP:ShellController._handleEmbeddedNavMode");},_centerViewPort:function(){this.oViewPortContainer.switchState("Center");},_getExistingAppAndDestroyIfNotRoot:function(i){var e;e=this.oViewPortContainer&&(this.oViewPortContainer.getViewPortControl('centerViewPort',"application"+'-'+i)||this.oViewPortContainer.getViewPortControl('centerViewPort',"applicationShellPage"+'-'+i));if(e&&i!==C.rootIntent){this.oViewPortContainer.removeCenterViewPort(e.getId(),true);e.destroy();return null;}else if(e){return e;}},getWrappedApplication:function(i,M,r,A,f){jQuery.sap.measure.start("FLP:ShellController.getWrappedApplication","getWrappedApplication","FLP");var I,e,o,t=this;e=this._getExistingAppAndDestroyIfNotRoot(i,A);if(e){this.closeLoadingScreen();return e;}jQuery.sap.require('sap.ushell.components.container.ApplicationContainer');setTimeout(function(){setTimeout(function(){var g;if(m.getProperty("/currentState/stateName")==="app"){g="shellAppTitle";}sap.ushell.renderers.fiori2.AccessKeysHandler.sendFocusBackToShell(g);setTimeout(function(){t.readNavigationEnd();},500);},100);sap.ui.getCore().getEventBus().publish("launchpad","appOpening",r);jQuery.sap.log.info('app is being opened');},0);if(C.applications){r.applicationConfiguration=C.applications[i];}o=this._getAppContainer(A,r);r.sShellHash=i;this.publishNavigationStateEvents(o,r);if(f){if(!M.hideLightBackground){o.addStyleClass('sapMShellGlobalInnerBackground');}I=o;}else{jQuery.sap.require("sap.m.Shell");I=new sap.m.Shell("applicationShellPage"+A,{logo:sap.ui.resource('sap.ui.core','themes/base/img/1x1.gif'),title:M.title,showLogout:false,app:o}).addStyleClass("sapUshellApplicationPage");if(!M.title){I.addStyleClass("sapUshellApplicationPageNoHdr");}}this._applyContentDensity();o.onfocusin=function(){sap.ushell.renderers.fiori2.AccessKeysHandler.bFocusOnShell=false;sap.ushell.renderers.fiori2.AccessKeysHandler.bFocusPassedToExternalHandlerFirstTime=false;};o.onfocusout=function(){sap.ushell.renderers.fiori2.AccessKeysHandler.bFocusOnShell=true;sap.ushell.renderers.fiori2.AccessKeysHandler.bFocusPassedToExternalHandlerFirstTime=true;};this.oViewPortContainer.addCenterViewPort(I);setTimeout(function(){t.closeLoadingScreen();},0);jQuery.sap.measure.end("FLP:ShellController.getWrappedApplication");return I;},resetShellUIServiceHandlers:function(){this.isHierarchyChanged=false;this.isTitleChanged=false;this.isRelatedAppsChanged=false;this.isBackNavigationChanged=false;},_publicEventDataFromResolutionResult:function(A){var p={};if(!A){return A;}["applicationType","ui5ComponentName","url","additionalInformation","text"].forEach(function(P){p[P]=A[P];});Object.freeze(p);return p;},onAppAfterRendering:function(A){setTimeout(function(){sap.ui.getCore().getEventBus().publish("launchpad","appOpened",A);jQuery.sap.log.info('app was opened');},0);var o=this._publicEventDataFromResolutionResult(A);sap.ushell.renderers.fiori2.utils.publishExternalEvent("appOpened",o);if(this.oShellUIService){if(!this.isHierarchyChanged){this.oShellUIService.setHierarchy();}if(!this.isTitleChanged){this.oShellUIService.setTitle();}if(!this.isRelatedAppsChanged){this.oShellUIService.setRelatedApps();}if(!this.isBackNavigationChanged){this.oShellUIService.setBackNavigation();}}s.updateStateProperty("application/icon",this.getAppIcon(),true);s.updateStateProperty("application/showNavMenuTitle",this.bNavMenuTitleVisible,true);},_getAppContainer:function(A,r){if(!this.oShellUIService){this.initShellUIService();}r.shellUIService=this.oShellUIService.getInterface();var o=new sap.ushell.components.container.ApplicationContainer("application"+A,r);return o;},_saveHomePageComponent:function(){if(this.oHomeApp){return;}var t=this,e="sap.ushell.components.container.ApplicationContainer",l=function(E,f,D){t.oHomeApp=D.component;sap.ui.getCore().getEventBus().unsubscribe(e,'componentCreated',l);};sap.ui.getCore().getEventBus().subscribe(e,'componentCreated',l);},hashChangeFailure:function(h,M,D,e,E){this.reportError(M,D,e);this.closeLoadingScreen();this.delayedMessageError(sap.ushell.resources.i18n.getText("fail_to_start_app_try_later"));c=false;if(h===0){hasher.setHash("");}else{if(jQuery.sap.getUriParameters().get("bFallbackToShellHome")){hasher.setHash("");}else{a=E;this._windowHistoryBack(1);}}},reportError:function(M,D,e){jQuery.sap.log.error(M,D,e);},delayedMessageError:function(M){setTimeout(function(){if(sap.ushell.Container!==undefined){sap.ushell.Container.getService("Message").error(M);}},0);},fixShellHash:function(S){if(!S){S='#';}else if(S.charAt(0)!=='#'){S='#'+S;}return S;},publishNavigationStateEvents:function(A,o){var e,i=A.getId?A.getId():"",t=this;var f=sap.ushell.services.AppConfiguration.getMetadata(),I=f.icon,T=f.title;A.addEventDelegate({onAfterRendering:this.onAppAfterRendering.bind(this,o)});e=A.exit;A.exit=function(){if(e){e.apply(this,arguments);}t._applyContentDensity();setTimeout(function(){var E=jQuery.extend(true,{},o);delete E.componentHandle;E["appId"]=i;E["usageIcon"]=I;E["usageTitle"]=T;sap.ui.getCore().getEventBus().publish("launchpad","appClosed",E);jQuery.sap.log.info('app was closed');},0);var p=t._publicEventDataFromResolutionResult(o);sap.ushell.renderers.fiori2.utils.publishExternalEvent("appClosed",p);};},_openAppNewWindow:function(U){var e=window.open(U);if(!e){var f=sap.ushell.resources.i18n.getText("fail_to_start_app_popup_blocker");this.delayedMessageError(f);}},_windowHistoryBack:function(S){window.history.back(S);},_changeWindowLocation:function(U){window.location.href=U;},setAppIcons:function(M){jQuery.sap.measure.start("FLP:ShellController.setAppIcons","setAppIcons","FLP");var e=jQuery.sap.getModulePath("sap.ushell"),l=(M&&M.homeScreenIconPhone)||(e+'/themes/base/img/launchicons/57_iPhone_Desktop_Launch.png'),L=(M&&M["homeScreenIconPhone@2"])||(e+'/themes/base/img/launchicons/114_iPhone-Retina_Web_Clip.png'),o=(M&&M.homeScreenIconTablet)||(e+'/themes/base/img/launchicons/72_iPad_Desktop_Launch.png'),f=(M&&M["homeScreenIconTablet@2"])||(e+'/themes/base/img/launchicons/144_iPad_Retina_Web_Clip.png'),F=(M&&M.favIcon)||(this._getDefaultFavIcon()),g=this.getFavIconHref();if(sap.ui.Device.os.ios){jQuery.sap.setIcons({'phone':l,'phone@2':L,'tablet':o,'tablet@2':f,'favicon':F,'precomposed':true});}else if(g!==F){jQuery.sap.setIcons({'phone':'','phone@2':'','tablet':'','tablet@2':'','favicon':F,'precomposed':true});}jQuery.sap.measure.end("FLP:ShellController.setAppIcons");},_getDefaultFavIcon:function(){jQuery.sap.require("sap.ui.core.theming.Parameters");var f=sap.ui.core.theming.Parameters.get('@sapFavicon');if(f){var e=/url[\s]*\('?"?([^\'")]*)'?"?\)/.exec(f);if(e){f=e[1];}else if(f==="''"||f==="none"){f=null;}}if(!f){var M=jQuery.sap.getModulePath("sap.ushell");return M+'/themes/base/img/launchpad_favicon.ico';}return f;},handleEndItemsOverflow:function(p){var e=this.getModel().getProperty("/currentState/headEndItems");if(p.name==='Phone'){if(e.indexOf("endItemsOverflowBtn")===-1){s.addHeaderEndItem(["endItemsOverflowBtn"],false,["home","app"]);}}else{if(e.indexOf("endItemsOverflowBtn")>-1){s.removeHeaderEndItem(["endItemsOverflowBtn"],false,["home","app"]);}var P=sap.ui.getCore().byId('headEndItemsOverflow');if(P){P.destroy();}}},isHeadEndItemOverflow:function(){var e=this.getModel().getProperty("/currentState/headEndItems");if(e.indexOf("endItemsOverflowBtn")===-1){return false;}else{return e.length>3;}},isHeadEndItemInOverflow:function(e){return e!=="ENDITEMSOVERFLOWBTN"&&!this.isHeadEndItemNotInOverflow(e);},isHeadEndItemNotInOverflow:function(e){if(this.isHeadEndItemOverflow()){if(e==="NOTIFICATIONSCOUNTBUTTON"||e==="ENDITEMSOVERFLOWBTN"){return true;}else{return false;}}else{if(e==="ENDITEMSOVERFLOWBTN"){return false;}else{return true;}}},pressEndItemsOverflow:function(e){if(!sap.ui.Device.system.desktop){var o=m.getProperty("/currentState").headerHiding;if(o){m.setProperty("/currentState/headerHiding",false);}}var p=sap.ui.getCore().byId('headEndItemsOverflow');function f(){p.close();}var i;if(p){i=p.getContent()[0];}else{var F=new sap.ui.model.Filter('','EQ','a');F.fnTest=this.isHeadEndItemInOverflow.bind(this);i=new sap.ui.layout.VerticalLayout({content:{path:"/currentState/headEndItems",filters:[F],factory:function(I,g){var h=sap.ui.getCore().byId(g.getObject());h.detachPress(f);h.attachPress(f);return h;}}});p=new sap.m.Popover("headEndItemsOverflow",{placement:sap.m.PlacementType.Bottom,showHeader:false,showArrow:false,content:i}).addStyleClass("sapUshellPopupContainer");i.updateAggregation=this.getView().updateShellAggregation;p.setModel(m);this.getView().aDanglingControls.push(p);p.attachAfterClose(p,function(){if(!sap.ui.Device.system.desktop){if(o){m.setProperty("/currentState/headerHiding",o);}}});}if(p.isOpen()){p.close();}else{i.updateAggregation("content");p.openBy(e.getSource());}},getFavIconHref:function(){return jQuery('link').filter('[rel="shortcut icon"]').attr('href')||'';},externalSearchTriggered:function(e,E,D){m.setProperty("/searchTerm",D.searchTerm);D.query=D.searchTerm;},onAfterNavigate:function(e){this.closeLoadingScreen();var h=this.oViewPortContainer.getInitialCenterViewPort(),f=e.getParameter("fromId"),F=e.getParameter("from");if(f&&f!==h){this.oViewPortContainer.removeCenterViewPort(f,true);F.destroy();}sap.ushell.utils.addTime("ShellController.onAfterNavigate");if(e.mParameters&&e.mParameters.toId===h){sap.ui.getCore().byId("configBtn").focus();if(this.oHomeApp&&this.oHomeApp.setInitialConfiguration){this.oHomeApp.setInitialConfiguration();}}},logApplicationUsage:function(e,N,A){if(C&&C.enableRecentActivity){var i=A.appId,I=i,r={};r.title=A.usageTitle;r.appType=sap.ushell.services.AppType.APP;r.url='#'+this.lastApplicationFullHash;if(i.indexOf('-')>0){I=i.substr(i.indexOf('-')+1);}r.appId='#'+I;if(I==="Action-search"){r.appType=sap.ushell.services.AppType.SEARCH;}this._logRecentActivity(r);}},openLoadingScreen:function(){jQuery.sap.measure.start("FLP:ShellController.openLoadingScreen","openLoadingScreen","FLP");if(this.oFiori2LoadingDialog){var A=m.getProperty('/animationMode');var A=A||'full';this.oFiori2LoadingDialog.openLoadingScreen(A);}jQuery.sap.measure.end("FLP:ShellController.openLoadingScreen");},closeLoadingScreen:function(){if(this.oFiori2LoadingDialog){this.oFiori2LoadingDialog.closeLoadingScreen();}},readNavigationEnd:function(){var A=document.getElementById("sapUshellLoadingAccessibilityHelper-loadingComplete");if(A){A.setAttribute("aria-live","polite");A.innerHTML=sap.ushell.resources.i18n.getText("loadingComplete");setTimeout(function(){A.setAttribute("aria-live","off");A.innerHTML="";},0);}},delayedCloseLoadingScreen:function(){setTimeout(function(){this.closeLoadingScreen();}.bind(this),600);},togglePane:function(e){var S=e.getSource(),f=S.getSelected();sap.ui.getCore().getEventBus().publish("launchpad","togglePane",{currentContent:S.getModel().getProperty("/currentState/paneContent")});if(e.getParameter("id")==="categoriesBtn"){S.getModel().setProperty("/currentState/showCurtainPane",!f);}else{S.getModel().setProperty("/currentState/showPane",!f);}},toggleNotificationsView:function(e){var S=e.getSource(),N,o=sap.ushell.Container.getService("Notifications"),f=sap.ui.getCore().byId("notifications-preview-container");this.bMeAreaSelected=false;var M=sap.ui.getCore().byId("meAreaHeaderButton");if(M){M.setSelected(false);jQuery(M.getDomRef()).attr("aria-pressed","false");}if(!sap.ui.getCore().byId('notificationsView')){N=sap.ui.view("notificationsView",{viewName:"sap.ushell.renderers.fiori2.notifications.Notifications",type:'JS',viewData:{}});this.oViewPortContainer.addRightViewPort(N);}this.bNotificationsSelected=S.getSelected();if(this.bNotificationsSelected){this._switchViewPortStateByControl(S,"Center");}else{this.getView().getModel().setProperty("/notificationsCount",0);if(f){f.setFloatingContainerItemsVisiblity(false);var i=f.getFloatingContainerItems().length;setTimeout(function(){this.oViewPortContainer.navTo('rightViewPort',"notificationsView",'show');this._switchViewPortStateByControl(S,"RightCenter");sap.ui.getCore().getEventBus().publish("launchpad","notificationViewOpened");}.bind(this),300+(i*100));}else{this.oViewPortContainer.navTo('rightViewPort',"notificationsView",'show');this._switchViewPortStateByControl(S,"RightCenter");sap.ui.getCore().getEventBus().publish("launchpad","notificationViewOpened");}}this.bNotificationsSelected=!this.bNotificationsSelected;S.setSelected(this.bNotificationsSelected);o.notificationsSeen();this.getView().getModel().setProperty("/notificationsCount",0);jQuery(S.getDomRef()).attr("aria-pressed",this.bNotificationsSelected);jQuery(S.getDomRef()).attr("aria-label",sap.ushell.resources.i18n.getText("NotificationToggleButtonCollapsedNoNotifications"));},toggleMeAreaView:function(e){var S=e.getSource(),f=S.getSelected(),m=this.getModel(),g=m.getProperty('/currentState/stateName');this.bMeAreaSelected=!f;if(g==='embedded'||g==='embedded-home'||g==='standalone'||g==='blank-home'||g==='blank'){if(!f){this.loadMeAreaView();}this._showActionsInPopOver(S);}else{this._switchToMeAreaView(S);}var N=sap.ui.getCore().byId("NotificationsCountButton");if(N&&this.bNotificationsSelected){this.bNotificationsSelected=false;N.setSelected(false);jQuery(N.getDomRef()).attr("aria-pressed","false");}jQuery(S.getDomRef()).attr("aria-pressed",this.bMeAreaSelected);},_showActionsInPopOver:function(o){var m=this.getModel(),e=m.getProperty('/currentState/actions');if(!this.oActionsPopover){this.oActionsLayout=new sap.ui.layout.VerticalLayout();this.oActionsPopover=new sap.m.Popover("sapUshellActionsPopover",{showHeader:false,placement:sap.m.PlacementType.Bottom,content:this.oActionsLayout}).addStyleClass("sapUshellPopupContainer");}this.oActionsLayout.removeAllContent();this._createActionButtons();e.forEach(function(A,i){var f=sap.ui.getCore().byId(A);if(f&&f.setActionType){this.oActionsLayout.addContent(f);f.setActionType('standard');f.addStyleClass('sapUshellStandardActionItem');}}.bind(this));this.oActionsPopover.openBy(o);this.oActionsPopover.setModel(m);},_switchToMeAreaView:function(o){var e=o.getSelected();if(e){this._switchViewPortStateByControl(o,"Center");}else{this._switchViewPortStateByControl(o,"LeftCenter");this.loadMeAreaView();}},_switchViewPortStateByControl:function(o,S){var e=false,v=this.oViewPortContainer;if(o&&o.setEnabled&&typeof o.setEnabled==="function"){e=true;}if(e){o.addStyleClass("sapUshellShellHeadItemOverrideDisableStyle");o.setEnabled(false);}function A(){o.setEnabled(true);o.removeStyleClass("sapUshellShellHeadItemOverrideDisableStyle");v.detachAfterSwitchStateAnimationFinished(A);}if(e){v.attachAfterSwitchStateAnimationFinished(A);}v.switchState(S);},onScreenSizeChange:function(p){this.validateShowLogo(p);this.handleNavMenuTitleVisibility(p);this._handleHomeAndBackButtonsVisibility(p);this.handleEndItemsOverflow(p);},_handleHomeAndBackButtonsVisibility:function(p){var m=sap.ushell.renderers.fiori2.ShellModel.getModel(),i=m.getProperty('/currentViewPortState')==='Center',e=sap.ui.Device.media.getCurrentRange(sap.ui.Device.media.RANGESETS.SAP_STANDARD).name,h=sap.ui.getCore().byId("homeBtn"),o=sap.ui.getCore().byId("backBtn"),H=e==="Desktop",f=e!=="Phone"||i;if(h){h.setVisible(H);}if(o){o.setVisible(f);}},validateShowLogo:function(p){var e;var f=this.getModel().getProperty('/currentState/stateName');var i=f==='merged'||f==='headerless'||f==='headerless-home'||f==='merged-home';if(p){e=p.name;}else{e=sap.ui.Device.media.getCurrentRange(sap.ui.Device.media.RANGESETS.SAP_STANDARD).name;}var S=true;if(e==="Phone"&&!this.bMeAreaSelected||i){S=false;}s.updateStateProperty("showLogo",S,false,["home","app","blank","blank-home"],true);},handleNavMenuTitleVisibility:function(p){this.bNavMenuTitleVisible=false;if(p.name!=="Desktop"){this.bNavMenuTitleVisible=true;}s.updateStateProperty("application/showNavMenuTitle",this.bNavMenuTitleVisible,true);},navigateFromShellApplicationNavigationMenu:function(i){this.oViewPortContainer.switchState("Center");hasher.setHash(i);var S=sap.ui.getCore().byId("shellAppTitle");if(S){S.close();}},loadUserImage:function(){if(!this.bUserImageAlreadyLoaded){this.getView().loadUserImage();this.bUserImageAlreadyLoaded=true;}},_loadCoreExtNWBC:function(S,e,A){if(A&&A.applicationType=="NWBC"){setTimeout(this._loadCoreExt,2000);}},_loadCoreExt:function(){var A=jQuery.sap.isDeclared('sap.fiori.core',true)||jQuery.sap.isDeclared('sap.fiori.core-ext-light',true),M=window['sap-ui-debug']===true?'sap/fiori/core-ext-light-dbg.js':'sap/fiori/core-ext-light.js',t=this;function l(){if(!t._pluginLoadingTriggered){t._pluginLoadingTriggered=true;jQuery.sap.log.info("Triggering load of 'RendererExtension' plug-ins after loading core-ext module (after home page content rendered)",null,"sap.ushell.renderers.fiori2.Shell");sap.ushell.Container.getService("PluginManager").loadPlugins("RendererExtensions");}}if(A){l();return;}this.oCoreExtLoadingDeferred=new jQuery.Deferred();jQuery.sap._loadJSResourceAsync(M).then(function(){l();t.oCoreExtLoadingDeferred.resolve();t._publishCoreExtLoadedEvent();}).catch(function(){l();jQuery.sap.log.warning('failed to load sap.fiori.core-ext-light');t.oCoreExtLoadingDeferred.reject();});},_publishCoreExtLoadedEvent:function(){setTimeout(function(){sap.ui.getCore().getEventBus().publish("launchpad","coreExtLoaded");},0);},getCurrentViewportState:function(){var v=m.getProperty('/currentViewPortState');return v;},makeEndUserFeedbackAnonymousByDefault:function(e){this.oEndUserFeedbackConfiguration.anonymousByDefault=e;},showEndUserFeedbackLegalAgreement:function(S){this.oEndUserFeedbackConfiguration.showLegalAgreement=S;},setFloatingContainerDragSelector:function(e){jQuery(e).addClass("sapUshellShellFloatingContainerSelector");if(this.oFloatingUIActions){this.oFloatingUIActions.delete();}this.oFloatingUIActions=new sap.ushell.UIActions({containerSelector:".sapUiBody",wrapperSelector:'.sapUshellShellFloatingContainerWrapper',draggableSelector:'.sapUshellShellFloatingContainerWrapper',rootSelector:".sapUiBody",cloneClass:"sapUshellFloatingContainer-clone",dragCallback:this._handleFloatingContainerUIStart.bind(this),endCallback:this._handleFloatingContainerDrop.bind(this),moveTolerance:3,switchModeDelay:1000,isLayoutEngine:false,isTouch:false,elementToCapture:e,debug:jQuery.sap.debug()}).enable();},_handleFloatingContainerDrop:function(e,f,D){var F=f.firstChild?sap.ui.getCore().byId(f.firstChild.id):undefined,g=jQuery.sap.storage(jQuery.sap.storage.Type.local,"com.sap.ushell.adapters.local.FloatingContainer"),w=jQuery(window).width(),W=jQuery(window).height(),p=D.deltaX/w,P=D.deltaY/W,o=f.style.visibility,O=f.style.display,i=parseFloat(f.style.left.replace("%","")),h=parseFloat(f.style.top.replace("%",""));f.style.visibility='hidden';f.style.display='block';if(typeof(i)==='number'){p=i+100*D.deltaX/w;}if(typeof(h)==='number'){P=h+100*D.deltaY/W;}f.setAttribute("style","left:"+p+"%;top:"+P+"%;position:absolute;");f.visibility=o;f.display=O;g.put("floatingContainerStyle",f.getAttribute("style"));if(F){F.handleDrop();}},_handleFloatingContainerUIStart:function(f,g){var h=g;h.style.display="none";if(window.getSelection){var i=window.getSelection();try{i.removeAllRanges();}catch(e){}}},setFloatingContainerVisibility:function(v){this.getView().getOUnifiedShell().setFloatingContainerVisible(v);},getFloatingContainerVisibility:function(){return this.getView().getOUnifiedShell().getFloatingContainerVisible();},setFloatingContainerContent:function(p,i,e,S){var f=document.querySelector(".sapUshellShellFloatingContainerWrapper"),g=jQuery.sap.storage(jQuery.sap.storage.Type.local,"com.sap.ushell.adapters.local.FloatingContainer");if(g.get("floatingContainerStyle")){f.setAttribute("style",g.get("floatingContainerStyle"));}else{var h=jQuery(".sapUshellShellHeadItm").position()?jQuery(".sapUshellShellHeadItm").position().left:0;var l=(jQuery(window).width()-jQuery("#shell-floatingContainer").width()-h)*100/jQuery(window).width();var t=jQuery(".sapUshellShellHeadContainer").height()*100/jQuery(window).height();f.setAttribute("style","left:"+l+"%;"+"top:"+t+"%;position:absolute;");}s.setFloatingContainerContent(p,i,e,S);},getRightFloatingContainerVisibility:function(){var r=this.getView().getOUnifiedShell().getRightFloatingContainer(),R=r&&r.getVisible();return R;},setHeaderTitle:function(t,i){if(typeof t!=="string"){throw new Error("sTitle type is invalid");}this.getView().getOUnifiedShell().getHeader().setTitleControl(t,i);},addEndUserFeedbackCustomUI:function(o,S){if(o){this.oEndUserFeedbackConfiguration.customUIContent=o;}if(S===false){this.oEndUserFeedbackConfiguration.showCustomUIContent=S;}},setFooter:function(f){if(typeof f!=="object"||!f.getId){throw new Error("oFooter value is invalid");}if(this.getView().oShellPage.getFooter()!==null){jQuery.sap.log.warning("You can only set one footer. Replacing existing footer: "+this.getView().oShellPage.getFooter().getId()+", with the new footer: "+f.getId()+".");}this.getView().oShellPage.setFooter(f);},removeFooter:function(){if(this.getView().oShellPage.getFooter()===null){jQuery.sap.log.warning("There is no footer to remove.");return;}this.getView().oShellPage.setFooter(null);},addUserPreferencesEntry:function(e){this._validateUserPrefEntryConfiguration(e);this._updateUserPrefModel(e);},addUserProfilingEntry:function(e){this._validateUserPrefEntryConfiguration(e);this._updateProfilingModel(e);},_validateUserPrefEntryConfiguration:function(e){if((!e)||(typeof e!=="object")){throw new Error("object oConfig was not provided");}if(!e.title){throw new Error("title was not provided");}if(!e.value){throw new Error("value was not provided");}if(typeof e.entryHelpID!=="undefined"){if(typeof e.entryHelpID!=="string"){throw new Error("entryHelpID type is invalid");}else{if(e.entryHelpID===""){throw new Error("entryHelpID type is invalid");}}}if(e.title&&typeof e.title!=="string"){throw new Error("title type is invalid");}if(typeof e.value!=="function"&&typeof e.value!=="string"&&typeof e.value!=="number"){throw new Error("value type is invalid");}if(e.onSave&&typeof e.onSave!=="function"){throw new Error("onSave type is invalid");}if(e.content&&typeof e.content!=="function"){throw new Error("content type is invalid");}if(e.onCancel&&typeof e.onCancel!=="function"){throw new Error("onCancel type is invalid");}},switchViewState:function(S,e){var A=S;if(S==='home'&&(C.appState==='embedded'||C.appState=='headerless'||C.appState=='merged'||C.appState=='blank')){A=C.appState+'-home';}else if(S==='app'&&d.indexOf(C.appState)>=0){A=C.appState;}var o=s.switchState(A,e);if(S==="searchResults"){m.setProperty("/lastSearchScreen",'');if(!hasher.getHash().indexOf("Action-search")===0){var f=sap.ui.getCore().getModel("searchModel");hasher.setHash("Action-search&/searchTerm="+f.getProperty("/uiFilter/searchTerms")+"&dataSource="+JSON.stringify(f.getProperty("/uiFilter/dataSource").getJson()));}}this._handleHomeAndBackButtonsVisibility();sap.ui.getCore().getEventBus().publish("launchpad","shellViewStateChanged",o);},_navBack:function(){this.bMeAreaSelected=false;B();},_historyBackNavigation:function(){window.history.back();},_updateUserPrefModel:function(e){var f=this._getModelEntryFromEntryObject(e),g=m.getProperty("/userPreferences/entries");g.push(f);g=this._reorderUserPrefEntries(g);m.setProperty("/userPreferences/entries",g);},_updateProfilingModel:function(e){var f=this._getModelEntryFromEntryObject(e),g=m.getProperty("/userPreferences/profiling")||[];g.push(f);m.setProperty("/userPreferences/profiling",g);},_getModelEntryFromEntryObject:function(e){return{"entryHelpID":e.entryHelpID,"title":e.title,"editable":e.content?true:false,"valueArgument":e.value,"valueResult":null,"onSave":e.onSave,"onCancel":e.onCancel,"contentFunc":e.content,"contentResult":null,"icon":e.icon};},pressActionBtn:function(e){if(!sap.ui.Device.system.desktop){var o=m.getProperty("/currentState").headerHiding;if(o){m.setProperty("/currentState/headerHiding",false);}}var A=sap.ui.getCore().byId('headActions');if(!A){this._createActionButtons();var f=new sap.ui.model.Filter('','EQ','a');f.fnTest=function(g){var h=m.getProperty("/currentState/actions"),i,j;for(j=0;j<h.length;j++){i=h[j];if(i.toUpperCase()==g){return!!sap.ui.getCore().byId(i);}}};A=new sap.m.ActionSheet("headActions",{placement:sap.m.PlacementType.Bottom,buttons:{path:"/currentState/actions",filters:[f],factory:function(i,g){var h=sap.ui.getCore().byId(g.getObject());if(h&&h.setActionType){h.setActionType("standart");}return h;}}});A.updateAggregation=this.getView().updateShellAggregation;A.setModel(m);this.getView().aDanglingControls.push(A);A.attachAfterClose(A,function(){if(!sap.ui.Device.system.desktop){if(o){m.setProperty("/currentState/headerHiding",o);}}});}A.updateAggregation("buttons");A.openBy(e.getSource());},_setUserPrefModel:function(){var e=m.getProperty("/userPreferences/entries");var D=this._getUserPrefDefaultModel();D.entries=D.entries.concat(e);D.entries=this._reorderUserPrefEntries(D.entries);m.setProperty("/userPreferences",D);},_reorderUserPrefEntries:function(e){var f,t;for(var i=0;i<e.length;i++){if(e[i].entryHelpID==="flpSettingsEntry"){f=i;}else if(e[i].entryHelpID==="themes"){t=i;}if(f!=undefined&&t!=undefined){var g=e.splice(f,1);e.splice(t+1,0,g[0]);break;}}return e;},_getUserPrefDefaultModel:function(){var t=this;var U=sap.ushell.Container.getUser();jQuery.sap.require('sap.ushell.renderers.fiori2.search.userpref.SearchPrefs');var S=sap.ushell.renderers.fiori2.search.userpref.SearchPrefs;var e=S.getEntry();e.isSearchPrefsActive().done(function(o){if(!o){return;}t.addUserProfilingEntry(e);});function G(v,o,q,r,w,x,y,z,A,D,m,E,F){this.view=null;this.getView=function(){if(!this.view||!sap.ui.getCore().byId(v)){if(q==="xml"){this.view=sap.ui.xmlview(v,o);}else{this.view=sap.ui.jsview(v,o);}}if(m){this.view.setModel(m);}return this.view;};return{entryHelpID:r,title:w,valueResult:null,onSave:x?x.bind(this):function(){if(this.getView().getController().onSave){return this.getView().getController().onSave();}return;}.bind(this),onCancel:y?y.bind(this):function(){if(this.getView().getController().onCancel){return this.getView().getController().onCancel();}return;}.bind(this),contentFunc:z?z.bind(this):function(){if(this.getView().getController().getContent){return this.getView().getController().getContent();}return;}.bind(this),valueArgument:A?A.bind(this):function(){var H=jQuery.Deferred(),t=this;setTimeout(function(){if(t.getView().getController().getValue){t.getView().getController().getValue().done(function(I){H.resolve(I);});}},0);return H.promise();}.bind(this),editable:typeof D==="function"?D():D,contentResult:null,icon:E,defaultVisibility:F};}var f=new G("userPrefThemeSelector","sap.ushell.renderers.fiori2.theme_selector.ThemeSelector","xml","themes",sap.ushell.resources.i18n.getText("Appearance"),function(){var o=this.getView().getController().onSave();o.done(function(){if(m.getProperty("/tilesOpacity")===true){sap.ushell.utils.handleTilesOpacity();}});return o;},undefined,undefined,undefined,function(){if(m.getProperty("/setTheme")!==undefined){return m.getProperty("/setTheme")&&U.isSetThemePermitted();}else{return U.isSetThemePermitted();}},this.getView().getModel(),"sap-icon://palette");var g=new G("userPrefUsageAnalyticsSelector","sap.ushell.renderers.fiori2.usageAnalytics_selector.UsageAnalyticsSelector","js","usageAnalytics",sap.ushell.resources.i18n.getText("usageAnalytics"),undefined,undefined,undefined,undefined,sap.ushell.Container.getService("UsageAnalytics").isSetUsageAnalyticsPermitted());var h=new G("defaultParametersSelector","sap.ushell.renderers.fiori2.defaultParameters_selector.DefaultParameters","js",undefined,sap.ushell.resources.i18n.getText("defaultsValuesEntry"),undefined,undefined,undefined,undefined,true,undefined,undefined,false);var i=new G("userProfilingView","sap.ushell.renderers.fiori2.profiling.UserProfiling","js","userProfiling",sap.ushell.resources.i18n.getText("userProfiling"),undefined,undefined,undefined,undefined,false,this.getView().getModel(),"sap-icon://user-settings",false);function L(){this.view=null;this.getView=function getView(){if(!this.languageRegionSelector){this.languageRegionSelector=sap.ui.jsview("languageRegionSelector","sap.ushell.renderers.fiori2.userPreferences.LanguageRegionSelector");}return this.languageRegionSelector;};var o=function(){var w=this.getView().getController().onSave();return w;}.bind(this);var q=function(){return this.getView().getController().onCancel();}.bind(this);var r=function(){return this.getView().getController().getContent();}.bind(this);var v=function(){return this.getView().getController().getValue();}.bind(this);return{entryHelpID:"language",title:sap.ushell.resources.i18n.getText("languageRegionTit"),editable:true,valueArgument:v,valueResult:null,onSave:o,onCancel:q,contentFunc:r,contentResult:null,icon:"sap-icon://globe"};}function j(){this.view=null;this.getView=function getView(){if(!this.userAccountSelector){this.userAccountSelector=sap.ui.jsview("UserAccountSelector","sap.ushell.renderers.fiori2.userAccount.UserAccountSelector");}return this.userAccountSelector;};var o=function(){var w=this.getView().getController().onSave();return w;}.bind(this);var q=function(){return this.getView().getController().onCancel();}.bind(this);var r=function(){return this.getView().getController().getContent();}.bind(this);var v=function(){return this.getView().getController().getValue();}.bind(this);return{entryHelpID:"userAccountEntry",title:sap.ushell.resources.i18n.getText("UserAccountFld"),editable:true,valueArgument:v,valueResult:null,onSave:o,onCancel:q,contentFunc:r,contentResult:null,icon:"sap-icon://account"};}var k=[new j(),f,new L()],p=[];p.push(g);k.push(i);if(m.getProperty("/enableNotifications")===true){var N=sap.ushell.Container.getService("Notifications")._getNotificationSettingsAvalability(),l;l=new G("notificationSettings","sap.ushell.renderers.fiori2.notifications.Settings","js",undefined,sap.ushell.resources.i18n.getText("notificationSettingsEntry_title"),undefined,undefined,undefined,undefined,true,undefined,"sap-icon://ui-notifications",false);k.push(l);N.done(function(o){if(o.settingsAvailable){l.visible=true;m.getProperty("/userPreferences/entries").every(function(q,r){if(q.title===sap.ushell.resources.i18n.getText("notificationSettingsEntry_title")){m.setProperty("/userPreferences/entries/"+r+"/visible",true);return false;}return true;});}});}if(m.getProperty("/userDefaultParameters")){k.push(h);}return{dialogTitle:sap.ushell.resources.i18n.getText("userSettings"),isDetailedEntryMode:false,activeEntryPath:null,entries:k,profiling:p};},onAfterViewPortSwitchState:function(e){var t=e.getParameter("to");var S=sap.ui.getCore().byId("shellAppTitle");m.setProperty("/currentViewPortState",t);if(this.applicationKeyHandler){sap.ushell.renderers.fiori2.AccessKeysHandler.registerAppKeysHandler(this.applicationKeyHandler);this.applicationKeyHandler=undefined;}sap.ui.getCore().getEventBus().publish("launchpad","afterSwitchState",e);if(t==="Center"){S.setVisible(true);this.bMeAreaSelected=false;}else{S.setVisible(false);if(t==="Right"){this.bMeAreaSelected=false;}else if(t=="RightCenter"){this.applicationKeyHandler=sap.ushell.renderers.fiori2.AccessKeysHandler.getAppKeysHandler();sap.ushell.renderers.fiori2.AccessKeysHandler.bFocusOnShell=false;sap.ushell.renderers.fiori2.AccessKeysHandler.registerAppKeysHandler(sap.ui.getCore().byId("notificationsView").getController().keydownHandler.bind(sap.ui.getCore().byId("notificationsView")));}}this.validateShowLogo();this._handleHomeAndBackButtonsVisibility();},getModel:function(){return m;},_getConfig:function(){return C?C:{};},_createWaitForRendererCreatedPromise:function(){var p,r;r=sap.ushell.Container.getRenderer();if(r){jQuery.sap.log.debug("Shell controller._createWaitForRendererCreatedPromise: shell renderer already created, return empty array.");return[];}else{p=new Promise(function(e,f){var o;o=function(){jQuery.sap.log.info("Shell controller: resolving component waitFor promise after shell renderer created event fired.");e();sap.ushell.Container.detachRendererCreatedEvent(o);};r=sap.ushell.Container.getRenderer();if(r){jQuery.sap.log.debug("Shell controller: resolving component waitFor promise immediately (shell renderer already created");e();}else{sap.ushell.Container.attachRendererCreatedEvent(o);}});return[p];}}});}());
