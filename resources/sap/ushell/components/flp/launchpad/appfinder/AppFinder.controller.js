// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.require("sap.ushell.ui.launchpad.AccessibilityCustomData");sap.ui.controller("sap.ushell.components.flp.launchpad.appfinder.AppFinder",{onInit:function(){sap.ushell.Container.getRenderer("fiori2").createExtendedShellState("appFinderExtendedShellState",function(){sap.ushell.Container.getRenderer("fiori2").showHeaderItem('backBtn',true);sap.ushell.Container.getRenderer("fiori2").showHeaderItem('homeBtn',true);});var v=this.getView(),m=v.getModel(),s=v.showEasyAccessMenu;if(!m.getProperty("/groups")||m.getProperty("/groups").length===0){var d=sap.ushell.components.flp.launchpad.getDashboardManager();d.loadPersonalizedGroups();}this.getView().setModel(this._getSubHeaderModel(),"subHeaderModel");this.oConfig=v.parentComponent.getComponentData().config;this.catalogView=sap.ui.view("catalogView",{type:sap.ui.core.mvc.ViewType.JS,viewName:"sap.ushell.components.flp.launchpad.appfinder.Catalog",height:"100%",viewData:{parentComponent:v.parentComponent,subHeaderModel:this._getSubHeaderModel()}});this.catalogView.addStyleClass('sapUiGlobalBackgroundColor sapUiGlobalBackgroundColorForce');this._addViewCustomData(this.catalogView,"appFinderCatalogTitle");this.oRouter=this.getView().parentComponent.getRouter();this.oRouter.getRoute("catalog").attachPatternMatched(function(e){this._navigateTo.apply(this,["appFinder","catalog"]);}.bind(this));this.oRouter.getRoute("appFinder").attachPatternMatched(function(e){this._preloadAppHandler();this._getPathAndHandleGroupContext(e);v.createSubHeader();this._toggleViewWithToggleButtonClass(this._showOpenCloseSplitAppButton());if(s){this.onShow(e);}else if(this.getView()._showSearch('catalog')){v.updateSubHeader('catalog',false);this._toggleViewWithSearchAndTagsClasses('catalog');}sap.ui.getCore().getEventBus().publish("showCatalog");}.bind(this));if(!s){v.oPage.addContent(this.catalogView);setTimeout(function(){jQuery('#catalogSelect').focus();},0);}sap.ui.Device.resize.attachHandler(this._resizeHandler.bind(this));},_resizeHandler:function(){var s=this._showOpenCloseSplitAppButton();var c=this.oSubHeaderModel.getProperty('/openCloseSplitAppButtonVisible');if(s!=c){this.oSubHeaderModel.setProperty('/openCloseSplitAppButtonVisible',s);if(s){this.oSubHeaderModel.setProperty('/openCloseSplitAppButtonToggled',false);}}this._toggleViewWithToggleButtonClass(s);},_showOpenCloseSplitAppButton:function(){return!sap.ui.Device.orientation.landscape||sap.ui.Device.system.phone;},_resetSubHeaderModel:function(){this.oSubHeaderModel.setProperty('/activeMenu',null);this.oSubHeaderModel.setProperty('/search',{searchMode:false,searchTerm:null});this.oSubHeaderModel.setProperty('/tag',{tagMode:false,selectedTags:[]});this.oSubHeaderModel.setProperty('/openCloseSplitAppButtonVisible',this._showOpenCloseSplitAppButton());this.oSubHeaderModel.setProperty('/openCloseSplitAppButtonToggled',false);},_getSubHeaderModel:function(){if(this.oSubHeaderModel){return this.oSubHeaderModel;}this.oSubHeaderModel=new sap.ui.model.json.JSONModel();this._resetSubHeaderModel();return this.oSubHeaderModel;},onTagsFilter:function(e){var t=e.getSource(),s=t.getModel('subHeaderModel'),S=e.getSource().getSelectedItems(),T=S.length>0,o={tagMode:T,selectedTags:[]};S.forEach(function(a,i){o.selectedTags.push(a.getText());});s.setProperty('/activeMenu',this.getCurrentMenuName());s.setProperty('/tag',o);},searchHandler:function(e){var s=e.getSource().getValue();if(!s){return;}var S=this.oSubHeaderModel.getProperty('/search');var a=this.oSubHeaderModel.getProperty('/activeMenu');if(this.getCurrentMenuName()!=a){a=this.getCurrentMenuName();}if(!S.searchMode&&!e.getParameter('clearButtonPressed')){S.searchMode=true;}if(S.searchMode&&sap.ui.Device.system.phone){this.oSubHeaderModel.setProperty("/openCloseSplitAppButtonToggled",false);}if(s!=S.searchTerm){if(this.containsOnlyWhiteSpac(s)){s='*';}S.searchTerm=s;}this.oSubHeaderModel.setProperty("/search",S);this.oSubHeaderModel.setProperty("/activeMenu",a);this.oSubHeaderModel.refresh(true);},_preloadAppHandler:function(){setTimeout(function(){if(sap.ushell.Container){sap.ushell.Container.getRenderer("fiori2").applyExtendedShellState("appFinderExtendedShellState");}this._updateShellHeader(this.oView.oPage.getTitle());}.bind(this),0);},getCurrentMenuName:function(){return this.currentMenu;},_navigateTo:function(n,m){var g=this.oView.getModel().getProperty("/groupContext");var G=g?g.path:null;if(G){this.oRouter.navTo(n,{'menu':m,filters:JSON.stringify({targetGroup:encodeURIComponent(G)})},true);}else{this.oRouter.navTo(n,{'menu':m},true);}},getSystemsModel:function(){if(this.getSystemsPromise){return this.getSystemsPromise;}var e=new sap.ui.model.json.JSONModel();e.setProperty('/systemSelected',null);e.setProperty('/systemsList',[]);this.getSystemsPromise=this.getSystems().then(function(r){e.setProperty("/systemsList",r);return e;});return this.getSystemsPromise;},onSegmentButtonClick:function(e){switch(e.getParameters().id){case"catalog":this._navigateTo("appFinder","catalog");break;case"userMenu":this._navigateTo("appFinder","userMenu");break;case"sapMenu":this._navigateTo("appFinder","sapMenu");break;}},onShow:function(e){var p=e.getParameter('arguments');var m=p.menu;if(m===this.getCurrentMenuName()){return;}var v=this.getView();v._updateSearchWithPlaceHolder(m);this._updateCurrentMenuName(m);this.getSystemsModel().then(function(s){var a=s.getProperty("/systemsList");v.oPage.removeAllContent();if(a&&a.length){v.updateSubHeader(this.currentMenu,true);}else if(v._showSearch(this.currentMenu)){v.updateSubHeader(this.currentMenu,false);}if(this.currentMenu==='catalog'){v.oPage.addContent(this.catalogView);}else if(this.currentMenu==='userMenu'){if(!this.userMenuView){this.userMenuView=new sap.ui.view("userMenuView",{type:sap.ui.core.mvc.ViewType.JS,viewName:"sap.ushell.components.flp.launchpad.appfinder.EasyAccess",height:"100%",viewData:{menuName:"USER_MENU",easyAccessSystemsModel:s,parentComponent:v.parentComponent,subHeaderModel:this._getSubHeaderModel(),enableSearch:this.getView()._showSearch("userMenu")}});this._addViewCustomData(this.userMenuView,"appFinderUserMenuTitle");}v.oPage.addContent(this.userMenuView);}else if(this.currentMenu==='sapMenu'){if(!this.sapMenuView){this.sapMenuView=new sap.ui.view("sapMenuView",{type:sap.ui.core.mvc.ViewType.JS,viewName:"sap.ushell.components.flp.launchpad.appfinder.EasyAccess",height:"100%",viewData:{menuName:"SAP_MENU",easyAccessSystemsModel:s,parentComponent:v.parentComponent,subHeaderModel:this._getSubHeaderModel(),enableSearch:this.getView()._showSearch("sapMenu")}});this._addViewCustomData(this.sapMenuView,"appFinderSapMenuTitle");}v.oPage.addContent(this.sapMenuView);}this._setFocusToSegmentedButton(a);this.oSubHeaderModel.setProperty("/activeMenu",this.currentMenu);if(this.oSubHeaderModel.getProperty("/openCloseSplitAppButtonVisible")){this.oSubHeaderModel.setProperty("/openCloseSplitAppButtonToggled",false);}this.oSubHeaderModel.refresh(true);}.bind(this));},_updateCurrentMenuName:function(m){var v=this.getView();if(!v.showEasyAccessMenu||(m==="sapMenu"&&!v.enableEasyAccessSAPMenu)||(m==="userMenu"&&!v.enableEasyAccessUserMenu)){this.currentMenu="catalog";}else{this.currentMenu=m;}this._toggleViewWithSearchAndTagsClasses(m);},_toggleViewWithSearchAndTagsClasses:function(m){var v=this.getView();if(v._showSearch(m)){v.oPage.addStyleClass('sapUshellAppFinderSearch');}else{v.oPage.removeStyleClass('sapUshellAppFinderSearch');}if(v._showSearchTag(m)){v.oPage.addStyleClass('sapUshellAppFinderTags');}else{v.oPage.removeStyleClass('sapUshellAppFinderTags');}},_toggleViewWithToggleButtonClass:function(b){var v=this.getView();if(b){v.oPage.addStyleClass('sapUshellAppFinderToggleButton');}else{v.oPage.removeStyleClass('sapUshellAppFinderToggleButton');}},_setFocusToSegmentedButton:function(s){var v=this.getView();if(s&&s.length){var b=v.segmentedButton.getSelectedButton();setTimeout(function(){jQuery("#"+b).focus();},0);}else{setTimeout(function(){jQuery('#catalogSelect').focus();},0);}},_getPathAndHandleGroupContext:function(e){var p=e.getParameter('arguments');var d=p.filters;var D=d?JSON.parse(d):d;var P=(D&&decodeURIComponent(D.targetGroup))||"";P=P==='undefined'?undefined:P;this._updateModelWithGroupContext(P);},_updateModelWithGroupContext:function(p){var l=sap.ushell.Container.getService("LaunchPage"),m=this.oView.getModel(),g,G={path:p,id:"",title:""};if(p&&p!==""){var t=function(){var M=m.getProperty("/groups");if(M.length){g=m.getProperty(p);G.id=l.getGroupId(g.object);G.title=g.title||l.getGroupTitle(g.object);return;}setTimeout(t,100);};t();}m.setProperty("/groupContext",G);},getSystems:function(){var d=new jQuery.Deferred();var s=[];var c=sap.ushell.Container.getService("ClientSideTargetResolution");if(!c){d.reject("cannot get ClientSideTargetResolution service");}else{c.getEasyAccessSystems().done(function(S){var a=Object.keys(S);for(var i=0;i<a.length;i++){var C=a[i];s[i]={"systemName":S[C].text,"systemId":C};}d.resolve(s);}).fail(function(e){d.reject("An error occurred while retrieving the systems: "+e);});}return d.promise();},_addViewCustomData:function(v,t){var r=sap.ushell.resources.i18n;v.addCustomData(new sap.ushell.ui.launchpad.AccessibilityCustomData({key:"role",value:"region",writeToDom:true}));v.addCustomData(new sap.ushell.ui.launchpad.AccessibilityCustomData({key:"aria-label",value:r.getText(t),writeToDom:true}));},_initializeShellUIService:function(){jQuery.sap.require("sap.ushell.ui5service.ShellUIService");this.oShellUIService=new sap.ushell.ui5service.ShellUIService({scopeObject:this.getOwnerComponent(),scopeType:"component"});},_updateShellHeader:function(t){if(!this.oShellUIService){this._initializeShellUIService();}this.oShellUIService.setTitle(t);this.oShellUIService.setHierarchy([{icon:'sap-icon://home',title:'Home',intent:'#'}]);},containsOnlyWhiteSpac:function(t){if(!t||t==="")return false;var T=t;return(!T.replace(/\s/g,'').length)}});}());
