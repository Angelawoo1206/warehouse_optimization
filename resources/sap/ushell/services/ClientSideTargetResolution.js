// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.services.ClientSideTargetResolution");jQuery.sap.require("sap.ui.generic.app.navigation.service.SelectionVariant");sap.ushell.services.ClientSideTargetResolution=function(A,c,p,S){var h,H,u;var t=[undefined,"GUI","WDA","UI5"];this._ensureInbounds=function(s){var G=A.getInbounds;if(s){var d=new jQuery.Deferred();A.getInbounds(s).done(function(I){d.resolve(I);}).fail(d.reject.bind(d));return d.promise();}if(!h){if(typeof G!=="function"){jQuery.sap.log.error("Cannot get Inbounds","ClientSideTargetResolutionAdapter should implement getInbounds method","sap.ushell.services.ClientSideTargetResolution");return new jQuery.Deferred().reject().promise();}h=new jQuery.Deferred();G.call(A).done(function(I){h.resolve(I);}).fail(h.reject.bind(h));}return h.promise();};this._getURLParsing=function(){if(!u){u=sap.ushell.Container.getService("URLParsing");}return u;};this._addDefaultParameterValues=function(I,s,k,m,d){var o={},D={};Object.keys(I).forEach(function(P){if(P!=="sap-ushell-defaultedParameterNames"){o[P]=I[P];}});if(!s){return o;}Object.keys(s).forEach(function(P){var T=s[P],a,v=false;if(!o[P]&&T.hasOwnProperty("defaultValue")){if(T.defaultValue.format&&T.defaultValue.format==="reference"){a=T.defaultValue.value;if(k.hasOwnProperty(a)){if(typeof k[a]==="string"){o[P]=[k[a]];v=true;}else if(typeof k[a]==="object"){o[P]=k[a];v=true;}}else{o[P]=[T.defaultValue];m.push(T.defaultValue.value);}}else{o[P]=[T.defaultValue.value];v=true;}if(v){D[P]=true;}}});Object.keys(D).sort().forEach(function(P){d.push(P);});return o;};this._matchesFilter=function(v,f,k,m){var F;if(!f){return true;}if(!v&&v!==""){return false;}F=f.value;if(f.format==="reference"){if(/UserDefault\.extended\./.test(F)){jQuery.sap.log.error("Illegal inbound: extended user default '"+F+"' used as filter");return false;}if(k.hasOwnProperty(F)){return v===k[F];}m[F]=true;return true;}if(f.format==="value"||f.format==="plain"||f.format===undefined){return v===f.value;}else if(f.format==="regexp"){return!!v.match("^"+f.value+"$");}else{jQuery.sap.log.error("Illegal oFilter format");return false;}};function g(m){return m.inbound&&m.inbound.resolutionResult&&m.inbound.resolutionResult["sap.ui"]&&m.inbound.resolutionResult["sap.ui"].technology;}this._calculateTechnologyMatch=function(m){var T=m.intentParamsPlusAllDefaults["sap-ui-tech-hint"]&&m.intentParamsPlusAllDefaults["sap-ui-tech-hint"][0];var I=m.defaultedParamNames&&(m.defaultedParamNames.indexOf("sap-ui-tech-hint")>=0);if(T&&g(m)===T){return I?1:2;}return 0;};this._getTechnologyPriority=function(m){var T=g(m);var P=t.indexOf(T);return Math.max(0,P);};this._addSortString=function(m){function a(n){var s="000"+n;return s.substr(s.length-3);}m.priorityString=[m.genericSO?"g":"x","TECM="+this._calculateTechnologyMatch(m),"MTCH="+a(m.countMatchingParams),"MREQ="+a(m.countMatchingRequiredParams),"NFIL="+a(m.countMatchingFilterParams),"NDEF="+a(m.countDefaultedParams),"POT="+a(m.countPotentiallyMatchingParams),"RFRE="+a(999-m.countFreeInboundParams),"TECP="+this._getTechnologyPriority(m)].join(" ");};this._checkAdditionalParameters=function(I,o){var a=false;if(I.signature.additionalParameters==="allowed"||I.signature.additionalParameters==="ignored"){return true;}if(I.signature.additionalParameters==="notallowed"||I.signature.additionalParameters===undefined){a=Object.keys(o).every(function(P){return(!I.signature.parameters[P]&&P.indexOf("sap-")!==0)?false:true;});}else{jQuery.sap.log.error("Unexpected value of inbound for signature.additionalParameters");}return a;};this._addFoundParametersToRefs=function(r,m){r.forEach(function(R){m[R]=true;});};this._extractSapPriority=function(I,m){var s;if(I&&I["sap-priority"]&&I["sap-priority"][0]){s=parseInt(I["sap-priority"][0],10);if(!isNaN(s)){m["sap-priority"]=s;}}return;};this._constructParameterDominatorMap=function(P){var d={},r={};Object.keys(P).forEach(function(k){var R=P[k].renameTo||k;r[R]=r[R]||{"renameTo":R,"dominatedBy":[]};r[R].dominatedBy.push(k);r[R].dominatedBy=r[R].dominatedBy.sort();d[k]=r[R];});return d;};this._removeSpuriousDefaultedValues=function(I,d,P){var o=d.slice(0);o.forEach(function(s,a){var b;var n=P[s].dominatedBy.some(function(k){if(I[k]&&(k!==s)&&d.indexOf(k)===-1){b=k;return true;}return false;});if(n&&(b!==s)){d.splice(a,1);delete I[s];}});return{intentParamsPlusAllDefaults:I,defaultedParamNames:d};};this._matchToInbound=function(I,o,k,m){function n(R,x,D){R.matches=false;R.noMatchReason=x;R.noMatchDebug=D;return R;}function M(R){R.matches=true;return R;}var a=this,b={inbound:o};b.genericSO=(o.semanticObject==="*");if(!(I.semanticObject===undefined||I.semanticObject===o.semanticObject||o.semanticObject==='*')){return n(b,"Semantic object \""+I.semanticObject+"\" did not match");}if(!(I.action===undefined||I.action===o.action)){return n(b,"Action \""+I.action+"\" did not match");}if(o.deviceTypes&&!(I.formFactor===undefined||o.deviceTypes[I.formFactor])){return n(b,"Form factor \""+I.formFactor+"\" did not match","Inbound: ["+Object.keys(o.deviceTypes).filter(function(K){return!!o.deviceTypes[K];}).join(", ")+"]");}var T=I.params&&I.params["sap-ui-tech-hint"]&&I.params["sap-ui-tech-hint"][0];if(I.treatTechHintAsFilter&&T){var s=g({inbound:o});if(s!==T){return n(b,"Tech Hint as filter \""+T+"\" did not match","Inbound: ["+s+"]");}}var r=[],d=[],e=I.params;var f=this._addDefaultParameterValues(e,o.signature&&o.signature.parameters,k,r,d);b.intentParamsPlusAllDefaults=f;b.defaultedParamNames=d;this._extractSapPriority(f,b);var j=0,l=0,q=0,v=0;var w=Object.keys(o.signature.parameters).every(function(P){var V=f[P],x=V&&V[0],y=o.signature.parameters[P],z=e.hasOwnProperty(P);if(y.required&&(x===null||x===undefined)){return false;}if(y.filter){if(!a._matchesFilter(x,y.filter,k,m)){return false;}if(z){++q;}}if(z&&y.required){++l;}if(z){++j;}if(!z&&(x===null||x===undefined)){++v;}var B=a._constructParameterDominatorMap(o.signature.parameters);var R=a._removeSpuriousDefaultedValues(b.intentParamsPlusAllDefaults,b.defaultedParamNames,B);b.intentParmsPlusAllDefaults=R.intentParmsPlusAllDefaults;b.defaultedParamNames=R.defaultedParamNames;return true;});b.countMatchingParams=j;b.countMatchingRequiredParams=l;b.countMatchingFilterParams=q;b.countDefaultedParams=d.length;b.countPotentiallyMatchingParams=Object.keys(I.params).length;b.countFreeInboundParams=v;if(!w){return n(b,"Inbound parameter signature did not match",this._compactSignatureNotation(o.signature));}if(!this._checkAdditionalParameters(o,f)){return n(b,"Additional parameters not allowed",this._compactSignatureNotation(o.signature));}if(o.signature.additionalParameters==="ignored"){this._filterObjectKeys(f,function(K){if(K.indexOf("sap-")===0){return true;}if(o.signature.parameters.hasOwnProperty(K)){return true;}return false;},true);b.countPotentiallyMatchingParams=Object.keys(I.params).filter(function(x){return o.signature.parameters.hasOwnProperty(x);}).length;}this._constructEarlyResolutionResult(b,o);this._addSortString(b);this._addFoundParametersToRefs(r,m);return M(b);};this._filterObjectKeys=function(o,f,I){var O=I?o:jQuery.extend(true,{},o);Object.keys(O).forEach(function(k){if(f(k)===false){delete O[k];}});return O;};this._isFullLocalWDAResolution=function(m){var I=m.inbound,r=I&&I.resolutionResult;if(S&&S.config&&S.config["enableWdaLocalResolution"]===false){return false;}return!(!I||!r||!(r["sap.wda"])||!(r.applicationType==="WDA"));};this._isLocalWDAResolution=function(m){var I=m.inbound,r=I&&I.resolutionResult;if(S&&S.config&&S.config["enableWdaLocalResolution"]===false){return false;}return!(!I||!r||!(r.applicationType==="WDA"));};this._isFullLocalWebguiResolution=function(m){var I=m.inbound,r=I&&I.resolutionResult;if(S&&S.config&&S.config["enableWebguiLocalResolution"]===false){return false;}return!(!I||!r||!(r["sap.gui"])||!(r.applicationType==="TR"));};this._isLocalWebguiNowrapResolution=function(m){var I=m.inbound,r=I&&I.resolutionResult;if(S&&S.config&&S.config["enableWebguiLocalResolution"]===false){return false;}return!(!I||!r||!(r.applicationType==="TR")||!(r.url.indexOf("/~canvas;")>=0)||!(r.url.indexOf("app/transaction/APB_LPD_CALL_")===-1));};this._isLocalWebguiWrapResolution=function(m){var I=m.inbound,r=I&&I.resolutionResult;if(S&&S.config&&S.config["enableWebguiLocalResolution"]===false){return false;}return!(!I||!r||!(r.applicationType==="TR")||!(r.url.indexOf("/~canvas;")>=0)||!(r.url.indexOf("app/transaction/APB_LPD_CALL_")>=0));};this._isLocalNativeWebguiWrapResolution=function(m){var I=m.inbound,r=I&&I.resolutionResult;if(S&&S.config&&S.config["enableNativeWebguiLocalResolution"]===false){return false;}return!(!I||!r||!(r.applicationType==="TR")||!(r.url.indexOf("/its/webgui")>=0)||!(r.url.indexOf("APB_LPD_CALL_")!==-1));};this._isLocalNativeWebguiNowrapResolution=function(m){var I=m.inbound,r=I&&I.resolutionResult;if(S&&S.config&&S.config["enableNativeWebguiLocalResolution"]===false){return false;}return!(!I||!r||!(r.applicationType==="TR")||!(r.url.indexOf("/its/webgui")>=0)||!(r.url.indexOf("APB_LPD_CALL_")===-1));};this._constructEarlyResolutionResult=function(m,I){m.resolutionResult={};if(I&&I.resolutionResult&&I.resolutionResult.hasOwnProperty("sap.platform.runtime")){m.resolutionResult["sap.platform.runtime"]=I.resolutionResult["sap.platform.runtime"];}Object.keys(m.intentParamsPlusAllDefaults).slice(0).forEach(function(n){if(!jQuery.isArray(m.intentParamsPlusAllDefaults[n])){if(!m.resolutionResult.oNewAppStateMembers){m.resolutionResult.oNewAppStateMembers={};}m.resolutionResult.oNewAppStateMembers[n]=m.intentParamsPlusAllDefaults[n];}});};this._hasRenameTo=function(m){return m.inbound&&m.inbound.signature&&m.inbound.signature.parameters&&Object.keys(m.inbound.signature.parameters).some(function(k){return!!(m.inbound.signature.parameters[k].renameTo);});};this._removeUnusedComplexParameterValuesFromDefaultList=function(m){m.defaultedParamNames=m.defaultedParamNames.filter(function(n){if(m.intentParamsPlusAllDefaults[n]&&!jQuery.isArray(m.intentParamsPlusAllDefaults[n])){if(!(m.resolutionResult.oNewAppStateMembers&&m.resolutionResult.oNewAppStateMembers[n])){return false;}}return true;});};this._computeNavigationMode=function(m){var a=["newWindow","embedded","replace"];if(m.intentParamsPlusAllDefaults["sap-ushell-next-navmode"]&&a.indexOf(m.intentParamsPlusAllDefaults["sap-ushell-next-navmode"][0])>=0){m.resolutionResult["sap-ushell-next-navmode"]=m.intentParamsPlusAllDefaults["sap-ushell-next-navmode"][0];}if(m.intentParamsPlusAllDefaults["sap-ushell-navmode"]&&a.indexOf(m.intentParamsPlusAllDefaults["sap-ushell-navmode"][0])>=0){m.resolutionResult.navigationMode=m.intentParamsPlusAllDefaults["sap-ushell-navmode"][0];m.resolutionResult.explicitNavMode=true;}};this._mapDefaultParameterNames=function(m){var P=jQuery.sap.getObject("inbound.signature.parameters",undefined,m)||{},M={};m.defaultedParamNames.forEach(function(n){var N=(P[n]&&P[n].renameTo)||n;if(M[N]){jQuery.sap.log.error("renaming of defaultedParamNames creates duplicates"+n+"->"+N);}else{M[N]=true;}});m.mappedDefaultedParamNames=Object.keys(M).sort();};this._mixAppStateIntoResolutionResultAndRename=function(m,a){var d=new jQuery.Deferred(),b=this,n,s,o;function e(T){b._removeUnusedComplexParameterValuesFromDefaultList(T);b._mapDefaultParameterNames(T);b._computeNavigationMode(T);delete T.resolutionResult.oNewAppStateMembers;d.resolve(T);}function f(m){return(m.resolutionResult.oNewAppStateMembers&&!jQuery.isEmptyObject(m.resolutionResult.oNewAppStateMembers));}function j(L,P){return jQuery.isArray(L)&&L.some(function(q){return(P.indexOf(q)!==-1);});}function k(q,P){var v,w,x;if(q&&q.selectionVariant){v=new sap.ui.generic.app.navigation.service.SelectionVariant(JSON.stringify(q.selectionVariant));x=v.getSelectOptionsPropertyNames()||[];w=v.getParameterNames()||[];if(j(x,P)||j(w,P)){return true;}}return false;}function r(q,v,P){var w=new sap.ui.generic.app.navigation.service.SelectionVariant(),x=q.getParameterNames()||[],y=q.getSelectOptionsPropertyNames()||[],z,B;x.forEach(function(C){z=q.getParameter(C);if(P[C]&&P[C].renameTo){if((w.getParameter(P[C].renameTo)===undefined)&&(w.getSelectOption(P[C].renameTo)===undefined)){w.addParameter(P[C].renameTo,z);v.changed=true;}else{jQuery.sap.log.error("renaming of appstate creates duplicates "+C+"->"+P[C].renameTo);}}else{if((w.getParameter(C)===undefined)&&(w.getSelectOption(C)===undefined)){w.addParameter(C,z);}}});y.forEach(function(C){B=q.getSelectOption(C);if(P[C]&&P[C].renameTo){if((w.getSelectOption(P[C].renameTo)===undefined)&&(w.getParameter(P[C].renameTo)===undefined)){w.massAddSelectOption(P[C].renameTo,B);v.changed=true;}else{jQuery.sap.log.error("renaming of appstate creates duplicates "+C+"->"+P[C].renameTo);}}else{if((w.getSelectOption(C)===undefined)&&(w.getParameter(C)===undefined)){w.massAddSelectOption(C,B);}}});x.forEach(function(C){q.removeParameter(C);});y.forEach(function(C){q.removeSelectOption(C);});w.getParameterNames().forEach(function(C){q.addParameter(C,w.getParameter(C));});w.getSelectOptionsPropertyNames().forEach(function(C){q.massAddSelectOption(C,w.getSelectOption(C));});return q;}function R(q,v,P){return r(q,v,P);}function l(D){if(D===undefined||jQuery.isPlainObject(D)){return false;}return true;}function M(N){var q=N.getData()||{},v,C={};if(q.selectionVariant){v=new sap.ui.generic.app.navigation.service.SelectionVariant(JSON.stringify(q.selectionVariant));}else{v=new sap.ui.generic.app.navigation.service.SelectionVariant();}if(f(m)){Object.keys(m.resolutionResult.oNewAppStateMembers).forEach(function(w){v.massAddSelectOption(w,m.resolutionResult.oNewAppStateMembers[w].Ranges);});}v=R(v,C,m.inbound.signature.parameters);if(v.getParameterNames().length!==0||v.getSelectOptionsPropertyNames().length!==0){q.selectionVariant=v.toJSONObject();}if(!C.changed&&!f(m)){e(m);return;}N.setData(q);N.save().done(function(){m.intentParamsPlusAllDefaults["sap-xapp-state"]=[N.getKey()];m.mappedIntentParamsPlusSimpleDefaults["sap-xapp-state"]=[N.getKey()];e(m);});}if(!f(m)&&!b._hasRenameTo(m)){e(m);}else{s=m.intentParamsPlusAllDefaults["sap-xapp-state"]&&m.intentParamsPlusAllDefaults["sap-xapp-state"][0];if(s){a.getAppState(s).done(function(q){var P=b._constructParameterDominatorMap(m.inbound.signature.parameters);o=q.getData();if(l(o)){delete m.resolutionResult.oNewAppStateMembers;e(m);}if(m.resolutionResult.oNewAppStateMembers){Object.keys(m.resolutionResult.oNewAppStateMembers).forEach(function(v){var D=P[v].dominatedBy;if(k(o,D)){delete m.resolutionResult.oNewAppStateMembers[v];}});}if(!f(m)&&!b._hasRenameTo(m)){e(m);}else{n=a.createEmptyAppState(undefined,true);if(n){n.setData(q.getData());M(n);}}});}else if(f(m)){M(a.createEmptyAppState(undefined,true));}else{e(m);}}return d.promise();};this._extractInboundFilter=function(o){if(!A.hasSegmentedAccess){return undefined;}if(typeof o!=="string"){return undefined;}var f=o.indexOf("#")===0?o:"#"+o;var s=this._getURLParsing().parseShellHash(f);if(!s||!s.semanticObject||!s.action){return undefined;}return[{semanticObject:s.semanticObject,action:s.action}];};this.resolveHashFragment=function(s){var a=this,d=new jQuery.Deferred(),b=A.resolveHashFragmentFallback&&A.resolveHashFragmentFallback.bind(A),e=this._extractInboundFilter(s);this._ensureInbounds(e).done(function(I){a._resolveHashFragment(s,b,I).done(d.resolve.bind(d)).fail(d.reject.bind(d));}).fail(d.reject.bind(d));return d.promise();};this.resolveTileIntent=function(s){var a=this,d=new jQuery.Deferred(),b=this._extractInboundFilter(s);this._ensureInbounds(b).done(function(I){a._resolveTileIntent(s,undefined,I).done(d.resolve.bind(d)).fail(d.reject.bind(d));}).fail(d.reject.bind(d));return d.promise();};this._resolveHashFragment=function(s,b,I){var U=this._getURLParsing(),a=this,d=new jQuery.Deferred(),f=s.indexOf("#")===0?s:"#"+s,o=U.parseShellHash(f);if(o===undefined){jQuery.sap.log.error("Could not parse shell hash '"+s+"'","please specify a valid shell hash","sap.ushell.services.ClientSideTargetResolution");return d.reject().promise();}o.formFactor=sap.ushell.utils.getFormFactor();this._getMatchingInbounds(o,I,true).fail(function(e){jQuery.sap.log.error("Could not resolve "+s,"_getMatchingInbounds promise rejected with: "+e,"sap.ushell.services.ClientSideTargetResolution");d.reject(e);}).done(function(m){var M;if(m.length===0){jQuery.sap.log.warning("Could not resolve "+s,"rejecting promise","sap.ushell.services.ClientSideTargetResolution");d.reject("Could not resolve navigation target");return;}M=m[0];a._resolveSingleMatchingTarget(M,b,f).done(d.resolve.bind(d)).fail(d.reject.bind(d));});return d.promise();};this._resolveEasyAccessMenuIntent=function(I,m){var e="Intent must be either #Shell-startGUI or #Shell-startWDA";if(I.action==="startGUI"){return this._resolveEasyAccessMenuIntentWebgui(I,m);}if(I.action==="startWDA"){return this._resolveEasyAccessMenuIntentWDA(I,m);}return new jQuery.Deferred().reject("The easy access menu intent "+I.semanticObject+"-"+I.action+" could not be resolved: "+e).promise();};this._resolveEasyAccessMenuIntentWDA=function(I,m){var d=new jQuery.Deferred(),U,o,a=this,b={};U="/ui2/nwbc/~canvas;window=app/wda/"+I.params["sap-ui2-wd-app-id"][0]+"/";jQuery.each(I.params,function(e,v){if(e==="sap-ui2-wd-app-id"||e==="sap-system"){return;}if(e==="sap-ui2-wd-conf-id"){b["sap-wd-configId"]=v;return;}b[e]=v;});if(b){U=U+"?"+a._getURLParsing().paramsToString(b);}o=new URI(U);this._spliceSapSystemIntoURI(o,"",I.params["sap-system"][0],"WDA").done(function(o){var r={url:o.toString(),applicationType:"NWBC",text:I.params["sap-ui2-wd-app-id"][0],additionalInformation:"","sap-system":I.params["sap-system"][0]};if(m&&m.inbound&&m.inbound.resolutionResult&&m.inbound.resolutionResult["sap.platform.runtime"]){r["sap.platform.runtime"]=m.inbound.resolutionResult["sap.platform.runtime"];}d.resolve(r);}).fail(d.reject.bind(d));return d.promise();};this._resolveEasyAccessMenuIntentWebgui=function(I,m){var d=new jQuery.Deferred(),U,o;U="/sap/bc/gui/sap/its/webgui?%7etransaction="+I.params["sap-ui2-tcode"][0]+"&%7enosplash=1";o=new URI(U);this._spliceSapSystemIntoURI(o,"",I.params["sap-system"][0],"NATIVEWEBGUI").done(function(o){var r={url:o.toString(),applicationType:"TR",text:I.params["sap-ui2-tcode"][0],additionalInformation:"","sap-system":I.params["sap-system"][0]};if(m&&m.inbound&&m.inbound.resolutionResult&&m.inbound.resolutionResult["sap.platform.runtime"]){r["sap.platform.runtime"]=m.inbound.resolutionResult["sap.platform.runtime"];}d.resolve(r);}).fail(d.reject.bind(d));return d.promise();};this._resolveSingleMatchingTarget=function(m,b,f){var a=this,d=new jQuery.Deferred(),U=this._getURLParsing(),I=U.parseShellHash(f);if(I.semanticObject==="Shell"&&(I.action==="startWDA"||I.action==="startGUI")){return this._resolveEasyAccessMenuIntent(I,m);}this._mapParameterNamesAndRemoveObjects(m);this._mixAppStateIntoResolutionResultAndRename(m,sap.ushell.Container.getService("AppState")).done(function(m){var B=a._determineResultProcessor(m);B(m,b,f).done(function(m){d.resolve(m.resolutionResult);}).fail(function(M){if(M.indexOf("fallback:")>=0){a._constructFallbackResolutionResult.call(this,m,b,f).fail(d.reject.bind(d)).done(function(m){d.resolve(m.resolutionResult);});}else{d.reject(M);}});});return d.promise();};this._resolveTileIntent=function(s,b,I){var U=this._getURLParsing(),a=this,d=new jQuery.Deferred(),f=s.indexOf("#")===0?s:"#"+s,o=U.parseShellHash(f);if(o===undefined){jQuery.sap.log.error("Could not parse shell hash '"+s+"'","please specify a valid shell hash","sap.ushell.services.ClientSideTargetResolution");return d.reject("Cannot parse shell hash").promise();}o.formFactor=sap.ushell.utils.getFormFactor();this._getMatchingInbounds(o,I,false).fail(function(e){jQuery.sap.log.error("Could not resolve "+s,"_getMatchingInbounds promise rejected with: "+e,"sap.ushell.services.ClientSideTargetResolution");d.reject(e);}).done(function(m){var M;if(m.length===0){jQuery.sap.log.warning("Could not resolve "+s,"no matching targets were found","sap.ushell.services.ClientSideTargetResolution");d.reject("No matching targets found");return;}M=m[0];a._resolveSingleMatchingTileIntent(M,b,f).done(d.resolve.bind(d)).fail(d.reject.bind(d));});return d.promise();};this._resolveSingleMatchingTileIntent=function(m,b,f){var d=new jQuery.Deferred();d.resolve(m.inbound.tileResolutionResult);return d.promise();};this._determineResultProcessor=function(m){var I=m.inbound,r=I&&I.resolutionResult;function l(P,R){jQuery.sap.log.debug("Resolution result will be constructed via "+P+" processor",R,"sap.ushell.services.ClientSideTargetResolution");}if(!I||!r){l("FALLBACK","the inbound or the inbound resolutionResult member was not available");return this._constructFallbackResolutionResult.bind(this);}if(r.applicationType==="SAPUI5"){l("SAPUI5","inbound resolutionResult had SAPUI5 applicationType");return this._constructSAPUI5ResolutionResult.bind(this);}var a=this._isFullLocalWDAResolution(m);if(a){l("WDA full url construction");return this._constructFullWDAResolutionResult.bind(this);}var b=this._isLocalWDAResolution(m);if(b){l("WDA");return this._constructWDAResolutionResult.bind(this);}var d=this._isFullLocalWebguiResolution(m);if(d){l("NON-WRAPPED WEBGUI full url construction");return this._constructFullWebguiResolutionResult.bind(this);}var e=this._isLocalWebguiNowrapResolution(m);if(e){l("NON-WRAPPED WEBGUI");return this._constructWebguiNowrapResult.bind(this);}var f=this._isLocalWebguiWrapResolution(m);if(f){l("WRAPPED WEBGUI");return this._constructWebguiWrapResult.bind(this);}var j=this._isLocalNativeWebguiNowrapResolution(m);if(j){l("NATIVE NON-WRAPPED WEBGUI");return this._constructNativeWebguiNowrapResult.bind(this);}var k=this._isLocalNativeWebguiWrapResolution(m);if(k){l("NATIVE WRAPPED WEBGUI");return this._constructNativeWebguiWrapResult.bind(this);}if(r.applicationType==="URL"){l("URL","inbound resolutionResult had URL applicationType");return this._constructURLResolutionResult.bind(this);}l("FALLBACK","could not apply any result processor to inbound resolutionResult: "+JSON.stringify(r,null,"   "));return this._constructFallbackResolutionResult.bind(this);};this._stripURI=function(U,s,a){var d=new jQuery.Deferred(),b=this;if(typeof s==="undefined"){this._stripURIWithSystemAlias(U,s,a,undefined).fail(function(e){d.reject(e);}).done(function(n){d.resolve(n);});return d.promise();}A.resolveSystemAlias(s).fail(function(e){d.reject(e);}).done(function(r){b._stripURIWithSystemAlias(U,s,a,r).fail(function(e){d.reject(e);}).done(function(n){d.resolve(n);});});return d.promise();};this._stripURIWithSystemAlias=function(U,s,a,r){var b=this,o,d,T,e,D=new jQuery.Deferred(),P=new jQuery.Deferred();U.protocol("");U.hostname("");U.port("");b._removeParametersFromURI(U,["sap-client","sap-language"]);if(!jQuery.isPlainObject(r)||typeof s!=="string"){return D.resolve(U).promise();}d=b._selectSystemAliasDataName(r,new URI(window.location.toString()).protocol());o=r[d];e=(typeof o.pathPrefix==="string")&&o.pathPrefix;if(e!==""){P.resolve(e);}else{A.resolveSystemAlias("").fail(function(E){D.reject(E);}).done(function(R){var f=R[d];P.resolve(f.pathPrefix);});}P.fail(function(E){D.reject(E);}).done(function(e){if(e&&e.length>0){T=U.path();T=T.replace(e,"");if(T.indexOf("/")!==0){T="/"+T;}U.path(T);}if(a==="NATIVEWEBGUI"&&r.hasOwnProperty("rfc")){T=U.path();T=T.split(";").filter(function(f){return f.indexOf("~sysid=")!==0&&f.indexOf("~service=")!==0&&f.indexOf("~loginGroup=")!==0&&f.indexOf("~messageServer=")!==0&&f.indexOf("~sncNameR3=")!==0&&f.indexOf("~sncQoPR3=")!==0;}).join(";");U.path(T);}D.resolve(U);});return D.promise();};this._removeParametersFromURI=function(U,P){var b={},T;P.forEach(function(s){b[s]=true;});T=U.query();T=T.split("&").filter(function(s){var a=(s.split("=")[0]||"").toLowerCase();return!b.hasOwnProperty(a);}).join("&");U.query(T);};this._spliceSapSystemIntoUrlURI=function(U,s,a){var b=this,d=new jQuery.Deferred();if(typeof a==="undefined"||s===a){return d.resolve(U).promise();}if(s===""||typeof s==="undefined"){if(this._isAbsoluteURI(U)){return d.resolve(U);}b._applyAliasToURI(a,U,"URL").fail(function(e){d.reject(e);}).done(function(o){d.resolve(o);});return d.promise();}if(typeof A.resolveSystemAlias!=="function"){return d.reject("fallback: the adapter does not implement resolveSystemAlias").promise();}A.resolveSystemAlias(s).fail(function(e){d.reject(e);}).done(function(r){var e=b._selectSystemAliasDataName(r,new URI(window.location.toString()).protocol()),o=r[e],D;if((U.protocol()||"").toLowerCase()===e&&(U.hostname()||"")===o.host&&(U.path().indexOf(o.pathPrefix)===0)){U.protocol("");U.hostname("");D=U.path().replace(o.pathPrefix,"");U.path(D);b._removeParametersFromURI(U,["sap-language","sap-client"]);b._applyAliasToURI(a,U,"URL").fail(function(E){d.reject(E);}).done(function(f){d.resolve(f);});}else{d.resolve(U);}});return d.promise();};this._spliceSapSystemIntoURI=function(U,s,a,b){var d=new jQuery.Deferred(),e=this;if(b==="URL"){return this._spliceSapSystemIntoUrlURI(U,s,a);}if(typeof a==="undefined"||s===a){return d.resolve(U).promise();}if(typeof A.resolveSystemAlias!=="function"){return d.reject("fallback: the adapter does not implement resolveSystemAlias").promise();}this._stripURI(U,s,b).fail(function(E){d.reject(E);}).done(function(o){e._applyAliasToURI(a,o,b).fail(function(E){d.reject(E);}).done(function(I){d.resolve(I);});});return d.promise();};this._applyAliasToURI=function(s,U,a){var b=this,n=U,d=new jQuery.Deferred();A.resolveSystemAlias(s).fail(function(e){d.reject(e);}).done(function(r){var e=b._selectSystemAliasDataName(r,new URI(window.location.toString()).protocol()),o=r[e],q,l,f;n.protocol(e);n.hostname(o.host);n.port(o.port);b._interpolatePathPrefixIntoURI(n,a,o.pathPrefix).fail(function(E){d.reject(E);}).done(function(n){q=n.query();if(typeof r.client==="string"&&r.client!==""){q=q+(q.length>0?"&":"")+"sap-client="+r.client;}if(typeof r.language==="string"&&r.language!==""){l=r.language;}else{f=sap.ushell.Container.getUser();if(!f){jQuery.sap.log.error("Cannot retieve the User object via sap.ushell.Container while determining sap-language","will default to 'en' language","sap.ushell.services.ClientSideTargetResolution");l="en";}else{l=f.getLanguage();}}q=q+(q.length>0?"&":"")+"sap-language="+l;n.query(q);n=b._interpolateNativeWebguiDataIntoURI(r,n,a);d.resolve(n);});});return d.promise();};this._interpolateNativeWebguiDataIntoURI=function(s,U,a){var I,T,b,P;if(s.hasOwnProperty("rfc")&&a==="NATIVEWEBGUI"){b=s.rfc;I=!!b.systemId;if(I){T=[b.systemId&&("~sysid="+b.systemId),b.loginGroup&&("~loginGroup="+b.loginGroup),b.sncNameR3&&("~messageServer="+encodeURIComponent(b.sncNameR3)),b.sncNameR3&&("~sncNameR3="+encodeURIComponent(b.sncNameR3)),b.sncQoPR3&&("~sncQoPR3="+b.sncQoPR3)].filter(function(o){return(typeof o==="string")&&(o!=="");});}else{T=[b.service&&("~service="+b.service),b.sncNameR3&&("~sncNameR3="+encodeURIComponent(b.sncNameR3)),b.sncQoPR3&&("~sncQoPR3="+b.sncQoPR3)].filter(function(o){return(typeof o==="string")&&(o!=="");});}P=U.path()+";"+T.join(";").replace(/(%[A-F0-9]{2})/g,function(e){return e.toLowerCase();});U.path(P);U._parts.path=P;}return U;};this._interpolatePathPrefixIntoURI=function(U,s,P){var a=this,d=new jQuery.Deferred(),T;if(s==="URL"&&P.length===0){return d.resolve(U).promise();}function b(e){var r=e+U.path();U.path(r.replace(/\/+/g,"/"));d.resolve(U);}if(P.length>0){if((s==="WDA"||s==="WEBGUI")&&U.path().indexOf("~canvas")>=0){T=U.path();T="/~canvas"+T.split("~canvas")[1];U.path(T);}b(P);}else{A.resolveSystemAlias("").fail(function(e){d.reject(e);}).done(function(r){var e=a._selectSystemAliasDataName(r,new URI(window.location.toString()).protocol()),f=r[e].pathPrefix;b(f);});}return d.promise();};this._selectSystemAliasDataName=function(s,b){if(s.hasOwnProperty("https")){return"https";}if(s.hasOwnProperty("http")){return"http";}jQuery.sap.log.error("Cannot select which system alias to pick between http/https","make sure they are provided in the given system alias collection","sap.ushell.services.ClientSideTargetResolution");return undefined;};this._getRenameParameterName=function(P,s,a){if(!a||!jQuery.isArray(a)){return P;}if(s&&s.parameters&&s.parameters[P]&&s.parameters[P].renameTo){return s.parameters[P].renameTo;}return P;};this._mapParameterNamesAndRemoveObjects=function(m){var a=this,n={},o=m.intentParamsPlusAllDefaults;Object.keys(o).sort().forEach(function(P){var r=a._getRenameParameterName(P,m.inbound.signature,o[P]);if(jQuery.isArray(m.intentParamsPlusAllDefaults[P])){if(n[r]){jQuery.sap.log.error("collision of values during parameter mapping : \""+P+"\" -> \""+r+"\"");}else{n[r]=m.intentParamsPlusAllDefaults[P];}}});m.mappedIntentParamsPlusSimpleDefaults=n;};this._constructFullWDAResolutionResult=function(m,b,f){var d=this,I=m.inbound,r=I&&I.resolutionResult,D=new jQuery.Deferred();var o={target:{"semanticObject":"Shell","action":"startWDA"},"params":{"sap-ui2-wd-app-id":[I.resolutionResult["sap.wda"].applicationId],"sap-system":[r.systemAlias]}};if(I.resolutionResult["sap.wda"].configId){o.params["sap-ui2-wd-conf-id"]=[I.resolutionResult["sap.wda"].configId];}this._resolveEasyAccessMenuIntentWDA(o,m).done(function(C){r.url=C.url;return d._constructWDAResolutionResult(m,b,f).done(function(a){D.resolve(a);}).fail(function(M){D.reject(M);});});return D.promise();};this._constructFullWebguiResolutionResult=function(m,b,f){var d=this,I=m.inbound,r=I&&I.resolutionResult,D=new jQuery.Deferred();var o={target:{"semanticObject":"Shell","action":"startGUI"},"params":{"sap-ui2-tcode":[I.resolutionResult["sap.gui"].transaction],"sap-system":[r.systemAlias]}};this._resolveEasyAccessMenuIntentWebgui(o,m).done(function(C){r.url=C.url;return d._constructWebguiNowrapResult(m,b,f).done(function(a){D.resolve(a);}).fail(function(M){D.reject(M);});});return D.promise();};this._constructWDAResolutionResult=function(m,b,f){var a=this,I=m.inbound,r=I&&I.resolutionResult,d=new jQuery.Deferred();var w=new URI(r.url);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);if(m.mappedDefaultedParamNames.length>0){e["sap-ushell-defaultedParameterNames"]=[JSON.stringify(m.mappedDefaultedParamNames)];}var s=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=s;delete e["sap-system"];a._spliceSapSystemIntoURI(w,r.systemAlias,s,"WDA").fail(d.reject.bind(d)).done(function(w){sap.ushell.Container.getService("ShellNavigation").compactParams(e,["sap-xapp-state","sap-ushell-defaultedParameterNames","sap-intent-params"],undefined,true).fail(d.reject.bind(d)).done(function(E){var j=a._getURLParsing().paramsToString(E);var P=w.search();if(j){P=P+((P.indexOf("?")<0)?"?":"&")+j;}w.search(P);["additionalInformation","applicationDependencies"].forEach(function(k){if(I.resolutionResult.hasOwnProperty(k)){m.resolutionResult[k]=I.resolutionResult[k];}});m.resolutionResult.url=w.toString();m.resolutionResult.text=I.title;m.resolutionResult.applicationType="NWBC";d.resolve(m);});});return d.promise();};this._constructWebguiNowrapResult=function(m,b,f){var a=this,I=m.inbound,r=I&&I.resolutionResult,d=new jQuery.Deferred();var w=new URI(r.url);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var s=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=s;delete e["sap-system"];a._adjustDYNP_OKCODE(e,m);a._spliceSapSystemIntoURI(w,r.systemAlias,s,"WEBGUI").fail(d.reject.bind(d)).done(function(w){var E=a._getURLParsing().paramsToString(e);var P=w.search();if(E){P=P+((P.indexOf("?")<0)?"?":"&")+E;}w.search(P);["additionalInformation","applicationDependencies"].forEach(function(j){if(I.resolutionResult.hasOwnProperty(j)){m.resolutionResult[j]=I.resolutionResult[j];}});m.resolutionResult.url=w.toString();m.resolutionResult.text=I.title;m.resolutionResult.applicationType="NWBC";d.resolve(m);});return d.promise();};this._constructWebguiWrapResult=function(m,b,f){var a=this,I=m.inbound,r=I&&I.resolutionResult,d=new jQuery.Deferred();var w=new URI(r.url);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var s=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=s;delete e["sap-system"];a._spliceSapSystemIntoURI(w,r.systemAlias,s,"WEBGUI").fail(d.reject.bind(d)).done(function(w){var P=w.search();P=a._injectEffectiveParametersIntoWebguiPobjectParam(P,e,"&","=");w.search(P);["additionalInformation","applicationDependencies"].forEach(function(j){if(I.resolutionResult.hasOwnProperty(j)){m.resolutionResult[j]=I.resolutionResult[j];}});m.resolutionResult.url=w.toString();m.resolutionResult.text=I.title;m.resolutionResult.applicationType="NWBC";d.resolve(m);});return d.promise();};this._injectEffectiveParametersIntoWebguiPobjectParam=function(q,P,Q,s){var I,a="P_OBJECT"+s,m=132;var b=this._getURLParsing().privparamsToString(P,"%25","%21");if(!b){return q;}var d="";this._amendGuiParam("P_OBJECT",q,Q,s,function(f){var j=f.replace(a,"");d=decodeURIComponent(j);if(d.length>0){d=d+"%25";}return a;});b=d+b;var o={pObjX:"",pObject:""};b.match(new RegExp(".{1,"+m+"}","g")).map(function(f){return encodeURIComponent(f);}).forEach(function(f,G){var j="P_OBJECT";var k="pObject";if(G>0){j="P_OBJ"+G;k="pObjX";}var l=o[k].length===0?"":Q;o[k]=o[k]+l+j+s+f;});I=[o.pObjX,o.pObject].filter(function(f){return f.length>0;}).join(Q);var e=this._amendGuiParam("P_OBJECT",q,Q,s,function(f){return I;});if(e.found){return e.query;}return q+(q.length===0?"":Q)+I;};this._amendGuiParam=function(T,q,Q,s,a){var f=false,P=T+s;var b=q.split(Q).map(function(d){if(d.indexOf(P)!==0){return d;}f=true;return a(d);}).filter(function(d){return typeof d!=="undefined";}).join(Q);return{found:f,query:b};};this._parseWebguiTransactionQueryParam=function(T){var s="^(.+?)(%20|(%20)(.+))?$",r=new RegExp(s,"i"),a,P={hasParameters:null,transactionParamName:"",transactionCode:"",parameters:[]};var b=T.split("=");if(b.length>2){return{"error":"Found more than one assignment ('=') in the transaction query parameter","details":"Only one '=' sign is expected in "+T};}if(b.length<2||typeof b[1]==="undefined"||b[1].length===0){return{"error":"The transaction query parameter must specify at least the transaction name","details":"Got "+T+" instead."};}P.transactionParamName=b[0];a=b[1];var m=a.match(r);if(!m){return{"error":"Cannot parse ~transaction query parameter value.","details":a+" should match /"+s+"/"};}P.transactionCode=m[1];if(m[2]&&m[2]!=="%20"){var d=m[4]||"";d.split("%3b").forEach(function(n){var N=n.split("%3d"),e=N[0];if(e&&typeof e==="string"&&e.length>0){P.parameters.push({name:e,value:N[1]});}});}P.hasParameters=false;if(P.parameters.length>0){P.hasParameters=true;P.transactionCode=P.transactionCode.replace(/^[*]/,"");}return P;};this._injectEffectiveParametersIntoWebguiQueryParam=function(T,P){var o=this._parseWebguiTransactionQueryParam(T);if(o.error){jQuery.sap.log.error(o.error,o.details,"sap.ushell.services.ClientSideTargetResolution");return T;}var a=o.parameters.map(function(e){return e.name.toUpperCase()+"%3d"+e.value;});var b={};Object.keys(P).forEach(function(k){b[k.toUpperCase()]=P[k];});var s=this._getURLParsing().privparamsToString(b,"%3b","%3d");if(s){a.push(s);}var d=a.length>0;return o.transactionParamName+"="+(d?"*":"")+o.transactionCode+(d?"%20":"")+a.join("%3b");};this._constructNativeWebguiWrapResult=function(m,b,f){var a=this,I=m.inbound,r=I&&I.resolutionResult,d=new jQuery.Deferred();var w=new URI(r.url);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var s=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=s;delete e["sap-system"];a._spliceSapSystemIntoURI(w,r.systemAlias,s,"NATIVEWEBGUI").fail(d.reject.bind(d)).done(function(w){var P=w.search();var j=P.split("&").map(function(q){var k;if(q.indexOf("?%7etransaction")===0||q.indexOf("%7etransaction")===0){k=a._injectEffectiveParametersIntoWebguiPobjectParam(q,e,"%3b","%3d");return k;}return q;}).join("&");w.search(j);["additionalInformation","applicationDependencies"].forEach(function(k){if(I.resolutionResult.hasOwnProperty(k)){m.resolutionResult[k]=I.resolutionResult[k];}});m.resolutionResult.url=w.toString();m.resolutionResult.text=I.title;m.resolutionResult.applicationType="TR";d.resolve(m);});return d.promise();};this._isWebguiBusinessParameter=function(n,v){var N;if(arguments.length===1){N=n.split(/[=](.+)?/);if(N.length>1){return this._isWebguiBusinessParameter.apply(this,N);}}return!(n.indexOf("sap-")===0||n.charAt(0)==="~");};this._extractWebguiNonBusinessParameters=function(P){var a=this,n={};Object.keys(P).forEach(function(s){var b=P[s];if(!a._isWebguiBusinessParameter(s,b)){n[s]=b;delete P[s];}});return n;};function i(I){return I&&I.signature&&I.signature&&I.signature.parameters&&I.signature.parameters.DYNP_OKCODE&&I.signature.parameters.DYNP_OKCODE.required===true;}this._adjustDYNP_OKCODE=function(e,m){var a=this;var I=i(m&&m.inbound);if(I){return e;}var n=Object.keys(e).reduce(function(P,s){if(!a._isWebguiBusinessParameter(s)){return P;}if(s.toUpperCase()==="DYNP_OKCODE"){return P;}return P+1;},0);if(n===0){Object.keys(e).forEach(function(P){if(P.toUpperCase()==="DYNP_OKCODE"){delete e[P];}});}return e;};this._constructNativeWebguiNowrapResult=function(m,b,f){var a=this,I=m.inbound,r=I&&I.resolutionResult,d=new jQuery.Deferred(),F={"sap-wd-run-sc":true,"sap-wd-auto-detect":true,"sap-ep-version":true,"sap-system":true};var w=new URI(r.url);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var s=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=s;Object.keys(e).forEach(function(P){if(F[P.toLowerCase()]){delete e[P];}});a._adjustDYNP_OKCODE(e,m);var E=this._extractWebguiNonBusinessParameters(e);a._spliceSapSystemIntoURI(w,r.systemAlias,s,"NATIVEWEBGUI").fail(d.reject.bind(d)).done(function(w){var P=w.search();var j=P.split("&").map(function(q){var n;if(!a._isWebguiBusinessParameter(q)){if(q.indexOf("=")>=0){n=q.split("=");if(!E.hasOwnProperty(n[0])){E[n[0]]=n[1];}}else{jQuery.sap.log.error("Found no '=' separator of Webgui non-business parameter. Parameter will be skipped.","'"+q+"'","sap.ushell.services.ClientSideTargetResolution");}return undefined;}var l;if(q.indexOf("?%7etransaction")===0||q.indexOf("%7etransaction")===0){l=a._injectEffectiveParametersIntoWebguiQueryParam(q,e,"%3b","%3d");return l;}return q;}).filter(function(l){return typeof l!=="undefined";}).join("&");var k=a._getURLParsing().paramsToString(E);j=[j,k.replace("~","%7e")].join("&");w.search(j);["additionalInformation","applicationDependencies","sap.platform.runtime"].forEach(function(l){if(I.resolutionResult.hasOwnProperty(l)){m.resolutionResult[l]=I.resolutionResult[l];}});m.resolutionResult.url=w.toString();m.resolutionResult.text=I.title;m.resolutionResult.applicationType="TR";d.resolve(m);});return d.promise();};this._constructSAPUI5ResolutionResult=function(m,b,f){var I=m.inbound,d=new jQuery.Deferred(),U,s,e;["applicationType","additionalInformation","url","applicationDependencies"].forEach(function(P){if(I.resolutionResult.hasOwnProperty(P)){m.resolutionResult[P]=I.resolutionResult[P];}});e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);if(m.mappedDefaultedParamNames.length>0){e["sap-ushell-defaultedParameterNames"]=[JSON.stringify(m.mappedDefaultedParamNames)];}s=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=s;U=this._getURLParsing().paramsToString(e);if(U){m.resolutionResult.url=I.resolutionResult.url+((I.resolutionResult.url.indexOf("?")<0)?"?":"&")+U;}if(typeof I.resolutionResult.ui5ComponentName!=="undefined"){m.resolutionResult.ui5ComponentName=I.resolutionResult.ui5ComponentName;}m.resolutionResult.text=I.title;d.resolve(m);return d.promise();};this._isAbsoluteURI=function(U){return(U.protocol()||"").length>0;};this._constructURLResolutionResult=function(m,b,f){var a=this,I=m.inbound,r=I&&I.resolutionResult,d=new jQuery.Deferred();var U=new URI(r.url);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);if(m.inbound&&m.inbound.action==="launchURL"&&m.inbound.semanticObject==="Shell"){delete e["sap-external-url"];}var s=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=s;delete e["sap-system"];a._spliceSapSystemIntoURI(U,r.systemAlias,s,"URL").fail(d.reject.bind(d)).done(function(o){var j=o.toString(),k,F,l;l=a._getURLParsing().paramsToString(e);if(l){if(o.fragment()){F="#"+o.fragment();k=j.replace(/#.*/,"");}else{k=j;F="";}j=k+((j.indexOf("?")<0)?"?":"&")+l+F;}["additionalInformation","applicationDependencies"].forEach(function(P){if(I.resolutionResult.hasOwnProperty(P)){m.resolutionResult[P]=I.resolutionResult[P];}});m.resolutionResult.url=j;m.resolutionResult.text=I.title;m.resolutionResult.applicationType="URL";d.resolve(m);});return d.promise();};this._constructFallbackResolutionResult=function(m,b,f){var d=new jQuery.Deferred(),e={},D;Object.keys(m.intentParamsPlusAllDefaults).forEach(function(P){if(jQuery.isArray(m.intentParamsPlusAllDefaults[P])){e[P]=m.intentParamsPlusAllDefaults[P];}});D=m.mappedDefaultedParamNames||m.defaultedParamNames;if(D.length>0){e["sap-ushell-defaultedParameterNames"]=[JSON.stringify(D)];}if(typeof b!=="function"){jQuery.sap.log.error("Cannot resolve hash fragment",f+" has matched an inbound that cannot be resolved client side"+" and no resolveHashFragmentFallback method was implemented in ClientSideTargetResolutionAdapter","sap.ushell.services.ClientSideTargetResolution");d.reject("Cannot resolve hash fragment: no fallback provided.");return d.promise();}jQuery.sap.log.warning("Cannot resolve hash fragment client side",f+" has matched an inbound that cannot be resolved client side. Using fallback logic","sap.ushell.services.ClientSideTargetResolution");b(f,jQuery.extend(true,{},m.inbound),e).done(function(r){["applicationType","additionalInformation","url","applicationDependencies","text"].forEach(function(P){if(r.hasOwnProperty(P)){m.resolutionResult[P]=r[P];}});d.resolve(m);}).fail(d.reject.bind(d));return d.promise();};this.getDistinctSemanticObjects=function(){var d=new jQuery.Deferred();this._ensureInbounds().done(function(I){var s={};I.forEach(function(o){if(typeof o.semanticObject==="string"&&o.semanticObject!=="*"&&o.semanticObject.length>0){s[o.semanticObject]=true;}});d.resolve(Object.keys(s).sort());}).fail(function(e){d.reject(e);});return d.promise();};this.getLinks=function(a){var b=this,s,P,I,d=new jQuery.Deferred(),C;if(arguments.length===1&&jQuery.isPlainObject(arguments[0])){var a=arguments[0];C=jQuery.extend(true,{},a);["action","semanticObject"].forEach(function(e){if(a.hasOwnProperty(e)){C[e]=a[e];}});if(C.appStateKey){C.params=C.params||{};C.params["sap-xapp-state"]=[C.appStateKey];delete C.appStateKey;}}else if(arguments.length<=3){jQuery.sap.log.warning("Passing positional arguments to getLinks is deprecated","Please use nominal arguments instead","sap.ushell.services.ClientSideTargetResolution");s=arguments[0];P=arguments[1];I=arguments[2];C={semanticObject:s,params:P,ignoreFormFactor:I};}else{return d.reject("invalid arguments for getLinks").promise();}this._ensureInbounds().done(function(e){b._getLinks(C,e).done(d.resolve.bind(d)).fail(d.reject.bind(d));}).fail(d.reject.bind(d));return d.promise();};this._validateGetSemanticObjectLinksArgs=function(a){var s=a.semanticObject,b=a.action,I=!a.hasOwnProperty("action");if(typeof s!=="undefined"||I){if(typeof s!=="string"){jQuery.sap.log.error("invalid input for _getLinks","the semantic object must be a string, got "+Object.prototype.toString.call(s)+" instead","sap.ushell.services.ClientSideTargetResolution");return"invalid semantic object";}if(I&&s.match(/^\s+$/)){jQuery.sap.log.error("invalid input for _getLinks","the semantic object must be a non-empty string, got '"+s+"' instead","sap.ushell.services.ClientSideTargetResolution");return"invalid semantic object";}if(!I&&s.length===0){jQuery.sap.log.error("invalid input for _getLinks","the semantic object must not be an empty string, got '"+s+"' instead","sap.ushell.services.ClientSideTargetResolution");return"invalid semantic object";}}if(typeof b!=="undefined"){if(typeof b!=="string"){jQuery.sap.log.error("invalid input for _getLinks","the action must be a string, got "+Object.prototype.toString.call(b)+" instead","sap.ushell.services.ClientSideTargetResolution");return"invalid action";}if(b.length===0){jQuery.sap.log.error("invalid input for _getLinks","the action must not be an empty string, got '"+b+"' instead","sap.ushell.services.ClientSideTargetResolution");return"invalid action";}}return undefined;};this._getLinks=function(a,I){var s=a.semanticObject,b=a.action,P=a.params,w=!!a.withAtLeastOneUsedParam,T=!!a.treatTechHintAsFilter,d=a.ignoreFormFactor,e=a.sortResultOnTexts?"text":"intent";var E=this._validateGetSemanticObjectLinksArgs(a);if(E){return new jQuery.Deferred().reject(E).promise();}if(s==="*"){return new jQuery.Deferred().resolve([]).promise();}function C(U,P){var B=U.paramsToString(P);return B?"?"+B:"";}var f=this,U=this._getURLParsing(),D=new jQuery.Deferred(),F=sap.ushell.utils.getFormFactor(),o=U.parseParameters(C(U,P)),j={semanticObject:(s===""?undefined:s),action:b,formFactor:(d?undefined:F),params:o};if(T){j.treatTechHintAsFilter=true;}this._getMatchingInbounds(j,I,true).done(function(m){var k={},r=m.map(function(M){var l=s||M.inbound.semanticObject,n="#"+l+"-"+M.inbound.action,N;if(l==="*"){return undefined;}if(M.inbound.action==="*"){return undefined;}if(M.inbound&&M.inbound.hasOwnProperty("hideIntentLink")&&M.inbound.hideIntentLink===true){return undefined;}if(!k.hasOwnProperty(n)){k[n]=1;if(M.inbound.signature.additionalParameters==="ignored"){N=f._filterObjectKeys(o,function(v){return(v.indexOf("sap-")===0)||M.inbound.signature.parameters.hasOwnProperty(v);},false);}else{N=o;}if(w){var q=Object.keys(N).some(function(v){return v.indexOf("sap-")!==0;});if(!q){return undefined;}}return{"intent":n+C(U,N),"text":M.inbound.title};}else{k[n]++;}return undefined;}).filter(function(l){return typeof l==="object";}).sort(function(G,l){return G[e]<l[e]?-1:1;});if(r.length===0){jQuery.sap.log.debug("_getLinks returned no results");}else if(jQuery.sap.log.getLevel()>=jQuery.sap.log.Level.DEBUG){if(jQuery.sap.log.getLevel()>=jQuery.sap.log.Level.TRACE){var R=[];r.forEach(function(l){var n=l.intent.split("?")[0],L="- "+n+" ("+k[n]+") "+"text: "+l.text+" "+"intent: "+l.intent;R.push(L);});jQuery.sap.log.debug("_getLinks filtered to the following unique intents:",R.join("\n"),"sap.ushell.services.ClientSideTargetResolution");}else{jQuery.sap.log.debug("_getLinks filtered to unique intents.","Reporting histogram: "+Object.keys(k).join(", "),"sap.ushell.services.ClientSideTargetResolution");}}D.resolve(r);}).fail(D.reject.bind(D));return D.promise();};this._serializeMatchingResult=function(m,I){var r=m.inbound.resolutionResult;return["applicationType","ui5ComponentName","url","additionalInformation","text"].map(function(k){if(I){return r.hasOwnProperty(k)?k+":"+r[k]:"";}return r.hasOwnProperty(k)?r[k]:"";}).join("");};this._getMatchingInbounds=function(s,I,e){var a=this,d=new jQuery.Deferred(),r=new jQuery.Deferred(),R=new jQuery.Deferred();function w(b){var C=jQuery.sap.log.getLevel();if(C>=jQuery.sap.log.Level.DEBUG){var j=C>=jQuery.sap.log.Level.TRACE;b(j);}}function U(k,v){return this[k]===undefined?"<undefined>":v;}var f=function(){var m=[],M={},P=[],b=[],n={};w(function(){jQuery.sap.log.debug("Intent to navigate to is: \"#"+((s||{}).semanticObject||"")+"-"+((s||{}).action||"")+"\" with parameters"+"\n"+JSON.stringify(s.params,U,"   "),null,"sap.ushell.services.ClientSideTargetResolution");});b=I;if(e){b=I.filter(function(o){return!o.tileResolutionResult||!o.tileResolutionResult.isCustomTile;});}b.forEach(function(o){var j=a._matchToInbound(s,o,{},M);if(j.matches){m.push(j);P.push(o);}else{w(function(){if(!n[j.noMatchReason]){n[j.noMatchReason]=[];}n[j.noMatchReason].push("#"+(j.inbound||{}).semanticObject+"-"+(j.inbound||{}).action+(j.noMatchDebug?"|"+j.noMatchDebug:""));});}});w(function(j){if(j){Object.keys(n).forEach(function(k){jQuery.sap.log.debug(k+": "+n[k].join("; "),null,"sap.ushell.services.ClientSideTargetResolution");});}});if(jQuery.isEmptyObject(M)){r.resolve(m);}else{w(function(j){jQuery.sap.log.debug(j?"A rematch is required because the following user defaults need to be determined:"+"\n"+Object.keys(M).join("\n"):"A rematch is required because one or more user defaults need to be determined.",null,"sap.ushell.services.ClientSideTargetResolution");});sap.ushell.Container.getService("ReferenceResolver").resolveReferences(Object.keys(M)).done(function(o){R.resolve(o,P);}).fail(function(E){jQuery.sap.log.error("Failed to resolve all references",E,"sap.ushell.services.ClientSideTargetResolution");r.resolve([]);});}};if(sap.ushell.utils.getParameterValueBoolean("sap-ushell-cstr-timeout")){setTimeout(f,0);}else{f();}R.done(function(k,P){w(function(j){jQuery.sap.log.debug(j?"Rematching with the following resolved user defaults:"+JSON.stringify(k,U,"   "):"Rematching with resolved user defaults.",null,"sap.ushell.services.ClientSideTargetResolution");});var b=[],m={};P.forEach(function(o){var M=a._matchToInbound(s,o,k,m);if(M.matches){b.push(M);}});if(jQuery.isEmptyObject(m)){r.resolve(b);}else{jQuery.sap.log.error("Still obtained unknown references during rematch",JSON.stringify(m,U,"   "),"sap.ushell.services.ClientSideTargetResolution");d.reject("Rematching returned unknown references!");}});r.done(function(P){a._sortMatchingResultsDeterministic(P);w(function(b){if(P.length===0){w(function(){jQuery.sap.log.debug("The intent did not match any inbounds",null,"sap.ushell.services.ClientSideTargetResolution");});return;}var T=0,j=function(m,v){return(m==="_original")?undefined:U.call(this,m,v);},k=P.map(function(m){var C="";T++;if(b){C=" "+(m["sap-priority"]||"")+" Priority: "+(m["sap-priority"]?"sap-priority : "+m["sap-priority"]:"")+m.priorityString+" Signature: "+a._compactSignatureNotation((m.inbound||{}).signature)+" Deterministic blob: "+a._serializeMatchingResult(m,true);}return T+". #"+(m.inbound||{}).semanticObject+"-"+(m.inbound||{}).action+C;}).join("\n"),l=b?JSON.stringify(P[0],U,"   "):JSON.stringify(P[0].resolutionResult||P[0],j,"   ");jQuery.sap.log.debug("Intent has matched the following inbounds (in priority): \n"+k,"\nTop matched inbound resolves to:"+l,"sap.ushell.services.ClientSideTargetResolution");});d.resolve(P);});return d.promise();};this._sortMatchingResultsDeterministic=function(m){var a=this;m.sort(function(M,o){if((M["sap-priority"]||0)-(o["sap-priority"]||0)!==0){return-((M["sap-priority"]||0)-(o["sap-priority"]||0));}if(M.priorityString<o.priorityString){return 1;}if(M.priorityString>o.priorityString){return-1;}return(a._serializeMatchingResult(M)<a._serializeMatchingResult(o))?1:-1;});};this._isIntentSupportedOne=function(I,a){var d=new jQuery.Deferred(),s=this._getURLParsing().parseShellHash(I);if(I==="#"){d.resolve(true);return d.promise();}if(s===undefined){jQuery.sap.log.error("Could not parse shell hash '"+I+"'","please specify a valid shell hash","sap.ushell.services.ClientSideTargetResolution");return d.reject().promise();}s.formFactor=sap.ushell.utils.getFormFactor();this._getMatchingInbounds(s,a,true).done(function(T){d.resolve(T.length>0);}).fail(function(){d.reject();});return d.promise();};this.isIntentSupported=function(I){var a=this,d=new jQuery.Deferred();this._ensureInbounds().done(function(b){a._isIntentSupported(I,b).done(d.resolve.bind(d)).fail(d.reject.bind(d));}).fail(d.reject.bind(d));return d.promise();};this._isIntentSupported=function(I,a){var b=this,d=new jQuery.Deferred(),s={};d.resolve();function e(f,j){s[f]={supported:j};}I.forEach(function(f){var n=b._isIntentSupportedOne(f,a);n.fail(function(E){e(f,false);});n.done(function(R){e(f,R);});d=jQuery.when(d,n);});var r=new jQuery.Deferred();d.done(function(){r.resolve(s);}).fail(function(){r.reject.bind(d);});return r.promise();};this.getUserDefaultParameterNames=function(){var a=this,d=new jQuery.Deferred();this._ensureInbounds().done(function(I){var r;try{r=a._getUserDefaultParameterNames(I);d.resolve(r);}catch(e){d.reject("Cannot get user default parameters from inbounds: "+e);}}).fail(d.reject.bind(d));return d.promise();};this._getUserDefaultParameterNames=function(I){var r={simple:{},extended:{}};I.forEach(function(T){var s=T.signature&&T.signature.parameters||[];Object.keys(s).forEach(function(P){var o=s[P],R,e,a,b;if(o){if(o.filter&&o.filter.format==="reference"){a=o.filter.value;}else if(o.defaultValue&&o.defaultValue.format==="reference"){a=o.defaultValue.value;}if(typeof a==="string"){b=sap.ushell.Container.getService("ReferenceResolver");R=b.extractUserDefaultReferenceName(a);if(typeof R==="string"){r.simple[R]={};}e=b.extractExtendedUserDefaultReferenceName(a);if(typeof e==="string"){r.extended[e]={};}}}});});return r;};this._compactSignatureNotation=function(s){var f=s||{};var P=f.parameters||{},T={optional:"[FORMAT]",required:"FORMAT"},F={regexp:"/VALUE/",reference:"@VALUE",value:"VALUE",plain:"VALUE",_unknown:"?VALUE"},a={allowed:"<+>",notallowed:"<->",ignored:"<o>",_unknown:"<?>"};if(jQuery.isEmptyObject(P)){return"<no params>"+(a[f.additionalParameters||"_unknown"]);}var r=[];Object.keys(P).forEach(function(b){var o=P[b],d=o.required?"required":"optional",e=o.filter&&o.filter.value,j=o.defaultValue&&o.defaultValue.value,k=(o.filter&&o.filter.format)||"plain",l=(o.defaultValue&&o.defaultValue.format)||"plain";var v=[],m=F[k]||F._unknown,n=F[l]||F._unknown;if(e){v.push(T["required"].replace("FORMAT",m.replace("VALUE",e)));}if(j){v.push(T["optional"].replace("FORMAT",n.replace("VALUE",j)));}r.push(T[d].replace("FORMAT",b+":"+v.join("")));});return r.join(";")+(a[f.additionalParameters||"_unknown"]);};this.getEasyAccessSystems=function(){var e={},d;d=sap.ushell.utils.getFormFactor();if(!H){H=new jQuery.Deferred();this._ensureInbounds().done(function(I){I.forEach(function(o){var s;if(o&&o.semanticObject&&o.semanticObject==="Shell"&&o.action&&(o.action==="startGUI"||o.action==="startWDA")&&o.deviceTypes&&d!==undefined&&o.deviceTypes[d]){if(jQuery.isPlainObject(o.signature.parameters["sap-system"])&&o.signature.parameters["sap-system"].hasOwnProperty("filter")){s=jQuery.sap.getObject("signature.parameters.sap-system.filter.value",undefined,o);}if(typeof s==="string"){if(!e[s]){e[s]={text:o.title,appType:{}};}else if(o.action==="startGUI"){e[s].text=o.title;}if(o.action==="startGUI"){e[s].appType.TR=true;}else if(o.action==="startWDA"){e[s].appType.WDA=true;}}}});H.resolve(e);}).fail(H.reject.bind(H));}return H.promise();};};sap.ushell.services.ClientSideTargetResolution.hasNoAdapter=false;}());
