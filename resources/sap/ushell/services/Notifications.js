// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.services.Notifications");jQuery.sap.require("sap.ui.thirdparty.datajs");sap.ushell.services.Notifications=function(c,p,s){var m=new sap.ui.model.json.JSONModel(),t=new Date(),S=s&&s.config,r={getNotifications:{},getNotificationsByType:{},getNotificationsInGroup:{},getBadgeNumber:{},resetBadgeNumber:{},getNotificationTypesSettings:{},getNotificationsGroupHeaders:{},getMobileSupportSettings:{},getNotificationCount:{}},w,W=S.webSocketUrl||"/sap/bc/apc/iwngw/notification_push_apc",P=S.pollingIntervalInSeconds||60,u=[],U=[],a=[],i=false,C=[],I=false,o=false,E=true,h,d,b=5000,f=6000,g=false,O={NOTIFICATIONS:0,NOTIFICATIONS_BY_TYPE:1,GET_BADGE_NUMBER:2,RESET_BADGE_NUMBER:3,GET_SETTINGS:4,GET_MOBILE_SUPPORT_SETTINGS:5,NOTIFICATIONS_GROUP_HEADERS:6,NOTIFICATIONS_IN_GROUP:7,GET_NOTIFICATIONS_COUNT:8,NOTIFICATIONS_BY_DATE_DESCENDING:"notificationsByDateDescending",NOTIFICATIONS_BY_DATE_ASCENDING:"notificationsByDateAscending",NOTIFICATIONS_BY_PRIORITY_DESCENDING:"notificationsByPriorityDescending",NOTIFICATIONS_BY_TYPE_DESCENDING:"notificationsByTypeDescending"},M={PACKAGED_APP:0,FIORI_CLIENT:1,WEB_SOCKET:2,POLLING:3},j,F=false,k,l=true,n=false,H=true,q=false,v=new jQuery.Deferred(),N=new jQuery.Deferred(),z,A=v.promise(),B=false,D=300,G={},J=10,K=false;this.isEnabled=function(){if(!S.enabled||!S.serviceUrl){E=false;if(S.enabled&&!S.serviceUrl){jQuery.sap.log.warning("No serviceUrl was found in the service configuration");}}else{E=true;}return E;};this.init=function(){if((!I)&&(this.isEnabled())){if(B===true){this._createDummyItems();}this.lastNotificationDate=new Date();l=S.enableNotificationsPreview;this._setWorkingMode();I=true;this.bUpdateDependencyInitiatorExists=false;this._userSettingInitialization();}};this.getUnseenNotificationsCount=function(){var e=jQuery.Deferred();e.resolve(m.getProperty("/UnseenCount"));return e.promise();};this.getNotificationsCount=function(){return m.getProperty("/NotificationsCount")?m.getProperty("/NotificationsCount"):"0";};this.getNotificationsByTypeWithGroupHeaders=function(){var e,R,x=new jQuery.Deferred(),y=this._getRequestURI(O.NOTIFICATIONS_BY_TYPE);R={requestUri:y};if(!this._getHeaderXcsrfToken()){e={};e["X-CSRF-Token"]="fetch";R.headers=e;}OData.request(R,function(L){x.resolve(L);},function(L){if(L.response&&L.response.statusCode===200&&L.response.body){x.resolve(L.response.body);}else{x.reject();jQuery.sap.log.error("Notification service - oData executeAction failed: ",L,"sap.ushell.services.Notifications");}});return x.promise();};this.getNotificationsGroupHeaders=function(){var e,R,x=new jQuery.Deferred(),y=this._getRequestURI(O.NOTIFICATIONS_GROUP_HEADERS);R={requestUri:y};if(!this._getHeaderXcsrfToken()){e={};e["X-CSRF-Token"]="fetch";R.headers=e;}OData.request(R,function(L){x.resolve(L);},function(L){if(L.response&&L.response.statusCode===200&&L.response.body){x.resolve(L.response.body);}else{x.reject();jQuery.sap.log.error("Notification service - oData executeAction failed: ",L,"sap.ushell.services.Notifications");}});return x.promise();};this.getNotificationsBufferInGroup=function(e,x,T){var y=this,L,R,Q=new jQuery.Deferred(),V={group:e,skip:x,top:T},X,Y,Z=this._getRequestURI(O.NOTIFICATIONS_IN_GROUP,V);if(B===true){X=G[O.NOTIFICATIONS_IN_GROUP].slice(x,x+T);Y=JSON.stringify({"@odata.context":"$metadata#Notifications","value":X});setTimeout(function(){Q.resolve(Y);},1000);}else{R={requestUri:Z};if(!this._getHeaderXcsrfToken()){L={};L["X-CSRF-Token"]="fetch";R.headers=L;}OData.request(R,function($){y._updateCSRF($.response);Q.resolve($.value);},function($){if($.response&&$.response.statusCode===200&&$.response.body){y._updateCSRF($.response);Q.resolve(JSON.parse($.response.body).value);}else{Q.reject();jQuery.sap.log.error("Notification service - oData executeAction failed: ",$,"sap.ushell.services.Notifications");}});}return Q.promise();};this.getNotificationsBufferBySortingType=function(e,x,T){var y=this,L,R,Q=new jQuery.Deferred(),V={skip:x,top:T},X,Y,Z=this._getRequestURI(e,V);if(B===true){X=G[e].slice(x,x+T);Y=JSON.stringify({"@odata.context":"$metadata#Notifications","value":X});setTimeout(function(){Q.resolve(Y);},1000);}else{R={requestUri:Z};if(!this._getHeaderXcsrfToken()){L={};L["X-CSRF-Token"]="fetch";R.headers=L;}OData.request(R,function($){y._updateCSRF($.response);Q.resolve($.value);},function($){if($.response&&$.response.statusCode===200&&$.response.body){y._updateCSRF($.response);Q.resolve(JSON.parse($.response.body).value);}else{Q.reject();jQuery.sap.log.error("Notification service - oData executeAction failed: ",$,"sap.ushell.services.Notifications");}});}return Q.promise();};this.getNotifications=function(){var R,e=jQuery.Deferred();if((j===M.FIORI_CLIENT)||(j===M.PACKAGED_APP)){R=this._readNotificationsData(false);R.done(function(){e.resolve(m.getProperty("/Notifications"));}).fail(function(x){e.reject();});}else{e.resolve(m.getProperty("/Notifications"));}return e.promise();};this.executeBulkAction=function(e,x){var y=new jQuery.Deferred(),L=[],Q=[],R={succededNotifications:L,failedNotifications:Q},T=[],V=this;e.forEach(function(X,Y){var Z=new jQuery.Deferred();T.push(Z.promise());V.executeAction(X,x).done(function(){L.push(X);Z.resolve();}).fail(function(){Q.push(X);Z.resolve();});});jQuery.when.apply(jQuery,T).always(function(){if(Q.length){y.reject(R);}else{y.resolve(R);}});return y.promise();};this.dismissBulkNotifications=function(e){var x=new jQuery.Deferred(),y=[],L=[],R={succededNotifications:y,failedNotifications:L},Q=[],T=this;e.forEach(function(V,X){var Y=new jQuery.Deferred();Q.push(Y.promise());T.dismissNotification(V).done(function(){y.push(V);Y.resolve();}).fail(function(){L.push(V);Y.resolve();});});jQuery.when.apply(jQuery,Q).always(function(){if(L.length){x.reject(R);}else{x.resolve(R);}});return x.promise();};this.executeAction=function(e,x){var y=S.serviceUrl+"/ExecuteAction",R={NotificationId:e,ActionId:x},L={requestUri:y,method:"POST",data:R,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","DataServiceVersion":d,"X-CSRF-Token":h}},Q=jQuery.Deferred();OData.request(L,function(T){var V,X={isSucessfull:true,message:""};if(T&&T.response&&T.response.statusCode===200&&T.response.body){V=JSON.parse(T.response.body);X.isSucessfull=V.Success;X.message=V.MessageText;}Q.resolve(X);},function(T){var V,X={isSucessfull:false,message:""};if(T.response&&T.response.statusCode===200&&T.response.body){V=JSON.parse(T.response.body);X.isSucessfull=V.Success;X.message=V.MessageText;Q.resolve(X);}else{Q.reject();jQuery.sap.log.error("Notification service - oData executeAction failed: ",T,"sap.ushell.services.Notifications");}});return Q.promise();};this.markRead=function(e){var x=S.serviceUrl+"/MarkRead",R={NotificationId:e},y={requestUri:x,method:"POST",data:R,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","DataServiceVersion":d,"X-CSRF-Token":h}},L=jQuery.Deferred();OData.request(y,function(Q){L.resolve();},function(Q){L.reject();jQuery.sap.log.error("Notification service - oData markRead failed: ",Q,"sap.ushell.services.Notifications");});return L.promise();};this.dismissNotification=function(e){var x=S.serviceUrl+"/Dismiss",R={NotificationId:e},y={requestUri:x,method:"POST",data:R,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","DataServiceVersion":d,"X-CSRF-Token":h}},L=jQuery.Deferred();OData.request(y,function(Q){L.resolve();},function(Q){L.reject();jQuery.sap.log.error("Notification service - oData dismiss notification failed: ",Q,"sap.ushell.services.Notifications");});return L.promise();};this.registerNotificationsUpdateCallback=function(e){u.push(e);};this.registerDependencyNotificationsUpdateCallback=function(e,x){if(x===false){this.bUpdateDependencyInitiatorExists=true;}U.push({callback:e,dependent:x});};this.registerNotificationCountUpdateCallback=function(e){a.push(e);};this.notificationsSeen=function(){this._setNotificationsAsSeen();};this.isFirstDataLoaded=function(){return F;};this.readSettings=function(){var e;e=this._readSettingsFromServer();return e;};this.saveSettingsEntry=function(e){var x;x=this._writeSettingsEntryToServer(e);return x;};this.getUserSettingsFlags=function(){var e=new jQuery.Deferred();if(q===true){e.resolve({previewNotificationEnabled:n,highPriorityBannerEnabled:H});}else{A.done(function(){e.resolve({previewNotificationEnabled:n,highPriorityBannerEnabled:H});});}return e.promise();};this.setUserSettingsFlags=function(e){n=e.previewNotificationEnabled;H=e.highPriorityBannerEnabled;this._writeUserSettingsFlagsToPersonalization(e);};this._getNotificationSettingsMobileSupport=function(){return z;};this.getPreviewNotificationEnabledConfig=function(){return l;};this.destroy=function(){o=true;if((j===M.WEB_SOCKET)&&w){w.close();}};this._readUnseenNotificationsCount=function(e){var x=this,y=new jQuery.Deferred(),L=this._getRequestURI(O.GET_BADGE_NUMBER),R={requestUri:L};OData.read(R,function(Q,T){m.setProperty("/UnseenCount",T.data.GetBadgeNumber.Number);x._setNativeIconBadge(T.data.GetBadgeNumber.Number);y.resolve(T.data.GetBadgeNumber.Number);},function(Q){if(Q.response&&Q.response.statusCode===200&&Q.response.body){var T=JSON.parse(Q.response.body);m.setProperty("/UnseenCount",T.value);x._setNativeIconBadge(T.value);y.resolve(T.value);}else{jQuery.sap.log.error("Notification service - oData read unseen notifications count failed: ",Q.message,"sap.ushell.services.Notifications");y.reject();}});return y.promise();};this.readNotificationsCount=function(){var e=new jQuery.Deferred(),x=this._getRequestURI(O.GET_NOTIFICATIONS_COUNT),R={requestUri:x};OData.read(R,function(y,L){e.resolve(L.data);},function(y){if(y.response&&y.response.statusCode===200&&y.response.body){var L=JSON.parse(y.response.body);e.resolve(L.value);}else{jQuery.sap.log.error("Notification service - oData read notifications count failed: ",y.message,"sap.ushell.services.Notifications");e.reject();}});return e.promise();};this._getNotificationSettingsAvalability=function(){return N.promise();};this._setNotificationsAsSeen=function(){var R=this._getRequestURI(O.RESET_BADGE_NUMBER),e={requestUri:R,method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","DataServiceVersion":d,"X-CSRF-Token":h}};if(this._isFioriClientMode()===true||this._isPackagedMode()===true){this._setNativeIconBadge(0);}OData.request(e,function(x,y){},function(x){jQuery.sap.log.error("Notification service - oData reset badge number failed: ",x,"sap.ushell.services.Notifications");});};this._readNotificationsData=function(e){var x=this,R,y,L,Q=new jQuery.Deferred(),T=[];R=this._readUnseenNotificationsCount(e);T.push(R);L=this.readNotificationsCount();L.done(function(V){m.setProperty("/NotificationsCount",V);});y=this.getNotificationsBufferBySortingType(O.NOTIFICATIONS_BY_DATE_DESCENDING,0,J);T.push(y);jQuery.when.apply(jQuery,T).then(function(V){T[0].done(function(X){if(e===true){x._updateNotificationsCountConsumers();}});T[1].done(function(X){m.setProperty("/Notifications",X);x._notificationAlert(X);if(e===true){x._updateNotificationsConsumers();x._updateDependentNotificationsConsumers();}Q.resolve();});});return Q.promise();};this._getHeaderXcsrfToken=function(){return h;};this._getDataServiceVersion=function(){return d;};this._getRequestURI=function(R,e){var x,y=encodeURI(this._getConsumedIntents(R));switch(R){case O.NOTIFICATIONS:if(r.getNotifications.basic===undefined){r.getNotifications.basic=S.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$filter=IsGroupHeader%20eq%20false";}if(this._isIntentBasedConsumption()){if(r.getNotifications.byIntents===undefined){r.getNotifications.byIntents=r.getNotifications.basic.concat("&intents%20eq%20"+y);}return r.getNotifications.byIntents;}return r.getNotifications.basic;case O.NOTIFICATIONS_BY_TYPE:if(r.getNotificationsByType.basic===undefined){r.getNotificationsByType.basic=S.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams";}if(this._isIntentBasedConsumption()){if(r.getNotificationsByType.byIntents===undefined){r.getNotificationsByType.byIntents=r.getNotificationsByType.basic.concat("&$filter=intents%20eq%20"+y);}return r.getNotificationsByType.byIntents;}return r.getNotificationsByType.basic;case O.NOTIFICATIONS_GROUP_HEADERS:if(r.getNotificationsGroupHeaders.basic===undefined){r.getNotificationsGroupHeaders.basic=S.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$filter=IsGroupHeader%20eq%20true";}if(this._isIntentBasedConsumption()){if(r.getNotificationsGroupHeaders.byIntents===undefined){r.getNotificationsGroupHeaders.byIntents=r.getNotificationsGroupHeaders.basic.concat("&intents%20eq%20"+y);}return r.getNotificationsGroupHeaders.byIntents;}return r.getNotificationsGroupHeaders.basic;case O.NOTIFICATIONS_IN_GROUP:if(r.getNotificationsInGroup.basic===undefined){r.getNotificationsInGroup.basic=S.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=CreatedAt%20desc&$filter=IsGroupHeader%20eq%20false&ParentId%20eq%20"+e.group+"$skip="+e.skip+"&$top="+e.top;}if(this._isIntentBasedConsumption()){if(r.getNotificationsInGroup.byIntents===undefined){r.getNotificationsInGroup.byIntents=r.getNotificationsInGroup.basic.concat("&intents%20eq%20"+y);}return r.getNotificationsInGroup.byIntents;}return r.getNotificationsInGroup.basic;case O.GET_BADGE_NUMBER:if(r.getBadgeNumber.basic===undefined){r.getBadgeNumber.basic=S.serviceUrl+"/GetBadgeNumber()";}if(this._isIntentBasedConsumption()){if(r.getBadgeNumber.byIntents===undefined){r.getBadgeNumber.byIntents=S.serviceUrl+"/GetBadgeCountByIntent("+y+")";}return r.getBadgeNumber.byIntents;}return r.getBadgeNumber.basic;case O.GET_NOTIFICATIONS_COUNT:if(r.getNotificationCount.basic===undefined){r.getNotificationCount.basic=S.serviceUrl+"/Notifications/$count";}return r.getNotificationCount.basic;case O.RESET_BADGE_NUMBER:if(r.resetBadgeNumber.basic===undefined){r.resetBadgeNumber.basic=S.serviceUrl+"/ResetBadgeNumber";}return r.resetBadgeNumber.basic;case O.GET_SETTINGS:if(r.getNotificationTypesSettings.basic===undefined){r.getNotificationTypesSettings.basic=S.serviceUrl+"/NotificationTypePersonalizationSet";}return r.getNotificationTypesSettings.basic;case O.GET_MOBILE_SUPPORT_SETTINGS:if(r.getMobileSupportSettings.basic===undefined){r.getMobileSupportSettings.basic=S.serviceUrl+"/Channels(ChannelId='SAP_SMP')";}return r.getMobileSupportSettings.basic;case O.NOTIFICATIONS_BY_DATE_DESCENDING:x=S.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=CreatedAt%20desc&$filter=IsGroupHeader%20eq%20false&$skip="+e.skip+"&$top="+e.top;if(this._isIntentBasedConsumption()===true){x=x.concat("&intents%20eq%20"+y);}break;case O.NOTIFICATIONS_BY_DATE_ASCENDING:x=S.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=CreatedAt%20asc&$filter=IsGroupHeader%20eq%20false&$skip="+e.skip+"&$top="+e.top;if(this._isIntentBasedConsumption()===true){x=x.concat("&intents%20eq%20"+y);}break;case O.NOTIFICATIONS_BY_PRIORITY_DESCENDING:x=S.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=Priority%20desc&$filter=IsGroupHeader%20eq%20false&$skip="+e.skip+"&$top="+e.top;if(this._isIntentBasedConsumption()===true){x=x.concat("&intents%20eq%20"+y);}break;default:x="";}return x;};this._readSettingsFromServer_noConnection=function(){var e=jQuery.Deferred(),x=[{NotificationTypeId:"type1",NotificationTypeDesc:"aaaaabbbbb-cccccddddd",PriorityDefault:"40-HIGH",DoNotDeliver:false,DoNotDeliverMob:true},{NotificationTypeId:"type2",NotificationTypeDesc:"cccccdddddccc-aaaaabbbbb",PriorityDefault:"10-LOW",DoNotDeliver:true,DoNotDeliverMob:true}];e.resolve(JSON.stringify({"@odata.context":"$metadata#NotificationTypePersonalizationSet","value":x}));return e.promise();};this._readSettingsFromServer_noData=function(){var e=jQuery.Deferred();e.resolve(JSON.stringify({"@odata.context":"$metadata#NotificationTypePersonalizationSet","value":{}}));return e.promise();};this._readSettingsFromServer=function(){var R=this._getRequestURI(O.GET_SETTINGS),e={requestUri:R},x=jQuery.Deferred();OData.request(e,function(y){x.resolve(y.results);},function(y){if(y.response&&y.response.statusCode===200&&y.response.body){x.resolve(y.response.body);}else{x.reject();jQuery.sap.log.error("Notification service - oData get settings failed: ",y,"sap.ushell.services.Notifications");}});return x.promise();};this._readMobileSettingsFromServer=function(){var R=this._getRequestURI(O.GET_MOBILE_SUPPORT_SETTINGS),e={requestUri:R},x=jQuery.Deferred();OData.request(e,function(y){x.resolve(y.results);},function(y){if(y.response&&y.response.statusCode===200&&y.response.body){x.resolve(y.response.body);}else{x.reject();jQuery.sap.log.error("Notification service - oData get settings failed: ",y,"sap.ushell.services.Notifications");}});return x.promise();};this._writeSettingsEntryToServer=function(e){var x,y=this._getRequestURI(O.GET_SETTINGS)+"(NotificationTypeId="+e.NotificationTypeId+")",R={requestUri:y,method:"PUT",data:{"@odata.context":"$metadata#NotificationTypePersonalizationSet/$entity","NotificationTypeId":e.NotificationTypeId,"NotificationTypeDesc":e.NotificationTypeDesc,"PriorityDefault":e.PriorityDefault,"DoNotDeliver":e.DoNotDeliver,"DoNotDeliverMob":e.DoNotDeliverMob},headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","DataServiceVersion":d,"X-CSRF-Token":h}};x=jQuery.Deferred();OData.request(R,function(L){x.resolve(L);},function(L){if(L.response&&L.response.statusCode===200&&L.response.body){x.resolve(L.response.body);}else{x.reject();jQuery.sap.log.error("Notification service - oData set settings entry failed: ",L,"sap.ushell.services.Notifications");}});return x.promise();};this._updateNotificationsConsumers=function(){u.forEach(function(e){e();});};this._updateDependentNotificationsConsumers=function(){var e=this,x=new jQuery.Deferred();U.forEach(function(y){if(e.bUpdateDependencyInitiatorExists===false){y.callback();}else{y.dependent===true?y.callback(x.promise()):y.callback(x);}});};this._updateNotificationsCountConsumers=function(){a.forEach(function(e){e();});};this._updateAllConsumers=function(){this._updateNotificationsConsumers();this._updateNotificationsCountConsumers();this._updateDependentNotificationsConsumers();};this._getModel=function(){return m;};this._getMode=function(){return j;};this._setWorkingMode=function(){var e;if(S.intentBasedConsumption===true){C=this._getIntentsFromConfiguration(S.consumedIntents);if(C.length>0){i=true;}}if(this._isPackagedMode()){j=M.PACKAGED_APP;e=this._getIntentsFromConfiguration(window.fiori_client_appConfig.applications);if(e.length>0){C=e;}if(C.length>0){i=true;}this._registerForPush();this._readNotificationsData(true);this._setNativeIconBadgeWithDelay();return;}this._performFirstRead();};this._performFirstRead=function(){var e=this,x,R=this._readNotificationsData(true);R.done(function(){x=e._getFioriClientRemainingDelay();if(x<=0){e._fioriClientStep();}else{setTimeout(function(){e._fioriClientStep();},x);}F=true;}).fail(function(y){jQuery.sap.log.error("Notifications oData read failed. Error: "+y);return;});};this._fioriClientStep=function(){var e=this,x;if(this._isFioriClientMode()){j=M.FIORI_CLIENT;this._addPushNotificationHandler();x=this.getUnseenNotificationsCount();x.done(function(y){e._setNativeIconBadge(y,function(){});}).fail(function(){});}else{this._webSocketStep();}};this._webSocketStep=function(){j=M.WEB_SOCKET;this._establishWebSocketConnection();};this._webSocketRecoveryStep=function(){if(g===false){g=true;setTimeout(function(){this._webSocketStep();}.bind(this),b);}else{this._activatePollingAfterInterval();}};this._activatePollingAfterInterval=function(){var e=this;setTimeout(function(){e._activatePolling();},P*1000);};this._activatePolling=function(){var e=this;j=M.POLLING;this._readNotificationsData(true);this.timer=setTimeout(e._activatePolling.bind(e,P,false),(P*1000));};this._formatAsDate=function(e){return new Date(e);};this._notificationAlert=function(e){if(H===false){return;}var x,y=[],L=0;for(x in e){if(this.lastNotificationDate&&this._formatAsDate(e[x].CreatedAt)>this.lastNotificationDate){if(e[x].Priority==="HIGH"){y.push(e[x]);}}if(L<this._formatAsDate(e[x].CreatedAt)){L=this._formatAsDate(e[x].CreatedAt);}}if(this.lastNotificationDate&&y&&y.length>0){sap.ui.getCore().getEventBus().publish("sap.ushell.services.Notifications","onNewNotifications",y);}this.lastNotificationDate=L;};this._getFioriClientRemainingDelay=function(){return f-(new Date()-t);};this._establishWebSocketConnection=function(){var x=this,y;jQuery.sap.require("sap.ui.core.ws.SapPcpWebSocket");try{w=new sap.ui.core.ws.SapPcpWebSocket(W,[sap.ui.core.ws.SapPcpWebSocket.SUPPORTED_PROTOCOLS.v10]);w.attachMessage(this,function(L,Q){y=L.getParameter("pcpFields");if((y)&&(y.Command)&&(y.Command==="Notification")){x._readNotificationsData(true);}});w.attachClose(this,function(L,Q){jQuery.sap.log.error("Notifications UShell service WebSocket: attachClose called with code: "+L.mParameters.code+" and reason: "+L.mParameters.reason);if(!o){x._webSocketRecoveryStep();}});w.attachError(this,function(L,Q){jQuery.sap.log.error("Notifications UShell service WebSocket: attachError called!");});}catch(e){jQuery.sap.log.error("Exception occurred while creating new sap.ui.core.ws.SapPcpWebSocket. Message: "+e.message);}};this._isFioriClientMode=function(){return!(sap.FioriClient===undefined);};this._isPackagedMode=function(){return(window.fiori_client_appConfig&&window.fiori_client_appConfig.prepackaged===true);};this._setNativeIconBadge=function(e){if((sap.Push!==undefined)&&(sap.Push.setBadgeNumber!==undefined)){sap.Push.setBadgeNumber(e,function(){});}};this._setNativeIconBadgeWithDelay=function(){var e=this,x;setTimeout(function(){x=e.getUnseenNotificationsCount();x.done(function(y){e._setNativeIconBadge(y);}).fail(function(){});},4000);};this._getIntentsFromConfiguration=function(e){var T=[],x,y;if(e&&e.length>0){for(y=0;y<e.length;y++){x=e[y].intent;T.push(x);}}return T;};this._handlePushedNotification=function(e){var x,y,L,Q,R=[],V;if(e!==undefined){if((e.additionalData===undefined)||(e.additionalData.foreground===true)){this._readNotificationsData(true);}else{x=e.NotificationId;y=e.NavigationTargetObject;L=e.NavigationTargetAction;Q=e.NavigationTargetParam;if(Q){if(typeof Q==='string'||Q instanceof String){R[0]=Q;}else if(Array.isArray(Q)===true){R=Q;}}if((typeof hasher!=="undefined")&&(hasher.getHash()===y+"-"+L)){V=sap.ui.getCore().byId('viewPortContainer');if(V){V.switchState("Center");}}sap.ushell.utils.toExternalWithParameters(y,L,R);this.markRead(x);this._readNotificationsData(true);}}};this._registerForPush=function(){sap.Push.initPush(this._handlePushedNotification.bind(this));};this._addPushNotificationHandler=function(){document.addEventListener("deviceready",this._registerForPush.bind(this),false);};this._isIntentBasedConsumption=function(){return i;};this._getConsumedIntents=function(R){var e="",x;if(!this._isIntentBasedConsumption()){return e;}if(C.length>0){if(R!==O.GET_BADGE_NUMBER){e="&";}for(x=0;x<C.length;x++){if(R===O.GET_BADGE_NUMBER){if(x===0){e=C[x];}else{e=e+","+C[x];}}else{e=e+"NavigationIntent%20eq%20%27"+C[x]+"%27";}}}return e;};this._notificationsAscendingSortBy=function(e,L){e.sort(function(x,y){var Q=x[L],R=y[L];if(Q===R){Q=x.id;R=y.id;}return R>Q?-1:1;});return e;};this._notificationsDescendingSortBy=function(e,L){e.sort(function(x,y){var Q=x[L],R=y[L];if(Q===R){Q=x.id;R=y.id;return Q>R?-1:1;}if(L==="Priority"){if(Q==="HIGH"){return-1;}if(R==="HIGH"){return 1;}if(Q==="MEDIUM"){return-1;}return 1;}return Q>R?-1:1;});return e;};this.getOperationEnum=function(){return O;};this._readUserSettingsFlagsFromPersonalization=function(){var e=this,x,y;try{y=this._getUserSettingsPersonalizer().getPersData();}catch(L){jQuery.sap.log.error("Personalization service does not work:");jQuery.sap.log.error(L.name+": "+L.message);x=new jQuery.Deferred();x.reject(L);y=x.promise();}y.done(function(Q){if(Q===undefined){e._writeUserSettingsFlagsToPersonalization({previewNotificationEnabled:n,highPriorityBannerEnabled:H});}else{n=Q.previewNotificationEnabled;H=Q.highPriorityBannerEnabled;}q=true;v.resolve();});y.fail(function(){jQuery.sap.log.error("Reading User Settings flags from Personalization service failed");});};this._writeUserSettingsFlagsToPersonalization=function(e){var x,y;try{y=this._getUserSettingsPersonalizer().setPersData(e);}catch(L){jQuery.sap.log.error("Personalization service does not work:");jQuery.sap.log.error(L.name+": "+L.message);x=new jQuery.Deferred();x.reject(L);y=x.promise();}return y;};this._getUserSettingsPersonalizer=function(){if(k===undefined){k=this._createUserSettingsPersonalizer();}return k;};this._createUserSettingsPersonalizer=function(){var e=sap.ushell.Container.getService("Personalization"),x,y={keyCategory:e.constants.keyCategory.FIXED_KEY,writeFrequency:e.constants.writeFrequency.LOW,clientStorageAllowed:true},L={container:"sap.ushell.services.Notifications",item:"userSettingsData"},Q=e.getPersonalizer(L,y,x);return Q;};this._updateCSRF=function(R){if((K===true)||(R.headers===undefined)){return;}if(!this._getHeaderXcsrfToken()){h=R.headers["x-csrf-token"]||R.headers["X-CSRF-Token"];}if(!this._getDataServiceVersion()){d=R.headers.DataServiceVersion||R.headers["odata-version"];}K=true;};this._userSettingInitialization=function(){var e,x,y={settingsAvailable:false,mobileAvailable:false},L;this._readUserSettingsFlagsFromPersonalization();e=this._readSettingsFromServer();x=this._readMobileSettingsFromServer();L=[e,x];e.done(function(){y.settingsAvailable=true;});x.done(function(R){z=R?JSON.parse(R).IsActive:false;y.mobileAvailable=z;});x.fail(function(){n=true;});jQuery.when.apply(jQuery,L).then(function(Q){N.resolve(y);});};this._createDummyItems=function(e){var x,y,L,Q,R=[],T=[],V=[],X;G[O.NOTIFICATIONS_BY_DATE_DESCENDING]=[];G[O.NOTIFICATIONS_BY_DATE_ASCENDING]=[];G[O.NOTIFICATIONS_BY_PRIORITY_DESCENDING]=[];for(x=0;x<D;x++){y={"Id":x,"OriginId":"G1Y_800","IsActionable":true,"IsRead":false,"IsGroupable":true,"IsGroupHeader":false,"NavigationTargetAction":"toappstatesample","NavigationTargetObject":"Action","NotificationTypeId":"00505692-5975-1EE5-A991-2706A9CB0001","ParentId":"00000000-0000-0000-0000-000000000000","Priority":"HIGH","Text":"A purchase order requires your approval","SensitiveText":"Purchase order #"+x,"GroupHeaderText":"","NotificationCount":0,"Actor":{"Id":"BAR-LEV","DisplayText":"BAR-LEV","ImageSource":"https://scn.sap.com/people/guest/avatar/BAR-LEV.png"},"NavigationTargetParams":[{"NotificationId":"00505692-5975-1ED5-ACF1-77645AE4AF3A","Key":"PurchaseOrderId","Value":"236400"},{"NotificationId":"00505692-5975-1ED5-ACF1-77645AE4AF3A","Key":"PurchaseOrderVendor","Value":"PARTNER_137"}],"Actions":[{"ActionId":"00505692-5975-1EE5-A991-2706A9CC0000","ActionText":"Accept","GroupActionText":"Accept All","Nature":"POSITIVE"},{"ActionId":"00505692-5975-1EE5-A991-2706A9CC0001","ActionText":"Reject","GroupActionText":"Reject All","Nature":"NEGATIVE"}]};L=new Date();y.CreatedAt=new Date(L.getTime()-x*15000);Q=parseInt(Math.random()*3,10);if(Q===0){y.Priority="LOW";V.push(y);}else if(Q===1){y.Priority="MEDIUM";T.push(y);}else{y.Priority="HIGH";R.push(y);}G[O.NOTIFICATIONS_BY_DATE_DESCENDING][x]=y;X=D-1-x;G[O.NOTIFICATIONS_BY_DATE_ASCENDING][X]=y;}G[O.NOTIFICATIONS_BY_PRIORITY_DESCENDING]=G[O.NOTIFICATIONS_BY_PRIORITY_DESCENDING].concat(R).concat(T).concat(V);};};sap.ushell.services.Notifications.hasNoAdapter=true;}());
