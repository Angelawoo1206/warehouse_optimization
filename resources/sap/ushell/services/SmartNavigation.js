// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(s,q){"use strict";var g=(function(){var C=Object.create(null,{"":{value:0|0}});return a;function a(b){var H,i;if(C[b]){return C[b];}H=0|0;i=b.length;while(i--){H=(H<<5)-H+(b.charCodeAt(i)|0);H|=0;}C[b]=H;return H;}})();S.hasNoAdapter=true;s.ui.define(["sap/ushell/services/AppConfiguration","sap/ushell/services/Personalization","sap/ushell/services/URLParsing","sap/ushell/services/CrossApplicationNavigation"],function(a){return new S(a);});s.ushell.services.SmartNavigation=S;function S(a){var A;if(S.instance){return S.instance;}A=Object.create(null);Object.defineProperty(S,"instance",{value:Object.create(null,{getLinks:{value:function(Q){var P,o;var C=s.ushell.Container.getService("CrossApplicationNavigation");var b=s.ushell.Container.getService("Personalization");var i=C.getLinks(Q);var j=a.getCurrentAppliction().sShellHash;if(!j){q.sap.log.warning("Call to SmartNavigation#getLinks() simply "+"delegated to CrossApplicationNavigation#getLinks()"+" because oAppConfiguration#getCurrentAppliction()#sShellHash"+" evaluates to undefined.");return i;}j="#"+j;P=f(j);o=c(P,A,b);return q.when(i,o.getFrequentItems()).then(function(l,F){var u;if(F.length===0){return l;}u=s.ushell.Container.getService("URLParsing");p(l,F,u);return l.sort(function(L,O){return O.clickCount-L.clickCount;});});}},toExternal:{value:function(o){var _=arguments;var D;var T=o.target;var b=function(){var i=s.ushell.Container.getService("CrossApplicationNavigation");return i.toExternal.apply(i,_);};var C=a.getCurrentAppliction().sShellHash;if(!C){q.sap.log.warning("Call to SmartNavigation#toExternal() simply "+"delegated to CrossApplicationNavigation#toExternal()"+" because oAppConfiguration#getCurrentAppliction()#sShellHash"+" evaluates to undefined.");return q.when(b());}C="#"+C;if(T.shellHash){D=h(s.ushell.Container.getService("URLParsing"),T.shellHash);}else{D="#"+T.semanticObject+"-"+T.action;}return t(C,D,A,s.ushell.Container.getService("Personalization")).then(b);}},constructor:{value:S}})});return S.instance;}function t(C,D,a,P){var b=f(C);return c(b,a,P).newItem({appId:D});}function p(l,F,u){m(l,F,u);}function m(l,F,u){var a=Object.create(null);F.forEach(function(A){a[A.appId]=A;});l.forEach(function(L){var b=h(u,L.intent);var o=a[b];L.clickCount=o?o.count:0;});}function c(P,a,o){var b;var A=a[P];if(!A){b=o.getPersonalizer({container:P,item:"data"},{keyCategory:o.constants.keyCategory.FIXED_KEY,writeFrequency:o.constants.writeFrequency.HIGH,clientStorageAllowed:true});A=new R(500,e,d,b.getPersData.bind(b),b.setPersData.bind(b));a[P]=A;}return A;}function e(a,o){return a.appId===o.appId;}function d(a,o){return o.iCount-a.iCount||o.iTimestamp-a.iTimestamp;}function f(a){return"ushell.smartnav."+g(a);}function h(u,i){var T=u.parseShellHash(i);return"#"+T.semanticObject+"-"+T.action;}function R(M,E,C,l,i){var j=30,r;var u=function(o,T){return r.recentUsageArray.some(function(a){if(!E(a.oItem,o)){return false;}q.extend(a.oItem,o);a.iTimestamp=T;a.oItem.timestamp=T;a.aUsageArray[a.aUsageArray.length-1]+=1;a.iCount+=1;a.oItem.count=a.iCount;r.recentUsageArray.sort(C);return true;});};var I=function(o,T){var n={oItem:o,iTimestamp:T,aUsageArray:[1],iCount:1};o.timestamp=T;if(r.recentUsageArray.length===M){r.recentUsageArray.pop();}r.recentUsageArray.unshift(n);};this.newItem=function(o){var D=new q.Deferred();var T=Date.now(),a,b=this,k=this.getDayFromDateObj(new Date());l().done(function(L){r=b.getRecentActivitiesFromLoadedData(L);if(k!==r.recentDay){b.addNewDay();r.recentDay=k;}a=u(o,T);if(!a){I(o,T);}i(r).done(function(n){D.resolve(n);}).fail(function(){D.reject();});});return D.promise();};this.getRecentItemsHelper=function(a){var b=this,D=new q.Deferred(),k=this.getDayFromDateObj(new Date()),n=function(L){var o=[],A=0,v;for(v=0;v<L.recentUsageArray.length&&(!a||A<a);v++){o.push(L.recentUsageArray[v]);A++;}D.resolve(o);};l().done(function(L){r=b.getRecentActivitiesFromLoadedData(L);var o=false;if(k!==r.recentDay){b.addNewDay();r.recentDay=k;o=true;}if(o){i(r).done(function(v){D.resolve(n(r));}).fail(function(){D.reject();});}else{D.resolve(n(r));}});return D.promise();};this.getFrequentItems=function(){var D=new q.Deferred();this.getRecentItemsHelper().done(function(k){var n,w=0,F=[],A,o=k[0]?new Date(k[0].iTimestamp):undefined,v;for(n=0;n<k.length&&w<30;n++){A=k[n];if(A.iCount>0){F.push(A);}v=new Date(A.iTimestamp);if(o.toDateString()!==v.toDateString()){w++;o=v;}}F.sort(function(a,b){return b.iCount-a.iCount;});F=F.slice(0,30);D.resolve(q.map(F,function(a){a.oItem.count=a.iCount;return a.oItem;}));});return D.promise();};this.addNewDay=function(){var a,b;for(a=0;a<r.recentUsageArray.length;a++){b=r.recentUsageArray[a].aUsageArray;if(!b){b=[];r.recentUsageArray[a].aUsageArray=b;r.recentUsageArray[a].iCount=0;}b.push(0);if(b.length>j){r.recentUsageArray[a].iCount-=b[0];b.shift();}}};this.getDayFromDateObj=function(a){return(a.getUTCFullYear()+"/"+(a.getUTCMonth()+1)+"/"+a.getUTCDate());};this.getRecentActivitiesFromLoadedData=function(a){var b;if(q.isArray(a)){b={recentDay:null,recentUsageArray:a};}else{b=a||{recentDay:null,recentUsageArray:[]};}return b;};}})(sap,jQuery);
