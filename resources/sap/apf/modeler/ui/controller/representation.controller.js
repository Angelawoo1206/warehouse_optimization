/*!
* SAP APF Analysis Path Framework
*
* (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
jQuery.sap.require("sap.apf.ui.utils.constants");jQuery.sap.require("sap.apf.core.constants");jQuery.sap.require('sap.apf.modeler.ui.utils.representationTypesHandler');jQuery.sap.require('sap.apf.modeler.ui.utils.stepPropertyMetadataHandler');jQuery.sap.require('sap.apf.modeler.ui.utils.representationHandler');jQuery.sap.require('sap.apf.modeler.ui.utils.representationBasicDataHandler');jQuery.sap.require('sap.apf.modeler.ui.utils.sortDataHandler');jQuery.sap.require('sap.apf.modeler.ui.utils.nullObjectChecker');jQuery.sap.require('sap.apf.modeler.ui.utils.optionsValueModelBuilder');(function(){'use strict';var p,c,C,r,P,R,s,o,a,S;var n=new sap.apf.modeler.ui.utils.NullObjectChecker();var b=new sap.apf.modeler.ui.utils.OptionsValueModelBuilder();var l=sap.apf.core.constants.representationMetadata.labelDisplayOptions;function _(y){y.byId("idVisualization").setText(c.getText("visualization"));y.byId("idChartTypeLabel").setText(c.getText("chartType"));y.byId("idChartTypeLabel").setTooltip(c.getText("chartType"));y.byId("idBasicData").setText(c.getText("basicData"));y.byId("idSorting").setText(c.getText("sorting"));}function d(y,z){var A;var I=R.getPictureOfRepresentationType(r.getRepresentationType());var B=C.getCategoriesForStep(P.getId());if(B.length===1){A={id:r.getId(),icon:I};if(z){A.name=z;}y.getView().getViewData().updateSelectedNode(A);}else{y.getView().getViewData().updateTree();}}function e(y,z){var T=c.getText("representation")+": "+z;y.getView().getViewData().updateTitleAndBreadCrumb(T);}function f(y){r.setRepresentationType(y);var A="TableRepresentation";if(y===sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){A=undefined;}r.setAlternateRepresentationType(A);}function g(y){var D,z,I,A,B,E,F,G;if(y==="TableRepresentation"){if(r.getProperties().length===0){G=R.getKindsForPropertyType(y);F=s.getProperties()[0];r.addProperty(F);r.setPropertyKind(F,G[0]);}}else{if(r.getDimensions().length===0){z=R.getKindsForDimensionPropertyType(y);z.forEach(function(K,H){D=s.getDimensions()[H];if(D){I=s.hasTextPropertyOfDimension(D);A=I?l.KEY_AND_TEXT:l.KEY;r.addDimension(D);r.setLabelDisplayOption(D,A);r.setDimensionKind(D,z[0]);}});}if(r.getMeasures().length===0){E=R.getKindsForMeasurePropertyType(y);E.forEach(function(K,H){B=s.getMeasures()[H];if(B){r.addMeasure(B);r.setMeasureKind(B,K);}});}}}function h(y){var V=[],M;c.getRepresentationTypes().forEach(function(z){if(z.metadata){V.push({key:z.id,name:c.getText(z.id)});}});M=b.prepareModel(V);y.byId("idChartType").setModel(M);y.byId("idChartType").setSelectedKey(r.getRepresentationType());}function i(){if(p&&p.arguments&&p.arguments.stepId){P=C.getStep(p.arguments.stepId);}}function j(y){var z;if(p&&p.arguments&&p.arguments.representationId){r=P.getRepresentation(p.arguments.representationId);}if(!n.checkIsNotUndefined(r)){r=P.createRepresentation();z=c.getRepresentationTypes()[0].id;f(z);d(y);C.setIsUnsaved();}else{z=r.getRepresentationType();w();}g(z);}function k(y){var z=new sap.m.Button({id:y.createId("idPreviewButton"),text:c.getText("preview"),press:y.handlePreviewButtonPress.bind(y)});var F=y.getView().getViewData().oFooter;F.addContentRight(z);}function m(y){var T=y.getView().getViewData().oConfigurationHandler.getTextPool();var V={oTextReader:c.getText,oConfigurationEditor:C,oTextPool:T,oParentObject:r,oParentStep:P,oRepresentationTypeHandler:R};var z=new sap.ui.controller("sap.apf.modeler.ui.controller.representationCornerTexts");var A=new sap.ui.view({viewName:"sap.apf.modeler.ui.view.cornerTexts",type:sap.ui.core.mvc.ViewType.XML,id:y.createId("representationCornerTexts"),viewData:V,controller:z});y.byId("idCornerTextsVBox").insertItem(A);y.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.representation.SETCHARTICON,A.getController().setChartIcon.bind(A.getController()));}function q(){r.getDimensions().forEach(function(D){r.removeDimension(D);});r.getMeasures().forEach(function(M){r.removeMeasure(M);});}function t(){var D,M;if(r.getRepresentationType()==="TableRepresentation"){D=r.getDimensions();M=r.getMeasures();D.forEach(function(y){r.addProperty(y);r.setPropertyTextLabelKey(y,r.getDimensionTextLabelKey(y));r.setPropertyKind(y,sap.apf.core.constants.representationMetadata.kind.COLUMN);C.setIsUnsaved();});M.forEach(function(y){r.addProperty(y);r.setPropertyTextLabelKey(y,r.getMeasureTextLabelKey(y));r.setPropertyKind(y,sap.apf.core.constants.representationMetadata.kind.COLUMN);C.setIsUnsaved();});q();}}function u(D){var y=s.hasTextPropertyOfDimension(D);if(y){r.setLabelDisplayOption(D,l.KEY_AND_TEXT);}else{r.setLabelDisplayOption(D,l.KEY);}C.setIsUnsaved();}function v(){r.getDimensions().forEach(function(y){if(r.getLabelDisplayOption(y)===undefined){u(y);}});}function w(){t();v();}function x(y){a.instantiateBasicData();S.instantiateRepresentationSortData();m(y);}sap.ui.controller("sap.apf.modeler.ui.controller.representation",{onInit:function(){var y=this;var V=y.getView().getViewData();c=V.oCoreApi;p=V.oParams;C=V.oConfigurationEditor;R=new sap.apf.modeler.ui.utils.RepresentationTypesHandler(c.getRepresentationTypes());_(y);i();s=new sap.apf.modeler.ui.utils.StepPropertyMetadataHandler(c,P);j(y);o=new sap.apf.modeler.ui.utils.RepresentationHandler(r,R,c.getText);a=new sap.apf.modeler.ui.utils.RepresentationBasicDataHandler(y.getView(),s,o);S=new sap.apf.modeler.ui.utils.SortDataHandler(y.getView(),r,s,c.getText);x(y);y.setDetailData();},setDetailData:function(){var y=this;h(y);k(y);},handleChangeForChartType:function(E){var y=this;var N=E.getParameter("selectedItem").getKey();var z=c.getText(N);var O=r.getRepresentationType();f(N);d(y,z);e(y,z);if(!R.isChartTypeSimilar(O,N)){y.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.REMOVEALLPROPERTIESFROMPARENTOBJECT);q();g(N);}a.instantiateBasicData();y.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.representation.SETCHARTICON);C.setIsUnsaved();},handlePreviewButtonPress:function(){var y=this;var z={oParentStep:P,oRepresentation:r,oConfigurationHandler:y.getView().getViewData().oConfigurationHandler,oCoreApi:c,oRepresentationHandler:o,oStepPropertyMetadataHandler:s,oRepresentationTypeHandler:R};sap.ui.view({id:y.createId("idPreviewContentView"),viewName:"sap.apf.modeler.ui.view.previewContent",type:sap.ui.core.mvc.ViewType.XML,viewData:z});},onExit:function(){var y=this;y.getView().getViewData().oFooter.removeContentRight(y.byId("idPreviewButton"));a.destroyBasicData();S.destroySortData();y.byId("idCornerTextsVBox").destroyItems();}});}());
