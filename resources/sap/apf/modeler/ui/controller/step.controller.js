jQuery.sap.require("sap.apf.modeler.ui.utils.textPoolHelper");jQuery.sap.require("sap.apf.modeler.ui.utils.nullObjectChecker");jQuery.sap.require("sap.apf.modeler.ui.utils.optionsValueModelBuilder");jQuery.sap.require("sap.apf.modeler.ui.utils.viewValidator");jQuery.sap.require('sap.apf.modeler.ui.utils.sortDataHandler');jQuery.sap.require('sap.apf.modeler.ui.utils.stepPropertyMetadataHandler');(function(){"use strict";var p,t,c,C,T,g,s,v,S,o;var n=new sap.apf.modeler.ui.utils.NullObjectChecker();var a=new sap.apf.modeler.ui.utils.OptionsValueModelBuilder();var b=sap.apf.modeler.ui.utils.TranslationFormatMap.STEP_TITLE;var d=sap.apf.modeler.ui.utils.TranslationFormatMap.STEP_LONG_TITLE;function _(i){i.byId("idStepBasicData").setText(t("stepBasicData"));i.byId("idStepTitleLabel").setText(t("stepTitle"));i.byId("idStepTitle").setPlaceholder(t("newStep"));i.byId("idStepLongTitleLabel").setText(t("stepLongTitle"));i.byId("idStepLongTitle").setPlaceholder(t("stepLongTitle"));i.byId("idCategoryTitleLabel").setText(t("categoryAssignments"));i.byId("idGlobalLabel").setText(t("globalNavigationTarget"));i.byId("idStepSpecificLabel").setText(t("stepSpecificNavTargets"));i.byId("idDataRequest").setText(t("dataRequest"));i.byId("idFilterMapping").setText(t("filterMap"));i.byId("idFilterMapKeepSourceLabel").setText(t("filterMapKeepSource"));i.byId("idNavigationTarget").setText(t("navigationTargetAssignment"));i.byId("idDataReduction").setText(t("dataReduction"));i.byId("idDataReductionLabel").setText(t("dataReductionType"));i.byId("idNoDataReduction").setText(t("noDataReduction"));i.byId("idTopN").setText(t("topN"));i.byId("idNumberOfRecordsLabel").setText(t("recordNumber"));}function e(i,j){var H=t("step")+": "+j;i.getView().getViewData().updateTitleAndBreadCrumb(H);}function f(i,j){var H={id:s.getId(),icon:"sap-icon://BusinessSuiteInAppSymbols/icon-phase"};if(j){H.name=j;}i.getView().getViewData().updateSelectedNode(H);}function h(i){var j,H;if(p&&p.arguments&&p.arguments.stepId){s=C.getStep(p.arguments.stepId);}if(!n.checkIsNotUndefined(s)){H=p.arguments.categoryId;j=C.createStep(H);s=C.getStep(j);f(i);}}function k(i){var j=this;var I=i.getParameter("bShowFilterMappingLayout");j.byId("idStepFilterMappingVBox").setVisible(I);j.byId("idFilterMapKeepSourceLabel").setVisible(I);j.byId("idFilterKeepSourceCheckBox").setVisible(I);if(!I){j.byId("idFilterMapping").setText("");j.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.RESETFILTERMAPPINGFIELDS);}else{j.byId("idFilterMapping").setText(t("filterMap"));}}function l(i,j,V,H,U){sap.ui.view({viewName:H,type:sap.ui.core.mvc.ViewType.XML,id:i.createId(U),viewData:V,controller:j});}function m(i){var V,j,H,I,J,K,L;V={oTextReader:t,oConfigurationEditor:C,oTextPool:T,oParentObject:s};j=new sap.ui.controller("sap.apf.modeler.ui.controller.stepCornerTexts");l(i,j,V,"sap.apf.modeler.ui.view.cornerTexts","idStepCornerTextView");J=i.byId("idStepCornerTextView");i.byId("idStepCornerTextVBox").insertItem(J);V.oConfigurationHandler=c;V.getCalatogServiceUri=i.getView().getViewData().getCalatogServiceUri;H=new sap.ui.controller("sap.apf.modeler.ui.controller.stepRequest");l(i,H,V,"sap.apf.modeler.ui.view.requestOptions","idStepRequestView");K=i.byId("idStepRequestView");i.byId("idStepRequestVBox").insertItem(K);I=new sap.ui.controller("sap.apf.modeler.ui.controller.stepFilterMapping");l(i,I,V,"sap.apf.modeler.ui.view.requestOptions","idStepFilterMappingView");L=i.byId("idStepFilterMappingView");i.byId("idStepFilterMappingVBox").insertItem(L);K.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETDATAREDUCTIONSECTION,i.setDataReductionSection.bind(i));K.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,k.bind(i));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,k.bind(i));K.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.UPDATEFILTERMAPPINGFIELDS,L.getController().updateFilterMappingFields.bind(L.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.RESETFILTERMAPPINGFIELDS,L.getController().resetFilterMappingFields.bind(L.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,J.getController().updateSubViewInstancesOnReset.bind(J.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,K.getController().updateSubViewInstancesOnReset.bind(K.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,L.getController().updateSubViewInstancesOnReset.bind(L.getController()));K.addStyleClass("formTopPadding");K.addStyleClass("formBottomPadding");L.addStyleClass("formTopPadding");L.addStyleClass("formBottomPadding");}function q(i){if(!n.checkIsNotNullOrUndefinedOrBlank(C.getStep(p.arguments.stepId))){return;}i.byId("idStepTitle").setValue(s.getId());if(n.checkIsNotNullOrUndefinedOrBlank(s.getTitleId())&&T.get(s.getTitleId())){i.byId("idStepTitle").setValue(T.get(s.getTitleId()).TextElementDescription);}}function r(i){if(!n.checkIsNotNullOrUndefinedOrBlank(C.getStep(p.arguments.stepId))){return;}i.byId("idStepLongTitle").setValue("");if(n.checkIsNotNullOrUndefinedOrBlank(s.getLongTitleId())&&T.get(s.getLongTitleId())){i.byId("idStepLongTitle").setValue(T.get(s.getLongTitleId()).TextElementDescription);}}function u(i){var j=[];var H=C.getCategories();H.forEach(function(J){var K={};K.CategoryId=J.getId();K.CategoryTitle=T.get(J.labelKey)?T.get(J.labelKey).TextElementDescription:J.labelKey;j.push(K);});var M=a.prepareModel(j,j.length);i.byId("idCategorySelect").setModel(M);var I=C.getCategoriesForStep(s.getId());if(n.checkIsNotNullOrUndefinedOrBlank(I)){i.byId("idCategorySelect").setSelectedKeys(I);}}function w(i){i.byId("idNumberOfRecordsValue").setValue("");i.byId("idNumberOfRecordsValue").setValueState("None");if(s.getTopN()){i.byId("idNumberOfRecordsValue").setValue(s.getTopN().top);}y(i);}function x(i){i.byId("idDataReductionRadioGroup").setSelectedButton(i.byId("idNoDataReduction"));A(i);if(s.getTopN()){i.byId("idDataReductionRadioGroup").setSelectedButton(i.byId("idTopN"));}}function y(i){var I=i.byId("idDataReductionRadioGroup").getSelectedButton()===i.byId("idTopN")?true:false;i.byId("idNumberOfRecordsLabel").setVisible(I);i.byId("idNumberOfRecordsValue").setVisible(I);if(I){v.addField("idNumberOfRecordsValue");}else{v.removeField("idNumberOfRecordsValue");}}function z(i){if(s.getTopN()){S.instantiateStepSortData();if(s.getTopN().orderby.length===0){i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETTOPNPROPERTIES);var M=o.createMessageObject({code:"11523"});o.putMessage(M);}}else{S.destroySortData();}}function A(i){var j=(s.getSelectProperties().length!==0)?true:false;i.byId("idDataReductionRadioGroup").setEnabled(j);}function B(i){var j=(s.getFilterProperties().length!==0)?true:false;i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,{"bShowFilterMappingLayout":j});}function D(i){if(n.checkIsNotNullOrUndefinedOrBlank(s.getFilterMappingKeepSource())){i.byId("idFilterKeepSourceCheckBox").setSelected(s.getFilterMappingKeepSource());}}function E(i,N,j,H){var M=[];if(N.length!==0){j.setBusy(true);}N.forEach(function(I){var J={};J.navTargetKey=I.getId();g(I.getId()).then(function(K){J.navTargetName=K;M.push(J);if(M.length===N.length){var L=a.prepareModel(M,M.length);j.setModel(L);j.setSelectedKeys(H);j.setBusy(false);}});});}function F(i){var j=C.getNavigationTargets();var H=s.getNavigationTargets();var N=j.filter(function(I){return I.isStepSpecific();});E(i,N,i.byId("idStepSpecificCombo"),H);}function G(i){var j=C.getNavigationTargets();var N=j.filter(function(I){return I.isGlobal();});var H=N.map(function(I){return I.getId();});E(i,N,i.byId("idGlobalCombo"),H);}sap.ui.controller("sap.apf.modeler.ui.controller.step",{onInit:function(){var i=this,j;var V=i.getView().getViewData();o=V.oCoreApi;t=o.getText;p=V.oParams;c=V.oConfigurationHandler;T=c.getTextPool();C=V.oConfigurationEditor;g=V.getNavigationTargetName;v=new sap.apf.modeler.ui.utils.ViewValidator(i.getView());_(i);h(i);j=new sap.apf.modeler.ui.utils.StepPropertyMetadataHandler(o,s);S=new sap.apf.modeler.ui.utils.SortDataHandler(i.getView(),s,j,t);m(i);i.setDetailData();v.addFields(["idStepTitle","idCategorySelect"]);},setDetailData:function(){var i=this;q(i);r(i);u(i);i.setDataReductionSection();B(i);D(i);F(i);G(i);},onAfterRendering:function(){var i=this;if(i.byId("idStepTitle").getValue().length===0){i.byId("idStepTitle").focus();}},updateSubViewInstancesOnReset:function(i){var j=this;C=i;s=C.getStep(s.getId());j.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,{"oConfigurationEditor":C,"oParentObject":s});},setDataReductionSection:function(){var i=this;x(i);w(i);z(i);},handleChangeForStepTitle:function(){var i=this;var j=C.getCategoriesForStep(s.getId());var H=i.byId("idStepTitle").getValue().trim();if(n.checkIsNotNullOrUndefinedOrBlank(H)){var I=T.setText(H,b);s.setTitleId(I);if(j.length>1){i.getView().getViewData().updateTree();}else{f(i,H);}e(i,H);}C.setIsUnsaved();},handleSuggestionsForStepTitle:function(i){var j=new sap.apf.modeler.ui.utils.SuggestionTextHandler(T);j.manageSuggestionTexts(i,b);},handleChangeForStepLongTitle:function(){var i=this;var j=i.byId("idStepLongTitle").getValue().trim();if(n.checkIsNotNullOrUndefinedOrBlank(j)){var H=T.setText(j,d);s.setLongTitleId(H);}C.setIsUnsaved();},handleSuggestionsForStepLongTitle:function(i){var j=new sap.apf.modeler.ui.utils.SuggestionTextHandler(T);j.manageSuggestionTexts(i,d);},handleChangeForCategory:function(){var H=this;var I=s.getId();var J=p.arguments.categoryId;var P=C.getCategoriesForStep(s.getId());var K=H.byId("idCategorySelect").getSelectedKeys();var L=K.indexOf(J);var M=[];var N=[];var i,j;for(i=0;i<P.length;i++){var O=false;for(j=0;j<K.length;j++){if(P[i]===K[j]){O=true;break;}}if(!O){N.push(P[i]);}}if(K.length!==0){K.forEach(function(Q){C.addCategoryStepAssignment(Q,I);var R={oldContext:{name:p.name,arguments:{configId:p.arguments.configId,categoryId:J,stepId:I}},newContext:{arguments:{configId:p.arguments.configId,categoryId:Q}}};if(Q!==J){M.push(R);}});P.forEach(function(Q){if(K.indexOf(Q)===-1){C.removeCategoryStepAssignment(Q,s.getId());}});if(N.length!==0){N.forEach(function(Q){var R={oldContext:{name:p.name,arguments:{configId:p.arguments.configId,categoryId:J,stepId:I}},newContext:{arguments:{configId:p.arguments.configId,categoryId:Q}},removeStep:true};if(L===-1&&Q===J){var U={arguments:{appId:p.arguments.appId,configId:p.arguments.configId,categoryId:K[0],stepId:I}};R.categoryChangeContext=U;R.changeCategory=true;}M.push(R);});}}if(M.length!==0){H.getView().getViewData().updateTree(M);}C.setIsUnsaved();},handleChangeForDataReductionType:function(){var i=this;if(i.byId("idDataReductionRadioGroup").getSelectedButton()===i.byId("idNoDataReduction")){s.resetTopN();i.setDataReductionSection();}else{S.instantiateStepSortData();}y(i);C.setIsUnsaved();},handleValidationForNumberOfRecords:function(i){var I=i.getSource();var V=I.getValue().trim();var j=(V.indexOf(".")!==-1||V<=0||V>10000)?sap.ui.core.ValueState.Error:sap.ui.core.ValueState.None;I.setValueState(j);C.setIsUnsaved();},handleChangeForNoOfRecords:function(i){var j=this;var V=i.getSource().getValue().trim();if(i.getSource().getValueState()===sap.ui.core.ValueState.Error){return;}if(n.checkIsNotNullOrUndefinedOrBlank(V)){if(s.getTopN()===undefined){j.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETTOPNPROPERTIES);}s.setTopNValue(V);}C.setIsUnsaved();},handleFilterMapKeepSource:function(){var i=this;var I=i.byId("idFilterKeepSourceCheckBox").getSelected();s.setFilterMappingKeepSource(I);C.setIsUnsaved();},handleChangeForStepSpecificNavTargets:function(){var i=this;var j=i.byId("idStepSpecificCombo").getSelectedKeys();var H=s.getNavigationTargets();H.forEach(function(I){if(j.indexOf(I)===-1){s.removeNavigationTarget(I);}});j.forEach(function(I){if(H.indexOf(I)===-1){s.addNavigationTarget(I);}});C.setIsUnsaved();},getValidationState:function(){var i=this;return v.getValidationState()&&i.byId("idStepRequestView").getController().getValidationState()&&i.byId("idStepFilterMappingView").getController().getValidationState();},onExit:function(){var i=this;i.byId("idStepCornerTextView").destroy();i.byId("idStepRequestView").destroy();i.byId("idStepFilterMappingView").destroy();}});}());
