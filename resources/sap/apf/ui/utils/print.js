/*
 * ! SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.ui.utils.print");jQuery.sap.require("sap.apf.ui.utils.formatter");jQuery.sap.require("sap.viz.ui5.types.legend.Common");
sap.apf.ui.utils.PrintHelper=function(I){"use strict";var c=I.oCoreApi;var u=I.uiApi;var a=null;var f=I.oFilterIdHandler;var n,C,b;this.oPrintLayout={};function _(){++n;if(b===n){C.resolve();}}function d(i){if(!jQuery.isEmptyObject(i.oPrintLayout)){i.oPrintLayout.removeContent();}jQuery('#apfPrintArea').remove();jQuery("body").append('<div id="printbuttondiv"></div><div id="apfPrintArea"></div>');u.createApplicationLayout(false).setBusy(true);}function e(){var i=new Date();var A=c.getApplicationConfigProperties().appName;var j=u.getAnalysisPath().oSavedPathName.getTitle();var w=new sap.ui.core.HTML({id:'idAPFHeaderForFirstPage',content:['<div class="subHeaderPrintWrapper"><p class="printHeaderTitle"> '+c.getTextHtmlEncoded(A)+' : '+jQuery.sap.encodeHTML(j)+'</p>','<p class="printHeaderDate"> '+i.toTimeString()+' </p></div><div class="clear"></div>'].join(""),sanitizeContent:true});return w;}function g(){var i,j,w,F,A,x,y,z,B,S;var D=[],E=[],G="",H=[],J=[],K=[],L=[],M={};var N=u.getEventCallback(sap.apf.core.constants.eventTypes.printTriggered);var O={getTextNotHtmlEncoded:c.getTextNotHtmlEncoded};var P=f.getAllInternalIds();if(P.length>0){for(i=0;i<P.length;i++){A=f.get(P[i]).getExpressions();D.push(A[0]);}}function Q(){function T(U){G="";J=[];z=new sap.apf.ui.utils.formatter({getEventCallback:u.getEventCallback.bind(u),getTextNotHtmlEncoded:c.getTextNotHtmlEncoded},U);G=U.label;J.push(z.getFormattedValue(U.name,D[i][j].value));}for(i=0;i<D.length;i++){for(j=0;j<D[i].length;j++){y=D[i][j];c.getMetadataFacade().getProperty(D[i][j].name,T);y["sName"]=G;y["value"]=J;E.push(y);}}return E;}if(N!==undefined){K=N.apply(O,D)||[];K=(K.length>0)?K:Q();}else{K=Q();}B=u.getFacetFilterForPrint();function R(S){H=[];S.forEach(function(T){H.push(T.getText());});}if(B){F=B.getLists();for(w=0;w<F.length;w++){S=[];M={};M.sName=F[w].getTitle();if(!F[w].getSelectedItems().length){S=F[w].getItems();}else{S=F[w].getSelectedItems();}R(S);M.value=H;L.push(M);}}x=K.length>0?K.concat(L):L;return k(x);}function h(){var S=u.getSmartFilterForPrint();if(S!==undefined&&S!==null){var i=JSON.parse(S.getFilterDataAsString());var O={};var j;for(j in i){var w='';var x=i[j]['ranges'];for(var y=0;y<x.length;y++){w+=x[y]['tokenText'];}O[j]=w;}}return O;}function k(F){var w,x;var y="";var z="";var A=new sap.ui.layout.VerticalLayout({id:'idAPFFacetAndFooterLayout'});for(var i=0;i<F.length;i++){y=F[i].sName;for(var j=0;j<F[i].value.length;j++){if(j!==F[i].value.length-1){z+=F[i].value[j]+", ";}else{z+=F[i].value[j];}}w=new sap.m.Text({text:y}).addStyleClass("printFilterName");x=new sap.m.Text({text:z}).addStyleClass("printFilterValue");A.addContent(w);A.addContent(x);z="";}var O=h();if(O!=undefined&&O!=null){for(var B in O){w=new sap.m.Text({text:B}).addStyleClass("printFilterName");x=new sap.m.Text({text:O[B]}).addStyleClass("printFilterValue");A.addContent(w);A.addContent(x);}}return A;}function l(i,j){var M;var w=new Date();var A=c.getApplicationConfigProperties().appName;var x=u.getAnalysisPath().oSavedPathName.getTitle();if(!A){M=c.createMessageObject({code:"6003",aParameters:["sAppName"]});c.putMessage(M);}var y=new sap.ui.core.HTML({id:'idAPFHeaderForEachStep'+i,content:['<div class="subHeaderPrintWrapper"><p class="printHeaderTitle"> '+c.getTextHtmlEncoded(A)+' : '+jQuery.sap.encodeHTML(x)+'</p>','<p class="printHeaderDate"> '+w.toTimeString()+' </p></div><div class="clear"></div>','<br /><div class="printChipName"><p>'+c.getTextHtmlEncoded("print-step-number",[i,j])+'</p></div>'].join(""),sanitizeContent:true});return y;}function m(S){var i,j,P,w=false,R={};var x=c.getTextNotHtmlEncoded(S.title);var y=S.getSelectedRepresentation();var z=y.bIsAlternateView?y.toggleInstance:y;if(y.bIsAlternateView){i=S.getSelectedRepresentation().getData();j=S.getSelectedRepresentation().getMetaData();z.setData(i,j);}if(z.type===sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){P=z.getPrintContent(x);R=P.oTableForPrint.getContent()[0];var A=P.aSelectedListItems;A.forEach(function(B){R.addSelectionInterval(B,B);});_();R.setWidth("1000px");}else{P=z.getPrintContent(x);R=P.oChartForPrinting;if(R.vizSelection){R.attachRenderComplete(function(){R.vizSelection(P.aSelectionOnChart);_();});}else{R.attachInitialized(function(){R.selection(P.aSelectionOnChart);_();});}}if(z.bIsLegendVisible===undefined||z.bIsLegendVisible===true){w=true;}if(R.setVizProperties){R.setVizProperties({legend:{visible:w},sizeLegend:{visible:w}});}else{if(R.setLegend!==undefined){R.setLegend(new sap.viz.ui5.types.legend.Common({visible:w}));}if(R.setSizeLegend!==undefined){R.setSizeLegend(new sap.viz.ui5.types.legend.Common({visible:w}));}}return R;}function o(S,i,j){var w=new sap.ui.layout.VerticalLayout({id:'idAPFChartLayout'+i});w.addContent(m(S));var x=new sap.ui.layout.VerticalLayout({id:'idAPFStepLayout'+i,content:[l(i,j),w]}).addStyleClass("representationContent");return x;}this.doPrint=function(){var j,i,P;var w=2000,x=this;n=0;a=c.getSteps();b=a.length;this.oPrintLayout=new sap.ui.layout.VerticalLayout({id:"idAPFPrintLayout"});d(this);C=jQuery.Deferred();if(b===0){C.resolve();}P=new sap.ui.layout.VerticalLayout({id:'idAPFPrintFirstPageLayout',content:[e(),g()]}).addStyleClass("representationContent");this.oPrintLayout.addContent(P);for(j=0;j<a.length;j++){i=parseInt(j,10)+1;this.oPrintLayout.addContent(o(a[j],i,a.length));}this.oPrintLayout.placeAt("apfPrintArea");if(jQuery(".v-geo-container").length){w=4000;}var y=new sap.m.Button({text:c.getTextNotHtmlEncoded("print")});var z=new sap.ui.layout.VerticalLayout({id:"printButtonLayout"});z.insertContent(y);z.placeAt("printbuttondiv");p(x.oPrintLayout,w,z);};function p(P,i,j){if(sap.ui.Device.browser.safari){window.setTimeout(function(){u.createApplicationLayout(false).setBusy(false);},i-150);window.setTimeout(function(){s(P);C.then(function(){r();});window.setTimeout(function(){q(P,j);},10);},i);}else{(function(){var w=jQuery.Deferred();setTimeout(function(){s(P);w.resolve();},i);return w;})().then(function(){r();}).then(function(){q(P,j);}).then(function(){u.createApplicationLayout(false).setBusy(false);});}}function q(P,j){j.destroy();j=null;var S,w;for(var i=0;i<jQuery("#apfPrintArea").siblings().length;i++){jQuery("#apfPrintArea").siblings()[i].hidden=false;}jQuery('#printbuttondiv').remove();for(var x=0;x<a.length;x++){S=a[x].getSelectedRepresentation();S=S.bIsAlternateView?S.toggleInstance:S;if(S.type!==sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){w=P.getContent()[x+1].getContent()[1].getContent()[0];w.destroy();w=null;}}P.destroy();P=null;jQuery("div[id^=idAPFStepLayout]").remove();jQuery("#apfPrintArea").remove();}function r(){jQuery(jQuery("#printbuttondiv").find('button')).attr('onclick','jQuery( "#printbuttondiv" ).remove();window.print();window.close();');var i=sap.ui.Device.system.tablet;var j=sap.ui.Device.os.ios;if(i==true&&j==true){var w=jQuery("html").clone();var x=jQuery(w).find('body');jQuery(x).children("div").each(function(A,B){if(jQuery(B).attr('id')!='apfPrintArea'&&jQuery(B).attr('id')!='printbuttondiv'){jQuery(B).remove();}else{jQuery(B).show();}if(jQuery(B).attr('id')=="#printbuttondiv"){jQuery(B).show();}});jQuery(jQuery(w).find('body')).html(jQuery(x.html()));var y="<html>"+jQuery(w).html()+"</html>";var z=window.open("","_blank","width=300,height=300");z.document.write(y);}else{window.print();}}function s(P){var j;jQuery("#"+P.sId+" > div:not(:last-child)").after("<div class='page-break'> </div>");var w=P.getDomRef();var x=jQuery('#apfPrintArea .sapUiTable');if(x.length){j=jQuery('#apfPrintArea .printTable .sapMListTblHeader .sapMListTblCell').length;if(j>11){jQuery("#setPrintMode").remove();jQuery("<style id='setPrintMode' > @media print and (min-resolution: 300dpi) { @page {size : landscape;}}</style>").appendTo("head");}else{jQuery("#setPrintMode").remove();jQuery("<style id='setPrintMode'>@media print and (min-resolution: 300dpi) { @page {size : portrait;}}</style>").appendTo("head");}}jQuery("#apfPrintArea").empty();jQuery("#apfPrintArea").append(jQuery(w).html());t();for(var i=0;i<jQuery("#apfPrintArea").siblings().length;i++){jQuery("#apfPrintArea").siblings()[i].hidden=true;}}function t(){var j=jQuery("div[id^=idAPFChartLayout]");var w=[];var x=[];var y=0;for(var z=0;z<j.length;z++){if(jQuery(j[z]).find('table').length>0){var A=[];jQuery(j[z]).find("div[id$=sapUiTableRowHdrScr]").find('div').each(function(i,J){A[i]=jQuery(J).attr('aria-selected');});w[y]=A;A=null;x[y]=jQuery(j[z]).find('label');y++;}}jQuery("#apfPrintArea").find("table").each(function(J,K){jQuery(K).find('*').removeAttr('class');var L=jQuery(K).parent();jQuery(L).empty();var M=K;var N=jQuery(K).find('tbody').find('tr').length;var O=jQuery(K).find('tbody');var P=jQuery(O).find('tr');jQuery(K).find('thead').unwrap();jQuery(M).empty();jQuery(M).unwrap();var i=0;var Q='<table class="printtable"><thead><tr>';var R='';for(var S=0;S<x[J].length;S++){if(w[J][0]!=undefined){if(S==0){Q+='<th></th>';}else{Q+='<th>'+jQuery(x[J][S]).html()+'</th>';}}else{if(x[J][S+1]){Q+='<th>'+jQuery(x[J][S+1]).html()+'</th>';}}}Q+='</tr></thead><tbody>';var T='<table class="printtable"><thead>';T+='</thead><tbody>';var U=0;var V=jQuery((jQuery(K).find('tbody').find('tr'))[0]).find('td').length;var W=Math.ceil(95/V)-1;jQuery(jQuery(K).find('tbody').find('td')).css('width',W+'%');for(i=0;i<Math.ceil(N/20);i++){if(i==0){R=Q;}else{R=T;}jQuery(P).each(function(X,Y){if(X>=i*20&&X<(i+1)*20){var Z='';if(w[J][X]=="true"){Z='checked';}if(w[J][X]!=undefined){jQuery(jQuery(Y).children()[0]).append('<input type="checkbox" '+Z+' />');jQuery(jQuery(Y).find('td')[0]).css('width','5%');}R+=jQuery(Y).wrap('<p/>').parent().html();jQuery(Y).unwrap();}U++;});R+='</tbody></table>';jQuery(L).append(R);R='';}});var B=0;for(var D=0;D<j.length;D++){var E=jQuery(j[D]).find('table');if(E.length>0){var F=jQuery(jQuery(jQuery(E[0]).find('tbody')).find('tr')[0]).find('td').length;jQuery(j[D]).empty();if(F<=9){jQuery(j[D]).css('display','inline');}var G='<div class="tableheaderdiv">'+jQuery(x[B][0]).html()+'</div>';for(var H=0;H<E.length;H++){if(H!=0){G='';}if(F>9){jQuery(j[D]).append('<div  class="rotationDiv">'+G+'<table  class="printtable">'+jQuery(E[H]).html()+'</table></div>');}else{jQuery(j[D]).append(G+'<table  class="printtable">'+jQuery(E[H]).html()+'</table>');}}B++;}}v(j);j=null;}function v(i){for(var j=0;j<i.length;j++){var w=jQuery(i[j]).find('table');var x=jQuery(jQuery(jQuery(w[0]).find('tbody')).find('tr')[0]).find('td').length;if(w.length>0&&x>9){var y=jQuery(i[j]).parent().parent().parent();var z='<div class="page-break"> </div>';var A='';for(var B=0;B<w.length;B++){var D=jQuery(y).clone();var E=jQuery(D).find('table');for(var F=0;F<w.length;F++){if(F!=B){jQuery(jQuery((E)[F]).parent()).remove();}}var G=jQuery(D).wrap('<p/>').parent().html();jQuery(D).unwrap();if(B<w.length-1){A+=G+z;}else{A+=G;}}jQuery(y).after(A);jQuery(y).remove();}}}};
