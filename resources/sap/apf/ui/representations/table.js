/* SAP APF Analysis Path Framework
* 
* (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
jQuery.sap.declare("sap.apf.ui.representations.table");jQuery.sap.require("sap.apf.core.constants");jQuery.sap.require('sap.apf.ui.utils.formatter');jQuery.sap.require("sap.apf.ui.representations.utils.paginationHandler");jQuery.sap.require("sap.apf.ui.representations.BaseUI5ChartRepresentation");(function(){'use strict';var t,s=0,a=false;function _(S){S.forEach(function(i){t.addSelectionInterval(i,i);});}function b(v,F){var C=v.concat(F);C=C.filter(function(i,u,C){return C.lastIndexOf(i)===u;});return C;}function c(T){T.oApi.getActiveStep().getSelectedRepresentation().UI5ChartHelper.filterValues=[];T.UI5ChartHelper.filterValues=[];}function d(T,R){var F=T.getFilter().getInternalFilter().getFilterTermsForProperty(R);var i=F.map(function(u){return u.getValue();});return i;}function e(T){var F=T.oApi.getActiveStep().getSelectedRepresentation().UI5ChartHelper.filterValues;var i=F.map(function(u){return u[0];});return i;}function f(R,C,F){var i=[];var u=t.getContextByIndex(C[0]).getProperty(R);if((t.isIndexSelected(C[0]))&&(i.indexOf(u))===-1){i.push(u);}else{var v=F.indexOf(u);if(v!==-1){F.splice(v,1);}}return i;}function g(T,F){if(a){c(T);T.filter=T.UI5ChartHelper.getFilterFromSelection(F);T.oApi.getActiveStep().getSelectedRepresentation().UI5ChartHelper.filterValues=T.UI5ChartHelper.filterValues;T.oApi.selectionChanged();a=false;}else{a=true;}}function h(A,R,F){var S=[];A.forEach(function(i,u){var v=i[R];if(F.indexOf(v)!==-1){S.push(u);}});return S;}function j(E){var F=[],R;var i=this.oParameter.requiredFilters;var u=E.getParameter("userInteraction");var C=E.getParameter("rowIndices");if(E.getSource().getFocusDomRef()&&E.getSource().getFocusDomRef().offsetTop!==0){s=jQuery(".sapUiTableVSb").prop("scrollTop");}if(!u||C.length===0){return;}R=i&&(i.length>0)?i[0]:undefined;if(this.UI5ChartHelper){F=R?d(this,R):[];}var v=f(R,C,F);F=F.concat(v.filter(function(w){return F.indexOf(w)<0;}));a=true;g(this,F);}function k(T,P){var R=T.oParameter.requiredFilters;var i=R&&(R.length>0)?R[0]:undefined;var F=e(T);var A=P.getModel().getData().tableData;var S=[];A.forEach(function(v,w){if(F.indexOf(v[i])!==-1){S.push(w);}});var u=(R&&(R.length>0))?"MultiToggle":"None";P.setSelectionMode(u);return S;}function l(S,T){var i=[];i.push(new sap.ui.model.Sorter(S.property,S.descending));T.oTableRepresentation.getBinding("rows").sort(i);}function m(i,S,T){var F=new sap.apf.ui.utils.formatter({getEventCallback:T.oApi.getEventCallback.bind(T.oApi),getTextNotHtmlEncoded:T.oApi.getTextNotHtmlEncoded},T.metadata,T.aDataResponse);var u=function(H){return function(I){if(T.metadata!==undefined){var J;if(i.value[H]&&I){J=F.getFormattedValue(i.value[H],I);if(J!==undefined){return J;}}}return I;};};var t=new sap.ui.table.Table({showNoData:false,title:S,enableSelectAll:false,visibleRowCount:15});var R=T.oParameter.requiredFilters;var v=(R&&(R.length>0))?"MultiToggle":"None";t.setSelectionMode(v);var w=[],C,x,y;for(var z=0;z<i.name.length;z++){C=new sap.m.Text().bindText(i.value[z],u(z),sap.ui.model.BindingMode.OneWay);x=new sap.ui.table.Column({label:new sap.m.Label({text:i.name[z]}),template:C,tooltip:i.name[z]});y=new sap.ui.core.CustomData({value:{text:i.name[z],key:i.value[z]}});x.addCustomData(y);w.push(x);}var A;A=w;A.forEach(function(H){t.addColumn(H);});if(w.length>10){t.getColumns().forEach(function(x){x.setWidth("125px");});}var M=new sap.ui.model.json.JSONModel();M.setSizeLimit(10000);var B=T.getData();M.setData({tableData:B});t.setModel(M);t.bindRows("/tableData");n(t);if(T.metadata!==undefined){for(var D=0;D<i.name.length;D++){var E=T.metadata.getPropertyMetadata(i.value[D]);if(E.unit){var G=t.getColumns()[D];G.setHAlign(sap.ui.core.TextAlign.Right);}}}return t;}function n(t){var i=t.getModel().getData().tableData.length;var u;if(jQuery('.chartContainer').height()){u=jQuery('.chartContainer').height()-(jQuery(".chartContainer > div :first-child").height()+120);}var v=(u>0)?u/32:15;var w=Math.floor(v);if(i<15||v>i){w=i;}t.setVisibleRowCount(w);}function o(C){var i,u;jQuery(".scrollContainer > div:first-child").css({"display":"table","width":"inherit"});if(u===undefined){u=jQuery(".tableRepresentation").offset().top;}if(jQuery(".tableRepresentation").offset().top!==u){i=((window.innerHeight-jQuery('.tableRepresentation').offset().top))+"px";}else{i=((window.innerHeight-jQuery('.tableRepresentation').offset().top)-(jQuery(".applicationFooter").height()))+"px";}document.querySelector('.tableRepresentation').style.cssText+="height : "+i;sap.ui.Device.orientation.attachHandler(function(){C.rerender();});jQuery(".sapUiTableVSb").animate({scrollTop:s},0);s=0;}function p(T){var S=[];var i=T.getData();var u=i.map(function(v){return v[T.oParameter.requiredFilters[0]];});T.UI5ChartHelper.filterValues.forEach(function(v){if(u.indexOf(v[0])!==-1){S.push(v[0]);}});return S;}function q(T){var u=T.getData();var P=[];var C={name:[],value:[]};P=T.oParameter.dimensions.concat(T.oParameter.measures).length?T.oParameter.dimensions.concat(T.oParameter.measures):T.parameter.properties;if(u.length!==0){for(var i=0;i<P.length;i++){C.value[i]=P[i].fieldName;var v="";var w=T.metadata.getPropertyMetadata(P[i].fieldName).label||T.metadata.getPropertyMetadata(P[i].fieldName).name;var U="";if(T.metadata!==undefined&&T.metadata.getPropertyMetadata(P[i].fieldName).unit!==undefined){var x=T.metadata.getPropertyMetadata(P[i].fieldName).unit;U=T.getData()[0][x];v=P[i].fieldDesc===undefined||!T.oApi.getTextNotHtmlEncoded(P[i].fieldDesc).length?w+" ("+U+")":T.oApi.getTextNotHtmlEncoded(P[i].fieldDesc)+" ("+U+")";C.name[i]=v;}else{C.name[i]=P[i].fieldDesc===undefined||!T.oApi.getTextNotHtmlEncoded(P[i].fieldDesc).length?w:T.oApi.getTextNotHtmlEncoded(P[i].fieldDesc);}}}return C;}function r(v){var S;var i=v.getSelectedSortItem();v.getSortItems().forEach(function(u){if(u.getId()===i){S=u.getKey();}});return S;}sap.apf.ui.representations.table=function(A,P){this.oViewSettingDialog=undefined;this.aDataResponse=[];this.oParameter=P;this.orderby=P.orderby;sap.apf.ui.representations.BaseUI5ChartRepresentation.apply(this,[A,P]);this.alternateRepresentation=P.alternateRepresentationType;this.type=sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION;this.oPaginationHandler=new sap.apf.ui.representations.utils.PaginationHandler(this);};sap.apf.ui.representations.table.prototype=Object.create(sap.apf.ui.representations.BaseUI5ChartRepresentation.prototype);sap.apf.ui.representations.table.prototype.constructor=sap.apf.ui.representations.table;sap.apf.ui.representations.table.prototype.setData=function(D,i,u,v){var w=this;if(v&&v.length>0){this.aValidatedFilter=[];var R=this.oParameter.requiredFilters[0];v.forEach(function(y){w.aValidatedFilter.push(y[R]);});}var x=this.oPaginationHandler.getPagingOption().skip;this.nDataResponseCount=u;if(x===undefined||x===0){this.aDataResponse=D;}else{D.map(function(y){w.aDataResponse.push(y);});}if(!i){this.oMessageObject=this.oApi.createMessageObject({code:"6004",aParameters:[this.oApi.getTextNotHtmlEncoded("step")]});this.oApi.putMessage(this.oMessageObject);}else{this.metadata=i;this.UI5ChartHelper.metadata=i;}};sap.apf.ui.representations.table.prototype.getSelectionFromChart=function(){var S=t.getSelectedIndices();return S;};sap.apf.ui.representations.table.prototype.getSelections=function(){var S=[];var v=(this.aValidatedFilter&&this.aValidatedFilter.length>0)?this.aValidatedFilter:[];var i=b(v,p(this));i.forEach(function(u){S.push({id:u,text:u});});return S;};sap.apf.ui.representations.table.prototype.markSelectionInTable=function(i){var S=[];var u=this.UI5ChartHelper.filterValues.map(function(x){return x[0];});if(!i&&!this.oParameter.isAlternateRepresentation){u=this.aValidatedFilter?this.aValidatedFilter:[];}var v=h(this.aDataResponse,this.oParameter.requiredFilters,u);if(this.oParameter.isAlternateRepresentation){var w=this.oTableRepresentation.getBinding().aIndices;v.forEach(function(x){S.push(w.indexOf(x));});v=S;}if(u.length>0){this.oTableRepresentation.clearSelection();_(v);}};sap.apf.ui.representations.table.prototype.getRequestOptions=function(F){if(F){this.oPaginationHandler.resetPaginationOption();}var i={paging:this.oPaginationHandler.getPagingOption(this.oParameter.top),orderby:[]};if(this.orderby&&this.orderby.length){var u=this.orderby.map(function(O){return{property:O.property,descending:!O.ascending};});i.orderby=u;}if(this.oViewSettingDialog){var S={property:r(this.oViewSettingDialog),descending:this.oViewSettingDialog.getSortDescending()};i.orderby=[S];}return i;};sap.apf.ui.representations.table.prototype.resetPaginationForTable=function(){this.oPaginationHandler.resetPaginationOption();};sap.apf.ui.representations.table.prototype.getMainContent=function(S,i,w){var u=this;var T=this.getData();var v=this.oParameter.dimensions.concat(this.oParameter.measures).length?this.oParameter.dimensions.concat(this.oParameter.measures):this.oParameter.properties;var x=q(this);var M;if(!S){M=this.oApi.createMessageObject({code:"6002",aParameters:["title",this.oApi.getTextNotHtmlEncoded("step")]});this.oApi.putMessage(M);}if(v.length===0){M=this.oApi.createMessageObject({code:"6002",aParameters:["dimensions",S]});this.oApi.putMessage(M);}if(!T||T.length===0){M=this.oApi.createMessageObject({code:"6000",aParameters:[S]});this.oApi.putMessage(M);}var y=(w||1000)+"px";t=m(x,S,this);t.attachRowSelectionChange(j.bind(u));this.oTableRepresentation=t;var z=new sap.m.ScrollContainer({content:[t],width:y,horizontal:false}).addStyleClass("tableRepresentation");z.addStyleClass("sapUiSizeCompact");t.addEventDelegate({onAfterRendering:function(){if(u.oViewSettingDialog&&u.oParameter.isAlternateRepresentation){var A={property:r(u.oViewSettingDialog),descending:u.oViewSettingDialog.getSortDescending()};l(A,u);}u.markSelectionInTable(true);n(t);o(z);if(!u.oParameter.top&&!u.oParameter.isAlternateRepresentation&&u.nDataResponseCount>100){u.oPaginationHandler.attachPaginationOnTable(u);}}});return z;};sap.apf.ui.representations.table.prototype.getThumbnailContent=function(){var T;var i=this.getData();var I=this.oParameter.isAlternateRepresentation?"sap-icon://table-view":"sap-icon://table-chart";if(i!==undefined&&i.length!==0){var u=new sap.ui.core.Icon({src:I,size:"70px"}).addStyleClass('thumbnailTableImage');T=u;}else{var v=new sap.m.Text({text:this.oApi.getTextNotHtmlEncoded("noDataText")}).addStyleClass('noDataText');T=new sap.ui.layout.VerticalLayout({content:v});}return T;};sap.apf.ui.representations.table.prototype.removeAllSelection=function(){c(this);t.clearSelection();this.oApi.selectionChanged();};sap.apf.ui.representations.table.prototype.getPrintContent=function(S){var i=q(this);var P=m(i,S,this);P.setTitle(S);P.getColumns().forEach(function(v){v.setWidth("75px");});P.setVisibleRowCount(P.getModel().getData().tableData.length);var u=k(this,P);var T=new sap.ui.layout.VerticalLayout();T.addContent(P);return{oTableForPrint:T,aSelectedListItems:u};};sap.apf.ui.representations.table.prototype.createViewSettingDialog=function(){var S;if(this.oViewSettingDialog){S={oSortProperty:r(this.oViewSettingDialog),isDescending:this.oViewSettingDialog.getSortDescending()};this.oViewSettingDialog.destroy();}var v={oSelectedSortItem:S,oTableInstance:this};var V=new sap.ui.view({type:sap.ui.core.mvc.ViewType.JS,viewName:"sap.apf.ui.reuse.view.viewSetting",viewData:v});this.oViewSettingDialog=V.getContent()[0];this.oViewSettingDialog.addStyleClass("sapUiSizeCompact");return this.oViewSettingDialog;};sap.apf.ui.representations.table.prototype.destroy=function(){if(this.UI5ChartHelper){this.UI5ChartHelper.destroy();this.UI5ChartHelper=null;}if(this.orderby){this.orderby=null;}if(this.oParameter){this.oParameter=null;}if(this.oViewSettingDialog){this.oViewSettingDialog.destroy();}if(this.aDataResponse){this.aDataResponse=null;}if(this.aValidatedFilter){this.aValidatedFilter=[];}};}());
