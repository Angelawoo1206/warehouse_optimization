/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare('sap.apf.core.request');jQuery.sap.require('sap.apf.utils.utils');jQuery.sap.require('sap.apf.core.utils.filter');jQuery.sap.require('sap.apf.core.utils.filterTerm');jQuery.sap.require("sap.apf.core.utils.filterSimplify");(function(){'use strict';sap.apf.core.Request=function(I,c){var m=I.instances.messageHandler;var C=I.instances.coreApi;var s=c.service;var a=c.selectProperties;var u=C.getUriGenerator();var M;if(s===undefined){M=m.createMessageObject({code:'5015',aParameters:[c.id]});m.putMessage(M);}var o=C.getMetadata(s);var U=o.getUriComponents(c.entityType);var e,b;if(U){e=U.entitySet;b=U.navigationProperty;}m.check(e!==undefined,'Invalid request configuration: An entityset does not exist under the service '+c.entityType);m.check(b!==undefined,'Invalid request configuration: A usable navigation does not exist for the service '+c.entityType);this.type=c.type;this.sendGetInBatch=function(F,h,r,S){var i;var j;g(F);if(F&&F.getProperties){i=F.restrictToProperties(o.getFilterableProperties(e));if(C.getStartParameterFacade().isFilterReductionActive()){j=new sap.apf.core.utils.FilterReduction();i=j.filterReduction(m,i);}}d(r);var p=r&&r.paging;var k=r&&r.orderby;var l=u.buildUri(m,e,a,i,F,k,p,undefined,f,b,o);var n=[{requestUri:l,method:'GET',headers:{'Accept-Language':sap.ui.getCore().getConfiguration().getLanguage(),'x-csrf-token':C.getXsrfToken(s)}}];t();var R={method:'POST',headers:{'x-csrf-token':C.getXsrfToken(s)},requestUri:u.getAbsolutePath(s)+'$batch',serviceMetadata:o.getODataModel().getServiceMetadata(),data:{__batchRequests:n}};var q=function(v,w){var x={};var y='';if(v&&v.__batchResponses&&v.__batchResponses[0].data){x.data=v.__batchResponses[0].data.results;x.metadata=C.getEntityTypeMetadata(c.service,c.entityType);if(v.__batchResponses[0].data.__count){x.count=parseInt(v.__batchResponses[0].data.__count,10);}if(v.__batchResponses[1]&&v.__batchResponses[1].data){x.selectionValidation=v.__batchResponses[1].data.results;}}else if(v&&v.__batchResponses[0]&&v.__batchResponses[0].response&&v.__batchResponses[0].message){y=w.requestUri;var z=v.__batchResponses[0].message;var A=v.__batchResponses[0].response.body;var B=sap.apf.utils.extractOdataErrorResponse(A);var H=v.__batchResponses[0].response.statusCode;x=m.createMessageObject({code:'5001',aParameters:[H,z,B,y]});m.putMessage(x);}else{y=w.requestUri||l;x=m.createMessageObject({code:'5001',aParameters:['unknown','unknown error','unknown error',y]});m.putMessage(x);}h(x,false);};var E=function(v){var w='unknown error';var x;var y='unknown error';var z=l;if(v.message!==undefined){w=v.message;}var H='unknown';if(v.response&&v.response.statusCode){H=v.response.statusCode;y=v.response.statusText||'';z=v.response.requestUri||l;}if(v.messageObject&&v.messageObject.type==='messageObject'){m.putMessage(v.messageObject);h(v.messageObject);}else{x=m.createMessageObject({code:'5001',aParameters:[H,w,y,z]});m.putMessage(x);h(x);}};C.odataRequest(R,q,E,OData.batchHandler);function t(){if(S&&S.requiredFilterProperties&&S.selectionFilter){var v=i.copy();v.addAnd(S.selectionFilter);if(C.getStartParameterFacade().isFilterReductionActive()){v=j.filterReduction(m,v);}var w=u.buildUri(m,e,S.requiredFilterProperties,v,F,undefined,undefined,undefined,f,b,o);n.push({requestUri:w,method:'GET',headers:{'Accept-Language':sap.ui.getCore().getConfiguration().getLanguage(),'x-csrf-token':C.getXsrfToken(s)}});}}};function f(p,v){var h="'";var E=o.getPropertyMetadata(e,p);if(E&&E.dataType){return sap.apf.utils.formatValue(v,E.dataType.type);}if(typeof v==='number'){return v;}return h+sap.apf.utils.escapeOdata(v)+h;}function d(r){var p,i;if(!r){return;}p=Object.getOwnPropertyNames(r);for(i=0;i<p.length;i++){if(p[i]!=='orderby'&&p[i]!=='paging'){m.putMessage(m.createMessageObject({code:'5032',aParameters:[e,p[i]]}));}}}function g(F){var h=o.getFilterableProperties(e);var r='';var E=o.getEntityTypeAnnotations(e);var i;if(E.requiresFilter!==undefined&&E.requiresFilter==='true'){if(E.requiredProperties!==undefined){r=E.requiredProperties;}}if(r===''){return;}if(jQuery.inArray(r,h)===-1){i=m.createMessageObject({code:'5006',aParameters:[e,r]});m.putMessage(i);}var p=F.getProperties();if(jQuery.inArray(r,p)===-1){i=m.createMessageObject({code:'5005',aParameters:[e,r]});m.putMessage(i);}}};}());
