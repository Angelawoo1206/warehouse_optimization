jQuery.sap.declare("sap.apf.core.layeredRepositoryProxy");jQuery.sap.require('sap.apf.utils.utils');jQuery.sap.require('sap.apf.core.constants');jQuery.sap.require('sap.apf.utils.hashtable');jQuery.sap.require('sap.ui.fl.LrepConnector');jQuery.sap.require('sap.apf.utils.parseTextPropertyFile');(function(){'use strict';sap.apf.core.LayeredRepositoryProxy=function(s,a){var c=a.instances.coreApi;var b;var m=a.instances.messageHandler;var n='sap/apf/dt';var t='text.properties';var d=new sap.apf.utils.Hashtable(a.instances.messageHandler);var e=new sap.apf.utils.Hashtable(a.instances.messageHandler);var f;var g=false;this.getConnector=function(){return b;};this.readEntity=function(O,P,Q,R,S,T,U){var V=Q[0].value;var W=v(T);var X=[];var Y=false;var Z=1;var $=0;var _;var a1;var b1;var i;var c1;var d1;var e1;var f1;var g1=q(U);var h1;m.check(O==='configuration',"layered repository proxy - only read entity of configuration supported");if(S!==undefined&&S===false){return N(P,V,T,R,U);}if(R===undefined||R.indexOf("SerializedAnalyticalConfiguration")>=0){Y=true;if(g1==='VENDOR'){var i1={contentType:'application/json'};var j1=[];j1.push({name:"layer",value:g1});j1.push({name:"dt",value:"true"});var k1="/sap/bc/lrep/content/"+W+"/"+V+'.apfconfiguration';k1+=b._buildParams(j1);h1=b.send(k1,'GET',undefined,i1);}else{h1=b.getStaticResource(W,V,'apfconfiguration');}X.push(h1);}else{Z=0;}_=o(T,V);if(_===undefined){var l1=b.getFileAttributes(W,V,'apfconfiguration',g1);X.push(l1);}a1=Promise.all(X);a1.then(function(m1){_=o(T,V);if(_===undefined){_=m1[Z].response;}p(T,V,_);b1=H(T,_);if(Y){f1=m1[$].response;if(f1 instanceof String){b1.SerializedAnalyticalConfiguration=f1;}else{b1.SerializedAnalyticalConfiguration=JSON.stringify(f1);}}b1.AnalyticalConfiguration=V;if(R&&R.length!==0){c1=R.length;d1={};for(i=0;i<c1;i++){e1=R[i];d1[e1]=b1[e1];}b1=d1;}P(b1,u());},function(m1){P(undefined,u(),r({code:'5221',aParameters:[T,V]},m1&&m1.messages));});};this.doChangeOperationsInBatch=function(O,P,Q){function R(U,V){P(V);}var i,S;function T(){}y(Q).then(function(){for(i=0;i<O.length;i++){S=O[i];S.application=Q;if(S.method==='DELETE'&&S.entitySetName==='texts'){w(S,T);}else if(S.method==='POST'&&sap.apf.utils.isValidPseudoGuid(S.data.TextElement)){z(S.data,T);}else{z(S.data,T);}}A(Q,R,true);}).fail(function(U){P(U);});};this.readCollectionsInBatch=function(O,P,Q){var R=O.length;var S=[];var T=0;function U(W){function X(Y,Z,$){if($){P(undefined,$);}else{T++;S[W]=Y;if(T===R){P(S);}}}return X;}for(var i=0;i<R;i++){var V=O[i];this.readCollection(V.entitySetName,U(i),V.inputParameters,V.selectList,V.filter,Q);}};this.readCollection=function(i,O,P,Q,R,S,T){var U,V;var W;var X;if(T&&T.layer){X=T.layer;}else{X="CUSTOMER";}var Y=function(Z,$){if($&&($==="error"||$==="timeout"||$==="abort"||$==="parsererror")){O(undefined,u(),r({code:'5222',aParameters:[V]},[$]));return;}var _=new sap.apf.utils.Hashtable(m);var a1=[];var b1=(Z&&Z.response)||(Z&&Z.responseText)||"";var c1=sap.apf.utils.parseTextPropertyFile(b1,{instances:{messageHandler:m}});var d1,e1;if(c1.Messages.length>0){d1=m.createMessageObject({code:'5416'});e1=d1;c1.Messages.forEach(function(f1){e1.setPrevious(f1);e1=f1;});}_=new sap.apf.utils.Hashtable(m);c1.TextElements.forEach(function(f1){if(f1.TextElement){_.setItem(f1.TextElement,f1);a1.push(f1);}});d.setItem(V,_);O(a1,u(),d1);};if(i==='application'){m.check(!P&&!Q&&!R,"unsupported parameters when calling readCollection for application");m.check(S===undefined||S===true,'no async readCollection of application supported');M(O,X);}else if(i==='texts'){U=R.getFilterTermsForProperty('Application');V=U[0].getValue();if(S!==undefined&&S===false){x(V,Y,true,T);}else{W=x(V,undefined,false,T);W.then(function(Z){Y(Z);},function(Z){O(undefined,u(),r({code:'5222',aParameters:[V]},Z&&Z.messages));});}}else if(i==='configuration'){U=R.getFilterTermsForProperty('Application');V=U[0].getValue();B(V,O);}};this.remove=function(i,O,P,Q,R,S){if(!S){S="CUSTOMER";}if(i==='application'){K(O,P,S);}else if(i==='configuration'){G(O,P,R,S);}else{m.check(false,'the remove operation on entity set '+i+' is currently not supported by the lrep proxy');}};this.create=function(i,O,P,Q,R){if(i==='application'){m.check(Q===undefined||Q===true,'no async creation of application supported');I(O,P,R);}else if(i==='configuration'){m.check(Q===undefined||Q===true,'no async creation of configuration supported');F(O,P,R);}else if(i==='texts'&&Q===false){z(O,P,false);}else{m.check(false,'the create operation on entity set '+i+' is currently not supported by the lrep proxy');}};this.update=function(i,O,P,Q){if(i==='configuration'){E(O,P);}else if(i==='application'){J(O,P);}else{m.check(false,'the update operation on entity set '+i+' is currently not supported by the lrep proxy');}};function h(i,O){var P={async:true,contentType:'application/json'};var Q=[];Q.push({name:"layer",value:i});Q.push({name:"deep-read",value:true});Q.push({name:"metadata",value:true});Q.push({name:"type",value:O});var R="/sap/bc/lrep/content/"+n+"/";R+=b._buildParams(Q);return b.send(R,'GET',undefined,P);}function j(i){var n=i.ns.split('/');return n[n.length-2];}function k(i,O){var P;i.metadata.forEach(function(Q){if(Q.name===O){P=Q.value;}});return P;}this.readAllConfigurationsFromVendorLayer=function(){var i=jQuery.Deferred();var O=[];h('VENDOR','apf*').then(function(P){var Q={};P.response.forEach(function(R){if(R.fileType&&R.fileType==='apfapplication'){Q[j(R)]=k(R,'apfdt-applname');}});P.response.forEach(function(R){var S;var T;var U;if(R.fileType&&R.fileType==="apfconfiguration"){S=j(R);T=R.name;if(!(sap.apf.utils.isValidPseudoGuid(S)&&sap.apf.utils.isValidPseudoGuid(T))){return;}U=k(R,'apfdt-configname');O.push({configurationText:U,applicationText:Q[S],value:S+'.'+T});}});i.resolve(O);},function(P){i.reject(r({code:'5231'},P&&P.messages));});return i.promise();};l();function l(){if(a.constructors&&a.constructors.LrepConnector){b=a.constructors.LrepConnector.createConnector();}else{b=sap.ui.fl.LrepConnector.createConnector();}if(!b._sClient){b._sClient=c.getStartParameterFacade().getSapClient();}}function o(i,O){var P=e.getItem(i);if(P===undefined){return;}O=P.getItem(O);return O;}function p(i,O,P){var Q=e.getItem(i);if(Q===undefined){Q=new sap.apf.utils.Hashtable(m);}Q.setItem(O,P);e.setItem(i,Q);}function q(i){var O=(i&&i.layer)||"CUSTOMER";if(O==="ALL"){return undefined;}return O;}function r(i,O){var P=m.createMessageObject(i);var Q="";if(O){O.forEach(function(R){Q=Q+R+' ';});P.setPrevious(m.createMessageObject({code:5220,aParameters:[Q]}));}return P;}function u(){return{};}function v(i){return n+'/'+i;}function w(i,O){var P=i.application;var Q=i.inputParameters[0].value;var R;y(P).done(function(){R=d.getItem(P);R.removeItem(Q);O(i,u());}).fail(function(S){O(undefined,u(),S);});}function x(i,O,P,Q){var R;var S=[];var T="/sap/bc/lrep/content/";var U=q(Q);T+=n+"/"+i+'/'+t;if(U){S.push({name:"layer",value:U});}R={contentType:'text/plain'};if(P){R.complete=O;R.async=false;}T+=b._buildParams(S);return b.send(T,'GET',undefined,R);}function y(i,O){var P=jQuery.Deferred();var Q;var R=d.getItem(i);var S=function(T){var U=(T&&T.response)||(T&&T.responseText)||"";var V=sap.apf.utils.parseTextPropertyFile(U,{instances:{messageHandler:m}});R=new sap.apf.utils.Hashtable(m);V.TextElements.forEach(function(W){if(W.TextElement){R.setItem(W.TextElement,W);}});d.setItem(i,R);P.resolve({});};if(R===undefined){if(O!==undefined&&O===false){x(i,S,true);}else{Q=x(i,undefined,false);Q.then(function(T){S(T);},function(T){P.reject(r({code:'5222',aParameters:[i]},T&&T.messages));});}}else{P.resolve({});}return P.promise();}function z(i,O,P){var Q=i.Application;if(i.TextElement===undefined||!sap.apf.utils.isValidGuid(i.TextElement)){i.TextElement=sap.apf.utils.createPseudoGuid();}y(Q,P).done(function(){var R=d.getItem(Q);R.setItem(i.TextElement,i);O(i,u());}).fail(function(R){O(undefined,u(),R);});}function A(i,O,P){var Q=v(i);var R;function S(){var U=sap.apf.utils.renderHeaderOfTextPropertyFile(i,m);U=U+sap.apf.utils.renderTextEntries(R,m);var V=b.upsert(Q,'text','properties',"CUSTOMER",U,'text/plain');V.then(function(W){O(u());},function(W){O(u(),r({code:'5230',aParameters:[i]},W&&W.messages));});}R=d.getItem(i);if(!R){O(u());return;}if(P){S();}else{var T=x(i,undefined,false);T.then(function(U){var V=(U&&U.response)||"";var W=sap.apf.utils.parseTextPropertyFile(V,{instances:{messageHandler:m}});W.TextElements.forEach(function(X){if(X.TextElement){R.setItem(X.TextElement,X);}});S();},function(U){O(u(),r({code:'5222',aParameters:[i]},U&&U.messages));});}}function B(i,O){var P=[];var Q=v(i);var R=b._buildParams([{name:"layer",value:"CUSTOMER"},{name:"metadata",value:"true"},{name:"type",value:"apfconfiguration"}]);var S=b.send("/sap/bc/lrep/content/"+Q+R);S.then(function(T){var U=T.response;U.forEach(function(V){if(V.fileType==="apfconfiguration"){V.metadata.forEach(function(W){if(W.name==="apfdt-configname"){P.push({AnalyticalConfiguration:V.name,Application:i,AnalyticalConfigurationName:W.value});}});}});O(P,u());},function(T){O([],u(),r({code:'5223',aParameters:[i]},T&&T.messages));});}function C(){var i=jQuery.Deferred();var P=[];if(g){i.resolve(f);}else{P.push({name:"dt",value:false});var R="/sap/bc/lrep/content/sap/ui/fl/settings/main.flsettings";R+=b._buildParams(P);var O=b.send(R,'GET',undefined);O.then(function(Q){var S=Q&&Q.response||{};g=true;if(S.isAtoEnabled===true){f="ATO_NOTIFICATION";}i.resolve(f);},function(Q){i.reject(Q);});}return i.promise();}function D(i,O,P,Q){var R=Q||'CUSTOMER';var S=v(i);var T=b.getFileAttributes(S,O,'apfconfiguration',R);T.then(function(U){var V=U.response;if(R==='CUSTOMER'){p(i,O,V);A(i,P);}else{P(u());}},function(U){P(u(),r({code:'5232',aParameters:[i,O]},U&&U.messages));});}function E(i,O,P){if(!P){P="CUSTOMER";}var Q=i.Application;var R=i.AnalyticalConfiguration;var S=JSON.parse(i.SerializedAnalyticalConfiguration);var T=v(Q);var U=C();U.then(function(f){var V=b.getStaticResource(T,"metadata","apfapplication");V.then(function(W){var X={Application:Q,ApplicationName:W.response.ApplicationName,SemanticObject:W.response.SemanticObject,AnalyticalConfiguration:R,AnalyticalConfigurationName:i.AnalyticalConfigurationName,CreationUTCDateTime:i.CreationUTCDateTime,LastChangeUTCDateTime:i.LastChangeUTCDateTime};S=jQuery.extend(true,S,{configHeader:X});S=JSON.stringify(S);var Y=b.upsert(T,R,'apfconfiguration',P,S,'application/json',f);return Y;},function(W){O(u(),r({code:'5233',aParameters:[Q,R]},W&&W.messages));}).then(function(W){D(Q,R,O,P);},function(W){O(u(),r({code:'5233',aParameters:[Q,R]},W&&W.messages));});},function(V){O(u(),r({code:'5224'},V&&V.messages));});}function F(i,O,P){var Q=q(P);var R=i.Application;var S=i.AnalyticalConfiguration;if(S===undefined||!sap.apf.utils.isValidGuid(S)){S=sap.apf.utils.createPseudoGuid(32);}var T=JSON.parse(i.SerializedAnalyticalConfiguration);var U=v(R);var V=b.getStaticResource(U,"metadata","apfapplication");V.then(function(X){var Y={Application:R,ApplicationName:X.response.ApplicationName,SemanticObject:X.response.SemanticObject,AnalyticalConfiguration:S,AnalyticalConfigurationName:T.analyticalConfigurationName,CreationUTCDateTime:i.CreationUTCDateTime,LastChangeUTCDateTime:i.LastChangeUTCDateTime};T=jQuery.extend(true,T,{configHeader:Y});T=JSON.stringify(T);W(R,S,i.AnalyticalConfigurationName,T,O);},function(X){O(undefined,u(),r({code:'5223',aParameters:[R]},X&&X.messages));});function W(R,S,X,T,O){var U=v(R);var Y=C();Y.then(function(f){var Z=b.upsert(U,S,'apfconfiguration',Q,T,'application/json',f);Z.then(function($){D(R,S,function(_,a1){if(!a1){O({AnalyticalConfiguration:S,AnalyticalConfigurationName:i.AnalyticalConfigurationName},u());}else{O(undefined,u(),a1);}},Q);},function($){O(undefined,u(),r({code:'5226',aParameters:[R,S]},$&&$.messages));});},function(Z){O(undefined,u(),r({code:'5224'},Z&&Z.messages));});}}function G(i,O,P,Q){var R=i[0].value;m.check(R!==undefined,"configuration may not be undefined");m.check(P!==undefined,"application of configuration not found");var S=v(P);C().then(function(f){var T=b.deleteFile(S,R,'apfconfiguration',Q,f);T.then(function(U){O(u());},function(U){O(u(),r({code:'5225',aParameters:[P,R]},U&&U.messages));});},function(T){O(u(),r({code:'5224'},T&&T.messages));});}function H(O,P){var i=0;var Q={Application:O};var R,S;for(i=0;i<P.length;i++){R=P[i].name;S=P[i].value;if(R==="apfdt-applname"){R="ApplicationName";}else if(R==='createdAt'){R="CreationUTCDateTime";}else if(R==='createdBy'){R="CreatedByUser";}else if(R==='lastChangedAt'){R="LastChangeUTCDateTime";}else if(R==='lastChangedBy'){R="LastChangedByUser";}else if(R==="apfdt-configname"){R='AnalyticalConfigurationName';}else if(R==='size'||R==='layer'){continue;}Q[R]=S;}return Q;}function I(i,O,P){m.check(i.ApplicationName!==undefined&&i.ApplicationName!=="","Valid application name is required");var Q=i.Application;if(Q===undefined||!sap.apf.utils.isValidGuid(Q)){Q=sap.apf.utils.createPseudoGuid(32);}var R=JSON.stringify({ApplicationName:i.ApplicationName,SemanticObject:i.SemanticObject,Application:Q});var S=sap.apf.utils.renderHeaderOfTextPropertyFile(Q,m);var T=q(P);function U(X){O(undefined,u(),r({code:'5227'},X&&X.messages));}var V=v(Q);var W=b.upsert(V,'metadata','apfapplication',T,R,'application/json');W.then(function(X){var Y=b.upsert(V,'text','properties',T,S,'text/plain');Y.then(function(Z){d.setItem(Q,new sap.apf.utils.Hashtable(m));O({Application:Q,ApplicationName:i.ApplicationName,SemanticObject:i.SemanticObject},u());},U);},U);}function J(i,O){m.check(i.ApplicationName!==undefined&&i.ApplicationName!=="","Valid application name is required");var P=i.Application;var Q=JSON.stringify({ApplicationName:i.ApplicationName,SemanticObject:i.SemanticObject,Application:P});function R(U){O(undefined,r({code:'5228',aParameters:[P]},U&&U.messages));}var S=v(P);var T=b.upsert(S,'metadata','apfapplication','CUSTOMER',Q,'application/json');T.then(function(U){O({Application:P,ApplicationName:i.ApplicationName,SemanticObject:i.SemanticObject});},R);}function K(i,O,P){var Q=i[0].value;function R(U){var V=L(U);O(u(),V);}var S=v(Q);var T=b.listContent(S,P);T.then(function(U){var V=U.response;var W=[];V.forEach(function(Y){if(Y.fileType==="apfconfiguration"){C().then(function(f){W.push(b.deleteFile(S,Y.name,Y.fileType,Y.layer,f));},function(Z){O(u(),r({code:'5224'},Z&&Z.messages));});}else{W.push(b.deleteFile(S,Y.name,Y.fileType,Y.layer));}});var X=Promise.all(W);return X;},R).then(function(U){O(u());},R);}function L(i){var O;if(i&&i.messageObject&&i.messageObject.getCode){O=i.messageObject;}else if(i&&i.response&&i.response.statusCode&&i.response.statusCode>=400){O=m.createMessageObject({code:'11005',aParameters:[i.response.statusCode.toString(),i.response.statusText]});}else{O=m.createMessageObject({code:'5201',aParameters:(i&&i.messages)||[]});}return O;}function M(i,O){var P=[];h(O,"apfapplication").then(function(R){var S=R.response;S.forEach(function(S){var T;var U;if(S.fileType&&S.fileType==="apfapplication"){T=j(S);if(!sap.apf.utils.isValidPseudoGuid(T)){return;}U="";var V="";U=k(S,'apfdt-applname');P.push({Application:T,ApplicationName:U,SemanticObject:V});}});i(P,u());},Q);function Q(R){i(undefined,u(),r({code:'5229'},R&&R.messages));}}function N(i,O,P,Q,R){var S=q(R);var T={async:false,complete:function(W,X){var Y={};if(X==="error"||X==="timeout"||X==="abort"||X==="parsererror"){i(undefined,u(),r({code:'5223',aParameters:[P]},[X]));}else{Y.SerializedAnalyticalConfiguration=W.responseText;i(Y,u());}}};var U=[];var V="/sap/bc/lrep/content/";m.check(Q===undefined||Q.indexOf("SerializedAnalyticalConfiguration")>=0,"layered repository proxy - read configuration async without analytical configuration - not supported call");V+=n+"/"+P+'/'+O+'.apfconfiguration';if(S){U.push({name:"layer",value:S});}V+=b._buildParams(U);b.send(V,'GET',undefined,T);}};}());
