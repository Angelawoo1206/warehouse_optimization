/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
(function(){'use strict';jQuery.sap.declare("sap.apf.core.resourcePathHandler");jQuery.sap.require("sap.apf.core.utils.filter");jQuery.sap.require("sap.apf.utils.hashtable");jQuery.sap.require("sap.apf.core.messageHandler");jQuery.sap.require("sap.apf.core.messageDefinition");jQuery.sap.require("sap.apf.core.odataProxy");jQuery.sap.require("sap.apf.core.layeredRepositoryProxy");jQuery.sap.require("sap.apf.core.constants");jQuery.sap.require("sap.apf.utils.startParameter");jQuery.sap.require("sap.apf.utils.utils");sap.apf.core.ResourcePathHandler=function(i){var t=this;var c=i.instances.coreApi;var m=i.instances.messageHandler;var h=new sap.apf.utils.Hashtable(m);var C;var p;var s=null;var b=false;var P=sap.apf.core.OdataProxy;n();this.loadConfigFromFilePath=function(F){if(b){return;}var q=c.getStartParameterFacade().getAnalyticalConfigurationId();var U=F;c.ajax({url:U,dataType:"json",success:r,error:function(J,S,E){var M=m.createMessageObject({code:"5068",aParameters:[U,S,E]});m.putMessage(M);},async:false});e();if(q){l(q);}else{d();}b=true;function r(D,S,J){var T=i.functions.checkForTimeout(J);var M;if(T){M=m.createMessageObject({code:"5054",aParameters:[F]});M.setPrevious(T);m.putMessage(M);}if(!D||!D.applicationConfiguration){m.putMessage(m.createMessageObject({code:"5055",aParameters:[F]}));}if(D.applicationConfiguration.textResourceLocations===undefined){m.putMessage(m.createMessageObject({code:"5056",aParameters:[F]}));return;}o(D,q);}};function u(){return c.getStartParameterFacade().isLrepActive();}function l(q){var r=q.applicationId;var v=q.configurationId;if(u()&&!r){m.putMessage(m.createMessageObject({code:"5024"}));}var w=new P({serviceRoot:p.path.service,entityTypes:{configuration:sap.apf.core.constants.entitySets.configuration,texts:sap.apf.core.constants.entitySets.texts}},{instances:{coreApi:c,messageHandler:m}});w.readEntity("configuration",function(x,y,z){if(z){m.putMessage(m.createMessageObject({code:"5022",aParameters:[v]}));}else{var A=JSON.parse(x.SerializedAnalyticalConfiguration);c.loadAnalyticalConfiguration(JSON.parse(x.SerializedAnalyticalConfiguration));r=r||x.Application;a(r,w);if(A.applicationTitle){C.appName=A.applicationTitle.key;C.appTitle=A.applicationTitle.key;}}},[{name:"AnalyticalConfiguration",value:v}],undefined,false,r,{layer:'ALL'});}function a(q,r){var v=new sap.apf.core.utils.Filter(m,'Application','eq',q);var w=new sap.apf.core.utils.Filter(m,'Language','eq',sap.apf.core.constants.developmentLanguage);w.addAnd(v);var x=["TextElement","TextElementDescription"];r.readCollection('texts',function(y,z,A){if(A){m.putMessage(m.createMessageObject({code:"5023",aParameters:[sap.apf.utils.uriParameter.getConfigurationId()]}));}else{c.loadTextElements(y);}},undefined,x,w,false,{layer:'ALL'});}function d(){var U=t.getResourceLocation(sap.apf.core.constants.resourceLocation.analyticalConfigurationLocation);var M;if(U!==""){c.ajax({url:U,dataType:"json",success:function(D,S,J){if(D){c.loadAnalyticalConfiguration(D);if(D.applicationTitle){C.appName=D.applicationTitle.key;C.appTitle=D.applicationTitle.key;}}else{M=m.createMessageObject({code:"5057",aParameters:[U]});m.putMessage(M);}},error:function(J,S,E,q){M=m.createMessageObject({code:"5057",aParameters:[U]});if(q){M.setPrevious(q);}m.putMessage(M);},async:false});}else{M=m.createMessageObject({code:"5060"});m.putMessage(M);}}function e(){c.loadMessageConfiguration(sap.apf.core.messageDefinition,true);f(sap.apf.core.constants.resourceLocation.applicationMessageDefinitionLocation,false);}function f(r,R){var U=t.getResourceLocation(r);if(U!==""){c.ajax({url:U,dataType:"json",success:q,error:function(J,S,E,v){var M=m.createMessageObject({code:"5058",aParameters:[S,E,U]});if(v){M.setPrevious(v);}m.putMessage(M);},async:false});}function q(D,S,J){var M;var T=i.functions.checkForTimeout(J);if(!T){if(D.messageConfiguration){c.loadMessageConfiguration(D.messageConfiguration.definitions,R);}}else{M=m.createMessageObject({code:"5067"});M.setPrevious(T);m.putMessage(M);}}}function g(q){var M;if(!q||!q.path){M=m.createMessageObject({code:"5066"});m.putMessage(M);}if(!q.path.service){M=m.createMessageObject({code:"5067"});m.putMessage(M);}if(q.analyticalConfiguration){if(!q.analyticalConfiguration.service){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"service or entity set are missing in analytical configuration in the application configuration"});m.putMessage(M);}}}function j(q){var M;if(q.evaluations&&!q.evaluations.service){M=m.createMessageObject({code:"5063"});m.putMessage(M);}if(q.evaluations&&(!q.evaluations.type||q.evaluations.type!=="smartBusinessRequest")){M=m.createMessageObject({code:"5062",rawText:"type in Smart Business configuration is not smartBusinessRequest"});m.putMessage(M);}if(q.evaluations&&!q.evaluations.entityType){M=m.createMessageObject({code:"5061"});m.putMessage(M);}}this.getResourceLocation=function(r){return h.getItem(r);};this.getPersistenceConfiguration=function(){m.check(b,"RessourcePathHandler: configuration must be loaded before access to ressources");return p;};this.getConfigurationProperties=function(){m.check(b,"RessourcePathHandler: configuration must be loaded before access to ressources");return C;};function k(){var q=sap.apf.core.utils.uriGenerator;var r,v,w;var x=i.manifests.manifest;var y=i.manifests.baseManifest;var M;if(b){return;}var z=q.getBaseURLOfComponent(sap.apf.utils.getComponentNameFromManifest(i.manifests.baseManifest));var A=q.getBaseURLOfComponent(sap.apf.utils.getComponentNameFromManifest(i.manifests.manifest));if(x["sap.app"].dataSources&&x["sap.app"].dataSources.PathPersistenceServiceRoot){w=x["sap.app"].dataSources.PathPersistenceServiceRoot.uri;}else{M=m.createMessageObject({code:"5064"});m.putMessage(M);}var B=y["sap.app"].i18n;B=q.addRelativeToAbsoluteURL(z,B);var D=x["sap.app"].i18n;D=q.addRelativeToAbsoluteURL(A,D);var E=x["sap.app"].title;var F=sap.apf.utils.createPseudoGuid();c.registerTextWithKey(F,E);var G=c.getStartParameterFacade().getAnalyticalConfigurationId();var H="";if(x["sap.app"].dataSources&&x["sap.app"].dataSources.AnalyticalConfigurationLocation&&x["sap.app"].dataSources.AnalyticalConfigurationLocation.uri){H=x["sap.app"].dataSources.AnalyticalConfigurationLocation.uri;H=q.addRelativeToAbsoluteURL(A,H);}if(!G&&!H){M=m.createMessageObject({code:"5065"});m.putMessage(M);}var I={"appName":F,"appTitle":F,"analyticalConfigurationLocation":H,"textResourceLocations":{"apfUiTextBundle":B,"applicationUiTextBundle":D},"persistence":{"path":{"service":w}}};if(x["sap.apf"]&&x["sap.apf"].appSpecificParameters){for(r in x["sap.apf"].appSpecificParameters){I[r]=x["sap.apf"].appSpecificParameters[r];}}if(u()){P=sap.apf.core.LayeredRepositoryProxy;}if(x["sap.app"].dataSources&&x["sap.app"].dataSources.SmartBusiness){v=x["sap.app"].dataSources.SmartBusiness.uri;I.smartBusiness={runtime:{service:v}};}if(x["sap.app"].dataSources&&x["sap.app"].dataSources.LogicalSystem){I.persistence.logicalSystem={service:x["sap.app"].dataSources.LogicalSystem.uri};}o({applicationConfiguration:I},G);e();if(G){l(G);}else{d();}b=true;}function n(){var A=c.getUriGenerator().getApfLocation();h.setItem(sap.apf.core.constants.resourceLocation.apfUiTextBundle,A+"resources/i18n/apfUi.properties");h.setItem(sap.apf.core.constants.resourceLocation.applicationMessageDefinitionLocation,"");h.setItem(sap.apf.core.constants.resourceLocation.applicationMessageTextBundle,"");h.setItem(sap.apf.core.constants.resourceLocation.applicationUiTextBundle,"");h.setItem(sap.apf.core.constants.resourceLocation.analyticalConfigurationLocation,"");}function o(q,r){function v(A){C=jQuery.extend(true,{},A);delete C.type;delete C.analyticalConfigurationLocation;delete C.applicationMessageDefinitionLocation;delete C.textResourceLocations;delete C.persistence;}var A=q.applicationConfiguration;v(A);var T=q.applicationConfiguration.textResourceLocations;p=q.applicationConfiguration.persistence;g(p);if(!p.path.entitySet){p.path.entitySet=sap.apf.core.constants.entitySets.analysisPath;}if(q.applicationConfiguration.smartBusiness){s=q.applicationConfiguration.smartBusiness;j(s);}var M;var U;var w;for(w in sap.apf.core.constants.resourceLocation){if(!sap.apf.core.constants.resourceLocation.hasOwnProperty(w)){continue;}if(w===sap.apf.core.constants.resourceLocation.analyticalConfigurationLocation&&r){continue;}if(A[w]!==undefined){U=A[w];}else if(T[w]!==undefined){U=T[w];}else{continue;}if(i.manifests){h.setItem(w,U);}else if(w===sap.apf.core.constants.resourceLocation.apfUiTextBundle||i.instances.fileExists.check(U)){h.setItem(w,U);}else if(!r){M=m.createMessageObject({code:"5059",aParameters:[U,w]});m.putMessage(M);}}}if(i.manifests&&i.manifests.manifest){k();}};}());
