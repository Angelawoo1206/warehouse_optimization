/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Element","sap/rules/ui/parser/businessLanguage/lib/parsingBackendMediator","sap/rules/ui/parser/ruleBody/lib/ruleServices","sap/rules/ui/parser/resources/common/lib/resourcesConvertor","sap/rules/ui/parser/resources/vocabulary/lib/vocabularyDataProviderInitiator","sap/rules/ui/parser/infrastructure/messageHandling/lib/responseCollector","sap/ui/core/Locale","sap/ui/core/LocaleData","sap/rules/ui/library"],function(q,E,P,R,r,a,b,L,c){"use strict";var d=E.extend("sap.rules.ui.services.ExpressionLanguage",{metadata:{library:"sap.rule.ui",properties:{},publicMethods:["setData","validateExpression","getSuggestions","getExpressionMetadata"],events:{"dataChange":{}}}});d.prototype._isDataExist=function(){if(!this._data){return false;}return true;};d.prototype._removeOdataTags=function(e){var i;if(!e){return{};}var f=JSON.parse(JSON.stringify(e));if(f.DataObjects&&f.DataObjects.results){f.DataObjects=f.DataObjects.results;for(i=0;i<f.DataObjects.length;i++){if(f.DataObjects[i].Attributes&&f.DataObjects[i].Attributes.results){f.DataObjects[i].Attributes=f.DataObjects[i].Attributes.results;}if(f.DataObjects[i].Associations&&f.DataObjects[i].Associations.results){f.DataObjects[i].Associations=f.DataObjects[i].Associations.results;}}}if(f.DecisionTable){if(f.DecisionTable.DecisionTableColumns&&f.DecisionTable.DecisionTableColumns.results){f.DecisionTable.DecisionTableColumns=f.DecisionTable.DecisionTableColumns.results;}if(f.DecisionTable.DecisionTableRows&&f.DecisionTable.DecisionTableRows.results){f.DecisionTable.DecisionTableRows=f.DecisionTable.DecisionTableRows.results;for(i=0;i<f.DecisionTable.DecisionTableRows.length;i++){if(f.DecisionTable.DecisionTableRows[i].Cells&&f.DecisionTable.DecisionTableRows[i].Cells.results){f.DecisionTable.DecisionTableRows[i].Cells=f.DecisionTable.DecisionTableRows[i].Cells.results;}}}}return f;};d.prototype._initRuntimeService=function(){if(!this._runtimeService){var v=this._removeOdataTags(this._data);this._vocabularyName=v.Id;var i={"connection":null,"vocaLoadingType":"json","resourceID":this._vocabularyName,"resourceContent":v};var e=a.lib;var f=new e.vocaDataProviderInitiatorLib();this._runtimeService=f.init(i);}};d.prototype._initBackendParser=function(){if(!this._backendParser){var e=P.lib;this._backendParser=new e.parsingBackendMediatorLib();}};d.prototype._initLocale=function(){if(!this._localeSettings){var l=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var o=c.getInstance(l);var e=o.getDatePattern('short');var t=o.getTimePattern('medium');var f=-(new Date().getTimezoneOffset());var g=o.getNumberSymbol('decimal');var h=o.getNumberSymbol('group');this._localeSettings={"dateFormat":e,"timeFormat":t,"timeZoneOffset":f,"number":{"groupSeparator":h,"decimalSeparator":g}};}};d.prototype._init=function(){this._initRuntimeService();this._initBackendParser();this._initLocale();};d.prototype._reset=function(){this._runtimeService=null;this._backendParser=null;this._initBackendParser();};d.prototype.setData=function(D){this._data=D;this._reset();this.fireDataChange({data:D});};d.prototype._initResponseCollector=function(s){var e=b.lib.ResponseCollector;var o=e.getInstance();o.clear();o.addSubject(s);return e;};d.prototype.convertRuleToDisplayValues=function(o){var C={"source":"codeText","target":"displayText"};var f=this._buildFlagsObject(C);return this._validateRule(o,f);};d.prototype.validateRule=function(o){return this._validateRule(o);};d.prototype._validateRule=function(o,f){if(!this._isDataExist()){return null;}f=f||{};f.isCollection=false;f.tokensOutput=true;this._init();var C=this._removeOdataTags(o);var e=this._initResponseCollector("Rule Validation");var g=e.getInstance();var m="************* RULE: "+JSON.stringify(C)+"\n\n\n\n"+"*************    VOCABULARY: "+JSON.stringify(this._data)+"\n\n\n\n";g.trace(e.severity().debug,m);g.setOpMessage("RuleValidation","failure");var h=R.lib.validateRule(C,this._vocabularyName,this._runtimeService,f);if(h.status=="Success"){g.setOpMessage("RuleValidation","success");}this._addOdataTags(h);g.setOutput(h);var i=g.build();return i;};d.prototype.validateExpression=function(e,f,C,t){if(!this._isDataExist()){return null;}this._init();this._initResponseCollector("Parsing");var g=this._buildFlagsObject(null,C,t);var p=this._backendParser.parseExpression(e,sap.rules.ui.BackendParserRequest.Validate,this._runtimeService,null,f,this._vocabularyName,g);var h={};h.status=p.status;if(h.status==="Error"){h.errorDetails=p.errorDetails;h.cursorPosition=p.cursorPosition;}else{h.actualReturnType=p.actualReturnType;}if(p.tokens){h.tokens=p.tokens;}return h;};d.prototype._buildFlagsObject=function(C,e,t){if(!e){e=false;}if(t===undefined||t===null){t=true;}var f={"isCollection":e,"tokensOutput":t};if(this._localeSettings){f.locale={localeSettings:this._localeSettings};}if(C){f.locale={localeSettings:this._localeSettings,convert:C};}return f;};d.prototype.getSuggestions=function(e,f,C,t){if(!this._isDataExist()){return null;}this._init();this._initResponseCollector("Parsing");var g=this._buildFlagsObject(null,C,t);var p=this._backendParser.parseExpression(e,sap.rules.ui.BackendParserRequest.Suggests,this._runtimeService,null,f,this._vocabularyName,g);var h={};h.suggs=p.suggs;if(p.tokens){h.tokens=p.tokens;}return h;};d.prototype.getSuggestionsByCategories=function(e,f){e=e?e:"";var s=this.getSuggestions(e,sap.rules.ui.ExpressionType.BooleanEnhanced,false).suggs;s=s?s:[];if(!f){return s;}var o=[];for(var i=0;i<f.length;i++){var g=f[i];for(var j=0;j<s.length;j++){if(g.tokenType===undefined||g.tokenType===s[j].tokenType||g.hasOwnProperty('tokenType')===false){if(s[j].hasOwnProperty('info')===false){if((g.hasOwnProperty('tokenCategory')===false&&g.hasOwnProperty('tokenBusinessType')===false)||(g.tokenCategory===undefined&&g.tokenBusinessType===undefined)){o.push(s[j]);}}else if((g.tokenCategory===undefined||g.tokenCategory===s[j].info.category||g.hasOwnProperty('tokenCategory')===false)&&(g.tokenBusinessType===undefined||g.tokenBusinessType===s[j].info.type||g.hasOwnProperty('tokenBusinessType')===false)){o.push(s[j]);}}}}return o;};d.prototype.getExpressionMetadata=function(e){if(!this._isDataExist()){return null;}this._init();this._initResponseCollector("Parsing");var p=this._backendParser.parseExpression(e,sap.rules.ui.BackendParserRequest.GetMetadata,this._runtimeService,null,null,this._vocabularyName,null);var f={};f.tokens=p.tokens;return f;};d.prototype.getResultInfo=function(s){if(!this._isDataExist()){return null;}this._init();var o=null;o=this._runtimeService.getOutput(this._vocabularyName,s,null);if(o&&o.name){this._getResultRequiredParamIds(o);}return o;};d.prototype._getResultRequiredParamIds=function(o){var i,j,k;var e=JSON.parse(JSON.stringify(this._data));if(e.DataObjects&&e.DataObjects.results){e.DataObjects=e.DataObjects.results;for(i=0;i<e.DataObjects.length;i++){if(e.DataObjects[i].Attributes&&e.DataObjects[i].Attributes.results&&(e.DataObjects[i].Name==o.name)&&(e.DataObjects[i].Usage=="RESULT")&&o.requiredParams){e.DataObjects[i].Attributes=e.DataObjects[i].Attributes.results;for(j=0;j<e.DataObjects[i].Attributes.length;j++){for(k=0;k<o.requiredParams.length;k++){if(o.requiredParams[k].name===e.DataObjects[i].Attributes[j].Name){o.requiredParams[k].paramId=e.DataObjects[i].Attributes[j].Id;}}}return;}}}return;};d.prototype._setConfigurationForBasic=function(){this.suggestAfterMap={"initial":["vocabulary,undefined"],"vocabulary,undefined":["reservedword,comparisonOp","reservedword,comparisonBetweenOp","reservedword,comparisonExistOp"],"reservedword,comparisonOp":["constant,dynamic","constant,fixed","reservedword,value"],"reservedword,comparisonBetweenOp":["constant,dynamic","reservedword,value"],"reservedword,comparisonExistOp":["constant,dynamic","constant,fixed","reservedword,value"],"reservedword,UOM":["reservedword,null","reservedword,conjunctionOp"],"reservedword,function":["vocabulary,undefined"],"reservedword,conjunctionOp":["initial"],"reservedword,value":["reservedword,null","reservedword,conjunctionOp"],"reservedword,null":["reservedword,conjunctionOp"],"constant.dynamic":["reservedword,UOM","reservedword,null","reservedword,conjunctionOp"],"constant.fixed":["reservedword,null","reservedword,conjunctionOp"],"unknown,undefined":[]};this.filterByTypeMap={"vocabulary,undefined":[{tokenType:sap.rules.ui.ExpressionTokenType.vocabulary}],"reservedword,comparisonOp":[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonOp}],"reservedword,comparisonBetweenOp":[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonBetweenOp}],"reservedword,comparisonExistOp":[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonExistOp}],"reservedword,UOM":[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.UOM}],"reservedword,function":[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.func}],"reservedword,conjunctionOp":[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.conjunctionOp}],"reservedword,value":[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.value}],"reservedword,null":[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:null}],"constant.dynamic":[{tokenType:sap.rules.ui.ExpressionTokenType.constant,tokenCategory:sap.rules.ui.ExpressionCategory.dynamic}],"constant.fixed":[{tokenType:sap.rules.ui.ExpressionTokenType.constant,tokenCategory:sap.rules.ui.ExpressionCategory.fixed}],};};d.prototype.getSuggestionsForBasic=function(e,f,C){var s=[];var g=this.getSuggestions(e,f,C,true);if(!g||!g.suggs||!g.suggs.length){return s;}s=this._filterSuggestionsForBasic(g);return s;};d.prototype._filterSuggestionsForBasic=function(s){var t=this._groupTokensByTokenType(s.tokens);var l=null;if(t&&t.length>0){l=t[t.length-1];}var e=this._getCategoryForToken(l);var f=this.suggestAfterMap[e];var g=this._getFilterForTokenTypes(f);var h=this._filterSuggestionsByCategories(s,g);return{suggs:h,afterTokenType:l&&l.tokenType};};d.prototype._getCategoryForToken=function(t){if(!t){return"initial";}var e=t.tokenType;var i=t.info&&t.info.category;return e+","+i;};d.prototype._getFilterForTokenTypes=function(t){var f=[];for(var i=0;i<t.length;i++){var e=t[i];var g=this.filterByTypeMap[e];if(g){f.push(g);}}return f;};d.prototype._filterSuggestionsByCategories=function(s,f){var o=[];if(!s||!f){return o;}for(var i=0;i<f.length;i++){var e=f[i];for(var j=0;j<suggs.length;j++){if(e.tokenType===undefined||e.tokenType===suggs[j].tokenType||e.hasOwnProperty('tokenType')===false){if(suggs[j].hasOwnProperty('info')===false){if((e.hasOwnProperty('tokenCategory')===false&&e.hasOwnProperty('tokenBusinessType')===false)||(e.tokenCategory===undefined&&e.tokenBusinessType===undefined)){o.push(suggs[j]);}}else if((e.tokenCategory===undefined||e.tokenCategory===suggs[j].info.category||e.hasOwnProperty('tokenCategory')===false)&&(e.tokenBusinessType===undefined||e.tokenBusinessType===suggs[j].info.type||e.hasOwnProperty('tokenBusinessType')===false)){o.push(suggs[j]);}}}}return o;};d.prototype._groupTokensByTokenType=function(t){var e=[];if(!t||!t.length){return e;}var p="";for(var i=0;i<t.length;i++){var f=aTokents[i];if(f.tokenType===sap.rules.ui.ExpressionTokenType.whitespace){continue;}else if(f.tokenType!==sap.rules.ui.ExpressionTokenType.vocabulary){e.push(f);p=f.tokenType;}else{if(p!==sap.rules.ui.ExpressionTokenType.vocabulary){e.push(f);}else{e[e.length-1].token+=" "+f.token;e[e.length-1].end=f.end;}p=f.tokenType;}}return e;};d.prototype._getSubExpressions=function(t){var e=[];var f=t.tokens.filter(function(o){var T=o.info;if(T){return T.category===sap.rules.ui.ExpressionCategory.comparisonOp||T.category===sap.rules.ui.ExpressionCategory.comparisonBetweenOp||T.category===sap.rules.ui.ExpressionCategory.comparisonExistOp;}});e.push({exp:""});var i=0;while(t.tokens[i]!==f[0]){e[0].exp+=t.tokens[i].token;i++;}e[0].exp=e[0].exp.replace(/  +/g,' ');if(!e[0].exp){return e;}if(e[0].exp.slice(-1)===" "){e[0].exp=e[0].exp.slice("",-1);}i++;if(!f[0]){return e;}e.push({exp:f[f.length-1].token.replace(/  +/g,' '),type:this._getCompType(this.exp)});if(i<t.tokens.length){e.push({exp:""});for(;i<t.tokens.length;i++){e[2].exp+=t.tokens[i].token;}}return e;};d.prototype._getBasicSuggestions=function(e,f){if(!f){f=sap.rules.ui.SuggestionsPart.all;}var t=this.validateExpression(e);var s=[];var g=this._getSubExpressions(t);var l=(g[0]&&g[0].exp)?g[0].exp:"";if(f===sap.rules.ui.SuggestionsPart.all){s.push(this._getLeft("",l));if(l===""){return s;}}var C=(g[1]&&g[1].exp)?g[1].exp:"";var h=""||(g[1]&&g[1].type);if(f===sap.rules.ui.SuggestionsPart.all||f===sap.rules.ui.SuggestionsPart.compPart){s.push(this._getComp(l,C,h));if(g.length===1){return s;}}if(f===sap.rules.ui.SuggestionsPart.all||f===sap.rules.ui.SuggestionsPart.rightPart){var i=(g[2]&&g[2].exp)?g[2].exp:"";h=(f===sap.rules.ui.SuggestionsPart.all)?s[1].type:null;var o=this._getRight(l,C,i,h,t);s.push.apply(s,o);}return s;};d.prototype._getLeft=function(e,f){var s=this._createEmptySuggestion(1)[0];var F=[{tokenType:sap.rules.ui.ExpressionTokenType.vocabulary}];var S=this.getSuggestionsByCategories(e,F);for(var i=0;i<S.length;i++){s.sugg.push(S[i].text);}s.currentValue=f;s.tokenCategory=sap.rules.ui.ExpressionTokenType.vocabulary;return s;};d.prototype._getComp=function(l,e,C){var s=this._createEmptySuggestion(1)[0];var f=[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonOp},{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonBetweenOp},{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonExistOp}];var S=this.getSuggestionsByCategories(l,f);s.type=C||this._getCompType(e);for(var i=0;i<S.length;i++){s.sugg.push(S[i].text);}s.currentValue=e;return s;};d.prototype._getRight=function(l,C,e,s,t){var S;var f=l+" "+C;var g=this._getLeftBusinessDataType(l);if(!s){s=this._getCompType(C);}switch(s){case sap.rules.ui.ExpressionCategory.comparisonOp:S=this._geRightForComparisonOp(g,f,e);break;case sap.rules.ui.ExpressionCategory.comparisonBetweenOp:S=this._geRightForBetweenOp(g,f,e);break;case sap.rules.ui.ExpressionCategory.comparisonExistOp:break;}if(!S){return[{}];}return S;};d.prototype._geRightForComparisonOp=function(l,s,e){var S=this._createEmptySuggestion(1);var f;S[0].BDT=l;if(l===sap.rules.ui.ExpressionType.TimeSpan){S.push.apply(S,this._createEmptySuggestion(1));var F=[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.UOM}];var g=this._splitStringBySeperator(e," ");S[0].currentValue=g[0];S[1].currentValue=g[1];f=this.getSuggestionsByCategories(s+" 5",F);for(var i=0;i<f.length;i++){S[1].sugg.push(f[i].text);}}else if(l===sap.rules.ui.ExpressionType.Date){var F=[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.value},{tokenType:sap.rules.ui.ExpressionTokenType.constant,tokenCategory:sap.rules.ui.ExpressionCategory.dynamic}];f=this.getSuggestionsByCategories(s+" ",F);for(var i=0;i<f.length;i++){S[0].sugg.push(f[i].text);}S[0].currentValue=q.trim(e);}else{S[0].currentValue=q.trim(e);}return S;};d.prototype._geRightForBetweenOp=function(l,s,e){var S=this._createEmptySuggestion(1);var f;var g;S[0].BDT=l;if(l!==sap.rules.ui.ExpressionType.TimeSpan&&l!==sap.rules.ui.ExpressionType.Date){g=this._getRightExpressionsForTimeStamp(e);}else{var g=this._splitStringBySeperator(e," ");}if(l===sap.rules.ui.ExpressionType.TimeSpan){S.push.apply(S,this._createEmptySuggestion(4));S[3].BDT=l;var F=[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.UOM}];f=this.getSuggestionsByCategories(s+" 5",F);for(var i=0;i<f.length;i++){S[1].sugg.push(f[i].text);S[4].sugg.push(f[i].text);}}else if(l===sap.rules.ui.ExpressionType.Date){S.push.apply(S,this._createEmptySuggestion(2));S[2].BDT=l;var F=[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.value},{tokenType:sap.rules.ui.ExpressionTokenType.constant,tokenCategory:sap.rules.ui.ExpressionCategory.dynamic}];f=this.getSuggestionsByCategories(s+" ",F);for(var i=0;i<f.length;i++){S[0].sugg.push(f[i].text);S[2].sugg.push(f[i].text);}}else{S.push.apply(S,this._createEmptySuggestion(2));S[2].BDT=l;}for(var i=0;i<S.length;i++){if(g[i]==="to"||(i===2&&l===sap.rules.ui.ExpressionType.TimeSpan)||(i===1&&l===sap.rules.ui.ExpressionType.Date)||((i===1&&l!==sap.rules.ui.ExpressionType.Date)&&(i===1&&l!=sap.rules.ui.ExpressionType.TimeSpan))){S[i].tokenCategory="reservedword.undefined";S[i].currentValue=(g[i]==="to"||g[i]==="and")?g[i]:"to";}else{S[i].currentValue=q.trim(g[i]);}}return S;};d.prototype._geRightForExistOp=function(l,s,e,t){var S=this._createEmptySuggestion(1);S[0].BDT=l;if(l===sap.rules.ui.ExpressionType.TimeSpan){var f=t.tokens.filter(function(o){if(o.info){return o.info.category===sap.rules.ui.ExpressionCategory.UOM||o.tokenType===sap.rules.ui.ExpressionTokenType.constant;}});f.forEach(function(v,i){});}else if(l===sap.rules.ui.ExpressionType.Date){var f=t.tokens.filter(function(o){if(o.info){return o.info.category===sap.rules.ui.ExpressionCategory.value;}});f.forEach(function(v,i){});}return S;};d.prototype._getLeftBusinessDataType=function(l){return this.validateExpression(l).actualReturnType;};d.prototype._splitStringBySeperator=function(e,s){return e.split(s).filter((function removeEmptyStrings(f){return f!=="";}));};d.prototype._getCompType=function(C){if(C){return this.getExpressionMetadata(C).tokens[0].info.category}else{return null;}};d.prototype._createEmptySuggestion=function(A){var s=[];for(var i=0;i<A;i++){s.push({sugg:[]});}return s;};d.prototype._getRightExpressionsForTimeStamp=function(e){if(!String.prototype.includes){String.prototype.includes=function(){'use strict';return String.prototype.indexOf.apply(this,arguments)!==-1;};}if(e.indexOf("to")!==-1){var f=this._splitStringBySeperator(e,"to");f.splice(1,0,"to");console.log(f);return f;}else if(e.indexOf("and")!==-1){var f=this._splitStringBySeperator(e,"and");f.splice(1,0,"and");return f;}return[e,"to"];};d.prototype._addOdataTags=function(C){var o=C.decisionTableData;if(o){var e=o.DecisionTable.DecisionTableColumns;o.DecisionTable.DecisionTableColumns={results:e};if(o.DecisionTable.DecisionTableRows){o.DecisionTable.DecisionTableRows.forEach(function(f){var g=f.Cells;f.Cells={results:g};});}}};d.prototype.convertDecisionTableExpressionToDisplayValue=function(h,f,C,e){this._init();var o={"source":"codeText","target":"displayText"};var g=this._buildFlagsObject(o);var i=this._initResponseCollector("RuleServiceValidation");var j=i.getInstance();j.setOpMessage("RuleServiceValidation","failure");var k=R.lib.validateDecisionTableExpression(h,f,C,e,this._vocabularyName,this._runtimeService,g);if(k.status=="Success"){j.setOpMessage("RuleServiceValidation","success");}j.setOutput(k);var l=j.build();return l;};d.prototype.convertDecisionTableExpressionToModelValue=function(h,f,C,e){this._init();var o={"source":"displayText","target":"codeText"};var g=this._buildFlagsObject(o);var i=this._initResponseCollector("RuleServiceValidation");var j=i.getInstance();j.setOpMessage("RuleServiceValidation","failure");var k=R.lib.validateDecisionTableExpression(h,f,C,e,this._vocabularyName,this._runtimeService,g);if(k.status=="Success"){j.setOpMessage("RuleServiceValidation","success");}j.setOutput(k);var l=j.build();return l;};d.prototype.getExpressionLanguageVersion=function(){return R.lib.getParserExprLangVersion();};return d;},true);
