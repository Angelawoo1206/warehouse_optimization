/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","./library","sap/rules/ui/DecisionTableCell","sap/rules/ui/RuleBase","sap/rules/ui/Utils","sap/ui/table/Table","sap/ui/table/Column","sap/m/Toolbar","sap/m/Popover","sap/ui/unified/Menu","sap/m/Dialog","sap/m/Button","sap/m/ToolbarSpacer","sap/m/Text","sap/m/Input","sap/m/ObjectIdentifier","sap/m/Link","sap/m/Label","sap/m/BusyIndicator","sap/m/DisplayListItem","sap/ui/unified/MenuItem","sap/m/FlexBox","sap/m/MessageStrip","sap/rules/ui/type/DecisionTableHeader"],function(q,l,D,R,U,T,C,a,P,M,b,B,c,d,I,O,L,e,f,g,h,F,j,k){"use strict";var m={vocabulary:"vocabulary",rule:"rule",columns:"columns",rows:"rows"};var v={emptyTable:3,max:10};var o=R.extend("sap.rules.ui.DecisionTable",{metadata:{properties:{enableSettings:{type:"boolean",group:"Misc",defaultValue:false},hitPolicies:{type:"sap.rules.ui.RuleHitPolicy[]",defaultValue:[sap.rules.ui.RuleHitPolicy.FirstMatch,sap.rules.ui.RuleHitPolicy.AllMatch]}},aggregations:{"_toolbar":{type:"sap.m.Toolbar",multiple:false,singularName:"_toolbar"},"_table":{type:"sap.ui.core.Control",multiple:false,singularName:"_table"},"_errorsText":{type:"sap.m.MessageStrip",multiple:false,singularName:"_errorsText"}}},_addErrorLabel:function(){var E=new j({showCloseButton:true,showIcon:true,type:sap.ui.core.MessageType.Error,visible:false}).addStyleClass("sapUiTinyMargin");this.setAggregation("_errorsText",E,true);},init:function(){this.multiHeaderFlag=false;this.resetContent=true;this._initInternalModel();this._initDisplayModel();this._initDataBucket();this.bindProperty("busy","dtModel>/busyState");this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this._addToolBar();this._addTable();this._addErrorLabel();this._decisionTableHeaderFormatter=new k();this.setBusyIndicatorDelay(0);},setEditable:function(i){this.setProperty("editable",i,true);this._internalModel.setProperty("/editable",i);var t=this.getAggregation("_table");var n=this.getAggregation("_toolbar");if(i===false){t.addStyleClass("sapRULDecisionTableEdit");n.removeStyleClass("sapRULDecisionTableToolBar");}else{t.removeStyleClass("sapRULDecisionTableEdit");n.addStyleClass("sapRULDecisionTableToolBar");}return this;},setExpressionLanguage:function(i){this.setAssociation("expressionLanguage",i,true);this._decisionTableHeaderFormatter.setExpressionLanguage(this.getExpressionLanguage());var n=(i instanceof Object)?i:sap.ui.getCore().byId(i);if(!n){return this;}var t=this.getAggregation("_table");if(t){var p=t.getBinding("columns");if(p){p.refresh();}}if(n._isDataExist()){var E=new sap.ui.base.Event("","",{data:true});this._handleVocabularyDataChanged(E);}n.attachDataChange(this._handleVocabularyDataChanged.bind(this));return this;},setEnableSettings:function(i){this.setProperty("enableSettings",i,true);this._internalModel.setProperty("/enableSettings",i);return this;},setHitPolicies:function(i){this.setProperty("hitPolicies",i,true);this._internalModel.setProperty("/hitPolicies",i);return this;},_initInternalModel:function(){var i={};i.editable=this.getEditable();i.newTable=true;i.busyState=true;i.busyTableState=true;i.hitPolicies=this.getHitPolicies();i.enableSettings=this.getEnableSettings();i.isAtLeastOneRowSelected=false;i.validationStatus={};this._internalModel=new sap.ui.model.json.JSONModel(i);this.setModel(this._internalModel,"dtModel");},_initDisplayModel:function(){this._displayModel=new sap.ui.model.json.JSONModel();this.setModel(this._displayModel,"displayModel");},_initDataBucket:function(){var i=false;var E=sap.ui.getCore().byId(this.getExpressionLanguage());if(E&&E._isDataExist()){i=true;}this.dataBucket={dataReceived:{vocabulary:i,rule:false,rows:false,columns:false},rows:{},columns:{},collectRowsMode:"replace"};},_setDataLoadedPromise:function(){if(!this._dataLoaded||this._dataLoaded.state()!=="pending"){this._dataLoaded=new q.Deferred();}},_getDataLoadedPromise:function(){if(!this._dataLoaded){this._setDataLoadedPromise();}return this._dataLoaded.promise();},setBindingContextPath:function(i){var n=this.getBindingContextPath();if(n!==i){this._unbindRule();this._unbindRows();this._unbindColumns();this.setProperty("bindingContextPath",i);this.resetContent=true;this._initDataBucket();}return this;},setModelName:function(i){this.setProperty("modelName",i);this.resetContent=true;return this;},resetControl:function(){this._unbindRule();this._unbindRows();this._unbindColumns();this._clearErrorMessages();this._initDataBucket();this._initDisplayModel();this._updateBusyState();var i=this._getModel();var n=this.getBindingContextPath();if(!n||!i){return;}var p=new sap.ui.model.Context(i,n);this.setBindingContext(p);this._bindRule();this._bindRows();this._bindColumns();},_openTableSettings:function(){var i=this._createDialog();i.open();this._unbindColumns();},_createDialog:function(){var i=new sap.rules.ui.DecisionTableSettings({expressionLanguage:this.getExpressionLanguage(),hitPolicies:"{dtModel>/hitPolicies}",newDecisionTable:this._internalModel.getProperty("/newTable")});var n=this._getModel();i.setModel(n);i.setModel(this._internalModel,"dtModel");var p=this.getBindingContext();i.setBindingContext(p);var r=new b({contentWidth:"70%",title:this.oBundle.getText("tableSettings")});r.addContent(i);r.attachBeforeClose(function(){this.getModel().submitChanges();r.destroy();this._initDisplayModel();this._bindColumns();this._refreshBinding();},this);var s=new B({text:this.oBundle.getText("applyChangesBtn")}).setTooltip(this.oBundle.getText("applyChangesBtn"));s.attachPress(function(){this.multiHeaderFlag=false;r.close();},this);r.addButton(s);return r;},_getBindModelName:function(){var p="";var i=this.getModelName();if(i){p=i+">";}return p;},_getModel:function(){var i=this.getModelName();if(i){return this.getModel(i);}return this.getModel();},columnFactory:function(i,n){if(this.multiHeaderFlag){this.multiHeaderFlag=false;}var r=this._getBindModelName();var p=new C(i,{width:"auto",multiLabels:[this._createColIfThenHeader(n),this._createColDescriptionHeader(n)],template:this._createCell(n)});p.isConditionOrFirstResultColumn=!this.firstResultColumnBound;var r=this._getBindModelName();this.firstResultColumnBound=n.getProperty(r+"Type")===sap.rules.ui.DecisionTableColumn.Result;return p;},_createColDescriptionHeader:function(i){var r=this._getBindModelName(),n=i.getProperty(r+"Type"),p=i.getProperty(r+"Id"),s=i.getProperty(r+"RuleId"),t=i.getProperty(r+"Version");var u;var H={RuleId:s,Id:p,Version:t};var w=document.getElementsByClassName("sapUiSizeCozy").length>0?3:1;var x=new d({maxLines:w}).addStyleClass("sapRULDecisionTableColumnHeaderLabel");if(n===sap.rules.ui.DecisionTableColumn.Condition){u=r+i.getModel().createKey("/DecisionTableColumnConditions",H);x.bindText({parts:[{path:u+"/Expression"},{path:u+"/FixedOperator"}],type:this._decisionTableHeaderFormatter});x.bindProperty("tooltip",{parts:[{path:u+"/Expression"},{path:u+"/FixedOperator"}],type:this._decisionTableHeaderFormatter});}else if(n===sap.rules.ui.DecisionTableColumn.Result){u=r+i.getModel().createKey("/DecisionTableColumnResults",H);x.bindText({path:u+"/DataObjectAttributeName"});x.bindProperty("tooltip",{path:u+"/DataObjectAttributeName"});}return x;},_createColIfThenHeader:function(i){var r=this._getBindModelName();var n=this.oBundle;return new e({text:{parts:[{path:r+"Type"},{path:r+"Id"}],formatter:function(t,p){if(p===1){return n.getText("conditionIfColumn");}else if(t===sap.rules.ui.DecisionTableColumn.Result&&this.getParent().isConditionOrFirstResultColumn){return n.getText("resultThenColumn");}else{return"";}}},design:"Bold"});},_createCell:function(i){var n=i.getProperty("Id");var p=i.getProperty("Type");return new D({editable:"{dtModel>/editable}",expressionLanguage:this.getExpressionLanguage(),displayModelName:"displayModel"}).data({colId:n,colType:p,table:this.getAggregation("_table")});},_updateTableCell:function(i,r,n,p){var s="null";if(r){var t=i.data("colId");var u=r.getProperty("Id");var w=r.getProperty("RuleId");var x=r.getProperty("Version");var y='';var z="DecisionTableRowCells(RuleId='"+w+"',Version='"+x+"',RowId="+u+",ColId="+t+")";var A={RuleId:w,Id:t,Version:x};s="/"+z+"/Content";switch(i.data("colType")){case"CONDITION":y="/"+r.getModel().createKey("DecisionTableColumnConditions",A);i.setHeaderValuePath(y+'/Expression');i.setFixedOperatorPath(y+'/FixedOperator');break;case"RESULT":y="/"+r.getModel().createKey("DecisionTableColumnResults",A);i.setTypePath(y+'/BusinessDataType');break;default:break;}i.setValueStateTextPath("dtModel>/validationStatus/"+"RowId="+u+",ColId="+t);}i.setValuePath(s);},_bindRule:function(){var i=[this._getBindModelName(),this.getBindingContextPath()].join("");this.bindElement({path:i,parameters:{expand:"DecisionTable"}});this.getElementBinding().attachDataRequested(this._handleRuleDataRequested,this);this.getElementBinding().attachDataReceived(this._handleRuleDataReceived,this);this.getElementBinding().refresh();},_unbindRule:function(){this.unbindElement();},_bindColumns:function(){var t=this.getAggregation("_table");var i=[this._getBindModelName(),this.getBindingContextPath(),"/DecisionTable/DecisionTableColumns"].join("");console.log("Hi");t.bindColumns({path:i,parameters:{expand:"Condition,Result"},factory:this.columnFactory.bind(this)});t.getBinding("columns").attachDataRequested(this._handleColumnsDataRequested,this);t.getBinding("columns").attachDataReceived(this._handleColumnsDataReceived,this);},_unbindColumns:function(){var t=this.getAggregation("_table");t.unbindColumns();},_bindRows:function(){var t=this.getAggregation("_table");var i=[this._getBindModelName(),this.getBindingContextPath(),"/DecisionTable/DecisionTableRows"].join("");t.bindRows({path:i,parameters:{expand:"Cells"}});t.getBinding("rows").attachDataRequested(this._handleRowsDataRequested,this);t.getBinding("rows").attachDataReceived(this._handleRowsDataReceived,this);},_unbindRows:function(){var t=this.getAggregation("_table");t.unbindRows();},_refreshBinding:function(){var t=this.getAggregation("_table");var r=this.getElementBinding();if(r){r.refresh();}var i=t.getBinding("columns");if(i){i.refresh();}var n=t.getBinding("rows");if(n){n.refresh();}},_handleRuleDataRequested:function(){this._dataPartRequested(m.rule);},_handleRuleDataReceived:function(i){if(i){this._dataPartReceived(m.rule);}},_handleColumnsDataRequested:function(E){this._dataPartRequested(m.columns);},_handleColumnsDataReceived:function(E){var i=E.getParameter("data");if(!i){return;}var t=this.getAggregation("_table");if(i.results&&i.results.length>0){this._internalModel.setProperty("/newTable",false);t.setNoData(null);}else{this._internalModel.setProperty("/newTable",true);var n=this._getBlankContent();t.setNoData(n);}this.dataBucket[m.columns]=i;this._dataPartReceived(m.columns);this._handleHeaderSpan();},_handleRowsDataRequested:function(E){this._dataPartRequested(m.rows);},_handleRowsDataReceived:function(E){var i=E.getParameter("data");if(i){if(this.dataBucket.collectRowsMode==="replace"){this.dataBucket[m.rows]=i;this.dataBucket.collectRowsMode="append";}else{var p=this.dataBucket[m.rows];var n={results:(p.results)?p.results.concat(i.results):i.results};this.dataBucket[m.rows]=n;}this._dataPartReceived(m.rows);}this._setTableRows();},_handleVocabularyDataChanged:function(E){var i=E.getParameter("data");if(i){this._handleVocabularyDataReceived(i);}else{this._handleVocabularyDataRequested();}},_handleVocabularyDataRequested:function(){this._dataPartRequested(m.vocabulary);},_handleVocabularyDataReceived:function(i){if(i){this._dataPartReceived(m.vocabulary);}},_dataPartRequested:function(p){this.dataBucket.dataReceived[p]=false;this._setDataLoadedPromise();this._updateBusyState();},_dataPartReceived:function(p){this.dataBucket.dataReceived[p]=true;if(!this._isAllDataReceived()){return;}var i=this._internalModel.getProperty("/newTable");if(i){this._updateBusyState();return;}try{this._convertAndValidate();this.dataBucket.collectRowsMode="replace";}catch(E){window.console.log(E);}this._updateBusyState();this._dataLoaded.resolve();},_isAllDataReceived:function(){var i=this.dataBucket.dataReceived;return i.rule&&i.rows&&i.columns&&i.vocabulary;},_updateBusyState:function(){var i=this.dataBucket.dataReceived;var n=i.rule&&i.columns&&i.vocabulary;var p=!n;this._internalModel.setProperty("/busyState",p);var t=!i.rows;this._internalModel.setProperty("/busyTableState",t);},_decideSettingsEnablement:function(i,n){return i&&n;},_decideDeleteRowEnablement:function(n,i){return n===false&&i;},_decideAddRowEnablement:function(n){return!n;},_addToolBar:function(){var t=new a({design:"Transparent",enabled:"{dtModel>/editable}"});var i=new sap.m.Title({text:this.oBundle.getText("decisionTable")});var s=new B({text:"",press:this._openTableSettings.bind(this),visible:{parts:[{path:"dtModel>/enableSettings"},{path:"dtModel>/editable"}],formatter:this._decideSettingsEnablement},enabled:{parts:[{path:"dtModel>/enableSettings"},{path:"dtModel>/editable"}],formatter:this._decideSettingsEnablement}}).setTooltip(this.oBundle.getText("tableSettings"));s.setIcon("sap-icon://action-settings");var n=new L({text:this.oBundle.getText("deleteRow"),press:[this._deleteRowWorkaround,this],visible:"{dtModel>/editable}",enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isAtLeastOneRowSelected"}],formatter:this._decideDeleteRowEnablement}}).setTooltip(this.oBundle.getText("deleteRow"));var A=new L({text:this.oBundle.getText("addRow"),visible:"{dtModel>/editable}",enabled:{parts:[{path:"dtModel>/newTable"}],formatter:this._decideAddRowEnablement},press:function(E){this.oMenu=new M({items:this._getMenuItems()});var p=sap.ui.core.Popup.Dock;this.oMenu.open("keyup",A,p.CenterTop,p.CenterBottom,A);}.bind(this)}).setTooltip(this.oBundle.getText("addRow"));t.addContent(new c({width:"1em"}));t.addContent(i);t.addContent(new c({}));t.addContent(A);t.addContent(new c({width:"1em"}));t.addContent(n);t._delete=n;t.addContent(new c({width:"1em"}));t.addContent(s);t.addContent(new c({width:"1em"}));this.setAggregation("_toolbar",t,true);},_addNewRowWorkaround:function(s,i){this._addNewRow(s,i);this._saveWorkAround();},_addNewRow:function(s,n){var p=this.oMenu;if(p){p.close();}var r=this._getModel();var t=this.dataBucket.columns&&this.dataBucket.columns.results;if(!r||!t){return;}var u=this.getAggregation("_table"),w=this.getBindingContext(),x=w.getProperty("Id"),V=w.getProperty("Version");var y={RuleId:x,Version:V};if(n){y.Id=1;}else if(s||s===0){y.Id=s+2;}r.createEntry("/DecisionTableRows",{properties:y});for(var i=0;i<t.length;i++){var z=t[i].Id;var A={RuleId:x,Version:V,RowId:y.Id,ColId:z,Content:""};r.createEntry("/DecisionTableRowCells",{properties:A});}u.setSelectedIndex(-1);this._clearErrorMessages();},_deleteRowWorkaround:function(){var i=this._getModel();if(i.hasPendingChanges()){this._saveWorkAround({success:function(){this._deleteRow();}.bind(this)});}else{this._deleteRow();}},_deleteRow:function(){var n=this._getModel();if(!n){return;}var t=this.getAggregation("_table"),p=this.getBindingContext(),r=p.getProperty("Id"),V=p.getProperty("Version");var s={RuleId:r,Version:V};var S=[];if(t){S=t.getSelectedIndices();}if(S.length===0){return;}var u=S.length;for(var i=0;i<u;i++){s.Id=S[i]+1;var w=n.createKey("/DecisionTableRows",s);n.remove(w);}t.setSelectedIndex(-1);this._clearErrorMessages();},_setTableRows:function(){var t=this.getAggregation("_table");var r=t.getBinding("rows");var V=v.emptyTable;if(r&&r.getLength()){V=Math.min(r.getLength(),v.max);}var i=t.getVisibleRowCount();if(i!==V){t.setVisibleRowCount(V);}if(this.dataBucket.rows.results.length===0||!this.getEditable()){t.setSelectionMode(sap.ui.table.SelectionMode.None)}else{t.setSelectionMode(sap.ui.table.SelectionMode.MultiToggle)}},_getMenuItems:function(){var t=this.getAggregation("_table");var s=[];if(t){s=t.getSelectedIndices();}var i=[new h({text:this.oBundle.getText("insertFirst"),enabled:true,select:this._addNewRowWorkaround.bind(this,s[0],true)}),new h({text:this.oBundle.getText("insertAfter"),enabled:s.length===1?true:false,select:this._addNewRowWorkaround.bind(this,s[0],false)})];return i;},_rowSelectionChange:function(){var t=this.getAggregation("_table");var s=[];if(t){s=t.getSelectedIndices();}if(s.length>0){this._internalModel.setProperty("/isAtLeastOneRowSelected",true);}else{this._internalModel.setProperty("/isAtLeastOneRowSelected",false);}},_getBlankContent:function(){var i=new e({text:this.oBundle.getText("start")});var s=new d();s.setText("\u00a0");var n=new L({enabled:{parts:[{path:"dtModel>/enableSettings"},{path:"dtModel>/editable"}],formatter:this._decideSettingsEnablement},text:" "+this.oBundle.getText("settings"),press:[this._openTableSettings,this]}).addStyleClass("sapRULDecisionTableLink");var p=new F({justifyContent:"Center",items:[i,s,n],visible:{parts:[{path:"dtModel>/enableSettings"},{path:"dtModel>/editable"}],formatter:this._decideSettingsEnablement}}).addStyleClass("sapUiMediumMargin");return p;},_decideSelectionMode:function(i){return i?sap.ui.table.SelectionMode.MultiToggle:sap.ui.table.SelectionMode.None;},_addTable:function(){var t=new T({visibleRowCount:v.emptyTable,visibleRowCountMode:sap.ui.table.VisibleRowCountMode.Fixed,threshold:20,selectionMode:{parts:[{path:"dtModel>/editable"}],formatter:this._decideSelectionMode},rowSelectionChange:function(){this.oParent._rowSelectionChange();},enableColumnReordering:false,busy:"{dtModel>/busyTableState}"});t._updateTableCell=this._updateTableCell;t.setBusyIndicatorDelay(0);this.setAggregation("_table",t,true);},_buildMessagesStructure:function(n,p,r){var s;var t;var u;var x;if(!n.details){return p;}for(var w=0;w<n.details.length;w++){s=n.details[w];if(!s.messages){continue;}for(var i=0;i<s.messages.length;i++){u=s.messages[i].description;t=s.messages[i].additionalInfo;if(t.type==="ruleResult"){r.push(u);x="genericError";p[x]=r;}else if(t.type==="column"){x="errorInColumnHeader";p[x]=true;}else if(t.type==="cell"){x="RowId="+t.rowId+",ColId="+t.colId;p[x]=u;}}}return p;},_concatinateHeaderErrors:function(n){var p="";for(var i=0;i<n.length;i++){p+="\n"+n[i];}return p;},_concatinateColumnsHeaderErrors:function(i){var n="";for(var p in i){if(i.hasOwnProperty(p)){if(i[p].header){n+="In Col: "+p+" - "+i[p].header+"\n";}}}return n;},_displayHeaderErrorMessages:function(i,n){var t=this.getAggregation("_errorsText");this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");var p=this._concatinateHeaderErrors(i);t.setText(this.oBundle.getText("errorInTableHeader")+p);t.setVisible(true);},_clearErrorMessages:function(){var t=this.getAggregation("_errorsText");t.setText("");t.setVisible(false);this._internalModel.setProperty("/validationStatus",{},null,true);},_displayErrorMessages:function(i,n){},_flatRule:function(r){var i=this._getModel();var n={};var p=function(s,t,u){var w=i.createKey(t,u);s[w]=u;};r.DecisionTable.DecisionTableColumns.results.forEach(function(s,t){if(s.Type==="CONDITION"){var u=s.Condition;if(u.parserResults&&u.parserResults.status==="Success"){u.Expression=u.parserResults.converted.Expression;u.FixedOperator=u.parserResults.converted.FixedOperator;}delete u.parserResults;p(n,"DecisionTableColumnConditions",u);}else if(s.Type==="RESULT"){var w=s.Result;p(n,"DecisionTableColumnResults",w);}});r.DecisionTable.DecisionTableRows.forEach(function(s){var t=s.Cells;t.results.forEach(function(u){if(u.parserResults&&u.parserResults.status==="Success"){u.Content=u.parserResults.converted.Content;}delete u.parserResults;p(n,"DecisionTableRowCells",u);});});return n;},_convertAndValidate:function(){var r=this._getRuleData();var E=sap.ui.getCore().byId(this.getExpressionLanguage());var i={};if(E&&r){i=E.convertRuleToDisplayValues(r);}if(i&&i.output){if(i.output.status==="Error"){var n=[];var p=this._internalModel.getProperty("/validationStatus");p=this._buildMessagesStructure(i,p,n);this._displayErrorMessages(n,p);this._internalModel.setProperty("/validationStatus",p,null,true);}var s=this._flatRule(i.output.decisionTableData);this._displayModel.setData(s,true);}},_getRuleData:function(){var i=this.getBindingContextPath();var n=this._getModel();var r=q.extend({},true,n.getProperty(i,null,true));var p=r.DecisionTable;p.DecisionTableColumns=this.dataBucket.columns;p.DecisionTableRows=this.dataBucket.rows;return r;},onBeforeRendering:function(){if(this.resetContent){this.resetControl();this.resetContent=false;}},_handleHeaderSpan:function(){if(!this.multiHeaderFlag){this.multiHeaderFlag=true;var n=this.dataBucket.columns.results;this.iNumOfCondition=0;this.iNumOfResults=0;for(var i=0;i<n.length;i++){if(n[i].Type===sap.rules.ui.DecisionTableColumn.Condition){this.iNumOfCondition++;}else if(n[i].Type===sap.rules.ui.DecisionTableColumn.Result){this.iNumOfResults++;}}var t=this.getAggregation('_table');n=t.getAggregation('columns');var i=0;for(;i<this.iNumOfCondition;i++){n[i].setHeaderSpan([this.iNumOfCondition,1]);}for(;i<n.length;i++){n[i].setHeaderSpan([this.iNumOfResults,1]);}}},exit:function(){var i=this.oMenu;if(i){i.destroy();}}});sap.rules.ui.DecisionTable.prototype._saveWorkAround=function(p){var i=this._getModel();i.submitChanges(p);};return o;},true);
