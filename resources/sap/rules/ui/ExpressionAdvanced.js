/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/core/Control","sap/m/Button","sap/m/TextArea","sap/m/Text","sap/m/MessageBox","sap/ui/layout/HorizontalLayout","sap/rules/ui/Utils","sap/ui/core/Popup","jquery.sap.global","sap/rules/ui/ExpressionBase","sap/rules/ui/codemirror/lib/codemirror","sap/rules/ui/codemirror/addon/hint/show-hint","sap/rules/ui/codemirror/mode/hdf/hdf","sap/rules/ui/codemirror/addon/display/placeholder","sap/rules/ui/codemirror/addon/mh/mark-selection","sap/rules/ui/codemirror/addon/hint/hdf-hint","sap/rules/ui/codemirror/addon/closeBrackets/closebrackets","sap/rules/ui/codemirror/addon/search/search"],function(C,B,a,b,M,H,U,P,q,E){"use strict";var c=E.extend("sap.rules.ui.ExpressionAdvanced",{metadata:{properties:{type:{type:"sap.rules.ui.ExpressionType",defaultValue:sap.rules.ui.ExpressionType.All,bindable:"bindable"},collection:{type:"boolean",defaultValue:false},placeholder:{type:"string",defaultValue:null},focusOnLoad:{type:"boolean",defaultValue:false},valueStateText:{type:"string",defaultValue:null,bindable:"bindable"}},aggregations:{_expressionArea:{type:"sap.m.TextArea",multiple:false,visibility:"hidden"}},events:{"change":{},"liveChange":{}},publicMethosds:["validate"]}});c.prototype.init=function(){E.prototype.init.apply(this,arguments);var d=jQuery.sap.getModulePath("sap.rules.ui.codemirror.lib")+"/codemirror.css";var s=jQuery.sap.getModulePath("sap.rules.ui.codemirror.addon.hint")+"/show-hint.css";jQuery.sap.includeStyleSheet(d);jQuery.sap.includeStyleSheet(s);this.pop=new P(q('<span></span>')[0],false,false,false);this.errorWidgets=[];this.expressionTokens=[];this._liveValue="";this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.dataModel=this.initControlDataModel();this.oTextArea=new a({width:"100%"});this.setAggregation("_expressionArea",this.oTextArea,true);};c.prototype.validateExpression=function(I){for(var i=0;i<this.errorWidgets.length;i++){this.codeMirror.removeLineWidget(this.errorWidgets[i]);}this.errorWidgets=[];var e=this.codeMirror?this.codeMirror.getValue():this.getValue();var r={};var d={};var o=sap.ui.getCore().byId(this.getExpressionLanguage());if(o){d=o.validateExpression(I?I:e,this.getProperty("type"),this.getCollection());if(d&&this.isActive()){r=d;if(typeof(d)!=='object'){r=JSON.parse(d);}if(r.status===sap.rules.ui.ValidationStatus.Error){var m=U.parseUTFToString(r.errorDetails);m=m.replace(/\r\n/g," ").replace(/\r/g," ").replace(/\n/g," ");this.errorCursorPosition=r.cursorPosition;this.setValueStateText(m);}else{this.oTextArea.setValueState("None");this.oTextArea.setValueStateText("");this.setValueStateText("");jQuery(this.codeMirror.getWrapperElement()).removeClass('sapMInputBaseStateInner sapMInputBaseErrorInner');}}}return d;};c.prototype._showPopUp=function(){var e="Error";var d=this.getProperty("valueStateText");var t=this.getId()+'-message';var p=this.pop;p.attachClosed(function(){q.sap.byId(t).remove();});var f=P.Dock;var g='sapMInputBaseMessage'+e+' sapMFocus';var T='sapMValueStateMessageError sapMText';var r=sap.ui.getCore().getLibraryResourceBundle('sap.m');if(e===sap.ui.core.ValueState.Success){g='sapUiInvisibleText';d='';}var $=q('<div>',{'id':t,'class':g,'role':'tooltip','aria-live':'assertive'}).append(q('<span>',{'aria-hidden':true,'class':'sapUiHidden','text':r.getText('INPUTBASE_VALUE_STATE_'+e.toUpperCase())})).append(q('<span>',{'id':t+'-text','class':T,'text':d}));p.setContent($[0]);p.close(0);p.open(0,f.BeginTop,f.BeginBottom,jQuery(this.codeMirror.getWrapperElement()),null,null,true);var s=this.pop.oContent.clientWidth;var h=document.getElementById(this.getAggregation("_expressionArea").sId).clientWidth;if(s>h){jQuery(".sapMText").css('width',h);}};c.prototype._closePopUp=function(){if(this.pop){this.pop.close(0);}};c.prototype._showErrorMessage=function(){if(this.getValueStateText()){this._setExpressionErrorStyle();}};c.prototype.initControlDataModel=function(){var d=new sap.ui.model.json.JSONModel();var e={};d.setData(e);return d;};c.prototype.setExpressionTokens=function(t){var m=0,n=false;this.expressionTokens=[];if(t instanceof Array){for(var i=0;i<t.length;i++){var d=t[i];var e=/\n/;if(e.test(d.token)){m=d.start+d.token.lastIndexOf('\n')+1;n=true;continue;}if(n){d.start=d.start-m;d.end=d.end-m+1;}else{d.end=d.end+1;}this.expressionTokens.push(d);}}};c.prototype.getExpressionTokens=function(){return this.expressionTokens;};c.prototype.getValue=function(){if(this.codeMirror!==undefined){return this.codeMirror.getValue();}return this.getProperty("value");};c.prototype.setValue=function(v){if(v===undefined||v===null){v="";}this._liveValue=v;this.oTextArea.setValue(v);if(this.getProperty("value")===v){return;}this.setProperty("value",v,true);if(this.codeMirror!==undefined){this.codeMirror.setValue(v);}};c.prototype.setPlaceholder=function(v){this.setProperty("placeholder",v);var m=(this.getEditable())?v:"";this.dataModel.setProperty("/placeholder",m);};c.prototype.getPlaceholder=function(){return this.dataModel.getProperty("/placeholder");};c.prototype.setValueStateText=function(m){this.setProperty("valueStateText",m,true);this._showErrorMessage(m);};c.prototype.setEditable=function(v){this.setProperty("editable",v);if(this.codeMirror){jQuery(this.codeMirror.getWrapperElement()).addClass('CodeMirror-rules-Not-Editable');}var _=(v)?this.getProperty("placeholder"):"";this.dataModel.setProperty("/placeholder",_);this.invalidate();};c.prototype.setType=function(t){this.setProperty("type",t);if(this.codeMirror){this.codeMirror.options.returnType=t;}};c.prototype.setCollection=function(i){this.setProperty("collection",i,true);if(this.codeMirror){this.codeMirror.options.collection=i;}};c.prototype.validate=function(){return this.validateExpression();};c.prototype.setFocusOnLoad=function(v){this.dataModel.setProperty("/focus",v);this.setProperty("focusOnLoad",v,true);};c.prototype.focus=function(){if(this.codeMirror){var l=this.codeMirror.getLine(this.codeMirror.lastLine());var d=l.length;this.codeMirror.setCursor({line:this.codeMirror.lastLine(),ch:d});this.codeMirror.focus();}};c.prototype.onAliasLinkPress=function(d){var e=sap.ui.getCore().byId(this.getExpressionLanguage());if(e){e.onAliasLinkPress(d);e.attachEvent("aliasDialogClosed",this.aliasClickCancel,this);}};c.prototype.onCreateAliasLinkForText=function(t){var e=sap.ui.getCore().byId(this.getExpressionLanguage());if(e){e.attachEvent("aliasDialogClosed",this.replaceTextWithAlias,this);e.onCreateAliasLinkForText(t);}};c.prototype.replaceTextWithAlias=function(e){if(e.getParameter("isSave")){this.codeMirror.replaceSelection(e.getParameter("savedAliasName"));}};c.prototype.aliasClickCancel=function(e){this.codeMirror.focus();this.codeMirror.execCommand("goLineEnd");this.fireDialog({dialogStatus:sap.rules.ui.ValueListDialogMode.Close});};c.prototype.onAfterRendering=function(){this.timer=null;this.needAutoComplete=false;this.endCompletion=false;this._setCodeMirror();this._setEditorStyle();this._handleMousedown();this._handleChange();this._handleFocusLeave();this._handleEndCodeCompletion();this._handleKeyPress();this._handleEditableProperty();this._handleOnLoadValidation();this._refreshOnNavigationEnd();this._handleFocus();this._handleValueListSelect();};c.prototype._handleValueListSelect=function(){};c.prototype.onEnumLinkPress=function(e,d){this.blurEvent=false;var f=sap.ui.getCore().byId(this.getExpressionLanguage());var g=jQuery.extend(true,{},this.codeMirror.getCursor());var h=this._createSearchCursor(e);if(h.find(e)||e===sap.rules.ui.VocabularyEnum.SelectValueList){var i=this._selectDialogCallback();this.oSelectDialog=new sap.m.SelectDialog({title:this.oBundle.getText('ENUM_SELECT_DIALOG_TITLE'),noDataText:this.oBundle.getText('ENUM_SELECT_DIALOG_MESSAGE'),contentHeight:"15rem",contentWidth:"10rem",search:i.searchFn,liveChange:i.searchFn});this.oSelectDialog.attachConfirm({cmCursor:h,enumText:e,cursorPos:g},i.confirm,this);f.vocabularyProxy.getEnumList(d,this._setSelectDialogModel,this);this.oSelectDialog.open();}};c.prototype._setSelectDialogModel=function(i){var l=new sap.m.StandardListItem({title:"{}"});var d=new sap.ui.model.json.JSONModel();d.setJSON(JSON.stringify(i));this.oSelectDialog.setModel(d);this.oSelectDialog.bindAggregation("items","/",l);};c.prototype._createSearchCursor=function(e){var d=this.codeMirror;d.getCursor().ch=d.getCursor().ch+e.length;var f=d.getSearchCursor(e,d.getCursor(),typeof e=="string"&&e==e.toLowerCase());return f;};c.prototype._selectDialogCallback=function(){var f={};f.searchFn=function(e){var F=[],s=e.getParameter("value"),i=e.getParameter("itemsBinding");if(s!==undefined&&s.length>0){F.push(new sap.ui.model.Filter('',sap.ui.model.FilterOperator.Contains,s));}i.filter(F,"Application");};f.confirm=function(e,d){if(e.getParameter('selectedItem')){var s=e.getParameter('selectedItem').getTitle();if(d.enumText!==sap.rules.ui.VocabularyEnum.SelectValueList){d.cmCursor.replace(s);}else{var g=d.cursorPos;this.codeMirror.replaceRange(s,g);g=this.codeMirror.findPosH(g,s.length,"char",true);this.codeMirror.setCursor(g);}this.oSelectDialog.destroy();this.oSelectDialog=null;this.codeMirror.focus();this.blurEvent=true;this.fireDialog({dialogStatus:sap.rules.ui.ValueListDialogMode.Close});}};return f;};c.prototype._setCodeMirror=function(){var e=this.getEditable();function d(p,r,u){var A=p.options.expressionEditor;if((A.getEditable()!==false)&&sap.ui.getCore().byId(A.getExpressionLanguage())){window.clearTimeout(A.timer);A.timer=window.setTimeout(function(){p.execCommand(r);},u);return window.CodeMirror.Pass;}return null;}function o(p){var A=p.options.expressionEditor;if(A.getEditable()!==false){window.clearTimeout(A.timer);A.needAutoComplete=true;A.timer=window.setTimeout(function(){if(A.needAutoComplete&&sap.ui.getCore().byId(A.getExpressionLanguage())){p.execCommand("autocomplete");}},500);return window.CodeMirror.Pass;}return null;}function f(p){return d(p,"enterAutocomplete",500);}function g(p){return d(p,"colonAutocomplete",500);}function h(p){d(p,"autocomplete",0);}function s(p){return d(p,"autocomplete",500);}this.keyMap={"Tab":false,"Shift-Tab":false,"Ctrl-Space":h,"Backspace":o,"Enter":f,"':'":g,"'+'":o,"'-'":o,"'*'":o,"'/'":o,"'_'":o,"'o'":o,"'q'":o,"'w'":o,"'e'":o,"'r'":o,"'t'":o,"'y'":o,"'u'":o,"'i'":o,"'p'":o,"'.'":o,"'a'":o,"'s'":o,"'d'":o,"'f'":o,"'g'":o,"'h'":o,"'j'":o,"'k'":o,"'l'":o,"'z'":o,"'x'":o,"'c'":o,"'v'":o,"'b'":o,"'n'":o,"'m'":o,"'O'":o,"'Q'":o,"'W'":o,"'E'":o,"'R'":o,"'T'":o,"'Y'":o,"'U'":o,"'I'":o,"'P'":o,"'A'":o,"'S'":o,"'D'":o,"'F'":o,"'G'":o,"'H'":o,"'J'":o,"'K'":o,"'L'":o,"'Z'":o,"'X'":o,"'C'":o,"'V'":o,"'B'":o,"'N'":o,"'M'":o,"'0'":false,"'1'":false,"'2'":false,"'3'":false,"'4'":false,"'5'":false,"'6'":false,"'7'":false,"'8'":false,"'9'":false,"' '":s};function k(A){return A.keyMap;}if(this.expressionTokens.length===0){var i=sap.ui.getCore().byId(this.getExpressionLanguage());if(i){var t=[];var j=i.getExpressionMetadata(this._liveValue);if(j){t=j.tokens;}this.setExpressionTokens(t);}}var l=k(this);var m=this.oTextArea.getId()+'-inner';var n=(U.msieversion()>=0);if(n){jQuery('#'+m).attr('placeholder',this.getProperty('placeholder'));}this.codeMirror=window.CodeMirror.fromTextArea(document.getElementById(m),{mode:"text/hdf",lineNumbers:false,lineWrapping:true,matchBrackets:e===true?true:false,highlightSelectionMatches:e===true?{showToken:/\w/}:{},relDelegate:sap.ui.getCore().byId(this.getExpressionLanguage()),returnType:this.getProperty("type"),collection:this.getProperty("collection"),expressionEditor:this,stillNeedShowHint:true,shouldValidate:true,styleSelectedText:true,smartIndent:true,autoCloseBrackets:true,indentUnit:6});this.codeMirror.addKeyMap(l,true);};c.prototype._setEditorStyle=function(){if(this.getValueStateText()){jQuery(this.codeMirror.getWrapperElement()).addClass('CodeMirror-error');jQuery(this.codeMirror.getWrapperElement()).addClass('sapMInputBaseStateInner sapMInputBaseErrorInner');jQuery('#'+this.oTextArea.getId()).addClass('sapMInputBaseError');}jQuery('#'+this.oTextArea.getId()).removeClass().addClass('sapMInput');jQuery(this.codeMirror.getWrapperElement()).addClass('sapMInputBaseInner CodeMirror-rules');if(!this.getEditable()){jQuery(this.codeMirror.getWrapperElement()).addClass('CodeMirror-rules-Not-Editable');}if(this.codeMirror){this.codeMirror.refresh();}};c.prototype._handleOnLoadValidation=function(){if(this.getValidateOnLoad()){this.validateExpression();this.setValidateOnLoad(false);}};c.prototype._handleEditableProperty=function(){if(this.getEditable()===false){this.codeMirror.setOption("readOnly","true");this.codeMirror.setOption("theme","read-only");}};c.prototype._handleFocus=function(){var o=this.codeMirror;if(this.getFocusOnLoad()){this.focus();}this.codeMirror.on("focus",function(d,e){var f=d.options.expressionEditor.getProperty("valueStateText");if((f)){d.options.expressionEditor._showPopUp();}d.options.stillNeedShowHint=true;jQuery('#'+d.options.expressionEditor.oTextArea.getId()).addClass('sapMInputFocused');jQuery(d.getWrapperElement()).removeClass('CodeMirror-errorBackground');});if(this.dataModel.getProperty("/focus")===true){window.setTimeout(function(){var l=o.getLine(o.lastLine());var d=l.length;o.setCursor({line:o.lastLine(),ch:d});},10);}};c.prototype._refreshOnNavigationEnd=function(){jQuery(".sapMNav").on('webkitTransitionEnd oTransitionEnd transitionend msTransitionEnd',function(){if(this.codeMirror){this.codeMirror.refresh();}});};c.prototype._handleKeyPress=function(){this.codeMirror.on("keyHandled",function(d,k,e){if(e.keyCode===27&&this&&this.endCompletion===true){e.stopPropagation();this.endCompletion=false;}if(e.ctrlKey===true&&k==="Ctrl-A"){e.stopPropagation();}});};c.prototype._handleEndCodeCompletion=function(){this.codeMirror.on("endCompletion",function(d){d.options.expressionEditor.needAutoComplete=false;d.options.expressionEditor.endCompletion=!d.options.expressionEditor.endCompletion;});};c.prototype._handleMousedown=function(){this.codeMirror.on("mousedown",function(d,e){e.stopPropagation();});};c.prototype._handleChange=function(){this.codeMirror.on("change",function(d,e){var A=d.options.expressionEditor;if(A.codeMirror.state.completionActive&&A.keyMap["'"+e.text[0]+"'"]===false){A.codeMirror.state.completionActive.close();}jQuery(A.codeMirror.getWrapperElement()).removeClass('CodeMirror-error');jQuery(A.codeMirror.getWrapperElement()).removeClass('sapMInputBaseStateInner sapMInputBaseErrorInner');A._liveValue=d.getValue();var o=sap.ui.getCore().byId(A.getExpressionLanguage());if(o){var t=[];var f=o.getExpressionMetadata(A._liveValue);if(f){t=f.tokens;}A.setExpressionTokens(t);}A.codeMirror.options.shouldValidate=true;A.fireLiveChange({newValue:d.getValue()});if(e.origin!=="+delete"){d.operation(function(){for(var l=0,g=d.lineCount();l<g;++l){d.indentLine(l,"smart");}});}});};c.prototype._handleFocusLeave=function(){this.codeMirror.on("blur",function(d){var A=d.options.expressionEditor;A._closePopUp();A.codeMirror.options.stillNeedShowHint=false;if(A.codeMirror.options.shouldValidate){A.setValue(A.codeMirror.getValue());A.validate();A._closePopUp();A.fireChange({newValue:d.getValue()});A.codeMirror.options.shouldValidate=false;}jQuery('#'+A.oTextArea.getId()).removeClass('sapMInputFocused');A.dataModel.setProperty("/focus",false);});};c.prototype._setExpressionErrorStyle=function(){var e=this.getProperty("valueStateText");if(e!==""&&e!==undefined&&this.codeMirror){jQuery(this.codeMirror.getWrapperElement()).addClass('CodeMirror-error');jQuery(this.codeMirror.getWrapperElement()).addClass('sapMInputBaseStateInner sapMInputBaseErrorInner');jQuery('#'+this.oTextArea.getId()).addClass('sapMInputBaseError');var d;if(this.errorCursorPosition<0){var l=this.codeMirror.getLine(this.codeMirror.lastLine());d=l.length;jQuery(this.codeMirror.getWrapperElement()).addClass('CodeMirror-errorBackground');}else{var i=e.lastIndexOf("'");if(i>0){var o=e.substring(0,i);i=o.lastIndexOf("'");if(i>0){o=o.substring(i+1);}var f=false;for(var g=this.codeMirror.lastLine();!f&&g>=0;g--){var h=this.codeMirror.getLine(g);d=h.lastIndexOf(o);if(d>=0){f=true;this.codeMirror.setSelection({line:g,ch:d},{line:g,ch:d+o.length});}}}}}};c.prototype.getSelectedText=function(){return this.codeMirror.getSelection();};return c;},true);
