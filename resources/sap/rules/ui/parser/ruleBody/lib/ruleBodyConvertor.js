jQuery.sap.declare("sap.rules.ui.parser.ruleBody.lib.ruleBodyConvertor");jQuery.sap.require("sap.rules.ui.parser.ruleBody.lib.ruleBodyValidator");jQuery.sap.require("sap.rules.ui.parser.ruleBody.lib.constants");jQuery.sap.require("sap.rules.ui.parser.businessLanguage.lib.constants");jQuery.sap.require("sap.rules.ui.parser.infrastructure.util.utilsBase");sap.rules.ui.parser.ruleBody.lib.ruleBodyConvertor=sap.rules.ui.parser.ruleBody.lib.ruleBodyConvertor||{};sap.rules.ui.parser.ruleBody.lib.ruleBodyConvertor.lib=(function(){var r=sap.rules.ui.parser.ruleBody.lib.ruleBodyValidator.lib;var c=sap.rules.ui.parser.ruleBody.lib.constants.lib;var p=sap.rules.ui.parser.businessLanguage.lib.constants.lib;var u=new sap.rules.ui.parser.infrastructure.util.utilsBase.lib.utilsBaseLib();function R(d){jQuery.sap.log.debug("CTOR - Rule Convertor");this.oDataRule=d;r.RuleBodyValidator.call(this);this.convertedRuleBody=null;this.decisionTableData=d?JSON.parse(JSON.stringify(d)):null;}R.prototype=Object.create(r.RuleBodyValidator.prototype);R.prototype.constructor=R;R.prototype.getConvertedData=function getConvertedData(a,b,e){a[e]=b;return a;};R.prototype.addParserResults=function addParserResults(a,b,s){var d={};d.status=s;if(b){d.converted=b;}u.setJsonValueAccordingPath(this.decisionTableData,a,c.decisionTableDataOutputPropEnum.parserResults,d);};R.prototype.hasParserConvertedExpression=function hasParserConvertedExpression(){if(this.currentParserResult.status===p.statusEnum.SUCCESS){if(!this.currentParserResult.hasOwnProperty(c.parserResultEnum.convertedExpression)){if(!this.flags[c.outputFlagsEnum.ASTOutput]){this.status=c.RULE_ERROR;}}else{return true;}}return false;};R.prototype.getParserConvertedExpression=function getParserConvertedExpression(){return this.currentParserResult[c.parserResultEnum.convertedExpression];};R.prototype.handleTextCondition=function handleTextCondition(a,b,d){r.RuleBodyValidator.prototype.handleTextCondition.call(this,a,b,d);if(this.status===c.RULE_SUCCESS&&this.hasParserConvertedExpression()){this.convertedRuleBody.content.condition=this.getParserConvertedExpression();}};R.prototype.handleTextOutputParameter=function handleTextOutputParameter(a,b,d){r.RuleBodyValidator.prototype.handleTextOutputParameter.call(this,a,b,d);if(this.status===c.RULE_SUCCESS&&this.hasParserConvertedExpression()){a.content=this.getParserConvertedExpression();}};R.prototype.handleTextActionParameter=function handleTextActionParameter(a,b,i,d){r.RuleBodyValidator.prototype.handleTextActionParameter.call(this,a,b,i,d);if(this.status===c.RULE_SUCCESS&&this.hasParserConvertedExpression()){a.content=this.getParserConvertedExpression();}};R.prototype.handleDecisionTableCondition=function handleDecisionTableCondition(h,a,b,d){var e,f;var g={};d=r.RuleBodyValidator.prototype.handleDecisionTableCondition.call(this,h,a,b,d);if(this.hasParserConvertedExpression()&&this.invalidHeaders[h.colID]!==true){e=this.getParserConvertedExpression();var o=h.hasOwnProperty(c.afterConversionParts.fixedOperator)?h.fixedOperator.operator:null;f=this.splitDecisionTableCondition(h.convertedExpression,e,o);if(this.flags[c.outputFlagsEnum.oDataOutput]){g=this.getConvertedData(g,f,c.decisionTableExpressionParts.content);this.addParserResults(a.row[b].inputModelPath,g,this.currentParserResult.status);}else if(this.status===c.RULE_SUCCESS){h.expression=h.convertedExpression;a.row[b].content=f;}}else if(this.flags[c.outputFlagsEnum.oDataOutput]){this.addParserResults(a.row[b].inputModelPath,null,p.statusEnum.ERROR);}if(this.flags[c.outputFlagsEnum.ASTOutput]&&this.currentParserResult.status===p.statusEnum.SUCCESS){g=this.getConvertedData(g,this.currentParserResult.model,c.decisionTableExpressionParts.astOutput);this.addParserResults(a.row[b].inputModelPath,g,this.currentParserResult.status);}return d;};R.prototype.handleDecisionTableActionParameter=function handleDecisionTableActionParameter(h,a,b,d){d=r.RuleBodyValidator.prototype.handleDecisionTableActionParameter.call(this,h,a,b,d);if(this.status===c.RULE_SUCCESS&&this.hasParserConvertedExpression()){a.row[b].content=this.getParserConvertedExpression();}return d;};R.prototype.handleDecisionTableOutputParameter=function handleDecisionTableOutputParameter(h,a,b,d){var e={};var f;d=r.RuleBodyValidator.prototype.handleDecisionTableOutputParameter.call(this,h,a,b,d);if(this.hasParserConvertedExpression()&&this.invalidHeaders[h.colID]!==true){f=this.getParserConvertedExpression();if(this.flags[c.outputFlagsEnum.oDataOutput]){e=this.getConvertedData(e,f,c.decisionTableExpressionParts.content);this.addParserResults(a.row[b].inputModelPath,e,this.currentParserResult.status);}else if(this.status===c.RULE_SUCCESS){a.row[b].content=f;}}else if(this.flags[c.outputFlagsEnum.oDataOutput]){this.addParserResults(a.row[b].inputModelPath,null,p.statusEnum.ERROR);}if(this.flags[c.outputFlagsEnum.ASTOutput]&&this.currentParserResult.status===p.statusEnum.SUCCESS){e=this.getConvertedData(e,this.currentParserResult.model,c.decisionTableExpressionParts.astOutput);this.addParserResults(a.row[b].inputModelPath,e,this.currentParserResult.status);}return d;};R.prototype.handleConditionHeader=function handleConditionHeader(h){var a={};var b;r.RuleBodyValidator.prototype.handleConditionHeader.call(this,h);if(this.hasParserConvertedExpression()){b=this.getParserConvertedExpression();if(this.flags[c.outputFlagsEnum.oDataOutput]){a=this.getConvertedData(a,b,c.decisionTableExpressionParts.expression);this.addParserResults(h.inputModelPath,a,this.currentParserResult.status);h.convertedExpression=b;}else if(this.status===c.RULE_SUCCESS){h.convertedExpression=b;}}else if(this.flags[c.outputFlagsEnum.oDataOutput]){this.addParserResults(h.inputModelPath,null,this.currentParserResult.status);}if(this.flags[c.outputFlagsEnum.ASTOutput]&&this.currentParserResult.status===p.statusEnum.SUCCESS){a=this.getConvertedData(a,this.currentParserResult.model,c.decisionTableExpressionParts.astOutput);this.addParserResults(h.inputModelPath,a,this.currentParserResult.status);}};R.prototype.finalizeResult=function finalizeResult(a){var i;if(!this.flags[c.outputFlagsEnum.oDataOutput]){for(i=0;i<a.content.headers.length;i++){if(a.content.headers[i].hasOwnProperty(c.parserResultEnum.convertedExpression)){delete a.content.headers[i].convertedExpression;}}}};R.prototype.initFlags=function initFlags(f){r.RuleBodyValidator.prototype.initFlags.call(this,f);if(f!==null&&f!==undefined){if(f.hasOwnProperty(c.outputFlagsEnum.conversionOutput)){this.flags[c.outputFlagsEnum.conversionOutput]=f[c.outputFlagsEnum.conversionOutput];}else if(f.hasOwnProperty(c.outputFlagsEnum.locale)&&f[c.outputFlagsEnum.locale].hasOwnProperty(c.localeEnum.convert)&&f[c.outputFlagsEnum.locale][c.localeEnum.convert]){this.flags[c.outputFlagsEnum.locale]=f[c.outputFlagsEnum.locale];}if(this.oDataRule){this.flags[c.outputFlagsEnum.oDataOutput]=true;}else{this.flags[c.outputFlagsEnum.oDataOutput]=false;}this.flags[c.outputFlagsEnum.ASTOutput]=f.hasOwnProperty(c.outputFlagsEnum.ASTOutput)?f[c.outputFlagsEnum.ASTOutput]:false;}};R.prototype.convert=function convert(a,v,b,f,o,d,t){this.convertedRuleBody=JSON.parse(JSON.stringify(a));var e=this.validateBusinessRule(this.convertedRuleBody,v,b,f,o,d,t);if(this.flags[c.outputFlagsEnum.oDataOutput]){e.decisionTableData=this.decisionTableData;}else{if(this.status===c.RULE_SUCCESS){e.convertedRuleBody=this.convertedRuleBody;}else{e.convertedRuleBody=null;}}return e;};return{RuleBodyConvertor:R};}());
